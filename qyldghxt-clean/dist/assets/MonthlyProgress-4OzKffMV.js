import{a as e,j as t}from"./index-ByQWdRVi.js";import{r as a}from"./charts--DrkC4h1.js";import{T as r}from"./TableManager-CI9BWYWi.js";import{r as l,u as s}from"./utils-d68qSfg_.js";import{e as n}from"./export-9Rbd0ORM.js";import{c as o,n as i,D as d,p as c,R as u}from"./ui-CyUNfsEX.js";import"./vendor-De9qiMg1.js";import"./router-BWTJJsff.js";import"./pdf-60kGjG4V.js";import"./DeleteConfirmDialog-CRlob68K.js";import"./InlineAlert-ConnvRud.js";const x=()=>{const{getMonthlyProgress:x,addMonthlyProgress:m,updateMonthlyProgress:p,deleteMonthlyProgress:h,getDepartments:b}=e(),[g,y]=a.useState([]),[j,v]=a.useState([]),[f,_]=a.useState(null),[w,k]=a.useState({year:(new Date).getFullYear(),month:"",department:"",status:""}),[N,C]=a.useState(!1);a.useEffect(()=>{D(),S()},[w]);const D=async()=>{const e=await x(w);e.success&&y(e.data||[])},S=async()=>{const e=await b();e.success&&v(e.data||[])},q=async e=>{const t={...e,year:w.year};return!!(await m(t)).success&&(D(),!0)},z=[{key:"year",label:"年度",type:"select",options:[{value:2024,label:"2024年"},{value:2025,label:"2025年"},{value:2026,label:"2026年"}],required:!0},{key:"month",label:"月份",type:"select",options:Array.from({length:12},(e,t)=>({value:t+1,label:`${t+1}月`})),required:!0},{key:"task_name",label:"任务名称",required:!0},{key:"department",label:"负责部门",type:"select",options:j.map(e=>({value:e.name,label:e.name})),required:!0},{key:"responsible_person",label:"负责人",required:!0},{key:"target_value",label:"目标值",type:"number"},{key:"actual_value",label:"实际值",type:"number"},{key:"completion_rate",label:"完成率",render:(e,a)=>{const r=a.actual_value&&a.target_value?(a.actual_value/a.target_value*100).toFixed(1):0;return t.jsxs("span",{className:"px-2 py-1 rounded-full text-xs "+(r>=100?"bg-green-100 text-green-800":r>=80?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"),children:[r,"%"]})}},{key:"status",label:"状态",type:"select",options:[{value:"on_track",label:"按计划进行"},{value:"delayed",label:"延期"},{value:"ahead",label:"提前完成"},{value:"at_risk",label:"有风险"}],required:!0,render:e=>t.jsx("span",{className:"px-2 py-1 rounded-full text-xs "+("ahead"===e?"bg-green-100 text-green-800":"on_track"===e?"bg-blue-100 text-blue-800":"delayed"===e?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:"ahead"===e?"提前完成":"on_track"===e?"按计划进行":"delayed"===e?"延期":"有风险"})},{key:"start_date",label:"开始日期",type:"date"},{key:"end_date",label:"结束日期",type:"date"},{key:"key_activities",label:"关键活动",type:"textarea"},{key:"achievements",label:"主要成果",type:"textarea"},{key:"challenges",label:"遇到的挑战",type:"textarea"},{key:"next_month_plan",label:"下月计划",type:"textarea"},{key:"support_needed",label:"需要支持",type:"textarea"}];return t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-6 text-white shadow-lg",children:t.jsxs("div",{className:"flex items-center space-x-4",children:[t.jsx("div",{className:"p-3 bg-white/20 rounded-lg",children:t.jsx(o,{size:24,className:"text-white"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold text-white",children:"月度推进计划"}),t.jsx("p",{className:"text-blue-100",children:"跟踪和管理各项工作的月度执行进展情况"})]})]})}),t.jsxs("div",{className:"relative",children:[t.jsxs("div",{className:"absolute top-4 right-4 flex items-center gap-2 z-10",children:[t.jsxs("button",{className:"h-10 px-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-medium hover:from-blue-600 hover:to-purple-700 transition-all duration-200 shadow-lg flex items-center justify-center text-sm gap-2",onClick:()=>C(e=>!e),children:[t.jsx(i,{size:16}),t.jsx("span",{children:"筛选"})]}),t.jsxs("button",{className:"h-10 px-4 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-xl font-medium hover:from-green-600 hover:to-teal-700 transition-all duration-200 shadow-lg flex items-center justify-center text-sm gap-2",onClick:()=>{try{const e=g.map(e=>({year:e.year,month:e.month,department:e.department,task_name:e.task_name,target_value:e.target_value,actual_value:e.actual_value,completion_rate:e.completion_rate,status:e.status,start_date:e.start_date,end_date:e.end_date,responsible_person:e.responsible_person}));n(e,`月度推进计划_${w.year}年`,"月度推进","monthlyProgress")}catch(e){console.error("导出Excel失败:",e),alert("导出失败，请稍后重试")}},children:[t.jsx(d,{size:16}),t.jsx("span",{children:"导出Excel"})]}),t.jsxs("label",{className:"h-10 px-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-medium hover:from-blue-600 hover:to-purple-700 transition-all duration-200 shadow-lg flex items-center justify-center text-sm gap-2 cursor-pointer",children:[t.jsx(c,{size:16}),t.jsx("span",{children:"导入Excel"}),t.jsx("input",{type:"file",accept:".xlsx,.xls",className:"hidden",onChange:e=>e.target.files[0]&&(async t=>{try{const e=await t.arrayBuffer(),a=l(e),r=a.SheetNames[0],n=a.Sheets[r],o=s.sheet_to_json(n);for(const t of o){const e={year:Number(t["年度"]||w.year),month:t["月份"]?Number(t["月份"]):null,department:t["部门"]||"",task_name:t["任务名称"]||"",target_value:t["目标"]?Number(t["目标"]):null,actual_value:t["实际"]?Number(t["实际"]):null,progress:t["进度"]?Number(t["进度"]):null,status:t["状态"]||"",responsible_person:t["负责人"]||""};await m(e)}await D(),alert("导入完成")}catch(e){console.error("导入失败:",e),alert("导入失败，请检查文件格式")}})(e.target.files[0])})]})]}),N&&t.jsxs("div",{className:"absolute top-16 right-4 w-96 bg-white border border-gray-200 rounded-xl shadow-xl p-4",children:[t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"年度"}),t.jsxs("select",{className:"w-full h-10 px-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white transition-all duration-200 text-sm",value:w.year,onChange:e=>k({...w,year:parseInt(e.target.value)}),children:[t.jsx("option",{value:"2024",children:"2024"}),t.jsx("option",{value:"2025",children:"2025"}),t.jsx("option",{value:"2026",children:"2026"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"月份"}),t.jsxs("select",{className:"w-full h-10 px-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white transition-all duration-200 text-sm",value:w.month,onChange:e=>k({...w,month:e.target.value}),children:[t.jsx("option",{value:"",children:"全部月份"}),Array.from({length:12},(e,a)=>t.jsxs("option",{value:a+1,children:[a+1,"月"]},a+1))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"部门"}),t.jsxs("select",{className:"w-full h-10 px-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white transition-all duration-200 text-sm",value:w.department,onChange:e=>k({...w,department:e.target.value}),children:[t.jsx("option",{value:"",children:"全部部门"}),j.map(e=>t.jsx("option",{value:e.name,children:e.name},e.id))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"状态"}),t.jsxs("select",{className:"w-full h-10 px-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-white transition-all duration-200 text-sm",value:w.status,onChange:e=>k({...w,status:e.target.value}),children:[t.jsx("option",{value:"",children:"全部状态"}),t.jsx("option",{value:"on_track",children:"按计划进行"}),t.jsx("option",{value:"delayed",children:"延期"}),t.jsx("option",{value:"ahead",children:"提前完成"}),t.jsx("option",{value:"at_risk",children:"有风险"})]})]})]}),t.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[t.jsx("button",{className:"h-9 px-3 border border-gray-300 text-gray-700 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm",onClick:()=>C(!1),children:"关闭"}),t.jsx("button",{className:"h-9 px-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all text-sm",onClick:()=>{D(),C(!1)},children:"应用筛选"}),t.jsxs("button",{className:"h-9 px-3 border border-gray-300 text-gray-700 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm",onClick:()=>k({year:(new Date).getFullYear(),month:"",department:"",status:""}),children:[t.jsx(u,{size:14,className:"inline mr-1"}),"重置"]})]})]})]}),t.jsx(r,{title:`${w.year}年度月度推进计划表`,data:g,columns:z,onAdd:q,onEdit:async(e,t)=>!!(await p(e,t)).success&&(D(),_(null),!0),onDelete:async e=>!!(await h(e)).success&&(D(),!0),onCopy:e=>{const t={...e};delete t.id,t.task_name=`${t.task_name}_副本`,t.year=w.year,q(t)},editingId:f,onEditingChange:_})]})};export{x as default};

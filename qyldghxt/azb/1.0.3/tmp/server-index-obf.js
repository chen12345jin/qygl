const _0x165f6e=_0x53ca;(function(_0x32fe14,_0x18d66b){const _0x234046=_0x53ca,_0x159535=_0x32fe14();while(!![]){try{const _0x5630de=parseInt(_0x234046(0x184))/0x1*(-parseInt(_0x234046(0x2a1))/0x2)+-parseInt(_0x234046(0x289))/0x3+parseInt(_0x234046(0x168))/0x4*(-parseInt(_0x234046(0x1c2))/0x5)+-parseInt(_0x234046(0x1a4))/0x6+-parseInt(_0x234046(0x20d))/0x7+-parseInt(_0x234046(0x3e6))/0x8*(-parseInt(_0x234046(0x378))/0x9)+parseInt(_0x234046(0x357))/0xa;if(_0x5630de===_0x18d66b)break;else _0x159535['push'](_0x159535['shift']());}catch(_0x457726){_0x159535['push'](_0x159535['shift']());}}}(_0x5503,0xd8a59));const express=require('express'),cors=require(_0x165f6e(0x3cc)),multer=require(_0x165f6e(0x116));let axios=null;const fs=require('fs')[_0x165f6e(0x35c)],fsSync=require('fs'),{createServer}=require('http'),{Server:SocketIOServer}=require('socket.io'),path=require('path'),mysql=require('mysql2/promise'),dotenv=require('dotenv'),jwt=require('jsonwebtoken'),crypto=require(_0x165f6e(0x303)),envPath=path[_0x165f6e(0x159)](process['cwd'](),_0x165f6e(0x34d));function _0x53ca(_0x55a6dd,_0x17d0c3){_0x55a6dd=_0x55a6dd-0x113;const _0x5503f5=_0x5503();let _0x53ca12=_0x5503f5[_0x55a6dd];return _0x53ca12;}dotenv[_0x165f6e(0x131)]({'path':envPath,'override':!![]}),console[_0x165f6e(0x128)]('Loading\x20config\x20file\x20path:',envPath),console[_0x165f6e(0x128)](_0x165f6e(0x2c7),{'appKey':process['env']['DINGTALK_APP_KEY']?'loaded':_0x165f6e(0x1c0),'appSecret':process['env'][_0x165f6e(0x320)]?_0x165f6e(0x1f0):_0x165f6e(0x1c0)});const app=express(),PORT=Number(process[_0x165f6e(0x308)]['PORT']||0x138c),ENABLE_AUTH=String(process['env']['ENABLE_AUTH']||'')['toLowerCase']()==='true',JWT_SECRET=process['env'][_0x165f6e(0x3d0)]||_0x165f6e(0x361);(!process[_0x165f6e(0x308)]['JWT_SECRET']||process[_0x165f6e(0x308)]['JWT_SECRET']===_0x165f6e(0x361))&&(console['warn'](_0x165f6e(0x2dd)),console['warn']('\x20\x20\x20生产环境中，请在\x20.env\x20文件中设置强随机的\x20JWT_SECRET'),console['warn'](_0x165f6e(0x32f)));app[_0x165f6e(0x130)](express['json']({'limit':_0x165f6e(0x214)}));const allowedOrigins=process[_0x165f6e(0x308)]['ALLOWED_ORIGINS']?process['env']['ALLOWED_ORIGINS']['split'](',')['map'](_0x17ace1=>_0x17ace1[_0x165f6e(0x1d6)]()):null;app[_0x165f6e(0x130)](cors({'origin':(_0x526ff0,_0x1f75da)=>{const _0x5c3956=_0x165f6e,_0x43db2c={'aeYeD':_0x5c3956(0x3cb),'slFbf':function(_0x16cd5c,_0x3501dc,_0x206e8e){return _0x16cd5c(_0x3501dc,_0x206e8e);},'krOHk':function(_0x18146e,_0x12a747){return _0x18146e!==_0x12a747;},'tusVC':'HXYUV','SzqqO':_0x5c3956(0x18c),'krmJw':'CORS\x20策略不允许来自此源的请求'};if(!_0x526ff0)return _0x43db2c['slFbf'](_0x1f75da,null,!![]);if(!allowedOrigins)return _0x1f75da(null,!![]);if(allowedOrigins['includes'](_0x526ff0))_0x1f75da(null,!![]);else{if(_0x43db2c[_0x5c3956(0x15e)](_0x43db2c[_0x5c3956(0x295)],_0x43db2c[_0x5c3956(0x2b7)]))_0x1f75da(new Error(_0x43db2c[_0x5c3956(0x32e)]));else return _0x5c9c2f['status'](0x190)[_0x5c3956(0x33d)]({'error':_0x43db2c[_0x5c3956(0x384)]});}},'methods':[_0x165f6e(0x2bc),'POST','PUT','DELETE','OPTIONS'],'credentials':!![]}));function _0x5503(){const _0x32eb0d=['CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20action_plans\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20year\x20INT,\x0a\x20\x20\x20\x20goal\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20what\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20why\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20who\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20`when`\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20how\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20how_much\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20priority\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20progress\x20INT\x20NULL,\x0a\x20\x20\x20\x20expected_result\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20actual_result\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20remarks\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','department\x20=\x20?','readFile','CThSY','TFHSd','sub_code','[DingTalk]\x20读取部门列表失败:','markdown','RyHcV','ylJZV','/api/health','active','管理部','iSGez','/api/action-plans','actual_result','Webhook地址不能为空','登录失败，请稍后重试','oivbR','VlDmB','HgWvi','OPTIONS','用户登录:\x20','/api/templates','DB_USER','budget','ThLGy','消息标题和内容不能同时为空','nrQKW','/api/templates/:id','ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','errmsg','min','QFvxW','/api/system-settings','DELETE\x20FROM\x20templates\x20WHERE\x20id=?','forEach','UayAa','QyAMr','year','departments','UHnSp','base64','LRGEc','DELETE','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20templates\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20type\x20VARCHAR(64)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20fields\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20updated_at\x20TIMESTAMP\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','cGHiV','4194072XTwQxm','KRsmH','uploads','hFIdj','integration','GHtHK','SchAd','xCIhf','emit','/api/login','keys','FwFvp','tusVC','cXCEH','[DingTalk]\x20同步员工失败:','所有日志已成功删除','remoteAddress','GKwrq','department_targets','UPDATE\x20templates\x20SET\x20','\x20WHERE\x20id=?','INSERT\x20INTO\x20','BdwKS','fbZgm','11850JpFoXI','ZoYEl','UyfnB','zxWie','未知用户','ExHhR','notifications','RRYCl','RIshn','wcHrP','Insert\x20major_event\x20failed:','系统通知','/socket.io','系统设置','priority','zATmh','Whunp','isGYD','DB_ENABLED','SELECT\x20*\x20FROM\x20major_events','INSERT\x20INTO\x20action_plans\x20(`','GgRin','SzqqO','RtqHM','type','Gcobu','qIenl','GET','TylhI','system','/api/monthly-progress','text','ObPVl','文件上传','JBbcp','map','获取钉钉部门列表失败','获取钉钉员工列表失败','DingTalk\x20config\x20check:','message','GvGtr','ncHPN','getFullYear','realname','XGigT','sort','SNUTk','\x20[sub_code=','用户名已存在','user','status\x20=\x20?','JuCbB','JazQo','dOKHX','No\x20valid\x20data\x20provided','permissions','/api/maintenance/status','/uploads','DINGTALK_APP_KEY','TbwDY','\x0a⚠️\x20\x20警告:\x20JWT_SECRET\x20未配置或使用默认值！','bFCpj','FCoRJ','remarks','\x20详情失败:','https://oapi.dingtalk.com/topapi/v2/department/get?access_token=','dingtalkAppSecret','Update\x20annual_work_plans\x20failed:','YxaOv','from','some','mkdirSync','DB_NAME','SMFrf','department_name','iwoIr','getMinutes','ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20notes\x20TEXT\x20NULL','LGmiB','method\x20=\x20\x27GET\x27','ALTER\x20TABLE\x20departments\x20ADD\x20COLUMN\x20type\x20VARCHAR(32)\x20DEFAULT\x20\x27DEPT\x27','updated_at','items','push','bwZYE','EvhWa','room','key','size','utf-8','length','parse','DMQhN','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20annual_work_plans\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20sheet_type\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20year\x20INT,\x0a\x20\x20\x20\x20month\x20INT\x20NULL,\x0a\x20\x20\x20\x20department_id\x20INT\x20NULL,\x0a\x20\x20\x20\x20department_name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20plan_name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20category\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20priority\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20start_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20end_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20budget\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20responsible_person\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','https://oapi.dingtalk.com/topapi/v2/user/list?access_token=','meDPb','target_level','goal','crypto','theme','path\x20LIKE\x20\x27/api/login%\x27','SELECT\x20d.*,\x20p.name\x20as\x20parent_name\x20FROM\x20departments\x20d\x20LEFT\x20JOIN\x20departments\x20p\x20ON\x20d.parent_id\x20=\x20p.id','dMawI','env','NilVq','未上传文件','TDjDO','\x20ORDER\x20BY\x20','UepSZ','put','Swujz','website','auto_add_user','jobnumber','AYakg','RwDhS','password','static','founded_year','UTbUf','oGrCU','find','method\x20=\x20\x27PUT\x27','qJego','diskStorage','/api/annual-work-plans','achievements','DINGTALK_APP_SECRET','RLgkA','SELECT\x20id\x20FROM\x20departments\x20WHERE\x20id\x20=\x20?','Pbzbo','name','code','powRG','匿名用户','aRZYC','aIglc','what','CgRZM','ALTER\x20TABLE\x20departments\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','/api/admin/backup','krmJw','\x20\x20\x20示例:\x20JWT_SECRET=your-very-long-random-secret-at-least-32-characters\x0a','next_month_plan','INSERT\x20INTO\x20employees\x20(name,\x20employee_id,\x20department,\x20position,\x20phone,\x20email,\x20status)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','event_type','progress','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20departments\x20(\x0a\x20\x20\x20\x20id\x20BIGINT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20code\x20VARCHAR(64)\x20UNIQUE,\x0a\x20\x20\x20\x20parent_id\x20BIGINT\x20NULL,\x0a\x20\x20\x20\x20type\x20VARCHAR(32)\x20DEFAULT\x20\x27DEPT\x27,\x0a\x20\x20\x20\x20manager\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20phone\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20email\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20DEFAULT\x20\x27active\x27,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','GUuVf','system-backup-','jjDnL','[DingTalk]\x20获取部门\x20','SELECT\x20*\x20FROM\x20department_targets','/api/dingtalk/employees','Vacah','24h','json','ozIaj','created_at\x20<=\x20?','parent_id','czxhp','task_name','[DingTalk]\x20同步部门失败:','CYSro','jHfrL','ALTER\x20TABLE\x20department_targets\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','MMRzG','cEKMH','userid','KGrTo','未配置钉钉APP\x20Key/Secret，请在环境变量或系统设置中配置','AlGii','.env','department','expected_result','how','SELECT\x20id,\x20username,\x20role,\x20method,\x20path,\x20status,\x20duration_ms,\x20ip,\x20ua,\x20query,\x20body,\x20created_at\x20FROM\x20audit_logs\x20ORDER\x20BY\x20id\x20DESC\x20LIMIT\x20?\x20OFFSET\x20?','UPDATE\x20','dWzST','Zeekx','JrJRr','monthly_progress','38310880QLialb','email','lstat','isArray','gYCeI','promises','OPluA','OwfAd','wMbWT','SYGgm','development-only-secret-change-me','test','hash','post','maintenanceMessage','/backups','CMnfX','start_date','详情\x20(ID:\x20','kSFzZ','INSERT\x20INTO\x20major_events\x20(`','leave','BXJHO','dept_name','pRUNL','ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20theme\x20VARCHAR(255)\x20NULL','DELETE\x20FROM\x20','QOhnA','tFjNb','lVvtx','UPDATE\x20action_plans\x20SET\x20','completion_rate','end_date','2088sbXrTU','UPDATE\x20company_info\x20SET\x20','MDYMQ','sheet_type','plan_name','ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20timeline\x20VARCHAR(255)\x20NULL','now','connection','/api/employees/:id','XQMtK','originalname','target-types','aeYeD','token','cmLZU','path','QilLf','planned_date','MulterError','SELECT\x20parent_id\x20FROM\x20departments\x20WHERE\x20id\x20=\x20?','CbsbF','/login','kcOIt','\x20员工失败:','hfmNP','rhvVp','kkOnW','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20department_targets\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20year\x20INT,\x0a\x20\x20\x20\x20department_id\x20INT\x20NULL,\x0a\x20\x20\x20\x20department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20target_level\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20target_type\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20target_name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20target_value\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20unit\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20quarter\x20VARCHAR(16)\x20NULL,\x0a\x20\x20\x20\x20month\x20INT\x20NULL,\x0a\x20\x20\x20\x20current_value\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20completion_rate\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20responsible_person\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','VIEW','description','secret','WuEaL','DELETE\x20FROM\x20major_events\x20WHERE\x20id=?','\x20=\x20?','FlxhH','CREATE','SELECT\x20*\x20FROM\x20annual_work_plans','\x20AND\x20','errcode','gvlSl','CsTNj','split','offset','panlt','cwd','VXAaC','dDeMT','[Login]\x20Error:','OmzOW','result','verify','ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20resources\x20TEXT\x20NULL','YHMtz','xOpdl','HbMyS','major_events','actual_value','Query:','method\x20=\x20\x27DELETE\x27','root_dept_id','YfWTJ','foxrB','who','tSaYp','HVkGC','zESpu','XjiwD','izXqE','WKcWi','limit','验证上级节点失败:\x20','error','YiSFO','children','inactive','event_name','ckSuy','SkIyU','hXCkQ','gIQKp','title','writeFile','CBMSv','文件大小超过限制（最大\x2010MB）','cors','list','cRzzw','SELECT\x20*\x20FROM\x20action_plans','JWT_SECRET','DB\x20init\x20failed:','SELECT\x20*\x20FROM\x20company_info\x20LIMIT\x201','wHHlF','DEPT','部门目标','xVZgM','ImERg','created_at','manager_id','priority\x20=\x20?','[DingTalk\x20Webhook]\x20消息发送失败:','PWoxT','add','max','iDLVX','ArQoD','lRdLI','HUDHB','UPDATE\x20annual_work_plans\x20SET\x20','.json','/api/company-info','41848pISkLG','/api/logs/:id','when','Socket\x20disconnected:','ZEgYn','startsWith','IwPbe','multer','autoBackup','IPJIt','ALTER\x20TABLE\x20audit_logs\x20ADD\x20COLUMN\x20operation\x20VARCHAR(512)\x20NULL','/api/users','oCIra','AHDZT','`=?','shift','文件不存在或无法删除','insertId','KLlaG','actual_date','response','TXJLM','Qatlx','ONnJQ','fields','log','EkOeN','MArAM','eGGCX','EojAN','OBBoj','\x20(ID:\x20','/api/system-settings/:id','use','config','XZvTF','QxHmF','LIMIT_FILE_SIZE','UiyzZ','JGGnr','tasks','\x20失败:','/api/employees','/api/admin/audit-logs','`)\x20VALUES\x20(','SELECT\x20COUNT(*)\x20as\x20total\x20FROM\x20audit_logs','employees','lessons_learned','PxDqr','/api/major-events/:id','true','filename','消息发送失败','unlink','/api/department-targets/:id','未提供授权令牌','resources','aCWLK','pvsRv','nRHTT','authorization','DINGTALK_ROOT_DEPT_ID','AzFur','current_value','null','YlFKW','create_dept_group','ljZUq','zwjmw','sUhEG','tVXhn','ejFGk','YRvPj','xkWKC','join','localhost','[DingTalk]\x20开始同步部门，根部门ID:','不支持的文件类型','xsfgc','krOHk','plyrb','LYGAo','/api/action-plans/:id','LLpGy','/uploads/','\x20WHERE\x20','vqsbu','params','phone','536LEGmyA','Migration\x20warning:','dawOx','GAqpR','timeline','xqPPn','smlHt','COMPANY','目标类型','AdspH','iRSZH','category',')\x20VALUES\x20(','employee_id','缺少必填项:\x20','mRMNU','TzaPD','SELECT\x20value\x20FROM\x20system_settings\x20WHERE\x20`key`=?\x20ORDER\x20BY\x20id\x20DESC\x20LIMIT\x201','cSwxR','`\x20=\x20?','ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20lessons_learned\x20TEXT\x20NULL','XAtuo','DB_PORT','appSecret','bBpbF','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20employees\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20employee_id\x20VARCHAR(64)\x20UNIQUE,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20position\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20phone\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20email\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20DEFAULT\x20\x27active\x27,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','annual_work_plans','Nbkcc','131NeiyjE','\x20DESC','[Auth]\x20Blocked\x20request\x20to\x20','notes','body','bDLRD','gDWTN','FCQzz','lcpih','cGQru','dziSG','部门编码已存在','month\x20=\x20?','toString','stringify','file','tCola','SELECT\x20value\x20FROM\x20system_settings\x20WHERE\x20`key`=?\x20LIMIT\x201','mBdvJ','/api/major-events','filter','pJlxx','zpcIP','IbalM','manager','replace','set','qhOFV','axios','LOGIN','get','不能将自己设置为上级节点','9124890gWEYdY','method','MqKgg','position','leave-room','mePXB','status','ijSyE','ATwEd','FsKRl','/api/departments','maintenanceSince','XrOzd','mmGVI','bZarW','姓名和工号为必填项','getHours','WFfYd','RBGUO','Updating\x20major_event','employee_count','department_id','/api/admin/backup/status','temp_store','query','ALTER\x20TABLE\x20templates\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','fQoeb','部门名称为必填项','missing','has','17185lkgOJl','failed','user-online','ttxiu','/api/monthly-progress/:id','mobile','指定的上级节点不存在','dept_id','MCGzq','`,`','org_email','【连接测试】企业年度规划系统连接测试成功！','TLIZM','enxKO','toISOString','jDjYG','sfiCP','target_name','ruAgr','errno','trim','backupInterval','gqWlP','/api/annual-work-plans/:id','MGtOU','values','target_value','ER_DUP_ENTRY','[DingTalk]\x20保存员工\x20','plans','TKkuW','WActA','UPDATE\x20major_events\x20SET\x20','vSEAv','jjWbL','getDate','RsEvH','\x20-\x20No\x20token','UPDATE\x20department_targets\x20SET\x20','LKRXm','meNWc','method\x20=\x20\x27POST\x27\x20AND\x20path\x20NOT\x20LIKE\x20\x27/api/login%\x27','WSFdg','dept_id_list','findIndex','username','loaded','users','\x20名员工','CVNlB','/api/department-targets','slice','weZZB','/backups/','target_type','ffXlF','\x20ORDER\x20BY\x20created_at\x20DESC','value','headers','PeSgD','工号已存在','UgEdG','data','ITHIg','lOsSj','USWvE','KLoAS','[DingTalk]\x20从钉钉获取到\x20','qcxeP','ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20actual_date\x20VARCHAR(32)\x20NULL','QRLBt','YxRTw','match','连接测试失败','sign','12061hNiPTA','ER_DUP_FIELDNAME','Ydcht','\x20个部门','planning_system','audit_logs','responsible_person','50mb','RnmqS','quarter','user-agent','nUOgV','数据查看','role','zQvFI','inAKi','vpWfy','非法文件名','dkcOW','FgzmL','[DingTalk]\x20开始同步员工','/api/users/:id','ObGrN','MwNzz','fXQWC','MTKGz','mtime','system_settings','unknown','HLjIm','operation','OXyER','dept_code','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20roles\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20code\x20VARCHAR(64)\x20UNIQUE,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20permissions\x20JSON\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','oVEFZ','action_plans','delete','includes','PSRog','ONanj','has_more','key_points','oopRk','thRzR','month','bTmLS','[DingTalk]\x20获取员工列表失败:','/api/','TeMOu','行动计划','TLBgl','YjzMB','ZKXZT','gYCwx','bTLLV','rNxoR','industry','tinQr','EBiUd','readdir','QSAbp','NywrD','UPDATE','YXGXk','INSERT\x20INTO\x20annual_work_plans\x20(`','WuNEv','join-room','admin','/:id','roles','actual_cost','pcQBx','获取钉钉access_token失败','pHTMY','compare','listen','pSmLI'];_0x5503=function(){return _0x32eb0d;};return _0x5503();}const uploadsDir=path[_0x165f6e(0x159)](process['cwd'](),_0x165f6e(0x28b));try{fsSync['mkdirSync'](uploadsDir,{'recursive':!![]});}catch(_0x1818f0){}const tempStoreDir=path[_0x165f6e(0x159)](process['cwd'](),_0x165f6e(0x1bb));try{fsSync['mkdirSync'](tempStoreDir,{'recursive':!![]});}catch(_0x46b38c){}const backupsDir=path['join'](process[_0x165f6e(0x3a4)](),'backups');try{fsSync[_0x165f6e(0x2e8)](backupsDir,{'recursive':!![]});}catch(_0x192877){}const tableFile=_0x37830c=>path['join'](tempStoreDir,_0x37830c+'.json');async function readTable(_0x6a4d04){const _0x3df499=_0x165f6e,_0x35c7b9={'deGzO':function(_0x1c414c,_0x2e6131){return _0x1c414c||_0x2e6131;}};try{const _0x4543f2=await fs[_0x3df499(0x25c)](tableFile(_0x6a4d04),_0x3df499(0x2fa));return JSON['parse'](_0x35c7b9['deGzO'](_0x4543f2,'[]'))||[];}catch(_0x540e7d){return[];}}async function writeTable(_0x3f97b,_0x1027ec){const _0x3ef2b2=_0x165f6e;await fs[_0x3ef2b2(0x3c9)](tableFile(_0x3f97b),JSON['stringify'](_0x1027ec,null,0x2),_0x3ef2b2(0x2fa));}async function addRow(_0x2187bb,_0x59b760){const _0x5de75a=_0x165f6e,_0x191a9f={'SchAd':function(_0x4a776d,_0x585d9a){return _0x4a776d(_0x585d9a);},'KDrDd':function(_0x17747e,_0x559078){return _0x17747e(_0x559078);},'WuEaL':function(_0x35779d,_0x592b25,_0x36a243){return _0x35779d(_0x592b25,_0x36a243);}},_0x105e1d=await _0x191a9f[_0x5de75a(0x28f)](readTable,_0x2187bb),_0x45a6fa=_0x105e1d[_0x5de75a(0x2fb)]?_0x191a9f['KDrDd'](Number,_0x105e1d[_0x105e1d[_0x5de75a(0x2fb)]-0x1]['id']||0x0)+0x1:0x1,_0x5b0dfd={'id':_0x45a6fa,'created_at':new Date()['toISOString'](),..._0x59b760};return _0x105e1d[_0x5de75a(0x2f4)](_0x5b0dfd),await _0x191a9f[_0x5de75a(0x397)](writeTable,_0x2187bb,_0x105e1d),_0x5b0dfd;}async function updateRow(_0x300feb,_0xac5439,_0x48cf21){const _0x42b5b9=_0x165f6e,_0x3eae98={'erUPf':function(_0x5bcb19,_0x5383df){return _0x5bcb19>=_0x5383df;},'rGnQb':function(_0x1373fc,_0x4eda8b){return _0x1373fc!==_0x4eda8b;},'AdspH':'hxeaK'},_0x1ef866=await readTable(_0x300feb),_0x28bc46=_0x1ef866[_0x42b5b9(0x1ee)](_0x1464b3=>String(_0x1464b3['id'])===String(_0xac5439));_0x3eae98['erUPf'](_0x28bc46,0x0)&&(_0x3eae98['rGnQb']('hxeaK',_0x3eae98[_0x42b5b9(0x171)])?_0x5eb23f[_0x42b5b9(0x1aa)](0x1f4)['json']({'error':_0x19da6d[_0x42b5b9(0x2c8)]}):(_0x1ef866[_0x28bc46]={..._0x1ef866[_0x28bc46],..._0x48cf21},await writeTable(_0x300feb,_0x1ef866)));}async function deleteRow(_0x468229,_0x4e298f){const _0x48bf37=_0x165f6e,_0x8fdd8d={'wElfr':function(_0x22acf0,_0x19d3fe){return _0x22acf0(_0x19d3fe);}},_0x54d668=await _0x8fdd8d['wElfr'](readTable,_0x468229),_0x4bdaa8=_0x54d668[_0x48bf37(0x198)](_0x68db06=>String(_0x68db06['id'])!==String(_0x4e298f));await writeTable(_0x468229,_0x4bdaa8);}const diskStorage=multer[_0x165f6e(0x31d)]({'destination':(_0x512b4d,_0x3acffe,_0x461e12)=>{const _0x2ce541=_0x165f6e,_0x1f3e50={'FCQzz':function(_0x3202da,_0x3eb75c,_0x3e0df8){return _0x3202da(_0x3eb75c,_0x3e0df8);}};_0x1f3e50[_0x2ce541(0x18b)](_0x461e12,null,uploadsDir);},'filename':(_0x8f7ae6,_0x3b4aab,_0x27f479)=>{const _0x479d32=_0x165f6e,_0x179932={'OEEFa':function(_0x24cd23,_0xecde52,_0x5a3e35){return _0x24cd23(_0xecde52,_0x5a3e35);}},_0x4686f6=_0x3b4aab[_0x479d32(0x382)]['replace'](/[^a-zA-Z0-9._-]/g,'_');_0x179932['OEEFa'](_0x27f479,null,Date['now']()+'-'+_0x4686f6);}}),allowedFileTypes=/\.(jpg|jpeg|png|gif|bmp|webp|pdf|doc|docx|xls|xlsx|ppt|pptx|txt|csv|zip|rar)$/i,upload=multer({'storage':diskStorage,'limits':{'fileSize':0xa*0x400*0x400},'fileFilter':(_0x28a629,_0xd63a22,_0x41fd3e)=>{const _0x4362ae=_0x165f6e,_0x192fa0={'NNpqi':function(_0xc552e,_0x477b28){return _0xc552e(_0x477b28);},'WZPtG':'不支持的文件类型，允许的类型：图片、PDF、Office文档、压缩包'};allowedFileTypes['test'](_0xd63a22[_0x4362ae(0x382)])?_0x41fd3e(null,!![]):_0x192fa0['NNpqi'](_0x41fd3e,new Error(_0x192fa0['WZPtG']));}});app['use'](_0x165f6e(0x2da),express[_0x165f6e(0x316)](uploadsDir)),app['use'](_0x165f6e(0x366),express[_0x165f6e(0x316)](backupsDir)),app['post']('/api/upload',upload['single']('file'),(_0x3dc0e0,_0x4092a6)=>{const _0x51fe68=_0x165f6e;try{if(!_0x3dc0e0[_0x51fe68(0x193)])return _0x4092a6['status'](0x190)['json']({'error':_0x51fe68(0x30a)});const _0x2ab815=_0x51fe68(0x163)+_0x3dc0e0['file']['filename'];_0x4092a6[_0x51fe68(0x33d)]({'success':!![],'url':_0x2ab815,'filename':_0x3dc0e0[_0x51fe68(0x193)][_0x51fe68(0x142)],'originalname':_0x3dc0e0[_0x51fe68(0x193)][_0x51fe68(0x382)],'size':_0x3dc0e0['file'][_0x51fe68(0x2f9)]});}catch(_0x32ac0c){_0x4092a6['status'](0x1f4)['json']({'error':_0x32ac0c[_0x51fe68(0x2c8)]});}}),app[_0x165f6e(0x130)]((_0x31362a,_0x12559a,_0x486c9d,_0x1e8f45)=>{const _0x51fd19=_0x165f6e,_0x306267={'SvdEu':function(_0x79ab12,_0x5d0a24){return _0x79ab12===_0x5d0a24;}};if(_0x31362a instanceof multer[_0x51fd19(0x38a)]){if(_0x306267['SvdEu'](_0x31362a[_0x51fd19(0x325)],_0x51fd19(0x134)))return _0x486c9d[_0x51fd19(0x1aa)](0x190)[_0x51fd19(0x33d)]({'error':_0x51fd19(0x3cb)});return _0x486c9d[_0x51fd19(0x1aa)](0x190)['json']({'error':'文件上传错误:\x20'+_0x31362a['message']});}if(_0x31362a&&_0x31362a['message']&&_0x31362a['message']['includes'](_0x51fd19(0x15c)))return _0x486c9d[_0x51fd19(0x1aa)](0x190)['json']({'error':_0x31362a['message']});_0x1e8f45(_0x31362a);});let autoBackupTimer=null,nextBackupAt=null;async function performBackup(){const _0x397741=_0x165f6e,_0x8081f7={'RLgkA':function(_0x4b27d5,_0x34f82e){return _0x4b27d5===_0x34f82e;},'jHfrL':function(_0x1f1c5a,_0x2a0e36){return _0x1f1c5a(_0x2a0e36);},'tDyCZ':function(_0x14e679,_0x43c1b3){return _0x14e679+_0x43c1b3;},'uqrhf':function(_0x4f3ec3,_0x55d45c){return _0x4f3ec3(_0x55d45c);},'ItRwS':_0x397741(0x230),'lgnkW':'ngqGg','JGGnr':'zmGdz','QOkzs':_0x397741(0x2fa)},_0x10653f=_0x1d10fa=>String(_0x1d10fa)['padStart'](0x2,'0'),_0x4311c6=new Date(),_0xf586c6=''+_0x4311c6[_0x397741(0x2cb)]()+_0x8081f7[_0x397741(0x345)](_0x10653f,_0x8081f7['tDyCZ'](_0x4311c6['getMonth'](),0x1))+_0x10653f(_0x4311c6[_0x397741(0x1e5)]())+'-'+_0x10653f(_0x4311c6[_0x397741(0x1b4)]())+_0x10653f(_0x4311c6[_0x397741(0x2ed)]())+_0x8081f7['uqrhf'](_0x10653f,_0x4311c6['getSeconds']()),_0x5c8c74=_0x397741(0x336)+_0xf586c6+_0x397741(0x3e4),_0x3a1ed3=path['join'](backupsDir,_0x5c8c74),_0x4351a5=[_0x397741(0x282),'employees','monthly_progress','department_targets',_0x8081f7['ItRwS'],_0x397741(0x228),'notifications','target_types'],_0x116a2a={'timestamp':_0x4311c6['toISOString'](),'data':{}};if(dbPool)for(const _0x59c8b8 of _0x4351a5){try{const [_0x413fd9]=await dbPool[_0x397741(0x1bc)]('SELECT\x20*\x20FROM\x20'+_0x59c8b8);_0x116a2a['data'][_0x59c8b8]=_0x413fd9;}catch(_0x4a23ff){_0x116a2a[_0x397741(0x200)][_0x59c8b8]=[];}}else for(const _0xbad9a7 of _0x4351a5){if(_0x8081f7['lgnkW']===_0x397741(0x246))return _0x4eac7c['status'](0x1f4)['json']({'error':_0x1bd69d['message']});else try{'DPUae'===_0x8081f7[_0x397741(0x136)]?_0x3fb4cf=_0x11d84f['filter'](_0x4ff8fc=>{const _0x4b8304=_0x397741,_0x7b5c70=_0x5bfb93(_0x4ff8fc[_0x4b8304(0x1a5)],_0x4ff8fc[_0x4b8304(0x387)]);return _0x8081f7[_0x4b8304(0x321)](_0x7b5c70,_0x209917);}):_0x116a2a['data'][_0xbad9a7]=await _0x8081f7['jHfrL'](readTable,_0xbad9a7);}catch(_0x26cc28){_0x116a2a[_0x397741(0x200)][_0xbad9a7]=[];}}return await fs[_0x397741(0x3c9)](_0x3a1ed3,JSON['stringify'](_0x116a2a,null,0x2),_0x8081f7['QOkzs']),{'path':_0x397741(0x1f7)+encodeURIComponent(_0x5c8c74),'name':_0x5c8c74};}async function getSystemAutoBackupSettings(){const _0x1dd044=_0x165f6e,_0x2a7778={'SMFrf':'SELECT\x20value\x20FROM\x20system_settings\x20WHERE\x20`key`=?\x20ORDER\x20BY\x20id\x20DESC\x20LIMIT\x201','UTbUf':_0x1dd044(0x2be)};let _0x4a485c=null;if(dbPool)try{const [_0x4fcb7a]=await dbPool['query'](_0x2a7778[_0x1dd044(0x2ea)],[_0x2a7778[_0x1dd044(0x318)]]),_0x3111cb=_0x4fcb7a&&_0x4fcb7a[0x0]?_0x4fcb7a[0x0]['value']:null;try{_0x4a485c=_0x3111cb?JSON['parse'](_0x3111cb):null;}catch(_0xd1973e){_0x4a485c=null;}}catch(_0x2ae555){_0x4a485c=null;}else try{const _0x24891d=await readTable(_0x1dd044(0x228)),_0x149cb9=_0x24891d['filter'](_0x41f523=>String(_0x41f523['key'])===_0x1dd044(0x2be)),_0x5d021a=_0x149cb9[_0x1dd044(0x2fb)]?_0x149cb9[_0x149cb9[_0x1dd044(0x2fb)]-0x1]:null,_0x5a2b53=_0x5d021a?_0x5d021a['value']:null;if(_0x5a2b53&&typeof _0x5a2b53==='string')try{_0x4a485c=JSON[_0x1dd044(0x2fc)](_0x5a2b53);}catch(_0x4bc3d3){_0x4a485c=null;}else _0x4a485c=_0x5a2b53||null;}catch(_0x266233){_0x4a485c=null;}return _0x4a485c||null;}async function getSecuritySettings(){const _0x5ec36b=_0x165f6e,_0x4290ec={'JrJRr':'Missing\x20key','mePXB':function(_0x45e3e0,_0x3d2d66){return _0x45e3e0||_0x3d2d66;},'wDeVi':_0x5ec36b(0x27b),'bBpbF':_0x5ec36b(0x179),'koKKF':function(_0x2fba3b,_0x8b2558){return _0x2fba3b!==_0x8b2558;},'LGmiB':_0x5ec36b(0x12c),'faMqE':_0x5ec36b(0x228),'OQizH':function(_0x545ece,_0x5ecec5){return _0x545ece-_0x5ecec5;}};let _0x4716e8=null;if(dbPool){if(_0x4290ec['wDeVi']!=='OsoYL')try{const [_0x5019bd]=await dbPool[_0x5ec36b(0x1bc)](_0x4290ec[_0x5ec36b(0x180)],['security']),_0x4cd473=_0x5019bd&&_0x5019bd[0x0]?_0x5019bd[0x0]['value']:null;try{_0x4716e8=_0x4cd473?JSON[_0x5ec36b(0x2fc)](_0x4cd473):null;}catch(_0x59360a){if(_0x4290ec['koKKF']('vddpD','vddpD'))return _0x40c997[_0x5ec36b(0x1aa)](0x190)[_0x5ec36b(0x33d)]({'error':_0x4290ec[_0x5ec36b(0x355)]});else _0x4716e8=null;}}catch(_0x1db2bd){_0x4716e8=null;}else _0x14eff0=_0x4290ec['mePXB'](_0x256a33,null);}else try{if('EojAN'===_0x4290ec[_0x5ec36b(0x2ef)]){const _0x84bffc=await readTable(_0x4290ec['faMqE']),_0x5e88f5=_0x84bffc[_0x5ec36b(0x198)](_0x3b8138=>String(_0x3b8138['key'])==='security'),_0x1866a6=_0x5e88f5[_0x5ec36b(0x2fb)]?_0x5e88f5[_0x4290ec['OQizH'](_0x5e88f5['length'],0x1)]:null,_0x352fba=_0x1866a6?_0x1866a6[_0x5ec36b(0x1fb)]:null;if(_0x352fba&&typeof _0x352fba==='string')try{_0x4716e8=JSON[_0x5ec36b(0x2fc)](_0x352fba);}catch(_0x3380c1){_0x4716e8=null;}else{if('OJNjq'!=='Suvte')_0x4716e8=_0x4290ec[_0x5ec36b(0x1a9)](_0x352fba,null);else return _0x5bec27[_0x5ec36b(0x1aa)](0x1f4)['json']({'error':_0x34f7b5[_0x5ec36b(0x2c8)]});}}else return _0x351d1d[_0x5ec36b(0x1aa)](0x190)[_0x5ec36b(0x33d)]({'error':'部门编码已存在'});}catch(_0x4f3d29){_0x4716e8=null;}return _0x4290ec[_0x5ec36b(0x1a9)](_0x4716e8,null);}async function isAuditEnabled(){const _0x1f24bd=await getSecuritySettings();return Boolean(_0x1f24bd&&_0x1f24bd['auditLog']===!![]);}function clearAutoBackupTimer(){autoBackupTimer&&(clearInterval(autoBackupTimer),autoBackupTimer=null);}async function applyAutoBackupSchedule(){const _0x41608f=_0x165f6e,_0x4bb626={'xaRIy':function(_0x1cba80){return _0x1cba80();},'sUnld':function(_0x3f6228){return _0x3f6228();},'kqiFW':function(_0x6fca1a,_0x1b7610){return _0x6fca1a(_0x1b7610);},'nrQKW':function(_0x1cddae,_0x4b1ba8){return _0x1cddae===_0x4b1ba8;},'odLcp':function(_0x392598,_0x502ff7){return _0x392598!=_0x502ff7;},'QvRar':function(_0x945ccc,_0x4bdc80){return _0x945ccc*_0x4bdc80;}};_0x4bb626['xaRIy'](clearAutoBackupTimer),nextBackupAt=null;const _0x5308cd=await _0x4bb626['sUnld'](getSystemAutoBackupSettings),_0x52d8ac=_0x4bb626['kqiFW'](Boolean,_0x5308cd&&_0x4bb626[_0x41608f(0x276)](_0x5308cd[_0x41608f(0x117)],!![])),_0x24698b=Number(_0x5308cd&&_0x4bb626['odLcp'](_0x5308cd['backupInterval'],null)?_0x5308cd[_0x41608f(0x1d7)]:0x18);if(!_0x52d8ac||!_0x24698b||_0x24698b<=0x0)return;const _0x4e492e=Math['max'](0xea60,Math['floor'](_0x4bb626['QvRar'](_0x24698b,0x36ee80)));autoBackupTimer=setInterval(async()=>{try{await performBackup();}catch(_0x1dfc15){}nextBackupAt=new Date(Date['now']()+_0x4e492e);},_0x4e492e),nextBackupAt=new Date(Date[_0x41608f(0x37e)]()+_0x4e492e);try{await performBackup();}catch(_0x2601ac){}}if(ENABLE_AUTH){const openPaths=new Set(['/api/login','/api/health','/api/integration/status','/api/maintenance/status']);app[_0x165f6e(0x130)]((_0x11e72d,_0x25da2e,_0x21aec8)=>{const _0x2e51b5=_0x165f6e,_0x23ce24={'PSRog':'/api/login','tvlmG':_0x2e51b5(0x2da),'aBkUK':'GET','CMnfX':function(_0x188121,_0x332fb0){return _0x188121===_0x332fb0;},'uuBlX':_0x2e51b5(0x271),'VlDmB':function(_0x307ff8){return _0x307ff8();},'ruAgr':'未提供授权令牌','ATwEd':function(_0x3fcf32){return _0x3fcf32();},'veyzP':'令牌无效或已过期'},_0x5483da=_0x11e72d['path'][_0x2e51b5(0x19d)](/\/+$/,'');if(openPaths[_0x2e51b5(0x1c1)](_0x5483da)||_0x5483da===_0x23ce24[_0x2e51b5(0x233)]||_0x5483da[_0x2e51b5(0x114)](_0x23ce24['PSRog'])||_0x11e72d['path'][_0x2e51b5(0x114)](_0x23ce24['tvlmG'])||_0x11e72d[_0x2e51b5(0x387)][_0x2e51b5(0x114)](_0x2e51b5(0x366))||_0x11e72d[_0x2e51b5(0x1a5)]===_0x23ce24['aBkUK']&&_0x23ce24[_0x2e51b5(0x367)](_0x5483da,_0x23ce24['uuBlX']))return _0x23ce24[_0x2e51b5(0x26d)](_0x21aec8);const _0x3f9380=_0x11e72d['headers']['authorization']||'',_0x5102fb=_0x3f9380[_0x2e51b5(0x20a)](/^Bearer\s+(.+)$/);if(!_0x5102fb)return console[_0x2e51b5(0x128)]('[Auth]\x20Blocked\x20request\x20to\x20'+_0x11e72d[_0x2e51b5(0x387)]+_0x2e51b5(0x1e7)),_0x25da2e['status'](0x191)[_0x2e51b5(0x33d)]({'error':_0x23ce24[_0x2e51b5(0x1d4)]});try{const _0x206ac7=jwt[_0x2e51b5(0x3aa)](_0x5102fb[0x1],JWT_SECRET);return _0x11e72d[_0x2e51b5(0x2d2)]=_0x206ac7,_0x23ce24[_0x2e51b5(0x1ac)](_0x21aec8);}catch(_0x190321){return console['log']('[Auth]\x20Blocked\x20request\x20to\x20'+_0x11e72d['path']+'\x20-\x20Invalid\x20token:\x20'+_0x190321[_0x2e51b5(0x2c8)]),_0x25da2e[_0x2e51b5(0x1aa)](0x191)['json']({'error':_0x23ce24['veyzP']});}});}function getOperationDescription(_0x158ae4,_0x279165,_0x474cb3){const _0x2c6e92=_0x165f6e,_0x279938={'JBJbR':_0x2c6e92(0x3d5),'kSFzZ':_0x2c6e92(0x23e),'YfZRe':_0x2c6e92(0x170),'ckSuy':'公司信息','foxrB':'组织架构','zxWie':'钉钉同步','ttxiu':_0x2c6e92(0x2c2),'lRdLI':'/sync-dingtalk','PTfyk':_0x2c6e92(0x282),'gHPgV':'执行系统备份','YxaOv':_0x2c6e92(0x38d)},_0x4f1062=_0x279165[_0x2c6e92(0x3a1)]('/')['filter'](Boolean),_0x7c9bf3=_0x4f1062[0x1]||'',_0x5265af=_0x4f1062[0x2]||null,_0x412080={'login':'系统登录','users':'用户','departments':'部门','employees':'员工','monthly-progress':'月度进展','department-targets':_0x279938['JBJbR'],'action-plans':_0x279938[_0x2c6e92(0x36a)],'annual-work-plans':'年度工作计划','major-events':'重大事项','notifications':'通知','templates':'模板','target-types':_0x279938['YfZRe'],'company-info':_0x279938[_0x2c6e92(0x3c4)],'system-settings':_0x2c6e92(0x2ae),'roles':'角色','admin':'系统管理','organization':_0x279938[_0x2c6e92(0x3b5)],'dingtalk':_0x279938[_0x2c6e92(0x2a4)],'upload':_0x279938[_0x2c6e92(0x1c5)],'logs':'系统日志'},_0x3bd5cb=_0x412080[_0x7c9bf3]||_0x7c9bf3;if(_0x279165['includes'](_0x279938[_0x2c6e92(0x3e1)]))return'同步钉钉'+(_0x279165['includes'](_0x279938['PTfyk'])?'部门':'员工')+'数据';if(_0x279165[_0x2c6e92(0x232)]('/backup'))return _0x279938['gHPgV'];if(_0x279165['includes'](_0x279938[_0x2c6e92(0x2e5)])){const _0x3d19ef=_0x474cb3?.[_0x2c6e92(0x1ef)]||_0x2c6e92(0x2a5);return _0x2c6e92(0x270)+_0x3d19ef;}switch(_0x158ae4){case _0x2c6e92(0x2bc):if(_0x5265af)return'查看'+_0x3bd5cb+_0x2c6e92(0x369)+_0x5265af+')';return'查询'+_0x3bd5cb+'列表';case'POST':const _0x35ed69=_0x474cb3?.['name']||_0x474cb3?.['title']||_0x474cb3?.['task_name']||_0x474cb3?.['event_name']||_0x474cb3?.['username']||'';return'新增'+_0x3bd5cb+(_0x35ed69?':\x20'+_0x35ed69:'');case'PUT':return'修改'+_0x3bd5cb+_0x2c6e92(0x12e)+_0x5265af+')';case _0x2c6e92(0x286):return'删除'+_0x3bd5cb+'\x20(ID:\x20'+_0x5265af+')';default:return _0x158ae4+'\x20'+_0x279165;}}app['use'](async(_0x4b2dff,_0x348dfb,_0xee015d)=>{const _0x39dfda=_0x165f6e,_0x24d812={'bTLLV':function(_0x3f4c15,_0x1901bd){return _0x3f4c15!==_0x1901bd;},'bFCpj':'[已脱敏]','LRGEc':_0x39dfda(0x26f),'ArQoD':_0x39dfda(0x163),'MMRzG':'/backups/','Lryos':function(_0xcc446,_0x5569d8){return _0xcc446||_0x5569d8;},'oopRk':'未知角色','ncHPN':_0x39dfda(0x315),'gDWTN':_0x39dfda(0x396),'WmmxG':'dingtalkAppSecret','RuSqj':'emailPassword','rAfhd':function(_0x4f7dad,_0x52879c,_0x41f422,_0x3deea9){return _0x4f7dad(_0x52879c,_0x41f422,_0x3deea9);},'OBBoj':'INSERT\x20INTO\x20audit_logs\x20(username,\x20role,\x20method,\x20path,\x20status,\x20duration_ms,\x20ip,\x20ua,\x20query,\x20body,\x20operation)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','PmsNR':function(_0x56c9c1,_0x2640f6,_0x1070e9){return _0x56c9c1(_0x2640f6,_0x1070e9);},'Ffglv':'finish'},_0x2f4588=Date['now']();_0x348dfb['on'](_0x24d812['Ffglv'],async()=>{const _0x4df100=_0x39dfda;try{const _0x1ca17c=_0x4b2dff[_0x4df100(0x387)]||'';if(_0x1ca17c[_0x4df100(0x114)]('/api/health'))return;if(_0x1ca17c[_0x4df100(0x114)](_0x4df100(0x2ad)))return;if(_0x4b2dff[_0x4df100(0x1a5)]===_0x24d812[_0x4df100(0x285)])return;if(_0x1ca17c[_0x4df100(0x114)](_0x24d812[_0x4df100(0x3e0)])||_0x1ca17c['startsWith'](_0x24d812[_0x4df100(0x347)]))return;let _0x347d9d=_0x4b2dff[_0x4df100(0x2d2)]?.['username']||null,_0x4e8510=_0x4b2dff[_0x4df100(0x2d2)]?.[_0x4df100(0x21a)]||null;if(!_0x347d9d){const _0x424e34=_0x4b2dff['headers']['authorization']||'',_0x509830=_0x424e34['match'](/^Bearer\s+(.+)$/);if(_0x509830)try{const _0x264270=jwt[_0x4df100(0x3aa)](_0x509830[0x1],JWT_SECRET);_0x347d9d=_0x264270?.[_0x4df100(0x1ef)]||_0x347d9d,_0x4e8510=_0x264270?.['role']||_0x4e8510;}catch(_0x384c44){}}_0x347d9d=_0x347d9d||_0x4df100(0x327),_0x4e8510=_0x24d812['Lryos'](_0x4e8510,_0x24d812[_0x4df100(0x237)]);const _0x4bea29=(_0x4b2dff[_0x4df100(0x1fc)]['x-forwarded-for']||_0x4b2dff['socket']?.[_0x4df100(0x299)]||'')[_0x4df100(0x191)](),_0x65aa62=(_0x4b2dff['headers'][_0x4df100(0x217)]||'')['toString'](),_0x178022=_0x348dfb['statusCode']||null,_0x3cd656=Date['now']()-_0x2f4588,_0x2e5363=_0x4b2dff[_0x4df100(0x188)]||null;let _0xeb2425=null;if(_0x2e5363){const _0x30d7dd={..._0x2e5363};[_0x24d812[_0x4df100(0x2ca)],_0x24d812[_0x4df100(0x18a)],_0x4df100(0x385),_0x4df100(0x17f),_0x24d812['WmmxG'],_0x24d812['RuSqj']][_0x4df100(0x27e)](_0x2ca956=>{const _0x3e2145=_0x4df100;if(_0x30d7dd&&_0x24d812[_0x3e2145(0x243)](_0x30d7dd[_0x2ca956],undefined))_0x30d7dd[_0x2ca956]=_0x24d812[_0x3e2145(0x2de)];});try{_0xeb2425=JSON[_0x4df100(0x192)](_0x30d7dd);}catch(_0x459381){_0xeb2425=null;}}let _0x1f9b85=null;try{_0x1f9b85=JSON['stringify'](_0x4b2dff['query']||null);}catch(_0x3d86f1){_0x1f9b85=null;}const _0x2af26f=_0x24d812['rAfhd'](getOperationDescription,_0x4b2dff['method'],_0x1ca17c,_0x2e5363);if(dbPool)try{await dbPool[_0x4df100(0x1bc)](_0x24d812[_0x4df100(0x12d)],[_0x347d9d,_0x4e8510,_0x4b2dff['method'],_0x1ca17c,_0x178022,_0x3cd656,_0x4bea29,_0x65aa62,_0x1f9b85,_0xeb2425,_0x2af26f]);}catch(_0x3c3428){}else{if('OIAvF'===_0x4df100(0x381))return _0x2d0d56['status'](0x1f4)[_0x4df100(0x33d)]({'error':_0x24db29[_0x4df100(0x2c8)]});else{const _0x55d14e={'username':_0x347d9d,'role':_0x4e8510,'method':_0x4b2dff[_0x4df100(0x1a5)],'path':_0x1ca17c,'status':_0x178022,'duration_ms':_0x3cd656,'ip':_0x4bea29,'ua':_0x65aa62,'query':_0x1f9b85,'body':_0xeb2425,'operation':_0x2af26f};try{await _0x24d812['PmsNR'](addRow,_0x4df100(0x212),_0x55d14e);}catch(_0x4a8a9c){}}}}catch(_0x5a62b0){}}),_0xee015d();}),app[_0x165f6e(0x1a2)](_0x165f6e(0x264),(_0x45d686,_0x1a5d66)=>{_0x1a5d66['json']({'status':'ok','timestamp':Date['now']()});}),app['post'](_0x165f6e(0x292),async(_0x1cbead,_0x1aa0c8)=>{const _0x1fded7=_0x165f6e,_0x200b86={'lZeef':'[Login]\x20Attempt:','FCoRJ':'请输入用户名和密码','DiPSz':function(_0x5b885b,_0x41e664){return _0x5b885b===_0x41e664;},'OmzOW':'123456','OPluA':'admin','MebDy':'SELECT\x20*\x20FROM\x20users\x20WHERE\x20username\x20=\x20?\x20AND\x20status\x20=\x20?\x20LIMIT\x201','kibPw':'users','HLjIm':'用户名或密码错误','lSyhd':function(_0x16558c,_0x38bc96){return _0x16558c(_0x38bc96);},'NpYlx':'bcryptjs','QfYFV':'string','DgSqq':_0x1fded7(0x3a7)};console[_0x1fded7(0x128)](_0x200b86['lZeef'],_0x1cbead[_0x1fded7(0x188)]?.[_0x1fded7(0x1ef)]);const {username:_0x328a32,password:_0x1efada}=_0x1cbead[_0x1fded7(0x188)]||{};if(!_0x328a32||!_0x1efada)return _0x1aa0c8[_0x1fded7(0x1aa)](0x190)['json']({'error':_0x200b86[_0x1fded7(0x2df)]});if(_0x328a32==='admin'&&_0x200b86['DiPSz'](_0x1efada,_0x200b86[_0x1fded7(0x3a8)])){console['log']('[Login]\x20Success\x20for\x20default\x20admin');const _0x5177b8=jwt[_0x1fded7(0x20c)]({'username':_0x328a32,'role':_0x1fded7(0x250)},JWT_SECRET,{'expiresIn':_0x1fded7(0x33c)});return _0x1aa0c8[_0x1fded7(0x33d)]({'token':_0x5177b8,'user':{'id':-0x1,'username':_0x328a32,'name':'管理员','role':_0x1fded7(0x250),'department':_0x1fded7(0x266),'permissions':[_0x200b86[_0x1fded7(0x35d)]]}});}try{let _0x10d106=null;if(dbPool){const [_0x2d3dbf]=await dbPool['query'](_0x200b86['MebDy'],[_0x328a32,'active']);_0x10d106=_0x2d3dbf[0x0]||null;}else{const _0x4ef5a1=await readTable(_0x200b86['kibPw']);_0x10d106=_0x4ef5a1[_0x1fded7(0x31a)](_0x4b8ee1=>_0x4b8ee1['username']===_0x328a32&&_0x4b8ee1['status']==='active')||null;}if(!_0x10d106)return console['log']('[Login]\x20User\x20not\x20found:',_0x328a32),_0x1aa0c8[_0x1fded7(0x1aa)](0x191)[_0x1fded7(0x33d)]({'error':_0x200b86[_0x1fded7(0x22a)]});const _0x2be9c3=_0x200b86['lSyhd'](require,_0x200b86['NpYlx']),_0x615001=await _0x2be9c3[_0x1fded7(0x257)](_0x1efada,_0x10d106[_0x1fded7(0x315)]);if(!_0x615001)return console[_0x1fded7(0x128)]('[Login]\x20Invalid\x20password\x20for:',_0x328a32),_0x1aa0c8[_0x1fded7(0x1aa)](0x191)[_0x1fded7(0x33d)]({'error':_0x200b86['HLjIm']});console[_0x1fded7(0x128)]('[Login]\x20Success\x20for:',_0x328a32);const _0x190509=typeof _0x10d106[_0x1fded7(0x2d8)]===_0x200b86['QfYFV']?_0x200b86['lSyhd'](safeParse,_0x10d106['permissions']):_0x10d106['permissions']||[],_0x4e542f=jwt[_0x1fded7(0x20c)]({'username':_0x10d106['username'],'role':_0x10d106[_0x1fded7(0x21a)]},JWT_SECRET,{'expiresIn':_0x1fded7(0x33c)});return _0x1aa0c8['json']({'token':_0x4e542f,'user':{'id':_0x10d106['id'],'username':_0x10d106['username'],'name':_0x10d106['name']||_0x10d106['username'],'role':_0x10d106['role']||_0x1fded7(0x2d2),'department':_0x10d106[_0x1fded7(0x34e)]||'','permissions':_0x190509}});}catch(_0x26947a){return console[_0x1fded7(0x3bf)](_0x200b86['DgSqq'],_0x26947a['message']),_0x1aa0c8['status'](0x1f4)['json']({'error':_0x1fded7(0x26b)});}});const createCrudRoutes=(_0xcd8703,_0x5b367d,_0x2fc7fd='created_at')=>{const _0x392e1c=_0x165f6e,_0x5a6402={'nOJzW':function(_0x101170,_0x5e0db8){return _0x101170(_0x5e0db8);},'ITHIg':function(_0x5c1547,_0x165f53){return _0x5c1547!==_0x165f53;},'sHxZW':'OPxHz','hhfjC':'No\x20data','OxGVv':_0x392e1c(0x1cb),'wQZYi':function(_0x3a3f6c,_0x81d2b7){return _0x3a3f6c===_0x81d2b7;},'cgaHq':'object','vOEir':function(_0x2552b8,_0x515cce){return _0x2552b8!==_0x515cce;},'VXAaC':'vkWni','HgWvi':_0x392e1c(0x2d5)};app[_0x392e1c(0x1a2)]('/api/'+_0x5b367d,async(_0x1c8597,_0x1c0eac)=>{const _0x236d83=_0x392e1c;if(!dbPool)try{const _0x40b2d9=await _0x5a6402['nOJzW'](readTable,_0xcd8703);return _0x1c0eac['json'](_0x40b2d9);}catch(_0x516c55){return _0x1c0eac['status'](0x1f4)['json']({'error':_0x516c55[_0x236d83(0x2c8)]});}try{const [_0xfe9d06]=await dbPool['query']('SELECT\x20*\x20FROM\x20'+_0xcd8703+_0x236d83(0x30c)+_0x2fc7fd+_0x236d83(0x185));_0x1c0eac['json'](_0xfe9d06);}catch(_0x3156d4){_0x1c0eac['status'](0x1f4)['json']({'error':_0x3156d4[_0x236d83(0x2c8)]});}}),app['post']('/api/'+_0x5b367d,async(_0x23d732,_0x3d0795)=>{const _0x1732b9=_0x392e1c;if(!dbPool)try{if(_0x5a6402[_0x1732b9(0x201)]('tTJPe',_0x5a6402['sHxZW'])){const _0x4b3389=await addRow(_0xcd8703,_0x23d732[_0x1732b9(0x188)]||{});return _0x3d0795[_0x1732b9(0x1aa)](0xc9)[_0x1732b9(0x33d)](_0x4b3389);}else{if(!_0x55c063)return;_0x563781['join'](_0x4d7f27),_0x326c62[_0x1732b9(0x200)][_0x1732b9(0x2f7)]=_0x4e9466,_0x1b3d9d['add'](_0x13cadc),_0x15b846['emit'](_0x1732b9(0x1c4),_0x41bf64['from'](_0x1e2114));}}catch(_0x46cc6d){return _0x3d0795[_0x1732b9(0x1aa)](0x1f4)['json']({'error':_0x46cc6d['message']});}try{const _0x2a1a93=Object[_0x1732b9(0x293)](_0x23d732['body'])['filter'](_0x558785=>_0x558785!=='id'&&_0x558785!==_0x2fc7fd);if(_0x2a1a93['length']===0x0)return _0x3d0795[_0x1732b9(0x1aa)](0x190)['json']({'error':_0x5a6402['hhfjC']});const _0x3bfe79=_0x2a1a93['map'](_0x3175ec=>{const _0x5ef30e=_0x1732b9,_0x40b86e=_0x23d732[_0x5ef30e(0x188)][_0x3175ec];return typeof _0x40b86e==='object'&&_0x40b86e!==null?JSON['stringify'](_0x40b86e):_0x40b86e;}),_0x4222d3=_0x1732b9(0x29e)+_0xcd8703+'\x20(`'+_0x2a1a93[_0x1732b9(0x159)](_0x5a6402['OxGVv'])+_0x1732b9(0x13b)+_0x2a1a93[_0x1732b9(0x2c4)](()=>'?')['join'](',')+')',[_0x5ccfda]=await dbPool['query'](_0x4222d3,_0x3bfe79);_0x3d0795['json']({'id':_0x5ccfda[_0x1732b9(0x120)],..._0x23d732['body']});}catch(_0x23eb54){_0x3d0795['status'](0x1f4)['json']({'error':_0x23eb54[_0x1732b9(0x2c8)]});}}),app['put'](_0x392e1c(0x23c)+_0x5b367d+_0x392e1c(0x251),async(_0x4c43ed,_0x4d63a5)=>{const _0x17c6f0=_0x392e1c;if(!dbPool)try{return _0x5a6402[_0x17c6f0(0x3a5)]!==_0x5a6402[_0x17c6f0(0x26e)]?(await updateRow(_0xcd8703,_0x4c43ed['params']['id'],_0x4c43ed['body']||{}),_0x4d63a5['json']({'success':!![]})):_0x3e1c12[_0x17c6f0(0x1aa)](0x1f4)['json']({'error':_0x35678d['message']});}catch(_0x9c321d){return _0x4d63a5['status'](0x1f4)[_0x17c6f0(0x33d)]({'error':_0x9c321d[_0x17c6f0(0x2c8)]});}try{const _0x48cb3f=Object['keys'](_0x4c43ed[_0x17c6f0(0x188)])['filter'](_0x5ee320=>_0x5ee320!=='id'&&_0x5ee320!==_0x2fc7fd);if(_0x48cb3f['length']===0x0)return _0x4d63a5['json']({'success':!![]});const _0x3d350c=_0x48cb3f[_0x17c6f0(0x2c4)](_0x1b68fd=>'`'+_0x1b68fd+_0x17c6f0(0x11d))[_0x17c6f0(0x159)](','),_0x5baa25=[..._0x48cb3f['map'](_0x509a3b=>{const _0x3ea7c4=_0x17c6f0,_0x314933=_0x4c43ed[_0x3ea7c4(0x188)][_0x509a3b];return _0x5a6402['wQZYi'](typeof _0x314933,_0x5a6402['cgaHq'])&&_0x5a6402['vOEir'](_0x314933,null)?JSON[_0x3ea7c4(0x192)](_0x314933):_0x314933;}),_0x4c43ed['params']['id']];await dbPool['query'](_0x17c6f0(0x352)+_0xcd8703+'\x20SET\x20'+_0x3d350c+'\x20WHERE\x20id=?',_0x5baa25),_0x4d63a5[_0x17c6f0(0x33d)]({'success':!![]});}catch(_0x1329b9){_0x4d63a5[_0x17c6f0(0x1aa)](0x1f4)[_0x17c6f0(0x33d)]({'error':_0x1329b9['message']});}}),app['delete'](_0x392e1c(0x23c)+_0x5b367d+_0x392e1c(0x251),async(_0x160467,_0x28855c)=>{const _0x3a5edd=_0x392e1c;if(!dbPool)try{return await deleteRow(_0xcd8703,_0x160467[_0x3a5edd(0x166)]['id']),_0x28855c['json']({'success':!![]});}catch(_0x296f56){return _0x28855c[_0x3a5edd(0x1aa)](0x1f4)['json']({'error':_0x296f56[_0x3a5edd(0x2c8)]});}try{await dbPool[_0x3a5edd(0x1bc)](_0x3a5edd(0x371)+_0xcd8703+_0x3a5edd(0x29d),[_0x160467[_0x3a5edd(0x166)]['id']]),_0x28855c['json']({'success':!![]});}catch(_0x3cc371){_0x28855c['status'](0x1f4)[_0x3a5edd(0x33d)]({'error':_0x3cc371[_0x3a5edd(0x2c8)]});}});};app[_0x165f6e(0x1a2)]('/api/employees',async(_0x125e85,_0x5cb642)=>{const _0x430283=_0x165f6e,_0x892407={'gvlSl':_0x430283(0x13d),'PxDqr':'heyNm','QilLf':'UegCt','meDPb':'SELECT\x20*\x20FROM\x20employees\x20ORDER\x20BY\x20created_at\x20DESC'};if(!dbPool)try{const _0x597136=await readTable(_0x892407[_0x430283(0x39f)]);return _0x5cb642[_0x430283(0x33d)](_0x597136);}catch(_0x1ed8db){if(_0x892407[_0x430283(0x13f)]===_0x892407[_0x430283(0x388)])_0x3a9f27['status'](0x1f4)['json']({'error':_0x4c4ac2[_0x430283(0x2c8)]});else return _0x5cb642[_0x430283(0x1aa)](0x1f4)[_0x430283(0x33d)]({'error':_0x1ed8db['message']});}try{const [_0x522fdb]=await dbPool[_0x430283(0x1bc)](_0x892407[_0x430283(0x300)]);_0x5cb642['json'](_0x522fdb);}catch(_0x479033){_0x5cb642['status'](0x1f4)[_0x430283(0x33d)]({'error':_0x479033['message']});}}),app['post'](_0x165f6e(0x139),async(_0x33984b,_0x1f8aa4)=>{const _0xa26e8e=_0x165f6e,_0x10f6af={'OXyER':function(_0x1e6a81,_0xccda37){return _0x1e6a81||_0xccda37;},'eHgVY':_0xa26e8e(0x1b3),'aUMPx':function(_0x137165,_0x542933){return _0x137165(_0x542933);},'mBdvJ':'employees','bibln':_0xa26e8e(0x1fe),'aRZYC':function(_0x2dc995,_0xdcc91a){return _0x2dc995||_0xdcc91a;},'UHnSp':_0xa26e8e(0x331),'nSImx':function(_0x43cfb9,_0x342131){return _0x43cfb9||_0x342131;},'QOhnA':function(_0x40b26,_0x9c7762){return _0x40b26||_0x9c7762;},'TtGrs':function(_0x99bdc7,_0x1639f9){return _0x99bdc7||_0x1639f9;},'RwDhS':_0xa26e8e(0x265),'ODGmK':'ER_DUP_ENTRY'},_0x40a315=_0x33984b[_0xa26e8e(0x188)]||{},{name:_0x8bfea8,employee_id:_0x455640,department:_0x5e4c9a,position:_0x5b0d17,phone:_0xd239e,email:_0x2dfc1e,status:_0x113110}=_0x40a315;if(_0x10f6af[_0xa26e8e(0x22c)](!_0x8bfea8,!_0x455640))return _0x1f8aa4['status'](0x190)[_0xa26e8e(0x33d)]({'error':_0x10f6af['eHgVY']});if(!dbPool)try{const _0x3fb1bd=await _0x10f6af['aUMPx'](readTable,_0x10f6af[_0xa26e8e(0x196)]);if(_0x3fb1bd['some'](_0x18f466=>_0x18f466[_0xa26e8e(0x175)]===_0x455640))return _0x1f8aa4['status'](0x190)['json']({'error':_0x10f6af['bibln']});const _0x5834ae=await addRow(_0x10f6af[_0xa26e8e(0x196)],{'name':_0x8bfea8,'employee_id':_0x455640,'department':_0x5e4c9a||null,'position':_0x10f6af[_0xa26e8e(0x328)](_0x5b0d17,null),'phone':_0xd239e||null,'email':_0x10f6af['OXyER'](_0x2dfc1e,null),'status':_0x10f6af['aRZYC'](_0x113110,'active')});return _0x1f8aa4[_0xa26e8e(0x1aa)](0xc9)[_0xa26e8e(0x33d)](_0x5834ae);}catch(_0x32c5da){return _0x1f8aa4[_0xa26e8e(0x1aa)](0x1f4)['json']({'error':_0x32c5da['message']});}try{const [_0x1200bc]=await dbPool[_0xa26e8e(0x1bc)](_0x10f6af[_0xa26e8e(0x283)],[_0x8bfea8,_0x455640,_0x10f6af['nSImx'](_0x5e4c9a,null),_0x10f6af[_0xa26e8e(0x372)](_0x5b0d17,null),_0xd239e||null,_0x2dfc1e||null,_0x10f6af['TtGrs'](_0x113110,_0x10f6af[_0xa26e8e(0x314)])]);_0x1f8aa4['status'](0xc9)['json']({'id':_0x1200bc[_0xa26e8e(0x120)],..._0x40a315});}catch(_0x3e5071){if(_0x3e5071[_0xa26e8e(0x325)]===_0x10f6af['ODGmK'])return _0x1f8aa4['status'](0x190)['json']({'error':'工号已存在'});_0x1f8aa4['status'](0x1f4)['json']({'error':_0x3e5071['message']});}}),app[_0x165f6e(0x30e)]('/api/employees/:id',async(_0x3ac57c,_0x51a914)=>{const _0x23da2b=_0x165f6e,_0x433225={'ejFGk':_0x23da2b(0x13d),'ZKXZT':'phone','mRMNU':function(_0x387848,_0x10ad3c,_0x42709d){return _0x387848(_0x10ad3c,_0x42709d);},'JnwjM':_0x23da2b(0x1dd),'Ydcht':'工号已存在'},_0x8811d5=_0x3ac57c['body']||{};if(!dbPool)try{if(_0x8811d5['employee_id']){const _0x41f5c8=await readTable(_0x433225[_0x23da2b(0x156)]);if(_0x41f5c8[_0x23da2b(0x2e7)](_0x20d920=>_0x20d920['employee_id']===_0x8811d5['employee_id']&&String(_0x20d920['id'])!==String(_0x3ac57c[_0x23da2b(0x166)]['id'])))return _0x51a914[_0x23da2b(0x1aa)](0x190)['json']({'error':'工号已存在'});}return await updateRow(_0x433225[_0x23da2b(0x156)],_0x3ac57c['params']['id'],_0x8811d5),_0x51a914['json']({'success':!![]});}catch(_0x230803){return _0x51a914[_0x23da2b(0x1aa)](0x1f4)[_0x23da2b(0x33d)]({'error':_0x230803[_0x23da2b(0x2c8)]});}try{const _0x2e64ff=['name',_0x23da2b(0x175),'department','position',_0x433225[_0x23da2b(0x241)],'email',_0x23da2b(0x1aa)],{setSql:_0x13d93a,values:_0x27a6ff}=_0x433225[_0x23da2b(0x177)](buildSafeUpdate,_0x8811d5,_0x2e64ff);if(!_0x13d93a)return _0x51a914[_0x23da2b(0x33d)]({'success':!![]});await dbPool[_0x23da2b(0x1bc)]('UPDATE\x20employees\x20SET\x20'+_0x13d93a+_0x23da2b(0x29d),[..._0x27a6ff,_0x3ac57c['params']['id']]),_0x51a914['json']({'success':!![]});}catch(_0x48476e){if(_0x48476e[_0x23da2b(0x325)]===_0x433225['JnwjM'])return _0x51a914['status'](0x190)[_0x23da2b(0x33d)]({'error':_0x433225[_0x23da2b(0x20f)]});_0x51a914[_0x23da2b(0x1aa)](0x1f4)['json']({'error':_0x48476e['message']});}}),app[_0x165f6e(0x231)](_0x165f6e(0x380),async(_0xb90260,_0xeb8437)=>{const _0x3ca216=_0x165f6e,_0xb8c3b2={'weZZB':_0x3ca216(0x13d)};if(!dbPool)try{return await deleteRow(_0xb8c3b2[_0x3ca216(0x1f6)],_0xb90260['params']['id']),_0xeb8437['json']({'success':!![]});}catch(_0x1fb15c){return _0xeb8437[_0x3ca216(0x1aa)](0x1f4)[_0x3ca216(0x33d)]({'error':_0x1fb15c['message']});}try{await dbPool['query']('DELETE\x20FROM\x20employees\x20WHERE\x20id=?',[_0xb90260[_0x3ca216(0x166)]['id']]),_0xeb8437[_0x3ca216(0x33d)]({'success':!![]});}catch(_0x530b60){_0xeb8437['status'](0x1f4)[_0x3ca216(0x33d)]({'error':_0x530b60[_0x3ca216(0x2c8)]});}}),createCrudRoutes('annual_work_plans',_0x165f6e(0x1df)),createCrudRoutes('notifications',_0x165f6e(0x2a7),'published_at'),createCrudRoutes('target_types',_0x165f6e(0x383)),createCrudRoutes(_0x165f6e(0x252),_0x165f6e(0x252)),app[_0x165f6e(0x1a2)]('/api/logs',async(_0x1fc36c,_0x514656)=>{const _0x379efc=_0x165f6e,_0x303eaf={'QSAbp':_0x379efc(0x286),'cEiRt':'success','YiSFO':function(_0x510e6e,_0x289ed0){return _0x510e6e*_0x289ed0;},'YlFKW':_0x379efc(0x1b0),'TFHSd':'audit_logs','jQIKL':'username\x20LIKE\x20?','Gcobu':_0x379efc(0x39b),'AqUfC':_0x379efc(0x1eb),'UyfnB':function(_0x5e2732,_0x4cba0e){return _0x5e2732===_0x4cba0e;},'Zeekx':_0x379efc(0x24b),'vJYJn':'VIEW','KHifC':_0x379efc(0x2f0),'pKoBL':_0x379efc(0x39d),'enxKO':function(_0x95873a,_0xeb930b){return _0x95873a(_0xeb930b);}},{page:page=0x1,pageSize:pageSize=0x14,username:_0x2d44e4,type:_0x1693ba,startDate:_0x2cb802,endDate:_0x357e84}=_0x1fc36c['query'],_0xc0a318=Number(pageSize),_0x2dcde6=_0x303eaf[_0x379efc(0x3c0)](Number(page)-0x1,_0xc0a318),_0x5e77d9=(_0x18975f,_0x3aafb7)=>{const _0x30d97c=_0x379efc;if(_0x3aafb7&&_0x3aafb7['includes'](_0x30d97c(0x38d)))return'LOGIN';if(_0x18975f==='POST')return _0x30d97c(0x39b);if(_0x18975f==='PUT')return _0x30d97c(0x24b);if(_0x18975f==='DELETE')return _0x303eaf[_0x30d97c(0x249)];if(_0x18975f==='GET')return _0x30d97c(0x394);return _0x18975f;},_0x2fc74f=_0x2ac96d=>{const _0x1ca54b=_0x379efc;if(_0x2ac96d>=0xc8&&_0x2ac96d<0x12c)return _0x303eaf['cEiRt'];if(_0x2ac96d>=0x190)return _0x1ca54b(0x1c3);return _0x1ca54b(0x229);};if(!dbPool)try{if(_0x303eaf[_0x379efc(0x150)]===_0x303eaf[_0x379efc(0x150)]){let _0x309d32=await readTable(_0x303eaf[_0x379efc(0x25e)]);if(_0x2d44e4)_0x309d32=_0x309d32[_0x379efc(0x198)](_0xc51628=>_0xc51628['username']&&_0xc51628['username']['includes'](_0x2d44e4));if(_0x2cb802)_0x309d32=_0x309d32['filter'](_0x239a21=>new Date(_0x239a21[_0x379efc(0x3d8)])>=new Date(_0x2cb802));if(_0x357e84)_0x309d32=_0x309d32['filter'](_0x2f25b0=>new Date(_0x2f25b0[_0x379efc(0x3d8)])<=new Date(_0x357e84));_0x1693ba&&(_0x309d32=_0x309d32['filter'](_0x3f9d92=>{const _0x206b4c=_0x5e77d9(_0x3f9d92['method'],_0x3f9d92['path']);return _0x206b4c===_0x1693ba;}));_0x309d32['sort']((_0x653f45,_0x306a73)=>new Date(_0x306a73['created_at'])-new Date(_0x653f45['created_at']));const _0x1537de=_0x309d32[_0x379efc(0x2fb)],_0x170e6e=_0x309d32['slice'](_0x2dcde6,_0x2dcde6+_0xc0a318),_0xf7096e=_0x170e6e[_0x379efc(0x2c4)](_0x537680=>({..._0x537680,'action_type':_0x5e77d9(_0x537680[_0x379efc(0x1a5)],_0x537680[_0x379efc(0x387)]),'details':_0x537680['operation']||_0x537680[_0x379efc(0x387)]+(_0x537680['query']&&_0x537680['query']!==_0x379efc(0x14f)?'\x20'+_0x537680[_0x379efc(0x1bc)]:''),'ip_address':_0x537680['ip'],'status':_0x2fc74f(_0x537680['status'])}));return _0x514656[_0x379efc(0x33d)]({'data':_0xf7096e,'total':_0x1537de,'page':Number(page),'pageSize':_0xc0a318});}else return _0x5486dd[_0x379efc(0x1aa)](0x194)[_0x379efc(0x33d)]({'error':_0x379efc(0x11f)});}catch(_0x1c7e0e){return _0x514656['status'](0x1f4)[_0x379efc(0x33d)]({'error':_0x1c7e0e[_0x379efc(0x2c8)]});}try{let _0x54f722=[],_0x273f80=[];_0x2d44e4&&(_0x54f722[_0x379efc(0x2f4)](_0x303eaf['jQIKL']),_0x273f80['push']('%'+_0x2d44e4+'%'));_0x2cb802&&(_0x54f722['push']('created_at\x20>=\x20?'),_0x273f80[_0x379efc(0x2f4)](_0x2cb802));_0x357e84&&(_0x54f722['push'](_0x379efc(0x33f)),_0x273f80[_0x379efc(0x2f4)](_0x357e84));if(_0x1693ba){if(_0x1693ba===_0x379efc(0x1a1))_0x54f722[_0x379efc(0x2f4)](_0x379efc(0x305));else{if(_0x1693ba===_0x303eaf[_0x379efc(0x2ba)])_0x54f722[_0x379efc(0x2f4)](_0x303eaf['AqUfC']);else{if(_0x303eaf[_0x379efc(0x2a3)](_0x1693ba,_0x303eaf[_0x379efc(0x354)]))_0x54f722[_0x379efc(0x2f4)](_0x379efc(0x31b));else{if(_0x1693ba==='DELETE')_0x54f722['push'](_0x379efc(0x3b2));else{if(_0x1693ba===_0x303eaf['vJYJn'])_0x54f722['push'](_0x303eaf['KHifC']);}}}}}const _0x43ff7d=_0x54f722[_0x379efc(0x2fb)]?_0x379efc(0x164)+_0x54f722['join'](_0x303eaf['pKoBL']):'',[_0x5b4470]=await dbPool[_0x379efc(0x1bc)](_0x379efc(0x13c)+_0x43ff7d,_0x273f80),_0x1fad51=_0x5b4470[0x0]['total'],_0x32d8bf='SELECT\x20*\x20FROM\x20audit_logs'+_0x43ff7d+'\x20ORDER\x20BY\x20created_at\x20DESC\x20LIMIT\x20?\x20OFFSET\x20?',[_0xf8c6df]=await dbPool['query'](_0x32d8bf,[..._0x273f80,_0xc0a318,_0x2dcde6]),_0x25aca8=_0xf8c6df[_0x379efc(0x2c4)](_0x3515b7=>({..._0x3515b7,'action_type':_0x5e77d9(_0x3515b7[_0x379efc(0x1a5)],_0x3515b7['path']),'details':_0x3515b7[_0x379efc(0x22b)]||_0x3515b7[_0x379efc(0x387)]+(_0x3515b7['query']&&_0x3515b7['query']!==_0x379efc(0x14f)?'\x20'+_0x3515b7[_0x379efc(0x1bc)]:''),'ip_address':_0x3515b7['ip'],'status':_0x2fc74f(_0x3515b7['status'])}));_0x514656[_0x379efc(0x33d)]({'data':_0x25aca8,'total':_0x1fad51,'page':_0x303eaf[_0x379efc(0x1cf)](Number,page),'pageSize':_0xc0a318});}catch(_0x210723){_0x514656[_0x379efc(0x1aa)](0x1f4)[_0x379efc(0x33d)]({'error':_0x210723['message']});}}),app['delete']('/api/logs',async(_0x1da285,_0x49739f)=>{const _0x5c65ae=_0x165f6e,_0x46f968={'HSGEm':_0x5c65ae(0x212)};try{!dbPool?await writeTable(_0x46f968['HSGEm'],[]):await dbPool['query']('DELETE\x20FROM\x20audit_logs'),_0x49739f['json']({'success':!![],'message':_0x5c65ae(0x298)});}catch(_0x485d48){_0x49739f['status'](0x1f4)['json']({'error':_0x485d48[_0x5c65ae(0x2c8)]});}}),app['delete'](_0x165f6e(0x3e7),async(_0x4dfb45,_0x572163)=>{const _0x130d56=_0x165f6e,_0x5d9d0a={'xSFhq':function(_0x29bf11,_0x2dc3f8){return _0x29bf11(_0x2dc3f8);},'VKybV':'DELETE\x20FROM\x20audit_logs\x20WHERE\x20id\x20=\x20?'},{id:_0x3ef1b5}=_0x4dfb45[_0x130d56(0x166)];try{if(!dbPool){const _0x26d298=await _0x5d9d0a['xSFhq'](readTable,_0x130d56(0x212)),_0x311b69=_0x26d298[_0x130d56(0x198)](_0x557c36=>String(_0x557c36['id'])!==String(_0x3ef1b5));await writeTable('audit_logs',_0x311b69);}else await dbPool[_0x130d56(0x1bc)](_0x5d9d0a['VKybV'],[_0x3ef1b5]);_0x572163[_0x130d56(0x33d)]({'success':!![],'message':'日志已成功删除'});}catch(_0x36dda0){_0x572163['status'](0x1f4)['json']({'error':_0x36dda0['message']});}}),app[_0x165f6e(0x1a2)](_0x165f6e(0x1ae),async(_0x5d93b8,_0x56176f)=>{const _0x22eb5f=_0x165f6e,_0x2da2cf={'zpcIP':_0x22eb5f(0x282)},_0x325110=_0x5d93b8[_0x22eb5f(0x1bc)]['type'];if(!dbPool)try{const _0x36718c=await readTable(_0x2da2cf[_0x22eb5f(0x19a)]);let _0x1ba0de=_0x36718c;_0x325110&&(_0x1ba0de=_0x36718c['filter'](_0x383dcd=>(_0x383dcd[_0x22eb5f(0x2b9)]||_0x22eb5f(0x3d4))===_0x325110));const _0x1c8a62=new Map(_0x36718c[_0x22eb5f(0x2c4)](_0x335a88=>[_0x335a88['id'],_0x335a88['name']])),_0xd7beef=_0x1ba0de[_0x22eb5f(0x2c4)](_0x13c5f3=>({..._0x13c5f3,'parent_name':_0x13c5f3[_0x22eb5f(0x340)]?_0x1c8a62[_0x22eb5f(0x1a2)](_0x13c5f3[_0x22eb5f(0x340)])||'':null}));return _0x56176f['json'](_0xd7beef);}catch(_0x4da1c9){return _0x56176f[_0x22eb5f(0x1aa)](0x1f4)[_0x22eb5f(0x33d)]({'error':_0x4da1c9[_0x22eb5f(0x2c8)]});}try{let _0x229bac=_0x22eb5f(0x306);const _0x2ec58a=[];_0x325110&&(_0x229bac+='\x20WHERE\x20d.type\x20=\x20?',_0x2ec58a[_0x22eb5f(0x2f4)](_0x325110));_0x229bac+='\x20ORDER\x20BY\x20d.created_at\x20DESC';const [_0x42a061]=await dbPool['query'](_0x229bac,_0x2ec58a);_0x56176f[_0x22eb5f(0x33d)](_0x42a061);}catch(_0x446a75){_0x56176f['status'](0x1f4)['json']({'error':_0x446a75['message']});}}),app['post']('/api/departments',async(_0x442d48,_0x43f147)=>{const _0x45b512=_0x165f6e,_0x359f6b={'zgHnK':_0x45b512(0x1c8),'iCcPK':function(_0x4fe4da,_0x21c7f8){return _0x4fe4da+_0x21c7f8;},'WFfYd':function(_0x37a3ca,_0x592534){return _0x37a3ca||_0x592534;},'RvwjD':'DEPT','inAKi':'active','iDLVX':'INSERT\x20INTO\x20departments\x20(id,\x20name,\x20code,\x20parent_id,\x20type,\x20manager,\x20phone,\x20email,\x20status,\x20description)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','MGtOU':function(_0xaaf829,_0x1b42a9){return _0xaaf829||_0x1b42a9;},'xkWKC':function(_0x4ab8ce,_0x57350c){return _0x4ab8ce||_0x57350c;},'MwNzz':function(_0x1892f2,_0x5a63fa){return _0x1892f2||_0x5a63fa;},'tVXhn':'ER_DUP_ENTRY'},_0x2057b1=_0x442d48[_0x45b512(0x188)]||{},{name:_0x371158,code:_0x5515b7,parent_id:_0xea16cd,type:_0x3e7bfb,manager:_0x2e4cd3,phone:_0x45b719,email:_0x200bfa,status:_0x21072a,description:_0x2a29bd}=_0x2057b1;if(!_0x371158)return _0x43f147[_0x45b512(0x1aa)](0x190)[_0x45b512(0x33d)]({'error':_0x45b512(0x1bf)});if(_0xea16cd&&dbPool)try{const [_0x69edc8]=await dbPool[_0x45b512(0x1bc)](_0x45b512(0x322),[_0xea16cd]);if(_0x69edc8['length']===0x0)return _0x43f147['status'](0x190)[_0x45b512(0x33d)]({'error':_0x359f6b['zgHnK']});}catch(_0x54b9d4){return _0x43f147[_0x45b512(0x1aa)](0x1f4)[_0x45b512(0x33d)]({'error':_0x359f6b['iCcPK'](_0x45b512(0x3be),_0x54b9d4['message'])});}if(!dbPool)try{const _0x175212=await addRow('departments',{'name':_0x371158,'code':_0x359f6b[_0x45b512(0x1b5)](_0x5515b7,''),'parent_id':_0x359f6b[_0x45b512(0x1b5)](_0xea16cd,null),'type':_0x3e7bfb||_0x359f6b['RvwjD'],'manager':_0x2e4cd3||null,'phone':_0x359f6b[_0x45b512(0x1b5)](_0x45b719,null),'email':_0x200bfa||null,'status':_0x359f6b[_0x45b512(0x1b5)](_0x21072a,_0x359f6b['inAKi']),'description':_0x2a29bd||null});return _0x43f147['status'](0xc9)[_0x45b512(0x33d)](_0x175212);}catch(_0x435e9b){return _0x43f147[_0x45b512(0x1aa)](0x1f4)[_0x45b512(0x33d)]({'error':_0x435e9b['message']});}try{const [_0x4bb406]=await dbPool[_0x45b512(0x1bc)](_0x359f6b[_0x45b512(0x3df)],[_0x2057b1['id']||null,_0x371158,_0x359f6b['MGtOU'](_0x5515b7,''),_0x359f6b[_0x45b512(0x1da)](_0xea16cd,null),_0x359f6b[_0x45b512(0x1da)](_0x3e7bfb,'DEPT'),_0x359f6b[_0x45b512(0x158)](_0x2e4cd3,null),_0x359f6b[_0x45b512(0x224)](_0x45b719,null),_0x200bfa||null,_0x21072a||_0x359f6b[_0x45b512(0x21c)],_0x2a29bd||null]),_0x9406d2=_0x2057b1['id']||_0x4bb406[_0x45b512(0x120)];_0x43f147[_0x45b512(0x1aa)](0xc9)['json']({'id':_0x9406d2,..._0x2057b1,'type':_0x3e7bfb||_0x45b512(0x3d4)});}catch(_0x334851){if(_0x334851[_0x45b512(0x325)]===_0x359f6b[_0x45b512(0x155)])return _0x43f147[_0x45b512(0x1aa)](0x190)[_0x45b512(0x33d)]({'error':_0x45b512(0x18f)});_0x43f147['status'](0x1f4)[_0x45b512(0x33d)]({'error':_0x334851[_0x45b512(0x2c8)]});}}),app[_0x165f6e(0x30e)]('/api/departments/:id',async(_0x105c33,_0x1d4704)=>{const _0x18e3e4=_0x165f6e,_0x5f5614={'tCola':function(_0x44c65a,_0x3dd9d4){return _0x44c65a===_0x3dd9d4;},'trcSr':'code','RsEvH':'phone','RCgvz':'description','vjvBO':'ER_DUP_ENTRY'},_0x33710b=Number(_0x105c33['params']['id']),_0x31983c=_0x105c33[_0x18e3e4(0x188)]||{};if(_0x31983c[_0x18e3e4(0x340)]!==undefined&&_0x5f5614[_0x18e3e4(0x194)](_0x31983c[_0x18e3e4(0x340)],_0x33710b))return _0x1d4704['status'](0x190)['json']({'error':_0x18e3e4(0x1a3)});if(_0x31983c['parent_id']&&dbPool)try{const _0x435dca=async(_0x5b84f2,_0xc43135)=>{const _0x330a8e=_0x18e3e4;if(_0x5b84f2===_0xc43135)return!![];const [_0x13e5f2]=await dbPool[_0x330a8e(0x1bc)](_0x330a8e(0x38b),[_0x5b84f2]);if(_0x13e5f2['length']===0x0||!_0x13e5f2[0x0][_0x330a8e(0x340)])return![];return await _0x435dca(_0x13e5f2[0x0]['parent_id'],_0xc43135);},_0x8433f9=await _0x435dca(_0x31983c[_0x18e3e4(0x340)],_0x33710b);if(_0x8433f9)return _0x1d4704[_0x18e3e4(0x1aa)](0x190)['json']({'error':'不能将子节点设置为上级节点，避免循环引用'});}catch(_0x1ab5e2){console['error']('[Department]\x20检查循环引用失败:',_0x1ab5e2[_0x18e3e4(0x2c8)]);}if(!dbPool)try{return await updateRow(_0x18e3e4(0x282),_0x105c33[_0x18e3e4(0x166)]['id'],_0x31983c),_0x1d4704[_0x18e3e4(0x33d)]({'success':!![]});}catch(_0x100f91){return _0x1d4704['status'](0x1f4)[_0x18e3e4(0x33d)]({'error':_0x100f91[_0x18e3e4(0x2c8)]});}try{const _0x221977=[_0x18e3e4(0x324),_0x5f5614['trcSr'],_0x18e3e4(0x340),_0x18e3e4(0x2b9),_0x18e3e4(0x19c),_0x5f5614[_0x18e3e4(0x1e6)],'email','status',_0x5f5614['RCgvz']],_0x12c514=Object['keys'](_0x31983c)['filter'](_0x2f711d=>_0x221977[_0x18e3e4(0x232)](_0x2f711d));if(_0x5f5614[_0x18e3e4(0x194)](_0x12c514[_0x18e3e4(0x2fb)],0x0))return _0x1d4704[_0x18e3e4(0x33d)]({'success':!![]});const _0x2115d4=_0x12c514[_0x18e3e4(0x2c4)](_0x3695f1=>_0x3695f1+'=?')[_0x18e3e4(0x159)](','),_0x96105e=[..._0x12c514['map'](_0x1bd3a5=>_0x31983c[_0x1bd3a5]),_0x33710b];await dbPool['query']('UPDATE\x20departments\x20SET\x20'+_0x2115d4+_0x18e3e4(0x29d),_0x96105e),_0x1d4704['json']({'success':!![]});}catch(_0x27961e){if(_0x27961e[_0x18e3e4(0x325)]===_0x5f5614['vjvBO'])return _0x1d4704['status'](0x190)[_0x18e3e4(0x33d)]({'error':_0x18e3e4(0x18f)});_0x1d4704['status'](0x1f4)[_0x18e3e4(0x33d)]({'error':_0x27961e[_0x18e3e4(0x2c8)]});}}),app[_0x165f6e(0x231)]('/api/departments/:id',async(_0x269acc,_0x295c2d)=>{const _0x5689c8=_0x165f6e,_0x93c7eb={'WkopC':'DELETE\x20FROM\x20departments\x20WHERE\x20id=?'};if(!dbPool)try{return await deleteRow(_0x5689c8(0x282),_0x269acc['params']['id']),_0x295c2d[_0x5689c8(0x33d)]({'success':!![]});}catch(_0x104e9b){return _0x295c2d['status'](0x1f4)[_0x5689c8(0x33d)]({'error':_0x104e9b[_0x5689c8(0x2c8)]});}try{await dbPool['query'](_0x93c7eb['WkopC'],[_0x269acc[_0x5689c8(0x166)]['id']]),_0x295c2d[_0x5689c8(0x33d)]({'success':!![]});}catch(_0x4aeee0){_0x295c2d[_0x5689c8(0x1aa)](0x1f4)['json']({'error':_0x4aeee0[_0x5689c8(0x2c8)]});}}),app[_0x165f6e(0x1a2)]('/api/organization/tree',async(_0x48804f,_0x2c5284)=>{const _0x1568b3=_0x165f6e,_0x79c554={'AlGii':function(_0x1d9a81,_0x5ee18b,_0x1f7ea7){return _0x1d9a81(_0x5ee18b,_0x1f7ea7);},'dDeMT':function(_0x45b29a,_0x1d2eee){return _0x45b29a!==_0x1d2eee;},'wMbWT':_0x1568b3(0x282),'GMvup':'SELECT\x20*\x20FROM\x20departments\x20ORDER\x20BY\x20id\x20ASC'};if(!dbPool){if(_0x79c554[_0x1568b3(0x3a6)](_0x1568b3(0x2b1),'Whunp')){const _0x3b5b49=_0x1218a5[_0x1568b3(0x382)]['replace'](/[^a-zA-Z0-9._-]/g,'_');_0x79c554[_0x1568b3(0x34c)](_0x2b2b1e,null,_0x4ebd60['now']()+'-'+_0x3b5b49);}else try{const _0x452c80=await readTable(_0x79c554[_0x1568b3(0x35f)]),_0x4e008b=buildOrgTree(_0x452c80);return _0x2c5284[_0x1568b3(0x33d)](_0x4e008b);}catch(_0x2da0cd){return _0x2c5284[_0x1568b3(0x1aa)](0x1f4)[_0x1568b3(0x33d)]({'error':_0x2da0cd[_0x1568b3(0x2c8)]});}}try{const [_0x78126e]=await dbPool[_0x1568b3(0x1bc)](_0x79c554['GMvup']),_0xc9b6d1=buildOrgTree(_0x78126e);_0x2c5284[_0x1568b3(0x33d)](_0xc9b6d1);}catch(_0x2e5d20){_0x2c5284['status'](0x1f4)[_0x1568b3(0x33d)]({'error':_0x2e5d20['message']});}});function buildOrgTree(_0xb7b5a1){const _0x554b31=_0x165f6e,_0x5f55a3={'cGHiV':function(_0x5c8b0f,_0x41f165){return _0x5c8b0f===_0x41f165;},'ajamE':_0x554b31(0x2d6),'HlzmY':'wtzyr'},_0x3df56=[],_0xefc483={};for(const _0x2ca1a3 of _0xb7b5a1){_0xefc483[_0x2ca1a3['id']]={..._0x2ca1a3,'children':[]};}for(const _0x134342 of _0xb7b5a1){const _0x499db3=_0x134342[_0x554b31(0x340)]||_0x134342['parentId']||null;_0x499db3&&_0xefc483[_0x499db3]?_0xefc483[_0x499db3][_0x554b31(0x3c1)]['push'](_0xefc483[_0x134342['id']]):_0x5f55a3[_0x554b31(0x288)](_0x5f55a3['ajamE'],_0x5f55a3['HlzmY'])?_0xfc6809[_0x554b31(0x1aa)](0x1f4)['json']({'error':_0x406e24[_0x554b31(0x2c8)]}):_0x3df56['push'](_0xefc483[_0x134342['id']]);}return _0x3df56;}app[_0x165f6e(0x364)]('/api/notifications/send',async(_0x2375af,_0x332348)=>{const _0x405923=_0x165f6e,_0x11ed21={'HUDHB':function(_0x62b46f,_0x36c374){return _0x62b46f===_0x36c374;},'DthuE':'标题和消息内容为必填项','NnwEA':function(_0x1e7a8e,_0x2dbcfd){return _0x1e7a8e||_0x2dbcfd;},'CsTNj':_0x405923(0x2a7),'TeMOu':'notification','MBaiE':'ndckR'},_0x33fdab=_0x2375af[_0x405923(0x188)]||{},{type:_0x807e8d,title:_0x4fa085,message:_0x27ec97,recipients:_0x1ab28d}=_0x33fdab;if(!_0x4fa085||!_0x27ec97)return _0x332348[_0x405923(0x1aa)](0x190)[_0x405923(0x33d)]({'error':_0x11ed21['DthuE']});try{const _0x190c2b={'type':_0x11ed21['NnwEA'](_0x807e8d,'system'),'title':_0x4fa085,'message':_0x27ec97,'recipients':_0x1ab28d||[],'published_at':new Date()['toISOString'](),'read':0x0};if(!dbPool){const _0x15a18c=await addRow(_0x11ed21[_0x405923(0x3a0)],_0x190c2b);return io&&io[_0x405923(0x291)]('notification',{'type':'new','data':_0x15a18c}),_0x332348['status'](0xc9)['json'](_0x15a18c);}const [_0x39bdcc]=await dbPool[_0x405923(0x1bc)]('INSERT\x20INTO\x20notifications\x20(type,\x20title,\x20message,\x20published_at,\x20`read`)\x20VALUES\x20(?,\x20?,\x20?,\x20NOW(),\x200)',[_0x190c2b['type'],_0x190c2b[_0x405923(0x3c8)],_0x190c2b[_0x405923(0x2c8)]]),_0xefd77={'id':_0x39bdcc['insertId'],..._0x190c2b};io&&io[_0x405923(0x291)](_0x11ed21[_0x405923(0x23d)],{'type':'new','data':_0xefd77}),_0x332348['status'](0xc9)[_0x405923(0x33d)](_0xefd77);}catch(_0x993fad){if('ppUhQ'===_0x11ed21['MBaiE']){if(_0x11ed21[_0x405923(0x3e2)](_0x55ac49[_0x405923(0x325)],_0x405923(0x1dd)))return _0x55c193['status'](0x190)[_0x405923(0x33d)]({'error':'工号已存在'});_0x1f558e[_0x405923(0x1aa)](0x1f4)[_0x405923(0x33d)]({'error':_0x2d4000[_0x405923(0x2c8)]});}else _0x332348['status'](0x1f4)[_0x405923(0x33d)]({'error':_0x993fad[_0x405923(0x2c8)]});}});const bcrypt=require('bcryptjs');app['get'](_0x165f6e(0x11a),async(_0x485f24,_0x661d09)=>{const _0x5d6b5e=_0x165f6e,_0x4ae016={'TuSrA':_0x5d6b5e(0x190),'ImERg':function(_0x513537,_0x160dab){return _0x513537(_0x160dab);},'LKRXm':function(_0x83d60e,_0x386eff){return _0x83d60e!==_0x386eff;},'OwfAd':'GbylJ','LLpGy':_0x5d6b5e(0x329)};if(!dbPool){if(_0x4ae016[_0x5d6b5e(0x1e9)]('GbylJ',_0x4ae016[_0x5d6b5e(0x35e)]))_0x29dbd5[_0x5d6b5e(0x1aa)](0x1f4)['json']({'error':_0xdfbeaa[_0x5d6b5e(0x2c8)]});else try{const _0x169d54=await readTable('users'),_0x7e7b74=_0x169d54['map'](({password:_0x1be191,..._0x231282})=>_0x231282);return _0x661d09[_0x5d6b5e(0x33d)](_0x7e7b74);}catch(_0x1b6232){if(_0x4ae016[_0x5d6b5e(0x162)]!==_0x4ae016[_0x5d6b5e(0x162)])_0x2a31b3[_0x5d6b5e(0x2f4)](_0x4ae016['TuSrA']),_0x31966c['push'](_0x4ae016[_0x5d6b5e(0x3d7)](_0x5bfa0f,_0x4487e0));else return _0x661d09['status'](0x1f4)['json']({'error':_0x1b6232[_0x5d6b5e(0x2c8)]});}}try{const [_0x5481c2]=await dbPool['query']('SELECT\x20id,\x20username,\x20name,\x20email,\x20role,\x20department,\x20permissions,\x20status,\x20created_at\x20FROM\x20users\x20ORDER\x20BY\x20id\x20DESC'),_0x6f50c5=_0x5481c2['map'](_0x1addc2=>({..._0x1addc2,'permissions':safeParse(_0x1addc2[_0x5d6b5e(0x2d8)])||[]}));_0x661d09[_0x5d6b5e(0x33d)](_0x6f50c5);}catch(_0x571de5){_0x661d09['status'](0x1f4)['json']({'error':_0x571de5[_0x5d6b5e(0x2c8)]});}}),app[_0x165f6e(0x364)]('/api/users',async(_0x3e9851,_0x225ac4)=>{const _0x1610cc=_0x165f6e,_0x2b5f71={'GvGtr':function(_0x58abdd,_0x10ba92){return _0x58abdd||_0x10ba92;},'TDjDO':function(_0x384ed7,_0x536671,_0x5d5b7d){return _0x384ed7(_0x536671,_0x5d5b7d);},'FjcCo':'users','hXCkQ':function(_0x72382b,_0x3cebf2){return _0x72382b||_0x3cebf2;},'dUEij':_0x1610cc(0x2d2),'Tqmbn':'INSERT\x20INTO\x20users\x20(username,\x20password,\x20name,\x20email,\x20role,\x20department,\x20permissions,\x20status)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','XjiwD':function(_0x284f8f,_0x3f2610){return _0x284f8f||_0x3f2610;},'ObPVl':function(_0x3ad562,_0x44c5e7){return _0x3ad562===_0x44c5e7;},'RyHcV':'ER_DUP_ENTRY','QxHmF':_0x1610cc(0x2d1)},_0x2cd25b=_0x3e9851[_0x1610cc(0x188)]||{},{username:_0x9369f5,password:_0x50c9a8,name:_0x314eca,email:_0x450eaf,role:_0xda21e1,department:_0x36f613,permissions:_0x420b50,status:_0x20b433}=_0x2cd25b;if(_0x2b5f71['GvGtr'](!_0x9369f5,!_0x50c9a8))return _0x225ac4[_0x1610cc(0x1aa)](0x190)[_0x1610cc(0x33d)]({'error':'用户名和密码为必填项'});const _0x5bc654=await bcrypt['hash'](_0x50c9a8,0xa);if(!dbPool)try{const _0x1ae41f=await _0x2b5f71[_0x1610cc(0x30b)](addRow,_0x2b5f71['FjcCo'],{'username':_0x9369f5,'password':_0x5bc654,'name':_0x314eca||_0x9369f5,'email':_0x450eaf||'','role':_0x2b5f71['hXCkQ'](_0xda21e1,_0x2b5f71['dUEij']),'department':_0x2b5f71[_0x1610cc(0x3c6)](_0x36f613,''),'permissions':_0x420b50||[_0x1610cc(0x219)],'status':_0x20b433||'active'}),{password:_0x222719,..._0x55ba2d}=_0x1ae41f;return _0x225ac4['status'](0xc9)[_0x1610cc(0x33d)](_0x55ba2d);}catch(_0x206f44){return _0x225ac4[_0x1610cc(0x1aa)](0x1f4)[_0x1610cc(0x33d)]({'error':_0x206f44[_0x1610cc(0x2c8)]});}try{const _0x236157=JSON['stringify'](_0x420b50||[_0x1610cc(0x219)]),[_0x565480]=await dbPool[_0x1610cc(0x1bc)](_0x2b5f71['Tqmbn'],[_0x9369f5,_0x5bc654,_0x2b5f71[_0x1610cc(0x3ba)](_0x314eca,_0x9369f5),_0x450eaf||'',_0x2b5f71[_0x1610cc(0x2c9)](_0xda21e1,_0x1610cc(0x2d2)),_0x36f613||'',_0x236157,_0x2b5f71[_0x1610cc(0x2c9)](_0x20b433,'active')]);_0x225ac4[_0x1610cc(0x1aa)](0xc9)[_0x1610cc(0x33d)]({'id':_0x565480[_0x1610cc(0x120)],'username':_0x9369f5,'name':_0x2b5f71[_0x1610cc(0x3c6)](_0x314eca,_0x9369f5),'email':_0x450eaf,'role':_0xda21e1,'department':_0x36f613,'permissions':_0x420b50,'status':_0x20b433});}catch(_0xff1216){if(_0x2b5f71[_0x1610cc(0x2c1)](_0xff1216['code'],_0x2b5f71[_0x1610cc(0x262)]))return _0x225ac4['status'](0x190)[_0x1610cc(0x33d)]({'error':_0x2b5f71[_0x1610cc(0x133)]});_0x225ac4['status'](0x1f4)[_0x1610cc(0x33d)]({'error':_0xff1216['message']});}}),app[_0x165f6e(0x30e)](_0x165f6e(0x222),async(_0x5f5dd6,_0x4aaab2)=>{const _0xc486a7=_0x165f6e,_0x426fda={'KLoAS':_0xc486a7(0x1f1),'CBMSv':_0xc486a7(0x1ef),'qJego':_0xc486a7(0x21a),'VcuKg':_0xc486a7(0x2d8),'kLpgh':'phone'},_0x4e32fa=_0x5f5dd6[_0xc486a7(0x188)]||{},{password:_0x3b7d3a,..._0x5a89d7}=_0x4e32fa;let _0x22fa53={..._0x5a89d7};_0x3b7d3a&&(_0x22fa53['password']=await bcrypt[_0xc486a7(0x363)](_0x3b7d3a,0xa));if(!dbPool)try{if(_0xc486a7(0x337)!==_0xc486a7(0x337))_0x1e6845[_0xc486a7(0x1aa)](0x1f4)['json']({'error':_0x131021['message']});else return await updateRow(_0x426fda[_0xc486a7(0x204)],_0x5f5dd6['params']['id'],_0x22fa53),_0x4aaab2[_0xc486a7(0x33d)]({'success':!![]});}catch(_0x1c7ad4){if('eYEgK'!=='eYEgK')_0x362d21['error']('[DingTalk]\x20获取部门\x20'+_0x8cef1f+_0xc486a7(0x2e1),_0x1d58ae['message']);else return _0x4aaab2[_0xc486a7(0x1aa)](0x1f4)['json']({'error':_0x1c7ad4[_0xc486a7(0x2c8)]});}try{const _0x796f96=[_0x426fda[_0xc486a7(0x3ca)],_0xc486a7(0x315),'name',_0xc486a7(0x358),_0x426fda[_0xc486a7(0x31c)],'department',_0x426fda['VcuKg'],_0xc486a7(0x1aa),_0x426fda['kLpgh'],'join_date'],_0x449079=Object['keys'](_0x22fa53)['filter'](_0xd21065=>_0x796f96[_0xc486a7(0x232)](_0xd21065));if(!_0x449079['length'])return _0x4aaab2[_0xc486a7(0x33d)]({'success':!![]});const _0xac7690=_0x449079['map'](_0x57db1c=>_0x57db1c+_0xc486a7(0x399))[_0xc486a7(0x159)](',\x20'),_0x33e50=_0x449079['map'](_0x54a9a6=>_0x54a9a6===_0xc486a7(0x2d8)?JSON[_0xc486a7(0x192)](_0x22fa53[_0x54a9a6]):_0x22fa53[_0x54a9a6]);await dbPool['query']('UPDATE\x20users\x20SET\x20'+_0xac7690+_0xc486a7(0x29d),[..._0x33e50,_0x5f5dd6[_0xc486a7(0x166)]['id']]),_0x4aaab2['json']({'success':!![]});}catch(_0x152d8a){_0x4aaab2[_0xc486a7(0x1aa)](0x1f4)[_0xc486a7(0x33d)]({'error':_0x152d8a['message']});}}),app['delete'](_0x165f6e(0x222),async(_0x49f419,_0x4f7048)=>{const _0x1ca73d=_0x165f6e,_0xc8a2e3={'ozIaj':'IPyew'};if(!dbPool)try{return await deleteRow(_0x1ca73d(0x1f1),_0x49f419[_0x1ca73d(0x166)]['id']),_0x4f7048['json']({'success':!![]});}catch(_0x1c387a){if(_0xc8a2e3[_0x1ca73d(0x33e)]!==_0xc8a2e3[_0x1ca73d(0x33e)])_0x4781cf=null;else return _0x4f7048[_0x1ca73d(0x1aa)](0x1f4)['json']({'error':_0x1c387a[_0x1ca73d(0x2c8)]});}try{await dbPool['query']('DELETE\x20FROM\x20users\x20WHERE\x20id=?',[_0x49f419['params']['id']]),_0x4f7048[_0x1ca73d(0x33d)]({'success':!![]});}catch(_0x2b57d1){_0x4f7048[_0x1ca73d(0x1aa)](0x1f4)[_0x1ca73d(0x33d)]({'error':_0x2b57d1['message']});}}),app[_0x165f6e(0x1a2)](_0x165f6e(0x3e5),async(_0x547b98,_0xe5ef07)=>{const _0x4417a6=_0x165f6e,_0x2b9c42={'dIOXx':function(_0x1ca41a,_0x341306){return _0x1ca41a(_0x341306);}};if(!dbPool)try{const _0x40918d=await _0x2b9c42['dIOXx'](readTable,'company_info');return _0xe5ef07[_0x4417a6(0x33d)](_0x40918d[0x0]||{});}catch(_0xe3d5e4){return _0xe5ef07['status'](0x1f4)['json']({'error':_0xe3d5e4[_0x4417a6(0x2c8)]});}try{const [_0x4a424b]=await dbPool[_0x4417a6(0x1bc)](_0x4417a6(0x3d2));_0xe5ef07['json'](_0x4a424b[0x0]||{});}catch(_0x5722ca){_0xe5ef07['status'](0x1f4)[_0x4417a6(0x33d)]({'error':_0x5722ca['message']});}}),app['put']('/api/company-info',async(_0xccbc5e,_0xa98e61)=>{const _0x56042d=_0x165f6e,_0x40f499={'XGigT':_0x56042d(0x1b3),'NFDyZ':'prhJT','Pbzbo':'company_info','pECyv':function(_0x2924f8,_0x95d4d0,_0x4a7f6a,_0x375aee){return _0x2924f8(_0x95d4d0,_0x4a7f6a,_0x375aee);},'HSeGs':function(_0x390429,_0x131944,_0x3f75c8){return _0x390429(_0x131944,_0x3f75c8);},'thRzR':_0x56042d(0x3bc),'Qatlx':_0x56042d(0x395),'oAHBU':_0x56042d(0x245)},_0x135e82=_0xccbc5e[_0x56042d(0x188)]||{};if(!dbPool){if(_0x40f499['NFDyZ']===_0x40f499['NFDyZ'])try{const _0x2eeee8=await readTable(_0x40f499[_0x56042d(0x323)]);return _0x2eeee8[_0x56042d(0x2fb)]>0x0?await _0x40f499['pECyv'](updateRow,_0x40f499['Pbzbo'],_0x2eeee8[0x0]['id'],_0x135e82):await _0x40f499['HSeGs'](addRow,'company_info',_0x135e82),_0xa98e61['json']({'success':!![],..._0x135e82});}catch(_0x8afc7){return _0xa98e61[_0x56042d(0x1aa)](0x1f4)['json']({'error':_0x8afc7['message']});}else return _0x267b4e[_0x56042d(0x1aa)](0x190)[_0x56042d(0x33d)]({'error':_0x40f499[_0x56042d(0x2cd)]});}try{if(_0x40f499[_0x56042d(0x238)]!==_0x56042d(0x2d4)){const [_0x65cbd2]=await dbPool['query']('SELECT\x20id\x20FROM\x20company_info\x20LIMIT\x201'),_0x3aebcf=[_0x56042d(0x324),'address','phone','email',_0x56042d(0x310),'logo',_0x40f499[_0x56042d(0x125)],_0x56042d(0x317),_0x56042d(0x1b8),_0x40f499['oAHBU']];if(_0x65cbd2[_0x56042d(0x2fb)]>0x0){const _0x3b15ae=_0x3aebcf[_0x56042d(0x198)](_0xc4d7b4=>_0x135e82[_0xc4d7b4]!==undefined);if(_0x3b15ae['length']){const _0x15f639=_0x3b15ae[_0x56042d(0x2c4)](_0x8166c8=>_0x8166c8+'\x20=\x20?')['join'](',\x20'),_0x3c5a80=_0x3b15ae['map'](_0xc90b7f=>_0x135e82[_0xc90b7f]);await dbPool['query'](_0x56042d(0x379)+_0x15f639+_0x56042d(0x29d),[..._0x3c5a80,_0x65cbd2[0x0]['id']]);}}else{const _0x3ba13e=_0x3aebcf[_0x56042d(0x2c4)](_0x596c90=>_0x135e82[_0x596c90]??null);await dbPool['query']('INSERT\x20INTO\x20company_info\x20('+_0x3aebcf[_0x56042d(0x159)](',')+_0x56042d(0x174)+_0x3aebcf[_0x56042d(0x2c4)](()=>'?')['join'](',')+')',_0x3ba13e);}_0xa98e61['json']({'success':!![],..._0x135e82});}else return _0x18d39a[_0x56042d(0x1aa)](0x190)['json']({'success':![],'message':_0x56042d(0x26a)});}catch(_0x35d484){_0xa98e61['status'](0x1f4)[_0x56042d(0x33d)]({'error':_0x35d484['message']});}}),app[_0x165f6e(0x1a2)]('/api/templates',async(_0x34703a,_0x3e1f31)=>{const _0x1be177=_0x165f6e,_0x2be06f={'kkOnW':function(_0x5ad95f,_0x405863){return _0x5ad95f(_0x405863);},'tKgeO':'templates'};if(!dbPool)try{const _0x1e3e82=await _0x2be06f[_0x1be177(0x392)](readTable,_0x2be06f['tKgeO']);return _0x3e1f31['json'](_0x1e3e82);}catch(_0x328da5){return _0x3e1f31[_0x1be177(0x1aa)](0x1f4)['json']({'error':_0x328da5[_0x1be177(0x2c8)]});}try{const [_0xb524cd]=await dbPool['query']('SELECT\x20id,\x20name,\x20type,\x20description,\x20fields,\x20updated_at,\x20created_at\x20FROM\x20templates\x20ORDER\x20BY\x20id\x20DESC'),_0x2d2817=_0xb524cd['map'](_0x38f2f2=>({'id':_0x38f2f2['id'],'name':_0x38f2f2['name'],'type':_0x38f2f2['type'],'description':_0x38f2f2[_0x1be177(0x395)],'fields':safeParse(_0x38f2f2['fields'])||[],'updated_at':_0x38f2f2[_0x1be177(0x2f2)],'created_at':_0x38f2f2[_0x1be177(0x3d8)]}));_0x3e1f31[_0x1be177(0x33d)](_0x2d2817);}catch(_0x2bfe17){_0x3e1f31[_0x1be177(0x1aa)](0x1f4)[_0x1be177(0x33d)]({'error':_0x2bfe17['message']});}}),app[_0x165f6e(0x364)](_0x165f6e(0x271),async(_0x57996b,_0xb3734d)=>{const _0x2b9bfd=_0x165f6e,_0x491710={'lbYMN':_0x2b9bfd(0x127)};if(!dbPool)try{const _0xec7de1=_0x57996b['body']||{},_0x436f33=await addRow('templates',_0xec7de1);return _0xb3734d[_0x2b9bfd(0x1aa)](0xc9)[_0x2b9bfd(0x33d)](_0x436f33);}catch(_0x2762f4){return _0xb3734d['status'](0x1f4)['json']({'error':_0x2762f4[_0x2b9bfd(0x2c8)]});}try{const _0xe0f311=_0x57996b[_0x2b9bfd(0x188)]||{},_0x4916df=['name',_0x2b9bfd(0x2b9),'description',_0x491710['lbYMN'],_0x2b9bfd(0x2f2)],_0x3206d9=[_0xe0f311['name']??null,_0xe0f311['type']??null,_0xe0f311['description']??null,_0xe0f311[_0x2b9bfd(0x127)]!==undefined?JSON[_0x2b9bfd(0x192)](_0xe0f311['fields']):'[]',_0xe0f311[_0x2b9bfd(0x2f2)]??new Date()['toISOString']()],_0x877933=_0x4916df[_0x2b9bfd(0x2c4)](()=>'?')[_0x2b9bfd(0x159)](','),[_0x459a7a]=await dbPool['query']('INSERT\x20INTO\x20templates\x20('+_0x4916df[_0x2b9bfd(0x159)](',')+')\x20VALUES\x20('+_0x877933+')',_0x3206d9);_0xb3734d['status'](0xc9)['json']({'id':_0x459a7a[_0x2b9bfd(0x120)],..._0xe0f311});}catch(_0x584dde){_0xb3734d[_0x2b9bfd(0x1aa)](0x1f4)['json']({'error':_0x584dde['message']});}}),app[_0x165f6e(0x30e)](_0x165f6e(0x277),async(_0x1b581a,_0x5aacbf)=>{const _0x2ea4ae=_0x165f6e,_0x52f784={'NunQc':'description'};if(!dbPool)try{return await updateRow('templates',_0x1b581a[_0x2ea4ae(0x166)]['id'],_0x1b581a['body']||{}),_0x5aacbf[_0x2ea4ae(0x33d)]({'success':!![]});}catch(_0x5f0df4){return _0x5aacbf['status'](0x1f4)['json']({'error':_0x5f0df4[_0x2ea4ae(0x2c8)]});}try{const _0x35130c=_0x1b581a['body']||{},_0x181217=['name',_0x2ea4ae(0x2b9),_0x52f784['NunQc'],'fields','updated_at'],_0x2acb9e=Object[_0x2ea4ae(0x293)](_0x35130c)[_0x2ea4ae(0x198)](_0x5f58e8=>_0x181217['includes'](_0x5f58e8));if(!_0x2acb9e[_0x2ea4ae(0x2fb)])return _0x5aacbf[_0x2ea4ae(0x33d)]({'success':!![]});const _0x2e994c=_0x2acb9e['map'](_0x462eb4=>_0x462eb4+'\x20=\x20?')[_0x2ea4ae(0x159)](',\x20'),_0xbc817e=_0x2acb9e['map'](_0x3ff977=>_0x3ff977==='fields'?JSON[_0x2ea4ae(0x192)](_0x35130c[_0x3ff977]??[]):_0x35130c[_0x3ff977]);await dbPool[_0x2ea4ae(0x1bc)](_0x2ea4ae(0x29c)+_0x2e994c+_0x2ea4ae(0x29d),[..._0xbc817e,_0x1b581a[_0x2ea4ae(0x166)]['id']]),_0x5aacbf['json']({'success':!![]});}catch(_0x368f33){_0x5aacbf[_0x2ea4ae(0x1aa)](0x1f4)['json']({'error':_0x368f33[_0x2ea4ae(0x2c8)]});}}),app[_0x165f6e(0x231)]('/api/templates/:id',async(_0x417528,_0x2bf9ca)=>{const _0x3d6f5f=_0x165f6e,_0x521197={'GUuVf':_0x3d6f5f(0x30a),'eoOhY':function(_0x5a61f2,_0x51b8e6,_0x58eb7b){return _0x5a61f2(_0x51b8e6,_0x58eb7b);},'CThSY':'templates'};if(!dbPool)try{return await _0x521197['eoOhY'](deleteRow,_0x521197[_0x3d6f5f(0x25d)],_0x417528[_0x3d6f5f(0x166)]['id']),_0x2bf9ca['json']({'success':!![]});}catch(_0x449a51){if('jeFLL'!==_0x3d6f5f(0x19b))return _0x2bf9ca['status'](0x1f4)['json']({'error':_0x449a51['message']});else{if(!_0x2ff98d['file'])return _0x23afa8[_0x3d6f5f(0x1aa)](0x190)[_0x3d6f5f(0x33d)]({'error':_0x521197[_0x3d6f5f(0x335)]});const _0x309fe3=_0x3d6f5f(0x163)+_0x5b8e3e[_0x3d6f5f(0x193)][_0x3d6f5f(0x142)];_0x49dbc9['json']({'success':!![],'url':_0x309fe3,'filename':_0x151f16['file']['filename'],'originalname':_0x126715['file']['originalname'],'size':_0x3b75e0['file'][_0x3d6f5f(0x2f9)]});}}try{await dbPool['query'](_0x3d6f5f(0x27d),[_0x417528[_0x3d6f5f(0x166)]['id']]),_0x2bf9ca['json']({'success':!![]});}catch(_0x412be0){_0x2bf9ca[_0x3d6f5f(0x1aa)](0x1f4)[_0x3d6f5f(0x33d)]({'error':_0x412be0['message']});}}),app['get'](_0x165f6e(0x2bf),async(_0x1a2034,_0x536be9)=>{const _0x8004bb=_0x165f6e,_0x546185={'bXFzl':'ER_DUP_ENTRY','PFxoK':function(_0x33b569,_0x22930b){return _0x33b569(_0x22930b);},'jjWbL':'monthly_progress','igqQF':'qKrLe','ThLGy':function(_0x4d3ccc,_0x4a1ccb){return _0x4d3ccc===_0x4a1ccb;},'aCWLK':_0x8004bb(0x28c),'BXJHO':'year\x20=\x20?','MqKgg':'month\x20=\x20?','nMznO':'department\x20=\x20?'};if(!dbPool)try{const {year:_0x23eaa4,month:_0x3d00f6,department:_0x5c7db2,status:_0x1c3509}=_0x1a2034[_0x8004bb(0x1bc)]||{};let _0x3f0944=await _0x546185['PFxoK'](readTable,_0x546185[_0x8004bb(0x1e4)]);if(_0x23eaa4)_0x3f0944=_0x3f0944[_0x8004bb(0x198)](_0xd694a9=>Number(_0xd694a9[_0x8004bb(0x281)])===Number(_0x23eaa4));if(_0x3d00f6)_0x3f0944=_0x3f0944[_0x8004bb(0x198)](_0x3adca8=>Number(_0x3adca8[_0x8004bb(0x239)])===Number(_0x3d00f6));if(_0x5c7db2)_0x3f0944=_0x3f0944[_0x8004bb(0x198)](_0x58f19a=>String(_0x58f19a['department'])===String(_0x5c7db2));if(_0x1c3509)_0x3f0944=_0x3f0944['filter'](_0x3266a4=>String(_0x3266a4['status'])===String(_0x1c3509));return _0x536be9[_0x8004bb(0x33d)](_0x3f0944);}catch(_0x201bee){if('qKrLe'!==_0x546185['igqQF']){if(_0x23737f[_0x8004bb(0x325)]===_0x546185['bXFzl'])return _0x42ffed['status'](0x190)['json']({'error':'部门编码已存在'});_0x2187e7['status'](0x1f4)['json']({'error':_0x1bfc05['message']});}else return _0x536be9[_0x8004bb(0x1aa)](0x1f4)['json']({'error':_0x201bee[_0x8004bb(0x2c8)]});}try{if(_0x546185[_0x8004bb(0x274)](_0x546185[_0x8004bb(0x148)],'XdhWW'))return _0x523a70[_0x8004bb(0x1aa)](0x1f4)[_0x8004bb(0x33d)]({'error':_0x12aae4[_0x8004bb(0x2c8)]});else{const {year:_0x30e194,month:_0x1bf226,department:_0x37a800,status:_0xd32603}=_0x1a2034['query']||{},_0x30b34e=[],_0x40ae63=[];_0x30e194&&(_0x30b34e['push'](_0x546185[_0x8004bb(0x36d)]),_0x40ae63['push'](Number(_0x30e194)));_0x1bf226&&(_0x30b34e['push'](_0x546185[_0x8004bb(0x1a6)]),_0x40ae63[_0x8004bb(0x2f4)](Number(_0x1bf226)));_0x37a800&&(_0x30b34e[_0x8004bb(0x2f4)](_0x546185['nMznO']),_0x40ae63['push'](String(_0x37a800)));_0xd32603&&(_0x30b34e[_0x8004bb(0x2f4)](_0x8004bb(0x2d3)),_0x40ae63[_0x8004bb(0x2f4)](String(_0xd32603)));const _0x1b5467='SELECT\x20*\x20FROM\x20monthly_progress'+(_0x30b34e[_0x8004bb(0x2fb)]?'\x20WHERE\x20'+_0x30b34e['join']('\x20AND\x20'):'')+_0x8004bb(0x1fa),[_0x25a309]=await dbPool['query'](_0x1b5467,_0x40ae63);_0x536be9['json'](_0x25a309);}}catch(_0x5b14bc){_0x536be9[_0x8004bb(0x1aa)](0x1f4)[_0x8004bb(0x33d)]({'error':_0x5b14bc['message']});}}),app['post'](_0x165f6e(0x2bf),async(_0x563e71,_0x418d57)=>{const _0x413d27=_0x165f6e,_0x4cd118={'TXJLM':'month','uHZTU':function(_0x530869,_0x27055f,_0x11ade1){return _0x530869(_0x27055f,_0x11ade1);},'REisf':_0x413d27(0x356),'ONnJQ':_0x413d27(0x342),'XGGbJ':_0x413d27(0x281),'BkPNN':'department','Hnuky':_0x413d27(0x3b0),'zXELN':'start_date','KRsmH':_0x413d27(0x377),'sOFES':_0x413d27(0x31f)};if(!dbPool)try{const _0x4a75b2=_0x563e71[_0x413d27(0x188)]||{},_0x1335da=[_0x413d27(0x281),_0x4cd118[_0x413d27(0x124)],_0x413d27(0x342)],_0x39d974=_0x1335da[_0x413d27(0x198)](_0x4f0313=>!_0x4a75b2[_0x4f0313]&&_0x4a75b2[_0x4f0313]!==0x0);if(_0x39d974['length'])return _0x418d57[_0x413d27(0x1aa)](0x190)['json']({'error':'缺少必填项:\x20'+_0x39d974['join'](',\x20')});const _0xfac258=await _0x4cd118['uHZTU'](addRow,_0x4cd118['REisf'],_0x4a75b2);return _0x418d57['status'](0xc9)['json'](_0xfac258);}catch(_0x143bbc){return _0x418d57[_0x413d27(0x1aa)](0x1f4)['json']({'error':_0x143bbc['message']});}try{const _0x448dd7=_0x563e71['body']||{},_0x52afd2=[_0x413d27(0x281),_0x4cd118['TXJLM'],_0x4cd118[_0x413d27(0x126)]],_0x33c9ca=_0x52afd2[_0x413d27(0x198)](_0x1831d2=>!_0x448dd7[_0x1831d2]&&_0x448dd7[_0x1831d2]!==0x0);if(_0x33c9ca['length'])return _0x418d57['status'](0x190)[_0x413d27(0x33d)]({'error':'缺少必填项:\x20'+_0x33c9ca['join'](',\x20')});const _0x541501=[_0x4cd118['XGGbJ'],_0x4cd118['TXJLM'],_0x4cd118['BkPNN'],'task_name',_0x413d27(0x1dc),_0x4cd118['Hnuky'],_0x413d27(0x1aa),_0x413d27(0x213),_0x4cd118['zXELN'],_0x4cd118[_0x413d27(0x28a)],'key_activities',_0x4cd118['sOFES'],'challenges',_0x413d27(0x330),'support_needed'],_0x56b077=_0x541501[_0x413d27(0x2c4)](_0x2261b8=>_0x448dd7[_0x2261b8]??null),_0x1f2c17=_0x541501[_0x413d27(0x2c4)](()=>'?')['join'](','),[_0x6decf7]=await dbPool[_0x413d27(0x1bc)]('INSERT\x20INTO\x20monthly_progress\x20(`'+_0x541501[_0x413d27(0x159)](_0x413d27(0x1cb))+_0x413d27(0x13b)+_0x1f2c17+')',_0x56b077);_0x418d57['status'](0xc9)[_0x413d27(0x33d)]({'id':_0x6decf7['insertId'],..._0x448dd7});}catch(_0x24ed52){_0x418d57[_0x413d27(0x1aa)](0x1f4)['json']({'error':_0x24ed52['message']});}}),app['put']('/api/monthly-progress/:id',async(_0x536612,_0x20a403)=>{const _0x2006cf=_0x165f6e,_0x77b0c1={'izXqE':function(_0x1bfd06,_0x59a2e6){return _0x1bfd06===_0x59a2e6;},'pHTMY':_0x2006cf(0x356),'cXCEH':_0x2006cf(0x281),'ywfCh':_0x2006cf(0x34e),'tygav':'actual_value','FdKvf':'status','Vacah':'next_month_plan'};if(!dbPool){if(_0x77b0c1[_0x2006cf(0x3bb)]('HIzrh','Kghxs'))_0x274cf4['error']('Insert\x20major_event\x20failed:',_0x120e47),_0x1afedd['status'](0x1f4)['json']({'error':_0x27c7b9[_0x2006cf(0x2c8)]});else try{return await updateRow(_0x77b0c1[_0x2006cf(0x256)],_0x536612['params']['id'],_0x536612['body']||{}),_0x20a403['json']({'success':!![]});}catch(_0x129002){return _0x20a403['status'](0x1f4)[_0x2006cf(0x33d)]({'error':_0x129002[_0x2006cf(0x2c8)]});}}try{const _0x1371c2=[_0x77b0c1[_0x2006cf(0x296)],_0x2006cf(0x239),_0x77b0c1['ywfCh'],_0x2006cf(0x342),'target_value',_0x77b0c1['tygav'],_0x77b0c1['FdKvf'],_0x2006cf(0x213),_0x2006cf(0x368),'end_date','key_activities',_0x2006cf(0x31f),'challenges',_0x77b0c1[_0x2006cf(0x33b)],'support_needed'],{setSql:_0x37e354,values:_0x217a4a}=buildSafeUpdate(_0x536612[_0x2006cf(0x188)]||{},_0x1371c2);if(!_0x37e354)return _0x20a403['json']({'success':!![]});await dbPool['query']('UPDATE\x20monthly_progress\x20SET\x20'+_0x37e354+_0x2006cf(0x29d),[..._0x217a4a,_0x536612[_0x2006cf(0x166)]['id']]),_0x20a403[_0x2006cf(0x33d)]({'success':!![]});}catch(_0x327f9c){_0x20a403[_0x2006cf(0x1aa)](0x1f4)['json']({'error':_0x327f9c[_0x2006cf(0x2c8)]});}}),app['delete'](_0x165f6e(0x1c6),async(_0x2c6a01,_0x30c6f8)=>{const _0xb5f453=_0x165f6e,_0x417872={'foQMy':function(_0x507e53,_0x5c52f7,_0x1b2376){return _0x507e53(_0x5c52f7,_0x1b2376);},'Nbkcc':'DELETE\x20FROM\x20monthly_progress\x20WHERE\x20id=?'};if(!dbPool)try{return await _0x417872['foQMy'](deleteRow,_0xb5f453(0x356),_0x2c6a01[_0xb5f453(0x166)]['id']),_0x30c6f8['json']({'success':!![]});}catch(_0x1f93aa){return _0x30c6f8['status'](0x1f4)[_0xb5f453(0x33d)]({'error':_0x1f93aa[_0xb5f453(0x2c8)]});}try{await dbPool['query'](_0x417872[_0xb5f453(0x183)],[_0x2c6a01[_0xb5f453(0x166)]['id']]),_0x30c6f8[_0xb5f453(0x33d)]({'success':!![]});}catch(_0x34df52){_0x30c6f8['status'](0x1f4)[_0xb5f453(0x33d)]({'error':_0x34df52[_0xb5f453(0x2c8)]});}}),app['get'](_0x165f6e(0x1f4),async(_0x557078,_0x2a2626)=>{const _0x3640b1=_0x165f6e,_0x11d493={'vbcIw':function(_0x3fd782,_0xa4e7b5){return _0x3fd782!==_0xa4e7b5;},'ijSyE':_0x3640b1(0x36f),'IwPbe':_0x3640b1(0x24e),'YRvPj':function(_0x1b5195,_0x2ae958){return _0x1b5195(_0x2ae958);}};if(!dbPool){if(_0x11d493['vbcIw'](_0x11d493[_0x3640b1(0x1ab)],'hQfWj'))try{if(_0x3640b1(0x24e)!==_0x11d493[_0x3640b1(0x115)])_0xc867ab[_0x3640b1(0x1aa)](0x1f4)[_0x3640b1(0x33d)]({'error':_0x425fbc['message']});else{const {year:_0x42d842,department:_0x70a79,targetType:_0x2a299e}=_0x557078[_0x3640b1(0x1bc)]||{};let _0x68889a=await _0x11d493['YRvPj'](readTable,_0x3640b1(0x29b));if(_0x42d842)_0x68889a=_0x68889a[_0x3640b1(0x198)](_0x463b07=>Number(_0x463b07['year'])===Number(_0x42d842));if(_0x70a79)_0x68889a=_0x68889a[_0x3640b1(0x198)](_0x36d6e6=>String(_0x36d6e6['department'])===String(_0x70a79));if(_0x2a299e)_0x68889a=_0x68889a['filter'](_0x522328=>String(_0x522328['target_type'])===String(_0x2a299e));return _0x2a2626[_0x3640b1(0x33d)](_0x68889a);}}catch(_0x575fc3){return _0x2a2626['status'](0x1f4)['json']({'error':_0x575fc3[_0x3640b1(0x2c8)]});}else return _0x2a810d[_0x3640b1(0x1aa)](0x1f4)['json']({'error':_0x32e50a[_0x3640b1(0x2c8)]});}try{const {year:_0x81a9f3,department:_0x5bfffe,targetType:_0x1317ca}=_0x557078[_0x3640b1(0x1bc)]||{},_0x379343=[],_0x53ebba=[];_0x81a9f3&&(_0x379343['push']('year\x20=\x20?'),_0x53ebba['push'](Number(_0x81a9f3)));_0x5bfffe&&(_0x379343[_0x3640b1(0x2f4)](_0x3640b1(0x25b)),_0x53ebba[_0x3640b1(0x2f4)](String(_0x5bfffe)));_0x1317ca&&(_0x379343['push']('target_type\x20=\x20?'),_0x53ebba[_0x3640b1(0x2f4)](_0x11d493[_0x3640b1(0x157)](String,_0x1317ca)));const _0x441f6d=_0x3640b1(0x339)+(_0x379343[_0x3640b1(0x2fb)]?_0x3640b1(0x164)+_0x379343[_0x3640b1(0x159)]('\x20AND\x20'):'')+_0x3640b1(0x1fa),[_0x50962f]=await dbPool['query'](_0x441f6d,_0x53ebba);_0x2a2626['json'](_0x50962f);}catch(_0x4ab5ad){_0x2a2626[_0x3640b1(0x1aa)](0x1f4)['json']({'error':_0x4ab5ad[_0x3640b1(0x2c8)]});}}),app['post']('/api/department-targets',async(_0x235e61,_0xc07bf5)=>{const _0x110886=_0x165f6e,_0x35ea22={'mpjlt':'department_id','czxhp':_0x110886(0x1f8),'MArAM':'unit','bIanB':'month','xsfgc':'completion_rate','Swujz':_0x110886(0x213),'xOpdl':function(_0x5367eb,_0x88b9b3,_0xe50f3e){return _0x5367eb(_0x88b9b3,_0xe50f3e);},'UepSZ':_0x110886(0x281),'vIivS':_0x110886(0x1dc),'zESpu':_0x110886(0x216),'tFjNb':_0x110886(0x395),'qhOFV':'`,`'};if(!dbPool)try{const _0x210577=_0x235e61[_0x110886(0x188)]||{},_0x1bd7e3=['year',_0x35ea22['mpjlt'],_0x35ea22[_0x110886(0x341)]],_0x47fae8=_0x1bd7e3[_0x110886(0x198)](_0x58de06=>!_0x210577[_0x58de06]&&_0x210577[_0x58de06]!==0x0);if(_0x47fae8['length'])return _0xc07bf5['status'](0x190)['json']({'error':'缺少必填项:\x20'+_0x47fae8[_0x110886(0x159)](',\x20')});const _0x35ed39=_0x210577[_0x110886(0x34e)]||null,_0x32dc8d=['year','department_id',_0x110886(0x34e),_0x110886(0x301),_0x35ea22['czxhp'],_0x110886(0x1d3),'target_value',_0x35ea22[_0x110886(0x12a)],_0x110886(0x216),_0x35ea22['bIanB'],'current_value',_0x35ea22[_0x110886(0x15d)],_0x35ea22[_0x110886(0x30f)],'description'],_0x5351ff={};_0x32dc8d['forEach'](_0xd2f489=>_0x5351ff[_0xd2f489]=_0x210577[_0xd2f489]??(_0xd2f489===_0x110886(0x34e)?_0x35ed39:null));const _0x4136a=await _0x35ea22[_0x110886(0x3ad)](addRow,_0x110886(0x29b),_0x5351ff);return _0xc07bf5[_0x110886(0x1aa)](0xc9)[_0x110886(0x33d)](_0x4136a);}catch(_0x2cb359){return _0xc07bf5[_0x110886(0x1aa)](0x1f4)['json']({'error':_0x2cb359['message']});}try{const _0x10b421=_0x235e61[_0x110886(0x188)]||{},_0x124ec1=[_0x35ea22[_0x110886(0x30d)],_0x35ea22['mpjlt'],'target_type'],_0x5c3631=_0x124ec1[_0x110886(0x198)](_0x49bdb2=>!_0x10b421[_0x49bdb2]&&_0x10b421[_0x49bdb2]!==0x0);if(_0x5c3631[_0x110886(0x2fb)])return _0xc07bf5[_0x110886(0x1aa)](0x190)[_0x110886(0x33d)]({'error':_0x110886(0x176)+_0x5c3631['join'](',\x20')});const _0x6ca084=_0x10b421['department']||null,_0xf8ea9d=[_0x35ea22[_0x110886(0x30d)],'department_id','department',_0x110886(0x301),_0x110886(0x1f8),_0x110886(0x1d3),_0x35ea22['vIivS'],'unit',_0x35ea22[_0x110886(0x3b9)],'month','current_value','completion_rate',_0x110886(0x213),_0x35ea22[_0x110886(0x373)]],_0xcac168=_0xf8ea9d[_0x110886(0x2c4)](_0x195ea2=>_0x10b421[_0x195ea2]??(_0x195ea2===_0x110886(0x34e)?_0x6ca084:null)),_0x177b8a=_0xf8ea9d[_0x110886(0x2c4)](()=>'?')[_0x110886(0x159)](','),[_0x441548]=await dbPool[_0x110886(0x1bc)]('INSERT\x20INTO\x20department_targets\x20(`'+_0xf8ea9d[_0x110886(0x159)](_0x35ea22[_0x110886(0x19f)])+'`)\x20VALUES\x20('+_0x177b8a+')',_0xcac168);_0xc07bf5['status'](0xc9)[_0x110886(0x33d)]({'id':_0x441548['insertId'],..._0x10b421});}catch(_0x688aa6){_0xc07bf5['status'](0x1f4)[_0x110886(0x33d)]({'error':_0x688aa6['message']});}}),app['put']('/api/department-targets/:id',async(_0x55b7f3,_0x4ec3ec)=>{const _0x2cb9b9=_0x165f6e,_0xcd5fac={'zQvFI':_0x2cb9b9(0x34e),'XZvTF':'target_level','rEYfA':'target_type','Adpgf':'target_name','oVEFZ':'target_value','QFLrS':'unit','ZoYEl':'month','RRYCl':function(_0xd9266f,_0x1fc779,_0x1a2154){return _0xd9266f(_0x1fc779,_0x1a2154);},'ahXfd':function(_0x225230,_0x485ba9){return _0x225230!==_0x485ba9;}};if(!dbPool)try{return await updateRow('department_targets',_0x55b7f3[_0x2cb9b9(0x166)]['id'],_0x55b7f3[_0x2cb9b9(0x188)]||{}),_0x4ec3ec['json']({'success':!![]});}catch(_0x2b102a){return _0x4ec3ec['status'](0x1f4)['json']({'error':_0x2b102a[_0x2cb9b9(0x2c8)]});}try{const _0x53c50a=['year',_0x2cb9b9(0x1b9),_0xcd5fac[_0x2cb9b9(0x21b)],_0xcd5fac[_0x2cb9b9(0x132)],_0xcd5fac['rEYfA'],_0xcd5fac['Adpgf'],_0xcd5fac[_0x2cb9b9(0x22f)],_0xcd5fac['QFLrS'],_0x2cb9b9(0x216),_0xcd5fac[_0x2cb9b9(0x2a2)],_0x2cb9b9(0x14e),_0x2cb9b9(0x376),_0x2cb9b9(0x213),'description'],{setSql:_0x9619d0,values:_0x508aea}=_0xcd5fac[_0x2cb9b9(0x2a8)](buildSafeUpdate,_0x55b7f3['body']||{},_0x53c50a);if(!_0x9619d0)return _0x4ec3ec['json']({'success':!![]});await dbPool['query'](_0x2cb9b9(0x1e8)+_0x9619d0+'\x20WHERE\x20id=?',[..._0x508aea,_0x55b7f3[_0x2cb9b9(0x166)]['id']]),_0x4ec3ec['json']({'success':!![]});}catch(_0x111549){if(_0xcd5fac['ahXfd'](_0x2cb9b9(0x391),_0x2cb9b9(0x391)))return _0x503f75[_0x2cb9b9(0x1aa)](0x1f4)[_0x2cb9b9(0x33d)]({'error':_0x475094[_0x2cb9b9(0x2c8)]});else _0x4ec3ec[_0x2cb9b9(0x1aa)](0x1f4)['json']({'error':_0x111549['message']});}}),app[_0x165f6e(0x231)](_0x165f6e(0x145),async(_0x3d19c7,_0x562c5b)=>{const _0x3da752=_0x165f6e;if(!dbPool)try{return await deleteRow('department_targets',_0x3d19c7[_0x3da752(0x166)]['id']),_0x562c5b[_0x3da752(0x33d)]({'success':!![]});}catch(_0x3c08c9){return _0x562c5b['status'](0x1f4)['json']({'error':_0x3c08c9['message']});}try{_0x3da752(0x203)===_0x3da752(0x203)?(await dbPool['query']('DELETE\x20FROM\x20department_targets\x20WHERE\x20id=?',[_0x3d19c7['params']['id']]),_0x562c5b[_0x3da752(0x33d)]({'success':!![]})):(_0x50e8db[_0x3da752(0x2f4)](_0x3da752(0x33f)),_0x17df3d[_0x3da752(0x2f4)](_0x2ded73));}catch(_0x31a5be){_0x562c5b[_0x3da752(0x1aa)](0x1f4)['json']({'error':_0x31a5be[_0x3da752(0x2c8)]});}}),app['get'](_0x165f6e(0x268),async(_0x4f4a45,_0x47580d)=>{const _0x51da2c=_0x165f6e,_0x42b966={'zwjmw':function(_0x343b81,_0x44a5d6){return _0x343b81(_0x44a5d6);},'EBiUd':'action_plans','FgzmL':'year\x20=\x20?','powRG':_0x51da2c(0x3da),'CSZUs':function(_0x538e79,_0x9be5cd){return _0x538e79+_0x9be5cd;},'lPlfY':_0x51da2c(0x164),'VBOQX':_0x51da2c(0x242)};if(!dbPool)try{const {year:_0x5dc2cf,department:_0x3c0849,status:_0x30e158,priority:_0x14e055}=_0x4f4a45['query']||{};let _0x1c5762=await _0x42b966[_0x51da2c(0x153)](readTable,_0x42b966[_0x51da2c(0x247)]);if(_0x5dc2cf)_0x1c5762=_0x1c5762[_0x51da2c(0x198)](_0x49b3be=>Number(_0x49b3be[_0x51da2c(0x281)])===Number(_0x5dc2cf));if(_0x3c0849)_0x1c5762=_0x1c5762[_0x51da2c(0x198)](_0x87924a=>String(_0x87924a[_0x51da2c(0x34e)])===String(_0x3c0849));if(_0x30e158)_0x1c5762=_0x1c5762['filter'](_0x4d0796=>String(_0x4d0796['status'])===String(_0x30e158));if(_0x14e055)_0x1c5762=_0x1c5762['filter'](_0x5257cc=>String(_0x5257cc['priority'])===String(_0x14e055));return _0x47580d['json'](_0x1c5762);}catch(_0x3d628c){return _0x47580d['status'](0x1f4)['json']({'error':_0x3d628c[_0x51da2c(0x2c8)]});}try{const {year:_0x45f2f2,department:_0x473275,status:_0x1a6ba0,priority:_0x330084}=_0x4f4a45[_0x51da2c(0x1bc)]||{},_0x38b502=[],_0x3e1ab8=[];_0x45f2f2&&(_0x38b502['push'](_0x42b966[_0x51da2c(0x220)]),_0x3e1ab8[_0x51da2c(0x2f4)](Number(_0x45f2f2)));_0x473275&&(_0x38b502[_0x51da2c(0x2f4)]('department\x20=\x20?'),_0x3e1ab8['push'](String(_0x473275)));_0x1a6ba0&&(_0x38b502[_0x51da2c(0x2f4)](_0x51da2c(0x2d3)),_0x3e1ab8[_0x51da2c(0x2f4)](String(_0x1a6ba0)));_0x330084&&(_0x38b502['push'](_0x42b966[_0x51da2c(0x326)]),_0x3e1ab8[_0x51da2c(0x2f4)](String(_0x330084)));const _0x25da11=_0x51da2c(0x3cf)+(_0x38b502[_0x51da2c(0x2fb)]?_0x42b966['CSZUs'](_0x42b966['lPlfY'],_0x38b502[_0x51da2c(0x159)]('\x20AND\x20')):'')+_0x51da2c(0x1fa),[_0x343b49]=await dbPool['query'](_0x25da11,_0x3e1ab8);_0x47580d['json'](_0x343b49);}catch(_0x101204){if(_0x42b966['VBOQX']!==_0x51da2c(0x1e3))_0x47580d[_0x51da2c(0x1aa)](0x1f4)['json']({'error':_0x101204[_0x51da2c(0x2c8)]});else{const _0x9bb8ee=_0x3a221b['headers'][_0x51da2c(0x14b)]||'',_0x18aec0=_0x9bb8ee['match'](/^Bearer\s+(.+)$/);if(_0x18aec0)try{const _0x25a366=_0x2a1817['verify'](_0x18aec0[0x1],_0x44be08);_0x2e4632=_0x25a366?.[_0x51da2c(0x1ef)]||_0x1d7c3b,_0x497907=_0x25a366?.['role']||_0x540f91;}catch(_0x30ce49){}}}}),app[_0x165f6e(0x1a2)](_0x165f6e(0x31e),async(_0x320585,_0x27860e)=>{const _0xe23596=_0x165f6e,_0x4e5098={'PncFa':function(_0xe8d0a6,_0x6f38e8){return _0xe8d0a6(_0x6f38e8);},'oivbR':_0xe23596(0x182),'ZEgYn':_0xe23596(0x2bb),'FsKRl':'year\x20=\x20?','hStxV':function(_0x34f709,_0x50a41c){return _0x34f709(_0x50a41c);},'iSGez':'sheet_type\x20=\x20?'};if(!dbPool)try{const {year:_0x460eab,sheet_type:_0xd6bbe6,month:_0x35de9e}=_0x320585['query']||{};let _0x4fb762=await _0x4e5098['PncFa'](readTable,_0x4e5098[_0xe23596(0x26c)]);if(_0x460eab)_0x4fb762=_0x4fb762[_0xe23596(0x198)](_0x113227=>Number(_0x113227[_0xe23596(0x281)])===Number(_0x460eab));if(_0xd6bbe6)_0x4fb762=_0x4fb762['filter'](_0x499cb6=>String(_0x499cb6[_0xe23596(0x37b)])===String(_0xd6bbe6));if(_0x35de9e)_0x4fb762=_0x4fb762['filter'](_0xa87dc5=>Number(_0xa87dc5[_0xe23596(0x239)])===Number(_0x35de9e));return _0x27860e['json'](_0x4fb762);}catch(_0x17d607){return _0x27860e['status'](0x1f4)[_0xe23596(0x33d)]({'error':_0x17d607[_0xe23596(0x2c8)]});}try{const {year:_0x15a113,sheet_type:_0xe29672,month:_0x3acaf7}=_0x320585['query']||{},_0x36d05e=[],_0xed95e9=[];_0x15a113&&(_0xe23596(0x353)===_0x4e5098[_0xe23596(0x113)]?_0x5beb61[_0xe23596(0x1aa)](0x1f4)[_0xe23596(0x33d)]({'error':_0x360462['message']}):(_0x36d05e[_0xe23596(0x2f4)](_0x4e5098[_0xe23596(0x1ad)]),_0xed95e9['push'](_0x4e5098['hStxV'](Number,_0x15a113))));_0xe29672&&(_0xe23596(0x29f)!==_0xe23596(0x2f6)?(_0x36d05e['push'](_0x4e5098[_0xe23596(0x267)]),_0xed95e9['push'](String(_0xe29672))):_0x49816d=_0x185515[_0xe23596(0x198)](_0x1765c9=>(_0x1765c9[_0xe23596(0x2b9)]||_0xe23596(0x3d4))===_0x20bb10));_0x3acaf7&&(_0x36d05e[_0xe23596(0x2f4)](_0xe23596(0x190)),_0xed95e9['push'](Number(_0x3acaf7)));const _0x547970=_0xe23596(0x39c)+(_0x36d05e['length']?'\x20WHERE\x20'+_0x36d05e['join'](_0xe23596(0x39d)):'')+_0xe23596(0x1fa),[_0x663628]=await dbPool['query'](_0x547970,_0xed95e9);_0x27860e['json'](_0x663628);}catch(_0x384014){_0x27860e['status'](0x1f4)[_0xe23596(0x33d)]({'error':_0x384014[_0xe23596(0x2c8)]});}}),app['post'](_0x165f6e(0x31e),async(_0x25b53f,_0x210c0e)=>{const _0x1ed036=_0x165f6e,_0x993dc={'HpXaT':_0x1ed036(0x239),'Wyadk':'department_name','HVkGC':_0x1ed036(0x368),'KGrTo':'end_date','bSUwr':_0x1ed036(0x1aa),'FlxhH':'goals','haiWI':_0x1ed036(0x137),'nRHTT':'notes','zATmh':'expected_result','ljZUq':'Insert\x20annual_work_plans\x20failed:'};if(!dbPool)try{const _0x4d6860=await addRow('annual_work_plans',_0x25b53f['body']||{});return _0x210c0e[_0x1ed036(0x1aa)](0xc9)['json'](_0x4d6860);}catch(_0x1b83ec){return _0x210c0e['status'](0x1f4)['json']({'error':_0x1b83ec[_0x1ed036(0x2c8)]});}try{const _0x8e48f6=_0x25b53f[_0x1ed036(0x188)]||{},_0x49cdb4=['sheet_type',_0x1ed036(0x281),_0x993dc['HpXaT'],'department_id',_0x993dc['Wyadk'],'plan_name',_0x1ed036(0x173),'priority',_0x993dc[_0x1ed036(0x3b8)],_0x993dc[_0x1ed036(0x34a)],'budget',_0x993dc['bSUwr'],'responsible_person',_0x1ed036(0x304),_0x993dc[_0x1ed036(0x39a)],_0x993dc['haiWI'],_0x1ed036(0x147),_0x1ed036(0x16c),'responsible',_0x993dc[_0x1ed036(0x14a)],_0x993dc[_0x1ed036(0x2b0)],_0x1ed036(0x269)],_0x4d1857=Object[_0x1ed036(0x293)](_0x8e48f6)[_0x1ed036(0x198)](_0x16190a=>_0x49cdb4[_0x1ed036(0x232)](_0x16190a));if(!_0x4d1857[_0x1ed036(0x2fb)])return _0x210c0e['status'](0x190)['json']({'error':_0x1ed036(0x2d7)});const _0xdc80eb=_0x4d1857['map'](_0x3dd3a4=>_0x8e48f6[_0x3dd3a4]),_0x2e028a=_0x1ed036(0x24d)+_0x4d1857[_0x1ed036(0x159)](_0x1ed036(0x1cb))+_0x1ed036(0x13b)+_0x4d1857['map'](()=>'?')[_0x1ed036(0x159)](',')+')',[_0x411e3f]=await dbPool[_0x1ed036(0x1bc)](_0x2e028a,_0xdc80eb);_0x210c0e[_0x1ed036(0x1aa)](0xc9)['json']({'id':_0x411e3f['insertId'],..._0x8e48f6});}catch(_0x4ee19a){console[_0x1ed036(0x3bf)](_0x993dc[_0x1ed036(0x152)],_0x4ee19a),_0x210c0e[_0x1ed036(0x1aa)](0x1f4)['json']({'error':_0x4ee19a['message']});}}),app['put'](_0x165f6e(0x1d9),async(_0x54fa41,_0xd882c2)=>{const _0x26859f=_0x165f6e,_0x5db85f={'smlHt':_0x26859f(0x1e1),'SYGgm':function(_0x1e4537,_0x3d9b9a,_0x51260f,_0x208335){return _0x1e4537(_0x3d9b9a,_0x51260f,_0x208335);},'ZUZwv':_0x26859f(0x182),'xVZgM':_0x26859f(0x281),'EkOeN':'department_id','qbtwZ':_0x26859f(0x37c),'aCgOO':'tasks','pSmLI':_0x26859f(0x147),'hoRMm':'responsible','pJlxx':_0x26859f(0x187),'GHtHK':_0x26859f(0x269)};if(!dbPool)try{if(_0x5db85f[_0x26859f(0x16e)]===_0x5db85f[_0x26859f(0x16e)])return await _0x5db85f[_0x26859f(0x360)](updateRow,_0x5db85f['ZUZwv'],_0x54fa41[_0x26859f(0x166)]['id'],_0x54fa41['body']||{}),_0xd882c2[_0x26859f(0x33d)]({'success':!![]});else _0x2e1028[_0x26859f(0x1aa)](0x1f4)[_0x26859f(0x33d)]({'error':_0x4a82dd[_0x26859f(0x2c8)]});}catch(_0x2eb26b){return _0xd882c2['status'](0x1f4)[_0x26859f(0x33d)]({'error':_0x2eb26b[_0x26859f(0x2c8)]});}try{const _0x3bbc88=[_0x26859f(0x37b),_0x5db85f[_0x26859f(0x3d6)],_0x26859f(0x239),_0x5db85f[_0x26859f(0x129)],'department_name',_0x5db85f['qbtwZ'],_0x26859f(0x173),_0x26859f(0x2af),_0x26859f(0x368),_0x26859f(0x377),_0x26859f(0x273),'status',_0x26859f(0x213),'theme','goals',_0x5db85f['aCgOO'],_0x5db85f[_0x26859f(0x259)],'timeline',_0x5db85f['hoRMm'],_0x5db85f[_0x26859f(0x199)],'expected_result',_0x5db85f[_0x26859f(0x28e)]],{setSql:_0x20d164,values:_0x19c961}=buildSafeUpdate(_0x54fa41['body']||{},_0x3bbc88);if(!_0x20d164)return _0xd882c2['json']({'success':!![]});await dbPool[_0x26859f(0x1bc)](_0x26859f(0x3e3)+_0x20d164+'\x20WHERE\x20id=?',[..._0x19c961,_0x54fa41['params']['id']]),_0xd882c2[_0x26859f(0x33d)]({'success':!![]});}catch(_0x41f21d){console[_0x26859f(0x3bf)](_0x26859f(0x2e4),_0x41f21d),_0xd882c2['status'](0x1f4)['json']({'error':_0x41f21d[_0x26859f(0x2c8)]});}}),app['delete']('/api/annual-work-plans/:id',async(_0x52ce09,_0x5c7025)=>{const _0x42fd06=_0x165f6e,_0x1d11e3={'XYqtH':function(_0xa346a9,_0x1a34ed,_0x189b49){return _0xa346a9(_0x1a34ed,_0x189b49);},'cRzzw':_0x42fd06(0x182),'Flfcn':'DELETE\x20FROM\x20annual_work_plans\x20WHERE\x20id=?'};if(!dbPool)try{return await _0x1d11e3['XYqtH'](deleteRow,_0x1d11e3[_0x42fd06(0x3ce)],_0x52ce09['params']['id']),_0x5c7025[_0x42fd06(0x33d)]({'success':!![]});}catch(_0x7ddc8b){return _0x5c7025[_0x42fd06(0x1aa)](0x1f4)[_0x42fd06(0x33d)]({'error':_0x7ddc8b[_0x42fd06(0x2c8)]});}try{await dbPool[_0x42fd06(0x1bc)](_0x1d11e3['Flfcn'],[_0x52ce09['params']['id']]),_0x5c7025['json']({'success':!![]});}catch(_0xe7ee74){_0x5c7025[_0x42fd06(0x1aa)](0x1f4)[_0x42fd06(0x33d)]({'error':_0xe7ee74[_0x42fd06(0x2c8)]});}}),app[_0x165f6e(0x1a2)](_0x165f6e(0x197),async(_0x31eac1,_0x3c4d0e)=>{const _0x2513bf=_0x165f6e,_0x57e66d={'RIshn':'year\x20=\x20?','ktqVJ':function(_0x5b7587,_0x533f27){return _0x5b7587(_0x533f27);},'aOGye':'\x20WHERE\x20'};if(!dbPool)try{const {year:_0x709e8}=_0x31eac1['query']||{};let _0x586cd0=await readTable(_0x2513bf(0x3af));if(_0x709e8)_0x586cd0=_0x586cd0[_0x2513bf(0x198)](_0xf5630a=>Number(_0xf5630a['year'])===Number(_0x709e8));return _0x3c4d0e[_0x2513bf(0x33d)](_0x586cd0);}catch(_0x301c3d){return _0x3c4d0e['status'](0x1f4)['json']({'error':_0x301c3d['message']});}try{const {year:_0x333d24}=_0x31eac1[_0x2513bf(0x1bc)]||{},_0x35217f=[],_0x4ae557=[];_0x333d24&&(_0x35217f[_0x2513bf(0x2f4)](_0x57e66d[_0x2513bf(0x2a9)]),_0x4ae557['push'](_0x57e66d['ktqVJ'](Number,_0x333d24)));const _0x398037=_0x2513bf(0x2b4)+(_0x35217f['length']?_0x57e66d['aOGye']+_0x35217f[_0x2513bf(0x159)](_0x2513bf(0x39d)):'')+_0x2513bf(0x1fa),[_0x214fc7]=await dbPool[_0x2513bf(0x1bc)](_0x398037,_0x4ae557);_0x3c4d0e[_0x2513bf(0x33d)](_0x214fc7);}catch(_0x482043){_0x3c4d0e['status'](0x1f4)[_0x2513bf(0x33d)]({'error':_0x482043[_0x2513bf(0x2c8)]});}}),app[_0x165f6e(0x364)]('/api/major-events',async(_0x48df97,_0x3f6829)=>{const _0x5a0777=_0x165f6e,_0x24603f={'gqWlP':'year','UiyzZ':_0x5a0777(0x3c3),'TzaPD':function(_0x48f6fe,_0x25870e,_0x588ec3){return _0x48f6fe(_0x25870e,_0x588ec3);},'JBbcp':'major_events','MtwXZ':_0x5a0777(0x332),'WSFdg':'responsible_person','xCIhf':'budget','sfiCP':_0x5a0777(0x253),'OhwPZ':'description','MDYMQ':_0x5a0777(0x236),'ylJZV':'success_criteria','zfQrc':_0x5a0777(0x13e),'FtjoM':'`,`','ZSyvr':_0x5a0777(0x2ab)};if(!dbPool)try{const _0x592bf7=_0x48df97['body']||{},_0x1a2940=[_0x24603f[_0x5a0777(0x1d8)],_0x24603f[_0x5a0777(0x135)]],_0x3cfc2c=_0x1a2940[_0x5a0777(0x198)](_0x8539fd=>!_0x592bf7[_0x8539fd]&&_0x592bf7[_0x8539fd]!==0x0);if(_0x3cfc2c['length'])return _0x3f6829['status'](0x190)['json']({'error':_0x5a0777(0x176)+_0x3cfc2c[_0x5a0777(0x159)](',\x20')});const _0x544501=await _0x24603f[_0x5a0777(0x178)](addRow,_0x24603f[_0x5a0777(0x2c3)],_0x592bf7);return _0x3f6829[_0x5a0777(0x1aa)](0xc9)[_0x5a0777(0x33d)](_0x544501);}catch(_0x48a243){return _0x3f6829['status'](0x1f4)[_0x5a0777(0x33d)]({'error':_0x48a243['message']});}try{const _0x5f33a7=_0x48df97['body']||{},_0x563469=['year','event_name',_0x24603f['MtwXZ'],'importance','planned_date','actual_date',_0x5a0777(0x1b9),'responsible_department',_0x24603f[_0x5a0777(0x1ec)],_0x5a0777(0x1aa),_0x24603f[_0x5a0777(0x290)],_0x24603f[_0x5a0777(0x1d2)],_0x24603f['OhwPZ'],_0x24603f[_0x5a0777(0x37a)],_0x24603f[_0x5a0777(0x263)],'risks',_0x24603f['zfQrc']],_0x2aa14e=_0x563469[_0x5a0777(0x2c4)](_0x9d96c9=>_0x5f33a7[_0x9d96c9]??null),_0x54ab62=_0x563469[_0x5a0777(0x2c4)](()=>'?')['join'](',');console[_0x5a0777(0x128)]('Inserting\x20major_event\x20with\x20keys:',_0x563469);const [_0x51e469]=await dbPool['query'](_0x5a0777(0x36b)+_0x563469[_0x5a0777(0x159)](_0x24603f['FtjoM'])+_0x5a0777(0x13b)+_0x54ab62+')',_0x2aa14e);_0x3f6829['status'](0xc9)[_0x5a0777(0x33d)]({'id':_0x51e469['insertId'],..._0x5f33a7});}catch(_0x1721f9){console['error'](_0x24603f['ZSyvr'],_0x1721f9),_0x3f6829[_0x5a0777(0x1aa)](0x1f4)[_0x5a0777(0x33d)]({'error':_0x1721f9[_0x5a0777(0x2c8)]});}}),app['put'](_0x165f6e(0x140),async(_0x4a3e5a,_0x43701b)=>{const _0xbe2474=_0x165f6e,_0x343d42={'byFDg':function(_0x5a691d,_0x1a3b41){return _0x5a691d!==_0x1a3b41;},'zFqun':_0xbe2474(0x240),'mdLkz':_0xbe2474(0x3af),'UWEZx':'year','xOPkg':'event_type','MTKGz':_0xbe2474(0x389),'CPTte':_0xbe2474(0x122),'gIQKp':_0xbe2474(0x253),'awuCE':_0xbe2474(0x395),'htIHc':'key_points','fbZgm':'success_criteria','HVohS':'risks','bDLRD':'lessons_learned','lOsSj':_0xbe2474(0x1b7)};if(!dbPool)try{if(_0x343d42['byFDg'](_0xbe2474(0x234),_0x343d42['zFqun']))return await updateRow(_0x343d42['mdLkz'],_0x4a3e5a['params']['id'],_0x4a3e5a[_0xbe2474(0x188)]||{}),_0x43701b['json']({'success':!![]});else{const _0x42dd9f=_0x5f4a3b[_0xbe2474(0x340)]||_0x124d95['parentId']||null;_0x42dd9f&&_0x3b9572[_0x42dd9f]?_0x5b7642[_0x42dd9f][_0xbe2474(0x3c1)][_0xbe2474(0x2f4)](_0x5952b6[_0x19ea4b['id']]):_0x806dd1['push'](_0x741ac0[_0x35da62['id']]);}}catch(_0x4df22e){return _0x43701b['status'](0x1f4)['json']({'error':_0x4df22e[_0xbe2474(0x2c8)]});}try{const _0x542b37=[_0x343d42['UWEZx'],'event_name',_0x343d42['xOPkg'],'importance',_0x343d42[_0xbe2474(0x226)],_0x343d42['CPTte'],_0xbe2474(0x1b9),'responsible_department','responsible_person',_0xbe2474(0x1aa),_0xbe2474(0x273),_0x343d42[_0xbe2474(0x3c7)],_0x343d42['awuCE'],_0x343d42['htIHc'],_0x343d42[_0xbe2474(0x2a0)],_0x343d42['HVohS'],_0x343d42[_0xbe2474(0x189)]],{setSql:_0x466d93,values:_0x1db836}=buildSafeUpdate(_0x4a3e5a['body']||{},_0x542b37);if(!_0x466d93)return _0x43701b['json']({'success':!![]});console[_0xbe2474(0x128)](_0x343d42[_0xbe2474(0x202)],_0x4a3e5a[_0xbe2474(0x166)]['id'],_0x466d93),await dbPool['query'](_0xbe2474(0x1e2)+_0x466d93+_0xbe2474(0x29d),[..._0x1db836,_0x4a3e5a[_0xbe2474(0x166)]['id']]),_0x43701b[_0xbe2474(0x33d)]({'success':!![]});}catch(_0x39e1f0){console['error']('Update\x20major_event\x20failed:',_0x39e1f0),_0x43701b[_0xbe2474(0x1aa)](0x1f4)['json']({'error':_0x39e1f0[_0xbe2474(0x2c8)]});}}),app['delete']('/api/major-events/:id',async(_0x58d67d,_0x553a23)=>{const _0x5e50ff=_0x165f6e,_0x5af300={'SkIyU':_0x5e50ff(0x3af)};if(!dbPool)try{return await deleteRow(_0x5af300[_0x5e50ff(0x3c5)],_0x58d67d[_0x5e50ff(0x166)]['id']),_0x553a23['json']({'success':!![]});}catch(_0x1d7116){return _0x553a23[_0x5e50ff(0x1aa)](0x1f4)[_0x5e50ff(0x33d)]({'error':_0x1d7116['message']});}try{await dbPool[_0x5e50ff(0x1bc)](_0x5e50ff(0x398),[_0x58d67d[_0x5e50ff(0x166)]['id']]),_0x553a23[_0x5e50ff(0x33d)]({'success':!![]});}catch(_0x54546f){_0x553a23['status'](0x1f4)[_0x5e50ff(0x33d)]({'error':_0x54546f[_0x5e50ff(0x2c8)]});}}),app['post']('/api/action-plans',async(_0x42a01d,_0x2ebdae)=>{const _0x460f58=_0x165f6e,_0x3edade={'CYSro':'goal','plyrb':'who','MIMpV':'how_much','OGeqZ':_0x460f58(0x2e0),'flCsj':function(_0x2a3ec4,_0x56a005,_0xa4b8f9){return _0x2a3ec4(_0x56a005,_0xa4b8f9);},'QyAMr':_0x460f58(0x281),'vzpIq':_0x460f58(0x3e8),'TqKqs':'department','PWoxT':_0x460f58(0x32a),'RBGUO':'how','ongcu':'priority','tfVkg':_0x460f58(0x1aa),'NVxir':'progress','DMQhN':_0x460f58(0x34f),'cSwxR':_0x460f58(0x269),'QUfbz':'`,`'};if(!dbPool)try{const _0x2dac30=_0x42a01d['body']||{},_0x21ac36=['year',_0x3edade[_0x460f58(0x344)],_0x460f58(0x32a),_0x3edade[_0x460f58(0x15f)],_0x460f58(0x3e8),_0x460f58(0x34e)],_0x260e7a=_0x21ac36[_0x460f58(0x198)](_0x44ee2d=>!_0x2dac30[_0x44ee2d]&&_0x2dac30[_0x44ee2d]!==0x0);if(_0x260e7a[_0x460f58(0x2fb)])return _0x2ebdae[_0x460f58(0x1aa)](0x190)[_0x460f58(0x33d)]({'error':'缺少必填项:\x20'+_0x260e7a[_0x460f58(0x159)](',\x20')});const _0x49629e=[_0x460f58(0x281),_0x460f58(0x302),'what','why',_0x460f58(0x3b6),_0x460f58(0x3e8),_0x460f58(0x350),_0x3edade['MIMpV'],_0x460f58(0x34e),_0x460f58(0x2af),_0x460f58(0x1aa),_0x460f58(0x333),'expected_result','actual_result',_0x3edade['OGeqZ']],_0x588257={};_0x49629e[_0x460f58(0x27e)](_0xc966d2=>_0x588257[_0xc966d2]=_0x2dac30[_0xc966d2]??null);const _0x1a5675=await _0x3edade['flCsj'](addRow,_0x460f58(0x230),_0x588257);return _0x2ebdae['status'](0xc9)[_0x460f58(0x33d)](_0x1a5675);}catch(_0x3a4b2e){return _0x2ebdae['status'](0x1f4)[_0x460f58(0x33d)]({'error':_0x3a4b2e['message']});}try{const _0x1e7e96=_0x42a01d['body']||{},_0x30201d=[_0x3edade[_0x460f58(0x280)],_0x460f58(0x302),_0x460f58(0x32a),'who',_0x3edade['vzpIq'],_0x3edade['TqKqs']],_0x4cc70b=_0x30201d[_0x460f58(0x198)](_0x2a2a11=>!_0x1e7e96[_0x2a2a11]&&_0x1e7e96[_0x2a2a11]!==0x0);if(_0x4cc70b['length'])return _0x2ebdae['status'](0x190)['json']({'error':'缺少必填项:\x20'+_0x4cc70b['join'](',\x20')});const _0x2efb4e=[_0x3edade[_0x460f58(0x280)],_0x460f58(0x302),_0x3edade[_0x460f58(0x3dc)],'why',_0x460f58(0x3b6),_0x460f58(0x3e8),_0x3edade[_0x460f58(0x1b6)],'how_much','department',_0x3edade['ongcu'],_0x3edade['tfVkg'],_0x3edade['NVxir'],_0x3edade[_0x460f58(0x2fd)],_0x3edade[_0x460f58(0x17a)],_0x460f58(0x2e0)],_0x1826dc=_0x2efb4e['map'](_0x28fb15=>_0x1e7e96[_0x28fb15]??null),_0x2f83ed=_0x2efb4e[_0x460f58(0x2c4)](()=>'?')['join'](','),[_0x4bae6d]=await dbPool['query'](_0x460f58(0x2b5)+_0x2efb4e['join'](_0x3edade['QUfbz'])+'`)\x20VALUES\x20('+_0x2f83ed+')',_0x1826dc);_0x2ebdae[_0x460f58(0x1aa)](0xc9)['json']({'id':_0x4bae6d['insertId'],..._0x1e7e96});}catch(_0x58e471){_0x2ebdae['status'](0x1f4)[_0x460f58(0x33d)]({'error':_0x58e471['message']});}}),app[_0x165f6e(0x30e)]('/api/action-plans/:id',async(_0x394a3b,_0x2f5595)=>{const _0x48922e=_0x165f6e,_0x477d1d={'CgRZM':_0x48922e(0x230),'wcHrP':'when','WiPjM':_0x48922e(0x34e),'YxRTw':_0x48922e(0x2af),'mmGVI':_0x48922e(0x1aa),'bZarW':'expected_result'};if(!dbPool)try{return await updateRow(_0x477d1d[_0x48922e(0x32b)],_0x394a3b[_0x48922e(0x166)]['id'],_0x394a3b[_0x48922e(0x188)]||{}),_0x2f5595[_0x48922e(0x33d)]({'success':!![]});}catch(_0x559383){return'iivpG'!=='iivpG'?(_0x42f1e7[_0x48922e(0x128)](_0x48922e(0x186)+_0x2d7d1e[_0x48922e(0x387)]+'\x20-\x20No\x20token'),_0x334b89[_0x48922e(0x1aa)](0x191)['json']({'error':_0x48922e(0x146)})):_0x2f5595[_0x48922e(0x1aa)](0x1f4)[_0x48922e(0x33d)]({'error':_0x559383[_0x48922e(0x2c8)]});}try{const _0x2248a7=['year','goal','what','why',_0x48922e(0x3b6),_0x477d1d[_0x48922e(0x2aa)],_0x48922e(0x350),'how_much',_0x477d1d['WiPjM'],_0x477d1d[_0x48922e(0x209)],_0x477d1d[_0x48922e(0x1b1)],_0x48922e(0x333),_0x477d1d[_0x48922e(0x1b2)],'actual_result',_0x48922e(0x2e0)],{setSql:_0x226f00,values:_0x3ad723}=buildSafeUpdate(_0x394a3b['body']||{},_0x2248a7);if(!_0x226f00)return _0x2f5595[_0x48922e(0x33d)]({'success':!![]});await dbPool[_0x48922e(0x1bc)](_0x48922e(0x375)+_0x226f00+_0x48922e(0x29d),[..._0x3ad723,_0x394a3b[_0x48922e(0x166)]['id']]),_0x2f5595['json']({'success':!![]});}catch(_0x4a930d){_0x2f5595['status'](0x1f4)[_0x48922e(0x33d)]({'error':_0x4a930d['message']});}}),app['delete'](_0x165f6e(0x161),async(_0x21ee53,_0x37174b)=>{const _0x292ff0=_0x165f6e,_0x266824={'UayAa':_0x292ff0(0x230)};if(!dbPool)try{return await deleteRow(_0x266824[_0x292ff0(0x27f)],_0x21ee53[_0x292ff0(0x166)]['id']),_0x37174b[_0x292ff0(0x33d)]({'success':!![]});}catch(_0x1c91d5){return _0x37174b[_0x292ff0(0x1aa)](0x1f4)['json']({'error':_0x1c91d5['message']});}try{await dbPool['query']('DELETE\x20FROM\x20action_plans\x20WHERE\x20id=?',[_0x21ee53[_0x292ff0(0x166)]['id']]),_0x37174b['json']({'success':!![]});}catch(_0x55dfd5){_0x37174b[_0x292ff0(0x1aa)](0x1f4)[_0x292ff0(0x33d)]({'error':_0x55dfd5[_0x292ff0(0x2c8)]});}});const DB_ENABLED=process['env'][_0x165f6e(0x2b3)]===_0x165f6e(0x141);let dbPool=null;async function initDB(){const _0x402289=_0x165f6e,_0xab3a52={'xNtMo':_0x402289(0x15a),'iRSZH':'root','IvHot':_0x402289(0x211),'AYakg':function(_0x3747f0,_0x8ed0a6){return _0x3747f0===_0x8ed0a6;},'TKkuW':_0x402289(0x223),'PalhS':_0x402289(0x2f1),'rretQ':_0x402289(0x278),'gYCeI':'ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20actual_cost\x20DECIMAL(14,2)\x20NULL','SKZSV':'ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20success_criteria\x20TEXT\x20NULL','MImKt':'ALTER\x20TABLE\x20company_info\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','JfoMU':'ALTER\x20TABLE\x20target_types\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','yzzTy':'ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20goals\x20TEXT\x20NULL','QMhKB':'ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20tasks\x20TEXT\x20NULL','RCKQS':_0x402289(0x3ab),'nYWXD':_0x402289(0x37d),'lyhnn':'ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20responsible\x20VARCHAR(255)\x20NULL','bdWkj':function(_0x37fd6e,_0x29b255){return _0x37fd6e===_0x29b255;},'AiHxB':function(_0x40028e,_0x50f0ab){return _0x40028e!==_0x50f0ab;},'CpqNG':_0x402289(0x169),'YfWTJ':_0x402289(0x3b1)};if(!DB_ENABLED)return;const _0x3020c2=process['env']['DB_HOST']||_0xab3a52['xNtMo'],_0x27bc93=process[_0x402289(0x308)][_0x402289(0x272)]||_0xab3a52[_0x402289(0x172)],_0x5134bd=process[_0x402289(0x308)]['DB_PASSWORD']||'',_0xbcbde3=Number(process['env'][_0x402289(0x17e)]||0xcea),_0xdec172=process[_0x402289(0x308)][_0x402289(0x2e9)]||_0xab3a52['IvHot'];try{const _0x41a915=await mysql['createConnection']({'host':_0x3020c2,'user':_0x27bc93,'password':_0x5134bd,'port':_0xbcbde3});try{await _0x41a915[_0x402289(0x1bc)]('CREATE\x20DATABASE\x20IF\x20NOT\x20EXISTS\x20`'+_0xdec172+'`');}catch(_0x1937ea){}await _0x41a915['end']();}catch(_0x2b54bc){throw _0x2b54bc;}dbPool=await mysql['createPool']({'host':_0x3020c2,'user':_0x27bc93,'password':_0x5134bd,'port':_0xbcbde3,'database':_0xdec172,'waitForConnections':!![],'connectionLimit':0xa,'queueLimit':0x0}),await dbPool[_0x402289(0x1bc)](_0x402289(0x2fe)),await dbPool[_0x402289(0x1bc)](_0x402289(0x22e)),await dbPool['query']('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20audit_logs\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20username\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20role\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20method\x20VARCHAR(16)\x20NULL,\x0a\x20\x20\x20\x20path\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20status\x20INT\x20NULL,\x0a\x20\x20\x20\x20duration_ms\x20INT\x20NULL,\x0a\x20\x20\x20\x20ip\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20ua\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20query\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20body\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool['query']('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20major_events\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20year\x20INT,\x0a\x20\x20\x20\x20event_name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20event_type\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20importance\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20planned_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20actual_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20department_id\x20INT\x20NULL,\x0a\x20\x20\x20\x20responsible_department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20responsible_person\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20budget\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20actual_cost\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20key_points\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20success_criteria\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20risks\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20lessons_learned\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool[_0x402289(0x1bc)]('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20monthly_progress\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20year\x20INT,\x0a\x20\x20\x20\x20month\x20INT,\x0a\x20\x20\x20\x20department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20task_name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20target_value\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20actual_value\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20responsible_person\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20start_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20end_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20key_activities\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20achievements\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20challenges\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20next_month_plan\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20support_needed\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool['query'](_0x402289(0x393));try{if(_0xab3a52[_0x402289(0x313)]('ObGrN',_0xab3a52[_0x402289(0x1e0)]))await dbPool['query']('ALTER\x20TABLE\x20department_targets\x20ADD\x20COLUMN\x20completion_rate\x20VARCHAR(32)\x20NULL');else return _0xb40a9f[_0x402289(0x1aa)](0x190)[_0x402289(0x33d)]({'error':'部门名称为必填项'});}catch(_0x50f7ad){}try{await dbPool[_0x402289(0x1bc)]('ALTER\x20TABLE\x20department_targets\x20MODIFY\x20quarter\x20VARCHAR(16)\x20NULL');}catch(_0x1af80a){}await dbPool[_0x402289(0x1bc)](_0x402289(0x25a)),await dbPool['query'](_0x402289(0x287)),await dbPool[_0x402289(0x1bc)]('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20notifications\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20type\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20title\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20message\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20published_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20`read`\x20TINYINT(1)\x20DEFAULT\x200\x0a\x20\x20)'),await dbPool['query']('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20target_types\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20color\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20icon\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20category\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20isActive\x20TINYINT(1)\x20DEFAULT\x201,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool['query'](_0x402289(0x334));try{await dbPool[_0x402289(0x1bc)]('ALTER\x20TABLE\x20departments\x20MODIFY\x20id\x20BIGINT\x20PRIMARY\x20KEY');}catch(_0x4fb1fa){}try{await dbPool[_0x402289(0x1bc)](_0xab3a52['PalhS']);}catch(_0x127bb9){}await dbPool[_0x402289(0x1bc)](_0x402289(0x181)),await dbPool[_0x402289(0x1bc)]('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20system_settings\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20`key`\x20VARCHAR(128)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20value\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool['query']('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20audit_logs\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20username\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20role\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20method\x20VARCHAR(16)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20path\x20VARCHAR(512)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20status\x20INT\x20NULL,\x0a\x20\x20\x20\x20duration_ms\x20INT\x20NULL,\x0a\x20\x20\x20\x20ip\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20ua\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20query\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20body\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool['query']('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20users\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20username\x20VARCHAR(64)\x20NOT\x20NULL\x20UNIQUE,\x0a\x20\x20\x20\x20password\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20email\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20role\x20VARCHAR(64)\x20DEFAULT\x20\x27user\x27,\x0a\x20\x20\x20\x20department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20permissions\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20DEFAULT\x20\x27active\x27,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool['query']('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20company_info\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20address\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20phone\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20email\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20website\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20logo\x20VARCHAR(512)\x20NULL,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20founded_year\x20INT\x20NULL,\x0a\x20\x20\x20\x20employee_count\x20INT\x20NULL,\x0a\x20\x20\x20\x20industry\x20VARCHAR(128)\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)');const _0x40f1b6=[_0xab3a52['PalhS'],_0x402289(0x32c),_0xab3a52['rretQ'],_0x402289(0x119),_0x402289(0x207),_0xab3a52[_0x402289(0x35b)],'ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20key_points\x20TEXT\x20NULL',_0xab3a52['SKZSV'],'ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20risks\x20TEXT\x20NULL',_0x402289(0x17c),_0x402289(0x346),_0x402289(0x1bd),_0xab3a52['MImKt'],_0xab3a52['JfoMU'],_0x402289(0x370),_0xab3a52['yzzTy'],_0xab3a52['QMhKB'],_0xab3a52['RCKQS'],_0xab3a52['nYWXD'],_0xab3a52['lyhnn'],_0x402289(0x2ee)];for(const _0x3b1653 of _0x40f1b6){if(_0xab3a52['bdWkj'](_0x402289(0x38c),_0x402289(0x38c)))try{await dbPool[_0x402289(0x1bc)](_0x3b1653);}catch(_0x56b1ed){_0x56b1ed[_0x402289(0x325)]!==_0x402289(0x20e)&&_0xab3a52['AiHxB'](_0x56b1ed[_0x402289(0x1d5)],0x424)&&console['error'](_0xab3a52['CpqNG'],_0x56b1ed['message'],_0xab3a52[_0x402289(0x3b4)],_0x3b1653);}else _0x2e8161[_0x402289(0x2e8)](_0x56eb2e,{'recursive':!![]});}}function buildSafeUpdate(_0x43d25a,_0xd0103b){const _0x131870=_0x165f6e,_0x29ec40=Object['keys'](_0x43d25a)['filter'](_0x20b2b2=>_0xd0103b['includes'](_0x20b2b2));if(!_0x29ec40['length'])return{'setSql':'','values':[]};const _0x11244a=_0x29ec40['map'](_0x244060=>'`'+_0x244060+_0x131870(0x17b))['join'](',\x20'),_0x1b59b0=_0x29ec40['map'](_0x474923=>_0x43d25a[_0x474923]);return{'setSql':_0x11244a,'values':_0x1b59b0};}async function getDingTalkAccessToken(){const _0x309844=_0x165f6e,_0x25c985={'IPJIt':function(_0x225604,_0x46bcca){return _0x225604(_0x46bcca);},'qdgMM':_0x309844(0x1a0),'dcCgp':function(_0x401d9c,_0x22ed65){return _0x401d9c(_0x22ed65);},'XfgXV':function(_0x48f304,_0x286f43){return _0x48f304===_0x286f43;},'bTmLS':'iGDrE'};if(!axios)axios=_0x25c985[_0x309844(0x118)](require,_0x25c985['qdgMM']);let _0x19d2e7=process[_0x309844(0x308)][_0x309844(0x2db)],_0x746467=process[_0x309844(0x308)][_0x309844(0x320)];if((!_0x19d2e7||!_0x746467)&&dbPool)try{const [_0x3deb9b]=await dbPool[_0x309844(0x1bc)]('SELECT\x20value\x20FROM\x20system_settings\x20WHERE\x20`key`=?\x20LIMIT\x201',[_0x309844(0x28d)]),_0x3ed33c=_0x3deb9b&&_0x3deb9b[0x0]&&_0x3deb9b[0x0][_0x309844(0x1fb)]?_0x3deb9b[0x0]['value']:null;if(_0x3ed33c)try{const _0x25a83e=JSON[_0x309844(0x2fc)](_0x3ed33c);_0x19d2e7=String(_0x25a83e['dingtalkAppKey']||_0x19d2e7||''),_0x746467=_0x25c985['dcCgp'](String,_0x25a83e[_0x309844(0x2e3)]||_0x746467||'');}catch(_0x35941f){}}catch(_0x57e141){}if(!_0x19d2e7||!_0x746467)throw new Error(_0x309844(0x34b));const _0x83ae54=await axios[_0x309844(0x1a2)]('https://oapi.dingtalk.com/gettoken',{'params':{'appkey':_0x19d2e7,'appsecret':_0x746467}}),_0x290786=_0x83ae54?.[_0x309844(0x200)]||{};if(_0x290786[_0x309844(0x39e)]!==0x0||!_0x290786['access_token']){if(_0x25c985['XfgXV']('iGDrE',_0x25c985[_0x309844(0x23a)])){const _0x49822d=_0x290786['errmsg']||'获取钉钉access_token失败',_0x22e9bc=_0x290786[_0x309844(0x25f)]?_0x309844(0x2d0)+_0x290786[_0x309844(0x25f)]+']':'';throw new Error(''+_0x49822d+_0x22e9bc);}else _0x5df4c3(null,!![]);}return _0x25c985[_0x309844(0x118)](String,_0x290786['access_token']);}function generateDingtalkSign(_0x52b5c7,_0xf9caf0){const _0x5b1ec7=_0x165f6e,_0x9a38cc={'QRLBt':'sha256','CLUoc':_0x5b1ec7(0x284)},_0x4906da=_0xf9caf0+'\x0a'+_0x52b5c7,_0x52252b=crypto['createHmac'](_0x9a38cc[_0x5b1ec7(0x208)],_0x52b5c7);_0x52252b['update'](_0x4906da);const _0x5d636c=encodeURIComponent(_0x52252b['digest'](_0x9a38cc['CLUoc']));return _0x5d636c;}app['post']('/api/dingtalk/test-connection',async(_0x2caf91,_0x1ffc1a)=>{const _0x3a2fb6=_0x165f6e,_0x3de035={'FwFvp':function(_0x1ea5a2,_0x121a38){return _0x1ea5a2(_0x121a38);},'LdZrz':'Webhook地址不能为空','RfJqz':function(_0x253d53,_0x57bec4,_0x4f746e){return _0x253d53(_0x57bec4,_0x4f746e);},'fsIQa':'text','ZwrvP':'application/json','RtqHM':function(_0xe922f9,_0x110ecd){return _0xe922f9===_0x110ecd;},'bxBnP':'连接测试成功','PwDFR':_0x3a2fb6(0x20b),'sUhEG':'[DingTalk\x20Webhook]\x20连接测试失败:'};try{if(!axios)axios=_0x3de035[_0x3a2fb6(0x294)](require,_0x3a2fb6(0x1a0));const {webhookUrl:_0x5c0913,secret:_0x121666}=_0x2caf91[_0x3a2fb6(0x188)]||{};if(!_0x5c0913)return _0x1ffc1a['status'](0x190)[_0x3a2fb6(0x33d)]({'success':![],'message':_0x3de035['LdZrz']});let _0x1ca2b5=_0x5c0913;if(_0x121666){if('QSkpj'!=='QSkpj')_0x494edf['status'](0x1f4)['json']({'error':_0x105855['message']});else{const _0x30df92=Date['now'](),_0x3729ba=_0x3de035['RfJqz'](generateDingtalkSign,_0x121666,_0x30df92),_0x495db0=_0x5c0913['includes']('?')?'&':'?';_0x1ca2b5=''+_0x5c0913+_0x495db0+'timestamp='+_0x30df92+'&sign='+_0x3729ba;}}const _0xb75d8b=await axios['post'](_0x1ca2b5,{'msgtype':_0x3de035['fsIQa'],'text':{'content':_0x3a2fb6(0x1cd)}},{'headers':{'Content-Type':_0x3de035['ZwrvP']},'timeout':0x2710});_0x3de035[_0x3a2fb6(0x2b8)](_0xb75d8b['data'][_0x3a2fb6(0x39e)],0x0)?_0x1ffc1a['json']({'success':!![],'message':_0x3de035['bxBnP']}):_0x1ffc1a['json']({'success':![],'message':_0xb75d8b[_0x3a2fb6(0x200)]['errmsg']||_0x3de035['PwDFR'],'errcode':_0xb75d8b[_0x3a2fb6(0x200)][_0x3a2fb6(0x39e)]});}catch(_0x100cdc){console['error'](_0x3de035[_0x3a2fb6(0x154)],_0x100cdc[_0x3a2fb6(0x2c8)]),_0x1ffc1a[_0x3a2fb6(0x1aa)](0x1f4)['json']({'success':![],'message':_0x100cdc['response']?.['data']?.['errmsg']||_0x100cdc['message']||'连接测试失败'});}}),app['post']('/api/dingtalk/send-message',async(_0x490096,_0x10c681)=>{const _0x26f5d5=_0x165f6e,_0x3582e1={'fXQWC':'请输入用户名和密码','tyKho':'axios','SNUTk':_0x26f5d5(0x26a),'oGrCU':function(_0x1180a8,_0x491c1c,_0xdf972f){return _0x1180a8(_0x491c1c,_0xdf972f);},'TbwDY':_0x26f5d5(0x2ac),'HwzLp':_0x26f5d5(0x2c0),'LYGAo':function(_0x232f37,_0x3d8ef4){return _0x232f37||_0x3d8ef4;},'GgRin':'application/json','TylhI':_0x26f5d5(0x143)};try{if(!axios)axios=require(_0x3582e1['tyKho']);const {webhookUrl:_0x5dad36,secret:_0x518836,title:_0x1b72a5,content:_0x19d915,msgtype:msgtype=_0x26f5d5(0x261)}=_0x490096['body']||{};if(!_0x5dad36)return _0x10c681[_0x26f5d5(0x1aa)](0x190)[_0x26f5d5(0x33d)]({'success':![],'message':_0x3582e1[_0x26f5d5(0x2cf)]});if(!_0x1b72a5&&!_0x19d915)return _0x10c681['status'](0x190)[_0x26f5d5(0x33d)]({'success':![],'message':_0x26f5d5(0x275)});let _0x27f0ce=_0x5dad36;if(_0x518836){if('ffXlF'!==_0x26f5d5(0x1f9))return _0x5bf61b['status'](0x190)['json']({'error':_0x3582e1[_0x26f5d5(0x225)]});else{const _0x48d766=Date['now'](),_0x5dc904=_0x3582e1[_0x26f5d5(0x319)](generateDingtalkSign,_0x518836,_0x48d766),_0x125029=_0x5dad36[_0x26f5d5(0x232)]('?')?'&':'?';_0x27f0ce=''+_0x5dad36+_0x125029+'timestamp='+_0x48d766+'&sign='+_0x5dc904;}}let _0x17339b;msgtype===_0x26f5d5(0x261)?_0x17339b={'msgtype':'markdown','markdown':{'title':_0x1b72a5||_0x3582e1[_0x26f5d5(0x2dc)],'text':'###\x20'+(_0x1b72a5||_0x26f5d5(0x2ac))+'\x0a\x0a'+(_0x19d915||'')}}:_0x17339b={'msgtype':_0x3582e1['HwzLp'],'text':{'content':_0x1b72a5?'【'+_0x1b72a5+'】\x0a'+(_0x19d915||''):_0x3582e1[_0x26f5d5(0x160)](_0x19d915,'')}};const _0x72e332=await axios['post'](_0x27f0ce,_0x17339b,{'headers':{'Content-Type':_0x3582e1[_0x26f5d5(0x2b6)]},'timeout':0x2710});_0x72e332['data'][_0x26f5d5(0x39e)]===0x0?_0x10c681[_0x26f5d5(0x33d)]({'success':!![],'message':'消息发送成功'}):_0x10c681['json']({'success':![],'message':_0x72e332['data'][_0x26f5d5(0x279)]||_0x3582e1[_0x26f5d5(0x2bd)],'errcode':_0x72e332['data'][_0x26f5d5(0x39e)]});}catch(_0x4a71ca){console[_0x26f5d5(0x3bf)](_0x26f5d5(0x3db),_0x4a71ca[_0x26f5d5(0x2c8)]),_0x10c681[_0x26f5d5(0x1aa)](0x1f4)['json']({'success':![],'message':_0x4a71ca[_0x26f5d5(0x123)]?.[_0x26f5d5(0x200)]?.['errmsg']||_0x4a71ca['message']||_0x3582e1['TylhI']});}}),app[_0x165f6e(0x1a2)]('/api/integration/status',async(_0x1d6be9,_0x13c8f5)=>{const _0x5a3ee5=_0x165f6e,_0x580555={'kttvD':_0x5a3ee5(0x28d)};let _0x1201cd=Boolean(process['env']['DINGTALK_APP_KEY']&&process[_0x5a3ee5(0x308)]['DINGTALK_APP_SECRET']);if(!_0x1201cd&&dbPool)try{const [_0x2a0f82]=await dbPool[_0x5a3ee5(0x1bc)](_0x5a3ee5(0x195),[_0x580555['kttvD']]),_0x19dda8=_0x2a0f82&&_0x2a0f82[0x0]&&_0x2a0f82[0x0][_0x5a3ee5(0x1fb)]?_0x2a0f82[0x0][_0x5a3ee5(0x1fb)]:null;if(_0x19dda8)try{const _0x251780=JSON['parse'](_0x19dda8);_0x1201cd=Boolean(_0x251780['dingtalkAppKey']&&_0x251780['dingtalkAppSecret']);}catch(_0x278615){}}catch(_0x28bbe2){}_0x13c8f5['json']({'dingtalkConfigured':_0x1201cd});});async function getMaintenanceStatus(){const _0x18ec8a=_0x165f6e,_0x17d344={'YHMtz':function(_0xff219f){return _0xff219f();},'pvsRv':function(_0x1c541b,_0x189ece){return _0x1c541b(_0x189ece);},'DkdPO':function(_0x37e963,_0x50fb4c){return _0x37e963===_0x50fb4c;},'pFMCH':'string'},_0x3b5c94=await _0x17d344[_0x18ec8a(0x3ac)](getSystemAutoBackupSettings),_0x50b100=_0x17d344['pvsRv'](Boolean,_0x3b5c94&&_0x17d344['DkdPO'](_0x3b5c94['maintenanceMode'],!![])),_0x5dc690=_0x3b5c94&&typeof _0x3b5c94[_0x18ec8a(0x365)]===_0x17d344['pFMCH']?_0x3b5c94[_0x18ec8a(0x365)]:null,_0x235eb8=_0x3b5c94&&_0x3b5c94[_0x18ec8a(0x1af)]?_0x17d344[_0x18ec8a(0x149)](String,_0x3b5c94['maintenanceSince']):null;return{'enabled':_0x50b100,'message':_0x5dc690,'since':_0x235eb8};}app[_0x165f6e(0x1a2)](_0x165f6e(0x2d9),async(_0x31f626,_0x3decd6)=>{const _0x2f1b4f=_0x165f6e;try{const _0x35dd27=await getMaintenanceStatus();_0x3decd6['json'](_0x35dd27);}catch(_0x264ce4){_0x3decd6[_0x2f1b4f(0x1aa)](0x1f4)[_0x2f1b4f(0x33d)]({'error':_0x264ce4['message']});}}),app[_0x165f6e(0x1a2)](_0x165f6e(0x27c),async(_0x55c0ab,_0x357709)=>{const _0xda04bb=_0x165f6e,_0x5db2c={'eeXxK':function(_0x30fbe6,_0x1d1b24){return _0x30fbe6(_0x1d1b24);},'vBVDP':_0xda04bb(0x228),'HbMyS':'zhyRV','dMawI':_0xda04bb(0x38e),'MCGzq':'SELECT\x20id,\x20`key`,\x20value,\x20created_at\x20FROM\x20system_settings\x20ORDER\x20BY\x20id\x20DESC'};if(!dbPool)try{const _0x4344ea=await _0x5db2c['eeXxK'](readTable,_0x5db2c['vBVDP']),_0x246afd=_0x4344ea[_0xda04bb(0x2c4)](_0x29d771=>({'id':_0x29d771['id'],'key':_0x29d771['key'],'value':_0x29d771[_0xda04bb(0x1fb)]}));return _0x357709['json'](_0x246afd);}catch(_0x40648e){return _0x357709['status'](0x1f4)[_0xda04bb(0x33d)]({'error':_0x40648e[_0xda04bb(0x2c8)]});}try{if(_0x5db2c[_0xda04bb(0x3ae)]!==_0x5db2c[_0xda04bb(0x307)]){const [_0x23e180]=await dbPool[_0xda04bb(0x1bc)](_0x5db2c[_0xda04bb(0x1ca)]),_0x295219=_0x23e180['map'](_0x5d10fd=>({'id':_0x5d10fd['id'],'key':_0x5d10fd[_0xda04bb(0x2f8)],'value':safeParse(_0x5d10fd['value'])}));_0x357709['json'](_0x295219);}else _0x1e1edf[_0xda04bb(0x1aa)](0x1f4)[_0xda04bb(0x33d)]({'error':_0x1bc18e[_0xda04bb(0x2c8)]});}catch(_0x574f4f){_0x357709['status'](0x1f4)['json']({'error':_0x574f4f['message']});}}),app['post']('/api/system-settings',async(_0x1b37ba,_0x194933)=>{const _0x5e8924=_0x165f6e,_0x4164d4={'CBxEg':'system_settings','vpWfy':function(_0x27390c,_0x4df367){return _0x27390c(_0x4df367);},'aQTTs':_0x5e8924(0x14f)};if(!dbPool)try{const _0x26e85f=String(_0x1b37ba['body']?.[_0x5e8924(0x2f8)]||'')[_0x5e8924(0x1d6)](),_0x3cae95=_0x1b37ba['body']?.['value'];if(!_0x26e85f)return _0x194933['status'](0x190)['json']({'error':'Missing\x20key'});const _0x40e54a=await addRow(_0x4164d4['CBxEg'],{'key':_0x26e85f,'value':_0x3cae95});try{await applyAutoBackupSchedule();}catch(_0x49252a){}return _0x194933[_0x5e8924(0x1aa)](0xc9)['json'](_0x40e54a);}catch(_0xbda0){return _0x194933['status'](0x1f4)['json']({'error':_0xbda0[_0x5e8924(0x2c8)]});}try{const _0x19a8e2=_0x4164d4[_0x5e8924(0x21d)](String,_0x1b37ba['body']?.['key']||'')['trim'](),_0x508bde=_0x1b37ba['body']?.['value']!==undefined?JSON[_0x5e8924(0x192)](_0x1b37ba[_0x5e8924(0x188)][_0x5e8924(0x1fb)]):_0x4164d4['aQTTs'];if(!_0x19a8e2)return _0x194933['status'](0x190)[_0x5e8924(0x33d)]({'error':'Missing\x20key'});const [_0xa2d301]=await dbPool['query']('INSERT\x20INTO\x20system_settings\x20(`key`,\x20value)\x20VALUES\x20(?,\x20?)',[_0x19a8e2,_0x508bde]);try{await applyAutoBackupSchedule();}catch(_0x3cd36d){}_0x194933['status'](0xc9)['json']({'id':_0xa2d301['insertId'],'key':_0x19a8e2,'value':_0x1b37ba['body'][_0x5e8924(0x1fb)]});}catch(_0x52c2d6){_0x194933['status'](0x1f4)['json']({'error':_0x52c2d6[_0x5e8924(0x2c8)]});}}),app[_0x165f6e(0x30e)]('/api/system-settings/:id',async(_0x3823b3,_0x1f3372)=>{const _0x1f9eae=_0x165f6e,_0x21055a={'BjGsa':function(_0x133590,_0x124ba5){return _0x133590(_0x124ba5);},'VSmAK':'QLOqa','iZuSM':function(_0x30ccbd,_0x5d0427,_0x7ede1,_0x569143){return _0x30ccbd(_0x5d0427,_0x7ede1,_0x569143);},'QkJHR':function(_0x2a7eb2,_0x19a04b){return _0x2a7eb2===_0x19a04b;}};if(!dbPool)try{const _0x5dda77=_0x21055a['BjGsa'](Number,_0x3823b3[_0x1f9eae(0x166)]['id']),_0x191350=String(_0x3823b3['body']?.[_0x1f9eae(0x2f8)]||'')['trim'](),_0x1b1a2f=_0x3823b3['body']?.[_0x1f9eae(0x1fb)];if(!_0x5dda77)return'QLOqa'!==_0x21055a['VSmAK']?_0x1e19fc[_0x1f9eae(0x1aa)](0x1f4)[_0x1f9eae(0x33d)]({'error':_0x5be6f9['message']}):_0x1f3372[_0x1f9eae(0x1aa)](0x190)['json']({'error':'Invalid\x20id'});return await _0x21055a['iZuSM'](updateRow,_0x1f9eae(0x228),_0x5dda77,{'key':_0x191350,'value':_0x1b1a2f}),_0x1f3372['json']({'success':!![]});}catch(_0x387b3){return _0x1f3372['status'](0x1f4)[_0x1f9eae(0x33d)]({'error':_0x387b3[_0x1f9eae(0x2c8)]});}try{const _0x3c4251=Number(_0x3823b3[_0x1f9eae(0x166)]['id']),_0x46d314=String(_0x3823b3[_0x1f9eae(0x188)]?.[_0x1f9eae(0x2f8)]||'')['trim'](),_0x4539d4=_0x3823b3[_0x1f9eae(0x188)]?.[_0x1f9eae(0x1fb)]!==undefined?JSON['stringify'](_0x3823b3['body'][_0x1f9eae(0x1fb)]):'null';if(!_0x3c4251)return _0x1f3372[_0x1f9eae(0x1aa)](0x190)['json']({'error':'Invalid\x20id'});await dbPool[_0x1f9eae(0x1bc)]('UPDATE\x20system_settings\x20SET\x20`key`=?,\x20value=?\x20WHERE\x20id=?',[_0x46d314,_0x4539d4,_0x3c4251]);try{_0x21055a['QkJHR'](_0x1f9eae(0x23f),_0x1f9eae(0x16b))?_0x3b0960[_0x1f9eae(0x1aa)](0x1f4)['json']({'error':_0x584b83['message']}):await applyAutoBackupSchedule();}catch(_0x503bc0){}_0x1f3372['json']({'success':!![]});}catch(_0x5d3d66){_0x1f3372[_0x1f9eae(0x1aa)](0x1f4)[_0x1f9eae(0x33d)]({'error':_0x5d3d66[_0x1f9eae(0x2c8)]});}}),app['delete'](_0x165f6e(0x12f),async(_0x5ac12d,_0x114f02)=>{const _0x43a4f6=_0x165f6e,_0x4b88ed={'vqsbu':_0x43a4f6(0x2f5),'IPjHp':'DELETE\x20FROM\x20system_settings\x20WHERE\x20id=?'};if(!dbPool){if(_0x43a4f6(0x11b)!==_0x4b88ed[_0x43a4f6(0x165)])try{return await deleteRow('system_settings',_0x5ac12d[_0x43a4f6(0x166)]['id']),_0x114f02['json']({'success':!![]});}catch(_0x32a59d){return _0x114f02[_0x43a4f6(0x1aa)](0x1f4)['json']({'error':_0x32a59d['message']});}else return _0x13e3a8['status'](0x190)[_0x43a4f6(0x33d)]({'error':'工号已存在'});}try{await dbPool[_0x43a4f6(0x1bc)](_0x4b88ed['IPjHp'],[_0x5ac12d['params']['id']]),_0x114f02['json']({'success':!![]});}catch(_0x52a663){_0x114f02['status'](0x1f4)[_0x43a4f6(0x33d)]({'error':_0x52a663[_0x43a4f6(0x2c8)]});}});function safeParse(_0x400e32){if(!_0x400e32)return null;try{return JSON['parse'](_0x400e32);}catch(_0x38c02f){return null;}}app[_0x165f6e(0x1a2)]('/api/dingtalk/departments',async(_0x1f0e4f,_0xc70f31)=>{const _0x4ae5e5=_0x165f6e,_0x56e910={'cmLZU':_0x4ae5e5(0x1a0),'isGYD':function(_0x47f012,_0xe94087){return _0x47f012(_0xe94087);},'YoeSE':function(_0x58df79,_0x5ebcc3){return _0x58df79!==_0x5ebcc3;}};try{if(!axios)axios=require(_0x56e910[_0x4ae5e5(0x386)]);const _0x21c1f0=await getDingTalkAccessToken(),_0x30f480=_0x1f0e4f[_0x4ae5e5(0x1bc)]['dept_id']||0x1,_0x485b74=await axios[_0x4ae5e5(0x364)]('https://oapi.dingtalk.com/topapi/v2/department/listsub?access_token='+_0x21c1f0,{'dept_id':_0x56e910[_0x4ae5e5(0x2b2)](Number,_0x30f480)});if(_0x56e910['YoeSE'](_0x485b74[_0x4ae5e5(0x200)]['errcode'],0x0))throw new Error(_0x485b74['data']['errmsg']||_0x4ae5e5(0x2c5));const _0x20a2f3=(_0x485b74['data'][_0x4ae5e5(0x3a9)]||[])['map'](_0x293a0c=>({'id':_0x293a0c[_0x4ae5e5(0x1c9)],'name':_0x293a0c['name'],'parent_id':_0x293a0c[_0x4ae5e5(0x340)],'create_dept_group':_0x293a0c[_0x4ae5e5(0x151)],'auto_add_user':_0x293a0c[_0x4ae5e5(0x311)]}));_0xc70f31[_0x4ae5e5(0x33d)](_0x20a2f3);}catch(_0x51b051){console['error']('[DingTalk]\x20获取部门列表失败:',_0x51b051['message']),_0xc70f31[_0x4ae5e5(0x1aa)](0x1f4)['json']({'error':_0x51b051[_0x4ae5e5(0x2c8)]});}}),app['get'](_0x165f6e(0x33a),async(_0x20fcb1,_0x206b12)=>{const _0x2cd19b=_0x165f6e,_0x38d1c7={'tSaYp':function(_0xa374d4,_0x2c3cde){return _0xa374d4(_0x2c3cde);},'XAtuo':function(_0x12ddf2,_0x1a01bb){return _0x12ddf2(_0x1a01bb);}};try{if(!axios)axios=require(_0x2cd19b(0x1a0));const _0x253e8f=await getDingTalkAccessToken(),_0x2be17b=_0x20fcb1[_0x2cd19b(0x1bc)][_0x2cd19b(0x1c9)]||0x1,_0x31db09=_0x20fcb1['query']['cursor']||0x0,_0x38e196=Math[_0x2cd19b(0x27a)](_0x38d1c7[_0x2cd19b(0x3b7)](Number,_0x20fcb1[_0x2cd19b(0x1bc)][_0x2cd19b(0x2f9)])||0x64,0x64),_0x365044=await axios['post'](_0x2cd19b(0x2ff)+_0x253e8f,{'dept_id':Number(_0x2be17b),'cursor':_0x38d1c7[_0x2cd19b(0x17d)](Number,_0x31db09),'size':_0x38e196});if(_0x365044['data'][_0x2cd19b(0x39e)]!==0x0)throw new Error(_0x365044[_0x2cd19b(0x200)]['errmsg']||_0x2cd19b(0x2c6));const _0x3cd7c1=_0x365044['data']['result']||{},_0x3f6230=(_0x3cd7c1[_0x2cd19b(0x3cd)]||[])['map'](_0xc9da2e=>({'employee_id':_0xc9da2e['userid'],'name':_0xc9da2e[_0x2cd19b(0x324)],'department':(_0xc9da2e[_0x2cd19b(0x1ed)]||[])[_0x2cd19b(0x159)](','),'position':_0xc9da2e[_0x2cd19b(0x3c8)]||'','phone':_0xc9da2e['mobile']||'','email':_0xc9da2e[_0x2cd19b(0x358)]||'','avatar':_0xc9da2e['avatar']||'','job_number':_0xc9da2e['job_number']||''}));_0x206b12[_0x2cd19b(0x33d)]({'list':_0x3f6230,'has_more':_0x3cd7c1['has_more']||![],'next_cursor':_0x3cd7c1['next_cursor']||0x0});}catch(_0x13018f){console[_0x2cd19b(0x3bf)](_0x2cd19b(0x23b),_0x13018f[_0x2cd19b(0x2c8)]),_0x206b12[_0x2cd19b(0x1aa)](0x1f4)[_0x2cd19b(0x33d)]({'error':_0x13018f[_0x2cd19b(0x2c8)]});}}),app['post']('/api/departments/sync-dingtalk',async(_0xc4b610,_0x1ab916)=>{const _0x7451b9=_0x165f6e,_0x4a2820={'hfmNP':function(_0x25da85,_0x53691f){return _0x25da85===_0x53691f;},'xqPPn':'DEPT','eGGCX':function(_0x1eb606,_0x57fa21){return _0x1eb606(_0x57fa21);},'cEKMH':'INSERT\x20INTO\x20departments\x20(id,\x20name,\x20code,\x20parent_id,\x20type,\x20manager,\x20phone,\x20email,\x20status,\x20description)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)\x20ON\x20DUPLICATE\x20KEY\x20UPDATE\x20name=VALUES(name),\x20code=VALUES(code),\x20parent_id=VALUES(parent_id),\x20type=VALUES(type),\x20manager=VALUES(manager),\x20phone=VALUES(phone),\x20email=VALUES(email),\x20status=VALUES(status),\x20description=VALUES(description)','cQAgv':_0x7451b9(0x265)};try{let _0x2cb2cc=Array['isArray'](_0xc4b610['body']?.['items'])?_0xc4b610[_0x7451b9(0x188)]['items']:[];if(_0x2cb2cc['length']===0x0){if(!axios)axios=require(_0x7451b9(0x1a0));const _0x2bd0bf=await getDingTalkAccessToken(),_0x6628ef=Number(_0xc4b610[_0x7451b9(0x188)]?.[_0x7451b9(0x3b3)]||process[_0x7451b9(0x308)][_0x7451b9(0x14c)]||0x1);console['log'](_0x7451b9(0x15b),_0x6628ef);const _0x5ae56d=[_0x6628ef],_0x2905e8=new Set(),_0x3d3ed3=[];while(_0x5ae56d['length']>0x0){const _0x1ad847=_0x5ae56d[_0x7451b9(0x11e)]();if(_0x2905e8[_0x7451b9(0x1c1)](_0x1ad847))continue;_0x2905e8[_0x7451b9(0x3dd)](_0x1ad847);try{const _0x373895=await axios[_0x7451b9(0x364)](_0x7451b9(0x2e2)+_0x2bd0bf,{'dept_id':_0x1ad847});if(_0x373895['data']['errcode']===0x0&&_0x373895['data'][_0x7451b9(0x3a9)]){if('KdUED'==='KdUED'){const _0x30d298=_0x373895[_0x7451b9(0x200)][_0x7451b9(0x3a9)],_0x8edbe0=!_0x30d298[_0x7451b9(0x340)]||_0x4a2820[_0x7451b9(0x390)](_0x30d298[_0x7451b9(0x340)],0x0)||_0x30d298['parent_id']===0x1,_0x127da3=_0x8edbe0?_0x7451b9(0x16f):_0x4a2820[_0x7451b9(0x16d)];_0x3d3ed3[_0x7451b9(0x2f4)]({'id':_0x30d298[_0x7451b9(0x1c9)],'name':_0x30d298[_0x7451b9(0x324)],'parent_id':_0x30d298['parent_id']??null,'type':_0x127da3,'code':_0x4a2820[_0x7451b9(0x12b)](String,_0x30d298['dept_id']),'manager':_0x30d298[_0x7451b9(0x3d9)]||null,'phone':null,'email':null,'status':_0x7451b9(0x265),'description':null});}else return _0x16e3c0['status'](0x1f4)[_0x7451b9(0x33d)]({'error':_0x4e528f[_0x7451b9(0x2c8)]});}}catch(_0x33126d){console[_0x7451b9(0x3bf)](_0x7451b9(0x338)+_0x1ad847+_0x7451b9(0x2e1),_0x33126d['message']);}let _0x40f634=0x0;while(!![]){try{const _0xa0f394=await axios[_0x7451b9(0x364)]('https://oapi.dingtalk.com/topapi/v2/department/listsub?access_token='+_0x2bd0bf,{'dept_id':_0x1ad847,'cursor':_0x40f634,'size':0x64});if(_0xa0f394['data']['errcode']!==0x0)break;const _0x53e164=Array['isArray'](_0xa0f394[_0x7451b9(0x200)][_0x7451b9(0x3a9)])?_0xa0f394[_0x7451b9(0x200)][_0x7451b9(0x3a9)]:[];for(const _0x20ac05 of _0x53e164){!_0x2905e8[_0x7451b9(0x1c1)](_0x20ac05[_0x7451b9(0x1c9)])&&_0x5ae56d[_0x7451b9(0x2f4)](_0x20ac05['dept_id']);}break;}catch(_0x58722c){break;}}}_0x2cb2cc=_0x3d3ed3,console['log'](_0x7451b9(0x205)+_0x2cb2cc[_0x7451b9(0x2fb)]+_0x7451b9(0x210));}let _0x3c8d11=0x0;if(dbPool)for(const _0x1b3383 of _0x2cb2cc){const _0x4431cd=_0x1b3383['id']||_0x1b3383['dept_id']||_0x1b3383['department_id']||null,_0x1a9f4a=_0x1b3383[_0x7451b9(0x324)]||_0x1b3383[_0x7451b9(0x36e)]||_0x1b3383[_0x7451b9(0x2eb)]||'',_0xc0abe5=_0x1b3383[_0x7451b9(0x325)]||_0x1b3383['dept_code']||String(_0x4431cd),_0x45dc1d=_0x1b3383['manager']||null,_0x4d9a97=_0x1b3383[_0x7451b9(0x167)]||null,_0x2c4caf=_0x1b3383[_0x7451b9(0x358)]||null,_0x3cd088=_0x1b3383[_0x7451b9(0x1aa)]||'active',_0x42490d=_0x1b3383[_0x7451b9(0x395)]||null;try{const _0x5c4e9a=_0x1b3383['type']||_0x4a2820[_0x7451b9(0x16d)];await dbPool[_0x7451b9(0x1bc)](_0x4a2820[_0x7451b9(0x348)],[_0x4431cd,_0x1a9f4a,_0xc0abe5,_0x1b3383[_0x7451b9(0x340)]||null,_0x5c4e9a,_0x45dc1d,_0x4d9a97,_0x2c4caf,_0x3cd088,_0x42490d]),_0x3c8d11++;}catch(_0x3f271f){console[_0x7451b9(0x3bf)]('[DingTalk]\x20保存部门\x20'+_0x4431cd+_0x7451b9(0x138),_0x3f271f[_0x7451b9(0x2c8)]);}}else{const _0x43cb2c=await readTable(_0x7451b9(0x282)),_0x368b0a=new Map(_0x43cb2c[_0x7451b9(0x2c4)](_0x36e56c=>[_0x36e56c['id'],_0x36e56c]));for(const _0x27a993 of _0x2cb2cc){const _0x440889=_0x27a993['id']||_0x27a993[_0x7451b9(0x1c9)]||_0x27a993[_0x7451b9(0x1b9)];if(_0x440889){const _0x52011a=_0x368b0a[_0x7451b9(0x1a2)](_0x440889)||{},_0x50f996=_0x27a993[_0x7451b9(0x2b9)]||_0x52011a[_0x7451b9(0x2b9)]||'DEPT';_0x368b0a[_0x7451b9(0x19e)](_0x440889,{..._0x52011a,'id':_0x440889,'name':_0x27a993['name']||_0x27a993[_0x7451b9(0x36e)]||_0x27a993[_0x7451b9(0x2eb)]||_0x52011a[_0x7451b9(0x324)]||'','code':_0x27a993[_0x7451b9(0x325)]||_0x27a993[_0x7451b9(0x22d)]||_0x52011a['code']||String(_0x440889),'parent_id':_0x27a993[_0x7451b9(0x340)]!==undefined?_0x27a993['parent_id']:_0x52011a[_0x7451b9(0x340)]||null,'type':_0x50f996,'manager':_0x27a993['manager']||_0x52011a['manager']||'','phone':_0x27a993[_0x7451b9(0x167)]||_0x52011a['phone']||'','email':_0x27a993[_0x7451b9(0x358)]||_0x52011a['email']||'','status':_0x27a993['status']||_0x52011a[_0x7451b9(0x1aa)]||_0x4a2820['cQAgv'],'description':_0x27a993['description']||_0x52011a[_0x7451b9(0x395)]||'','created_at':_0x52011a['created_at']||new Date()[_0x7451b9(0x1d0)]()});}}await writeTable('departments',Array[_0x7451b9(0x2e6)](_0x368b0a[_0x7451b9(0x1db)]())),_0x3c8d11=_0x2cb2cc[_0x7451b9(0x2fb)];}_0x1ab916[_0x7451b9(0x33d)]({'success':!![],'count':_0x3c8d11});}catch(_0x4c418b){console[_0x7451b9(0x3bf)](_0x7451b9(0x343),_0x4c418b[_0x7451b9(0x2c8)]),_0x1ab916['status'](0x1f4)[_0x7451b9(0x33d)]({'error':_0x4c418b['message']});}}),app['post']('/api/employees/sync-dingtalk',async(_0x4c4774,_0x316c72)=>{const _0x1401e5=_0x165f6e,_0x45c8d8={'MKkGF':function(_0x382f72,_0x5d5d8e){return _0x382f72===_0x5d5d8e;},'lOxPj':'axios','YXGXk':_0x1401e5(0x221),'dziSG':'SELECT\x20id,\x20name\x20FROM\x20departments','rNxoR':function(_0x2cef38,_0x3f6dd7){return _0x2cef38(_0x3f6dd7);},'cGQru':_0x1401e5(0x3d3),'CQGqt':_0x1401e5(0x260),'bOgnm':function(_0x2dee98,_0x24cb72){return _0x2dee98===_0x24cb72;},'CVNlB':function(_0x80076d,_0x3fd415){return _0x80076d!==_0x3fd415;},'jDjYG':'RnmqS','dkcOW':_0x1401e5(0x374),'fQoeb':_0x1401e5(0x3a3),'lumoz':_0x1401e5(0x3c2),'KLlaG':_0x1401e5(0x265),'QWLAG':function(_0x4e32e4,_0x19d46d){return _0x4e32e4(_0x19d46d);},'iwrDp':_0x1401e5(0x13d),'RYGBn':_0x1401e5(0x297)};try{let _0x38255e=Array[_0x1401e5(0x35a)](_0x4c4774[_0x1401e5(0x188)]?.[_0x1401e5(0x2f3)])?_0x4c4774['body']['items']:[];if(_0x45c8d8['MKkGF'](_0x38255e['length'],0x0)){if(!axios)axios=require(_0x45c8d8['lOxPj']);const _0x1de30f=await getDingTalkAccessToken();console[_0x1401e5(0x128)](_0x45c8d8[_0x1401e5(0x24c)]);let _0x245ec1=[];const _0x4a39c2=new Map();if(dbPool)try{const [_0x5c1038]=await dbPool[_0x1401e5(0x1bc)](_0x45c8d8[_0x1401e5(0x18e)]);_0x245ec1=_0x5c1038[_0x1401e5(0x2c4)](_0x28d834=>Number(_0x28d834['id'])),_0x5c1038['forEach'](_0x2f4cf3=>_0x4a39c2['set'](Number(_0x2f4cf3['id']),String(_0x2f4cf3['name']||'')));}catch(_0x5044fc){console['error']('[DingTalk]\x20获取部门列表失败:',_0x5044fc['message']);}else try{const _0x272a42=await _0x45c8d8[_0x1401e5(0x244)](readTable,_0x1401e5(0x282));_0x245ec1=_0x272a42[_0x1401e5(0x2c4)](_0x2ce6a5=>Number(_0x2ce6a5['id']||0x0))[_0x1401e5(0x198)](_0x35f535=>_0x35f535>0x0),_0x272a42['forEach'](_0x1483f9=>_0x4a39c2[_0x1401e5(0x19e)](Number(_0x1483f9['id']||0x0),String(_0x1483f9['name']||'')));}catch(_0x5c2e35){'DsKvh'!==_0x45c8d8[_0x1401e5(0x18d)]?console['error'](_0x45c8d8['CQGqt'],_0x5c2e35[_0x1401e5(0x2c8)]):_0x2b0bcd['status'](0x1f4)[_0x1401e5(0x33d)]({'error':_0x2f0087['message']});}if(_0x45c8d8['bOgnm'](_0x245ec1['length'],0x0)){if(_0x45c8d8[_0x1401e5(0x1f3)](_0x45c8d8[_0x1401e5(0x1d1)],_0x1401e5(0x215)))return _0x23d65c[_0x1401e5(0x2fc)](_0xefcd98);else{const _0x390df9=_0x45c8d8['rNxoR'](Number,_0x4c4774[_0x1401e5(0x188)]?.['root_dept_id']||process[_0x1401e5(0x308)][_0x1401e5(0x14c)]||0x1);_0x245ec1=[_0x390df9];try{if(_0x45c8d8[_0x1401e5(0x21f)]===_0x45c8d8[_0x1401e5(0x1be)])_0x559d57['push'](_0x1401e5(0x190)),_0x5aab29[_0x1401e5(0x2f4)](_0x5f3a26(_0x3976e0));else{const _0x2eec76=await axios['post']('https://oapi.dingtalk.com/topapi/v2/department/get?access_token='+_0x1de30f,{'dept_id':_0x390df9});_0x45c8d8['bOgnm'](_0x2eec76['data'][_0x1401e5(0x39e)],0x0)&&_0x2eec76[_0x1401e5(0x200)][_0x1401e5(0x3a9)]&&_0x4a39c2['set'](_0x390df9,_0x2eec76['data'][_0x1401e5(0x3a9)][_0x1401e5(0x324)]);}}catch(_0x4c8dde){}}}const _0x589638=[],_0x21eaf7=new Set();for(const _0x401903 of _0x245ec1){const _0x3e740e=_0x4a39c2[_0x1401e5(0x1a2)](_0x401903)||'未知部门';let _0x5168d4=0x0;while(!![]){try{const _0x2df2a2=await axios['post'](_0x1401e5(0x2ff)+_0x1de30f,{'dept_id':_0x401903,'cursor':_0x5168d4,'size':0x64});if(_0x2df2a2['data'][_0x1401e5(0x39e)]!==0x0)break;const _0x5c554e=_0x2df2a2['data'][_0x1401e5(0x3a9)]?.['list']||[];for(const _0x4d849c of _0x5c554e){if(_0x21eaf7[_0x1401e5(0x1c1)](_0x4d849c['userid']))continue;_0x21eaf7[_0x1401e5(0x3dd)](_0x4d849c[_0x1401e5(0x349)]),_0x589638[_0x1401e5(0x2f4)]({'employee_id':_0x4d849c['userid'],'name':_0x4d849c[_0x1401e5(0x324)]||'','department':_0x3e740e,'position':_0x4d849c[_0x1401e5(0x3c8)]||'','phone':_0x4d849c[_0x1401e5(0x1c7)]||'','email':_0x4d849c['email']||_0x4d849c[_0x1401e5(0x1cc)]||'','status':_0x45c8d8['bOgnm'](_0x4d849c['active'],![])?_0x45c8d8['lumoz']:_0x45c8d8[_0x1401e5(0x121)]});}if(!_0x2df2a2['data'][_0x1401e5(0x3a9)]?.[_0x1401e5(0x235)])break;_0x5168d4=_0x2df2a2[_0x1401e5(0x200)]['result']?.['next_cursor']||0x0;}catch(_0x1abf61){console[_0x1401e5(0x3bf)]('[DingTalk]\x20获取部门\x20'+_0x401903+_0x1401e5(0x38f),_0x1abf61[_0x1401e5(0x2c8)]);break;}}}_0x38255e=_0x589638,console['log'](_0x1401e5(0x205)+_0x38255e[_0x1401e5(0x2fb)]+_0x1401e5(0x1f2));}let _0x2f0b3d=0x0;if(dbPool)for(const _0x3902da of _0x38255e){const _0x1e14bc=_0x3902da[_0x1401e5(0x175)]||_0x3902da[_0x1401e5(0x349)]||_0x3902da['jobnumber']||null,_0x2b325e=_0x3902da[_0x1401e5(0x324)]||_0x3902da['username']||_0x3902da[_0x1401e5(0x2cc)]||'',_0x27c11c=_0x3902da['department']||_0x3902da['dept_name']||'',_0xe67d5c=_0x3902da[_0x1401e5(0x1a7)]||'',_0x3858ba=_0x3902da['phone']||_0x3902da['mobile']||'',_0x1e475a=_0x3902da[_0x1401e5(0x358)]||'',_0x3c5e67=_0x3902da[_0x1401e5(0x1aa)]||_0x1401e5(0x265);if(!_0x1e14bc)continue;try{await dbPool['query']('INSERT\x20INTO\x20employees\x20(employee_id,\x20name,\x20department,\x20position,\x20phone,\x20email,\x20status)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)\x20ON\x20DUPLICATE\x20KEY\x20UPDATE\x20name=VALUES(name),\x20department=VALUES(department),\x20position=VALUES(position),\x20phone=VALUES(phone),\x20email=VALUES(email),\x20status=VALUES(status)',[_0x1e14bc,_0x2b325e,_0x27c11c,_0xe67d5c,_0x3858ba,_0x1e475a,_0x3c5e67]),_0x2f0b3d++;}catch(_0x3d1f6d){console['error'](_0x1401e5(0x1de)+_0x1e14bc+'\x20失败:',_0x3d1f6d['message']);}}else{const _0x2dd4b3=await _0x45c8d8['QWLAG'](readTable,_0x45c8d8['iwrDp']),_0x16bfb7=new Map(_0x2dd4b3[_0x1401e5(0x2c4)](_0x29b85b=>[_0x29b85b[_0x1401e5(0x175)],_0x29b85b]));for(const _0x2efe71 of _0x38255e){const _0x383cb8=_0x2efe71['employee_id']||_0x2efe71['userid']||_0x2efe71[_0x1401e5(0x312)];if(_0x383cb8){const _0x42e437=_0x16bfb7['get'](_0x383cb8)||{};_0x16bfb7[_0x1401e5(0x19e)](_0x383cb8,{..._0x42e437,'employee_id':_0x383cb8,'name':_0x2efe71[_0x1401e5(0x324)]||_0x2efe71['username']||_0x2efe71['realname']||_0x42e437['name']||'','department':_0x2efe71['department']||_0x2efe71[_0x1401e5(0x36e)]||_0x42e437[_0x1401e5(0x34e)]||'','position':_0x2efe71['position']||_0x42e437[_0x1401e5(0x1a7)]||'','phone':_0x2efe71[_0x1401e5(0x167)]||_0x2efe71['mobile']||_0x42e437['phone']||'','email':_0x2efe71['email']||_0x42e437[_0x1401e5(0x358)]||'','status':_0x2efe71[_0x1401e5(0x1aa)]||_0x42e437['status']||_0x45c8d8[_0x1401e5(0x121)],'created_at':_0x42e437[_0x1401e5(0x3d8)]||new Date()['toISOString']()});}}await writeTable(_0x1401e5(0x13d),Array['from'](_0x16bfb7[_0x1401e5(0x1db)]())),_0x2f0b3d=_0x38255e[_0x1401e5(0x2fb)];}_0x316c72[_0x1401e5(0x33d)]({'success':!![],'count':_0x2f0b3d});}catch(_0xbbf933){console[_0x1401e5(0x3bf)](_0x45c8d8['RYGBn'],_0xbbf933['message']),_0x316c72['status'](0x1f4)[_0x1401e5(0x33d)]({'error':_0xbbf933['message']});}}),app[_0x165f6e(0x1a2)]('/api/admin/backups',async(_0x360a17,_0x3daf24)=>{const _0x20621f=_0x165f6e,_0x1ff1f7={'NywrD':function(_0x52f324,_0x2c5814){return _0x52f324(_0x2c5814);},'iwoIr':function(_0x3effd8,_0x4a5048){return _0x3effd8+_0x4a5048;}};try{const _0x562347=Math['max'](0x1,Math[_0x20621f(0x27a)](0xc8,_0x1ff1f7[_0x20621f(0x24a)](Number,_0x360a17[_0x20621f(0x1bc)]?.[_0x20621f(0x3bd)]||0x32))),_0xbc066d=Math['max'](0x0,Number(_0x360a17[_0x20621f(0x1bc)]?.[_0x20621f(0x3a2)]||0x0)),_0x1fda61=await fs[_0x20621f(0x248)](backupsDir),_0x542a15=[];for(const _0x4229ff of _0x1fda61){try{const _0x1535c9=path[_0x20621f(0x159)](backupsDir,_0x4229ff),_0x1b488e=await fs[_0x20621f(0x359)](_0x1535c9);_0x1b488e['isFile']()&&_0x542a15[_0x20621f(0x2f4)]({'name':_0x4229ff,'mtime':_0x1b488e[_0x20621f(0x227)]['toISOString'](),'size':_0x1b488e[_0x20621f(0x2f9)]});}catch(_0x549c21){}}_0x542a15[_0x20621f(0x2ce)]((_0x3f8c68,_0x2f37d6)=>new Date(_0x2f37d6[_0x20621f(0x227)])-new Date(_0x3f8c68['mtime']));const _0x33e980=_0x542a15[_0x20621f(0x2fb)],_0x13ef03=_0x542a15[_0x20621f(0x1f5)](_0xbc066d,_0x1ff1f7[_0x20621f(0x2ec)](_0xbc066d,_0x562347))[_0x20621f(0x2c4)](_0x178312=>({..._0x178312,'url':'/backups/'+encodeURIComponent(_0x178312['name'])}));_0x3daf24['json']({'items':_0x13ef03,'total':_0x33e980});}catch(_0x3e718e){_0x3daf24[_0x20621f(0x1aa)](0x1f4)[_0x20621f(0x33d)]({'error':_0x3e718e[_0x20621f(0x2c8)]});}}),app['delete']('/api/admin/backups/:name',async(_0x332f3a,_0x538383)=>{const _0x8e21b4=_0x165f6e,_0x2521c7={'UgEdG':function(_0x4052dc,_0x290cfc){return _0x4052dc(_0x290cfc);},'PeSgD':_0x8e21b4(0x21e),'meNWc':_0x8e21b4(0x11f)};try{const _0x1de977=_0x2521c7[_0x8e21b4(0x1ff)](String,_0x332f3a['params']?.['name']||''),_0x4f36d6=_0x1de977[_0x8e21b4(0x19d)](/[^a-zA-Z0-9._-]/g,'_');if(!/^system-backup-\d{8}-\d{6}\.json$/[_0x8e21b4(0x362)](_0x4f36d6))return _0x538383['status'](0x190)['json']({'error':_0x2521c7[_0x8e21b4(0x1fd)]});const _0x4a9c4a=path['join'](backupsDir,_0x4f36d6);try{await fs[_0x8e21b4(0x144)](_0x4a9c4a);}catch(_0x2330ff){return _0x538383['status'](0x194)['json']({'error':_0x2521c7[_0x8e21b4(0x1ea)]});}_0x538383[_0x8e21b4(0x33d)]({'success':!![]});}catch(_0x2a5dee){_0x538383['status'](0x1f4)['json']({'error':_0x2a5dee['message']});}}),app[_0x165f6e(0x1a2)](_0x165f6e(0x13a),async(_0x5f1998,_0x398fd0)=>{const _0x406198=_0x165f6e,_0x2e91e1={'hUhhd':_0x406198(0x255),'lpxwq':function(_0x4464f3,_0x2979ab){return _0x4464f3(_0x2979ab);},'dawOx':_0x406198(0x212),'twiGj':function(_0x4daa6f,_0x1a6d37){return _0x4daa6f-_0x1a6d37;},'AHDZT':function(_0xd52bde,_0x5e254c){return _0xd52bde-_0x5e254c;},'UAaPB':function(_0x345e46,_0x49bf3b){return _0x345e46!==_0x49bf3b;},'pcQBx':_0x406198(0x14d)};try{const _0x30d748=Math[_0x406198(0x3de)](0x1,Math['min'](0xc8,_0x2e91e1['lpxwq'](Number,_0x5f1998['query']?.['limit']||0x32))),_0x49bfeb=Math[_0x406198(0x3de)](0x0,Number(_0x5f1998['query']?.[_0x406198(0x3a2)]||0x0));if(dbPool){const [_0xe96924]=await dbPool['query'](_0x406198(0x351),[_0x30d748,_0x49bfeb]);return _0x398fd0[_0x406198(0x33d)]({'items':_0xe96924});}const _0x35b2c0=await readTable(_0x2e91e1[_0x406198(0x16a)]),_0x6d495f=_0x35b2c0[_0x406198(0x1f5)](Math[_0x406198(0x3de)](0x0,_0x2e91e1['twiGj'](_0x2e91e1[_0x406198(0x11c)](_0x35b2c0[_0x406198(0x2fb)],_0x30d748),_0x49bfeb)),_0x35b2c0['length']-_0x49bfeb)['reverse']();return _0x398fd0[_0x406198(0x33d)]({'items':_0x6d495f});}catch(_0x390a4a){if(_0x2e91e1['UAaPB']('lUngz',_0x2e91e1[_0x406198(0x254)]))_0x398fd0[_0x406198(0x1aa)](0x1f4)['json']({'error':_0x390a4a['message']});else{const _0x5ab508=_0x55e5db['errmsg']||_0x2e91e1['hUhhd'],_0x2ac43b=_0x5ba3a9[_0x406198(0x25f)]?_0x406198(0x2d0)+_0x46166c['sub_code']+']':'';throw new _0x1d3ee8(''+_0x5ab508+_0x2ac43b);}}}),app['post'](_0x165f6e(0x32d),async(_0xc58f5d,_0x5d3902)=>{const _0x40d486=_0x165f6e,_0x261aba={'qcxeP':function(_0x4608e8,_0x309f14){return _0x4608e8!==_0x309f14;},'nUOgV':'lPvEW'};try{if(_0x261aba[_0x40d486(0x206)](_0x261aba[_0x40d486(0x218)],_0x40d486(0x309))){const _0x2859f3=await performBackup();_0x5d3902[_0x40d486(0x33d)](_0x2859f3);}else _0x255932['error']('Insert\x20annual_work_plans\x20failed:',_0x4d0086),_0x4934ab['status'](0x1f4)['json']({'error':_0x2ab301['message']});}catch(_0x3b7a64){_0x5d3902[_0x40d486(0x1aa)](0x1f4)[_0x40d486(0x33d)]({'error':_0x3b7a64['message']});}}),app[_0x165f6e(0x1a2)](_0x165f6e(0x1ba),async(_0x586bfb,_0x3b20fb)=>{const _0x2d28b1=_0x165f6e;try{const _0x67e8cb=await getSystemAutoBackupSettings(),_0x49483f=Boolean(_0x67e8cb&&_0x67e8cb['autoBackup']===!![]),_0x587fc3=Number(_0x67e8cb&&_0x67e8cb['backupInterval']!=null?_0x67e8cb[_0x2d28b1(0x1d7)]:null);_0x3b20fb[_0x2d28b1(0x33d)]({'enabled':_0x49483f,'intervalHours':_0x587fc3||null,'nextRunAt':nextBackupAt?nextBackupAt['toISOString']():null});}catch(_0x50c8a7){_0x3b20fb['status'](0x1f4)['json']({'error':_0x50c8a7[_0x2d28b1(0x2c8)]});}});const httpServer=createServer(app),io=new SocketIOServer(httpServer,{'path':'/socket.io','cors':{'origin':'*','methods':[_0x165f6e(0x2bc),'POST']}}),onlineRooms=new Set();io['on'](_0x165f6e(0x37f),_0x1f09e1=>{const _0x544e5f=_0x165f6e,_0x39a940={'GKwrq':'data-updated','RsJvW':_0x544e5f(0x1c4),'TLIZM':_0x544e5f(0x3e9),'cKNHk':_0x544e5f(0x24f)};console[_0x544e5f(0x128)]('Socket\x20connected:',_0x1f09e1['id']),_0x1f09e1['on'](_0x39a940['cKNHk'],_0x292e72=>{const _0x349d78=_0x544e5f;if(!_0x292e72)return;_0x1f09e1[_0x349d78(0x159)](_0x292e72),_0x1f09e1[_0x349d78(0x200)]['room']=_0x292e72,onlineRooms['add'](_0x292e72),io[_0x349d78(0x291)]('user-online',Array[_0x349d78(0x2e6)](onlineRooms));}),_0x1f09e1['on']('data-update',({room:_0x29c799,..._0x393324})=>{const _0x57a54a=_0x544e5f,_0x59ea8e=_0x29c799||_0x1f09e1[_0x57a54a(0x200)]['room'];_0x59ea8e&&io['to'](_0x59ea8e)['emit'](_0x39a940[_0x57a54a(0x29a)],_0x393324);}),_0x1f09e1['on'](_0x544e5f(0x1a8),_0x35e279=>{const _0x703cdf=_0x544e5f;if(!_0x35e279)return;try{_0x1f09e1[_0x703cdf(0x36c)](_0x35e279);}catch{}onlineRooms[_0x703cdf(0x1c1)](_0x35e279)&&(onlineRooms[_0x703cdf(0x231)](_0x35e279),io['emit'](_0x703cdf(0x1c4),Array['from'](onlineRooms)));}),_0x1f09e1['on']('disconnect',()=>{const _0x366ada=_0x544e5f,_0x5e3870=_0x1f09e1['data']['room'];_0x5e3870&&onlineRooms['has'](_0x5e3870)&&(onlineRooms['delete'](_0x5e3870),io[_0x366ada(0x291)](_0x39a940['RsJvW'],Array['from'](onlineRooms))),console[_0x366ada(0x128)](_0x39a940[_0x366ada(0x1ce)],_0x1f09e1['id']);});});async function start(){const _0x315a4d=_0x165f6e,_0x3d6bbe={'ExHhR':_0x315a4d(0x3d1)};try{await initDB();}catch(_0x1a6da5){console['error'](_0x3d6bbe[_0x315a4d(0x2a6)],_0x1a6da5?.[_0x315a4d(0x2c8)]||_0x1a6da5);}try{await applyAutoBackupSchedule();}catch(_0x533d80){}httpServer[_0x315a4d(0x258)](PORT,()=>{const _0x11d1b2=_0x315a4d;console[_0x11d1b2(0x128)]('Backend\x20server\x20listening\x20on\x20http://localhost:'+PORT);});}start();
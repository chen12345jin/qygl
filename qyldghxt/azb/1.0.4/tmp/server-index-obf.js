const _0x1ce9f3=_0x6017;(function(_0x5c9f64,_0xc80a03){const _0x3ec0c7=_0x6017,_0x2fa025=_0x5c9f64();while(!![]){try{const _0x40c1ac=parseInt(_0x3ec0c7(0x257))/0x1+parseInt(_0x3ec0c7(0x230))/0x2+parseInt(_0x3ec0c7(0x38a))/0x3*(-parseInt(_0x3ec0c7(0x21e))/0x4)+-parseInt(_0x3ec0c7(0x3fd))/0x5+-parseInt(_0x3ec0c7(0x2d2))/0x6+parseInt(_0x3ec0c7(0x320))/0x7+parseInt(_0x3ec0c7(0x2e0))/0x8*(-parseInt(_0x3ec0c7(0x3a3))/0x9);if(_0x40c1ac===_0xc80a03)break;else _0x2fa025['push'](_0x2fa025['shift']());}catch(_0x57b26a){_0x2fa025['push'](_0x2fa025['shift']());}}}(_0xfe32,0xcd35b));const express=require('express'),cors=require('cors'),multer=require('multer');let axios=null;const fs=require('fs')[_0x1ce9f3(0x241)],fsSync=require('fs'),{createServer}=require(_0x1ce9f3(0x382)),{Server:SocketIOServer}=require(_0x1ce9f3(0x41e)),path=require(_0x1ce9f3(0x275)),mysql=require(_0x1ce9f3(0x2b2)),dotenv=require(_0x1ce9f3(0x2bb)),jwt=require('jsonwebtoken'),crypto=require('crypto'),envPath=path['join'](process[_0x1ce9f3(0x490)](),'.env');dotenv['config']({'path':envPath,'override':!![]}),console[_0x1ce9f3(0x49f)](_0x1ce9f3(0x434),envPath),console[_0x1ce9f3(0x49f)]('DingTalk\x20config\x20check:',{'appKey':process[_0x1ce9f3(0x244)][_0x1ce9f3(0x31f)]?_0x1ce9f3(0x229):_0x1ce9f3(0x304),'appSecret':process['env']['DINGTALK_APP_SECRET']?_0x1ce9f3(0x229):_0x1ce9f3(0x304)});const app=express(),PORT=Number(process['env']['PORT']||0x138c),ENABLE_AUTH=String(process[_0x1ce9f3(0x244)]['ENABLE_AUTH']||'')['toLowerCase']()===_0x1ce9f3(0x475),JWT_SECRET=process[_0x1ce9f3(0x244)][_0x1ce9f3(0x348)]||_0x1ce9f3(0x232);(!process['env'][_0x1ce9f3(0x348)]||process['env']['JWT_SECRET']===_0x1ce9f3(0x232))&&(console[_0x1ce9f3(0x44e)]('\x0a⚠️\x20\x20警告:\x20JWT_SECRET\x20未配置或使用默认值！'),console[_0x1ce9f3(0x44e)]('\x20\x20\x20生产环境中，请在\x20.env\x20文件中设置强随机的\x20JWT_SECRET'),console[_0x1ce9f3(0x44e)](_0x1ce9f3(0x481)));app[_0x1ce9f3(0x34e)](express['json']({'limit':'50mb'}));const allowedOrigins=process[_0x1ce9f3(0x244)]['ALLOWED_ORIGINS']?process[_0x1ce9f3(0x244)][_0x1ce9f3(0x256)][_0x1ce9f3(0x1f5)](',')[_0x1ce9f3(0x377)](_0x4c011d=>_0x4c011d[_0x1ce9f3(0x487)]()):null;app[_0x1ce9f3(0x34e)](cors({'origin':(_0x34f6c2,_0x4b2a56)=>{const _0x584f25=_0x1ce9f3,_0x534c21={'YdzTV':function(_0x52f089,_0x55d615,_0xd7aa70){return _0x52f089(_0x55d615,_0xd7aa70);},'EnuCL':function(_0x2cbab1,_0x5753fc,_0x2094d6){return _0x2cbab1(_0x5753fc,_0x2094d6);},'iHVRR':'CORS\x20策略不允许来自此源的请求'};if(!_0x34f6c2)return _0x4b2a56(null,!![]);if(!allowedOrigins)return _0x534c21[_0x584f25(0x399)](_0x4b2a56,null,!![]);allowedOrigins['includes'](_0x34f6c2)?_0x534c21['EnuCL'](_0x4b2a56,null,!![]):_0x4b2a56(new Error(_0x534c21['iHVRR']));},'methods':['GET','POST','PUT','DELETE',_0x1ce9f3(0x2cd)],'credentials':!![]}));function _0x6017(_0x380310,_0x2fe906){_0x380310=_0x380310-0x1cf;const _0xfe32df=_0xfe32();let _0x60171b=_0xfe32df[_0x380310];return _0x60171b;}const uploadsDir=path['join'](process['cwd'](),_0x1ce9f3(0x38e));try{fsSync['mkdirSync'](uploadsDir,{'recursive':!![]});}catch(_0xcd7149){}const tempStoreDir=path['join'](process[_0x1ce9f3(0x490)](),'temp_store');try{fsSync['mkdirSync'](tempStoreDir,{'recursive':!![]});}catch(_0x150596){}const backupsDir=path[_0x1ce9f3(0x209)](process[_0x1ce9f3(0x490)](),_0x1ce9f3(0x428));try{fsSync['mkdirSync'](backupsDir,{'recursive':!![]});}catch(_0x53c579){}const tableFile=_0xc5a284=>path['join'](tempStoreDir,_0xc5a284+_0x1ce9f3(0x337));async function readTable(_0x48b3c9){const _0x56b1b4=_0x1ce9f3,_0x375a5a={'CuAAZ':function(_0x1a4c8b,_0x28c2ff){return _0x1a4c8b(_0x28c2ff);}};try{const _0x10ace4=await fs['readFile'](_0x375a5a[_0x56b1b4(0x440)](tableFile,_0x48b3c9),_0x56b1b4(0x441));return JSON['parse'](_0x10ace4||'[]')||[];}catch(_0x3c6be9){return[];}}async function writeTable(_0x114a4,_0x4e55d9){const _0x4e9dd1=_0x1ce9f3,_0x2363c8={'fgbMZ':function(_0x544f10,_0x2c8686){return _0x544f10(_0x2c8686);},'wxrEo':_0x4e9dd1(0x441)};await fs['writeFile'](_0x2363c8['fgbMZ'](tableFile,_0x114a4),JSON['stringify'](_0x4e55d9,null,0x2),_0x2363c8[_0x4e9dd1(0x264)]);}async function addRow(_0x4c3375,_0x374b6e){const _0x25ffd2=_0x1ce9f3,_0x3f219d={'LkwpB':function(_0x370e44,_0x637b93){return _0x370e44(_0x637b93);},'QhPef':function(_0x54cf33,_0x197b39){return _0x54cf33-_0x197b39;}},_0x26a492=await _0x3f219d['LkwpB'](readTable,_0x4c3375),_0x5c09dc=_0x26a492['length']?Number(_0x26a492[_0x3f219d[_0x25ffd2(0x2cb)](_0x26a492['length'],0x1)]['id']||0x0)+0x1:0x1,_0x3bb90e={'id':_0x5c09dc,'created_at':new Date()['toISOString'](),..._0x374b6e};return _0x26a492['push'](_0x3bb90e),await writeTable(_0x4c3375,_0x26a492),_0x3bb90e;}async function updateRow(_0x2e2f08,_0x25cd80,_0x290a0f){const _0x5a8573=_0x1ce9f3,_0x547ed1=await readTable(_0x2e2f08),_0x3af07e=_0x547ed1[_0x5a8573(0x1e5)](_0x10e688=>String(_0x10e688['id'])===String(_0x25cd80));_0x3af07e>=0x0&&(_0x547ed1[_0x3af07e]={..._0x547ed1[_0x3af07e],..._0x290a0f},await writeTable(_0x2e2f08,_0x547ed1));}async function deleteRow(_0x5c6efe,_0x3a0105){const _0x11379f=_0x1ce9f3,_0x2597b0=await readTable(_0x5c6efe),_0x384365=_0x2597b0[_0x11379f(0x2d9)](_0x3aa607=>String(_0x3aa607['id'])!==String(_0x3a0105));await writeTable(_0x5c6efe,_0x384365);}const diskStorage=multer['diskStorage']({'destination':(_0x41d2f1,_0x1ab1b1,_0x1a9f55)=>{_0x1a9f55(null,uploadsDir);},'filename':(_0x339ab7,_0x31c86b,_0x575625)=>{const _0x288036=_0x1ce9f3,_0x1f1b1d=_0x31c86b[_0x288036(0x493)][_0x288036(0x369)](/[^a-zA-Z0-9._-]/g,'_');_0x575625(null,Date['now']()+'-'+_0x1f1b1d);}}),allowedFileTypes=/\.(jpg|jpeg|png|gif|bmp|webp|pdf|doc|docx|xls|xlsx|ppt|pptx|txt|csv|zip|rar)$/i,upload=multer({'storage':diskStorage,'limits':{'fileSize':0xa*0x400*0x400},'fileFilter':(_0x4eb4d0,_0xfb822d,_0x110f67)=>{const _0x35cb5e=_0x1ce9f3,_0x3bd09a={'TjukD':function(_0x1b820e,_0x46a586,_0x492b03){return _0x1b820e(_0x46a586,_0x492b03);}};allowedFileTypes[_0x35cb5e(0x3a8)](_0xfb822d[_0x35cb5e(0x493)])?_0x3bd09a['TjukD'](_0x110f67,null,!![]):_0x110f67(new Error('不支持的文件类型，允许的类型：图片、PDF、Office文档、压缩包'));}}),BACKUP_TABLES=[_0x1ce9f3(0x20a),_0x1ce9f3(0x2c3),_0x1ce9f3(0x32a),_0x1ce9f3(0x335),_0x1ce9f3(0x3ef),'department_targets',_0x1ce9f3(0x371),'templates',_0x1ce9f3(0x21c),_0x1ce9f3(0x28d),_0x1ce9f3(0x3c9),_0x1ce9f3(0x1d5),_0x1ce9f3(0x364),'users',_0x1ce9f3(0x476)];function normalizeDateTimeFields(_0x495f9d){const _0x49fb63=_0x1ce9f3,_0x35526a={'OBEZP':_0x49fb63(0x47e)};if(!_0x495f9d||typeof _0x495f9d!==_0x49fb63(0x1fb))return _0x495f9d;const _0x12e474={..._0x495f9d},_0xa214db=Object['keys'](_0x12e474);for(const _0x5cd647 of _0xa214db){const _0x1e8b2a=_0x5cd647['toLowerCase']();if(_0x1e8b2a==='created_at'||_0x1e8b2a==='updated_at'||_0x1e8b2a==='published_at'||_0x1e8b2a[_0x49fb63(0x238)](_0x35526a[_0x49fb63(0x3c6)])){const _0x12b50a=_0x12e474[_0x5cd647];if(typeof _0x12b50a==='string'){const _0x3873bb=_0x12b50a['match'](/^(\d{4}-\d{2}-\d{2})[T ](\d{2}:\d{2}:\d{2})/);_0x3873bb&&(_0x12e474[_0x5cd647]=_0x3873bb[0x1]+'\x20'+_0x3873bb[0x2]);}}}return _0x12e474;}app[_0x1ce9f3(0x34e)]('/uploads',express['static'](uploadsDir)),app[_0x1ce9f3(0x34e)](_0x1ce9f3(0x46e),express[_0x1ce9f3(0x47a)](backupsDir)),app[_0x1ce9f3(0x2c1)](_0x1ce9f3(0x2d4),upload[_0x1ce9f3(0x3e7)](_0x1ce9f3(0x39f)),(_0x1d6ff6,_0x1650b1)=>{const _0x579db7=_0x1ce9f3;try{if(!_0x1d6ff6['file'])return _0x1650b1[_0x579db7(0x42b)](0x190)['json']({'error':_0x579db7(0x480)});const _0x5ab5c4='/uploads/'+_0x1d6ff6[_0x579db7(0x39f)]['filename'];_0x1650b1[_0x579db7(0x1fc)]({'success':!![],'url':_0x5ab5c4,'filename':_0x1d6ff6['file']['filename'],'originalname':_0x1d6ff6['file'][_0x579db7(0x493)],'size':_0x1d6ff6[_0x579db7(0x39f)]['size']});}catch(_0x3ef630){_0x1650b1['status'](0x1f4)['json']({'error':_0x3ef630[_0x579db7(0x359)]});}}),app['use']((_0x52b5c7,_0x1323ec,_0x11e9cc,_0x388339)=>{const _0x527c28=_0x1ce9f3,_0x298b8c={'qvhmG':'LIMIT_FILE_SIZE'};if(_0x52b5c7 instanceof multer['MulterError']){if(_0x52b5c7[_0x527c28(0x43d)]===_0x298b8c['qvhmG'])return _0x11e9cc[_0x527c28(0x42b)](0x190)['json']({'error':'文件大小超过限制（最大\x2010MB）'});return _0x11e9cc['status'](0x190)['json']({'error':'文件上传错误:\x20'+_0x52b5c7[_0x527c28(0x359)]});}if(_0x52b5c7&&_0x52b5c7['message']&&_0x52b5c7['message'][_0x527c28(0x24b)](_0x527c28(0x3ab)))return _0x11e9cc[_0x527c28(0x42b)](0x190)['json']({'error':_0x52b5c7[_0x527c28(0x359)]});_0x388339(_0x52b5c7);});let autoBackupTimer=null,nextBackupAt=null;async function performBackup(){const _0x11d966=_0x1ce9f3,_0x502cd4={'YvvuC':function(_0x403257,_0x52c5a2){return _0x403257(_0x52c5a2);},'EyvPI':function(_0x12a557,_0x276373){return _0x12a557(_0x276373);}},_0x453f41=_0x367c4d=>String(_0x367c4d)[_0x11d966(0x2b8)](0x2,'0'),_0x3c6026=new Date(),_0x53dd3d=''+_0x3c6026[_0x11d966(0x489)]()+_0x453f41(_0x3c6026[_0x11d966(0x3c0)]()+0x1)+_0x453f41(_0x3c6026['getDate']())+'-'+_0x502cd4['YvvuC'](_0x453f41,_0x3c6026[_0x11d966(0x1e7)]())+_0x453f41(_0x3c6026['getMinutes']())+_0x502cd4['YvvuC'](_0x453f41,_0x3c6026[_0x11d966(0x3d9)]()),_0x376298='system-backup-'+_0x53dd3d+_0x11d966(0x337),_0x3e7d30=path['join'](backupsDir,_0x376298),_0x59d60e=BACKUP_TABLES,_0x50fedb={'timestamp':_0x3c6026['toISOString'](),'data':{}};if(dbPool)for(const _0x54e6ae of _0x59d60e){try{const [_0x5549b2]=await dbPool['query'](_0x11d966(0x2a6)+_0x54e6ae);_0x50fedb[_0x11d966(0x26f)][_0x54e6ae]=_0x5549b2;}catch(_0x48d575){_0x50fedb['data'][_0x54e6ae]=[];}}else for(const _0x2db55e of _0x59d60e){try{_0x50fedb[_0x11d966(0x26f)][_0x2db55e]=await _0x502cd4[_0x11d966(0x3f4)](readTable,_0x2db55e);}catch(_0x4e5069){_0x50fedb[_0x11d966(0x26f)][_0x2db55e]=[];}}return await fs[_0x11d966(0x1dc)](_0x3e7d30,JSON['stringify'](_0x50fedb,null,0x2),_0x11d966(0x441)),{'path':'/backups/'+encodeURIComponent(_0x376298),'name':_0x376298};}async function restoreBackupFromFile(_0x117e29){const _0x451e76=_0x1ce9f3,_0x3095aa={'xudxr':function(_0x478c70,_0x5c2578){return _0x478c70(_0x5c2578);},'uOQzi':_0x451e76(0x441),'JcSoD':_0x451e76(0x1da),'pHIKg':function(_0x5d5b4d,_0x2f86c3){return _0x5d5b4d||_0x2f86c3;},'XKOgi':'备份文件内容不是有效的JSON','ztSbj':_0x451e76(0x247),'HFAUr':function(_0x3b9c00,_0x36f2d6,_0x37727f){return _0x3b9c00(_0x36f2d6,_0x37727f);}},_0x35634e=_0x3095aa['xudxr'](String,_0x117e29||'')['replace'](/[^a-zA-Z0-9._-]/g,'_');if(!/^system-backup-\d{8}-\d{6}\.json$/[_0x451e76(0x3a8)](_0x35634e))throw new Error('非法备份文件名');const _0x8a8be4=path[_0x451e76(0x209)](backupsDir,_0x35634e);let _0x512c30=null;try{_0x512c30=await fs[_0x451e76(0x1f7)](_0x8a8be4,_0x3095aa[_0x451e76(0x2bc)]);}catch(_0x3cc264){throw new Error(_0x3095aa['JcSoD']);}let _0x46eb06=null;try{_0x46eb06=JSON[_0x451e76(0x485)](_0x3095aa[_0x451e76(0x2be)](_0x512c30,'{}'));}catch(_0x3efc11){throw new Error(_0x3095aa['XKOgi']);}if(!_0x46eb06||typeof _0x46eb06!==_0x451e76(0x1fb)||!_0x46eb06['data']||typeof _0x46eb06['data']!==_0x451e76(0x1fb))throw new Error(_0x3095aa['ztSbj']);const _0x37a2f5=BACKUP_TABLES;if(dbPool)for(const _0x228088 of _0x37a2f5){const _0x474bd7=Array['isArray'](_0x46eb06['data'][_0x228088])?_0x46eb06['data'][_0x228088]:[];await dbPool['query']('DELETE\x20FROM\x20'+_0x228088);if(_0x474bd7[_0x451e76(0x43c)])for(const _0x3fe274 of _0x474bd7){const _0x56bf13=_0x3095aa[_0x451e76(0x413)](normalizeDateTimeFields,_0x3fe274);await dbPool[_0x451e76(0x429)]('INSERT\x20INTO\x20'+_0x228088+_0x451e76(0x31a),_0x56bf13);}}else for(const _0x559ebf of _0x37a2f5){const _0x351055=Array['isArray'](_0x46eb06[_0x451e76(0x26f)][_0x559ebf])?_0x46eb06['data'][_0x559ebf]:[];await _0x3095aa['HFAUr'](writeTable,_0x559ebf,_0x351055);}}const backupUpload=multer({'storage':multer['memoryStorage'](),'limits':{'fileSize':0xa*0x400*0x400},'fileFilter':(_0x1052ed,_0x4aec45,_0x35cd99)=>{/\.json$/i['test'](_0x4aec45['originalname'])?_0x35cd99(null,!![]):_0x35cd99(new Error('只支持\x20JSON\x20备份文件'));}});async function getSystemAutoBackupSettings(){const _0x43793e=_0x1ce9f3,_0x580fa0={'xsiea':_0x43793e(0x3d6),'dNpZf':_0x43793e(0x364)};let _0x22090a=null;if(dbPool)try{const [_0x47ef85]=await dbPool['query'](_0x580fa0['xsiea'],['system']),_0x54b6fc=_0x47ef85&&_0x47ef85[0x0]?_0x47ef85[0x0][_0x43793e(0x2ea)]:null;try{_0x22090a=_0x54b6fc?JSON[_0x43793e(0x485)](_0x54b6fc):null;}catch(_0x44f49d){_0x22090a=null;}}catch(_0x372569){_0x22090a=null;}else try{const _0x83b1b9=await readTable(_0x580fa0['dNpZf']),_0x5b03a7=_0x83b1b9['filter'](_0x2a58b6=>String(_0x2a58b6[_0x43793e(0x1d2)])===_0x43793e(0x3e2)),_0x2d1155=_0x5b03a7['length']?_0x5b03a7[_0x5b03a7[_0x43793e(0x43c)]-0x1]:null,_0x2e0311=_0x2d1155?_0x2d1155[_0x43793e(0x2ea)]:null;if(_0x2e0311&&typeof _0x2e0311==='string')try{_0x22090a=JSON[_0x43793e(0x485)](_0x2e0311);}catch(_0x536589){_0x22090a=null;}else _0x22090a=_0x2e0311||null;}catch(_0x1458a2){_0x22090a=null;}return _0x22090a||null;}async function getSecuritySettings(){const _0x562db7=_0x1ce9f3,_0x25d1f3={'snImv':function(_0x30a960,_0x4ccfe0){return _0x30a960===_0x4ccfe0;},'mRbsD':_0x562db7(0x39a),'ZaLLp':function(_0x2333f9,_0x8cbb0c){return _0x2333f9!==_0x8cbb0c;},'zWtHC':_0x562db7(0x42c),'knleI':function(_0x903dd5,_0x572f9c){return _0x903dd5(_0x572f9c);},'OlidL':_0x562db7(0x364),'jBOKo':_0x562db7(0x384)};let _0x29950f=null;if(dbPool)try{if(_0x25d1f3[_0x562db7(0x3d7)](_0x562db7(0x3d2),_0x562db7(0x381)))return _0x32de4b['status'](0x1f4)[_0x562db7(0x1fc)]({'error':_0x2277f5['message']});else{const [_0x486774]=await dbPool[_0x562db7(0x429)](_0x562db7(0x3d6),[_0x25d1f3[_0x562db7(0x3f2)]]),_0x31fd65=_0x486774&&_0x486774[0x0]?_0x486774[0x0]['value']:null;try{_0x29950f=_0x31fd65?JSON['parse'](_0x31fd65):null;}catch(_0x147053){_0x29950f=null;}}}catch(_0x345d83){_0x29950f=null;}else try{if(_0x25d1f3['ZaLLp'](_0x25d1f3[_0x562db7(0x23a)],_0x25d1f3[_0x562db7(0x23a)]))_0x507e25['set'](_0x45665c,_0x296fe6['data'][_0x562db7(0x460)][_0x562db7(0x419)]);else{const _0x5a3b73=await _0x25d1f3['knleI'](readTable,_0x25d1f3['OlidL']),_0x526232=_0x5a3b73[_0x562db7(0x2d9)](_0x47ee00=>String(_0x47ee00['key'])===_0x562db7(0x39a)),_0x389d24=_0x526232['length']?_0x526232[_0x526232[_0x562db7(0x43c)]-0x1]:null,_0x195193=_0x389d24?_0x389d24[_0x562db7(0x2ea)]:null;if(_0x195193&&_0x25d1f3['snImv'](typeof _0x195193,_0x25d1f3[_0x562db7(0x218)]))try{_0x29950f=JSON[_0x562db7(0x485)](_0x195193);}catch(_0x50760c){_0x29950f=null;}else _0x29950f=_0x195193||null;}}catch(_0x51029e){_0x29950f=null;}return _0x29950f||null;}async function isAuditEnabled(){const _0x4ba2fb=_0x1ce9f3,_0x51d191={'cOmQj':function(_0x2b2519){return _0x2b2519();},'mckwt':function(_0x541971,_0x39764d){return _0x541971===_0x39764d;}},_0x4a266b=await _0x51d191[_0x4ba2fb(0x3ae)](getSecuritySettings);return Boolean(_0x4a266b&&_0x51d191['mckwt'](_0x4a266b[_0x4ba2fb(0x20e)],!![]));}function clearAutoBackupTimer(){autoBackupTimer&&(clearInterval(autoBackupTimer),autoBackupTimer=null);}function _0xfe32(){const _0x14b085=['actual_date','department_name','DELETE\x20FROM\x20audit_logs','月度进展','keys','[Login]\x20Attempt:','lessons_learned','DB_HOST','\x20(`','JWT_SECRET','hHQOd','FYVli','/sync-dingtalk','actual_value','\x20(ID:\x20','use','some','status\x20=\x20?','hvEbu','DB_PASSWORD','FqxHp','hash','ASQbm','department','target_value','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20action_plans\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20year\x20INT,\x0a\x20\x20\x20\x20goal\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20what\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20why\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20who\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20`when`\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20how\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20how_much\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20priority\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20progress\x20INT\x20NULL,\x0a\x20\x20\x20\x20expected_result\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20actual_result\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20remarks\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','message','fOvFU','hBWMC','xZbaJ','plan_name','\x20=\x20?','\x20SET\x20','BEYQc','insertId','NAJrX','dAEha','system_settings','Inserting\x20major_event\x20with\x20keys:','xNucT','nPzZL','priority\x20=\x20?','replace','KBLtp','total','month','[DingTalk]\x20读取部门列表失败:','mwmKN','未知角色','wGHav','action_plans','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20company_info\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20address\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20phone\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20email\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20website\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20logo\x20VARCHAR(512)\x20NULL,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20founded_year\x20INT\x20NULL,\x0a\x20\x20\x20\x20employee_count\x20INT\x20NULL,\x0a\x20\x20\x20\x20industry\x20VARCHAR(128)\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','[Login]\x20Invalid\x20password\x20for:','/api/department-targets/:id','toISOString','mVKgJ','map','XxSom','target-types','unlink','localhost','wBTEH','start_date','current_value','Insert\x20major_event\x20failed:','SELECT\x20id\x20FROM\x20departments\x20WHERE\x20id\x20=\x20?','tXvfC','http','nViHK','string','LpLsr','`,`','系统登录','BqOKq','\x20详情失败:','116175nZboNq','系统通知','unit','lxKUk','uploads','cIxRR','xkPOO','bGOYN','maintenanceMessage','stringify','UZefm','ajUDP','SekbQ','AcKIZ','ZmiWU','YdzTV','security','https://oapi.dingtalk.com/topapi/v2/department/listsub?access_token=','key_activities','[Auth]\x20Blocked\x20request\x20to\x20','\x20失败:','file','DINGTALK_APP_SECRET','sDVaT','ALTER\x20TABLE\x20departments\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','9xtjjiq','vGFNW','values','integration','employee_id','test','DINGTALK_ROOT_DEPT_ID','forEach','不支持的文件类型','qsJex','年度工作计划','cOmQj','responsible_department','logo','INSERT\x20INTO\x20employees\x20(name,\x20employee_id,\x20department,\x20position,\x20phone,\x20email,\x20status)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','/:id','rEBMB','/login','INSERT\x20INTO\x20','position','\x20WHERE\x20','匿名用户','userid','用户登录:\x20','ZNuYl','rzwoP','LMNkD','address','hJnWv','getMonth','NfKCz','MNDgb','isFile','文件上传','Update\x20annual_work_plans\x20failed:','OBEZP','bNlLD','/api/departments','departments','mtime','/api/logs/:id','Anehn','FHYfi','avatar','sort','UPDATE\x20monthly_progress\x20SET\x20','active','zBGgG','KMqbp','RyDGO','cbUnA','SELECT\x20value\x20FROM\x20system_settings\x20WHERE\x20`key`=?\x20ORDER\x20BY\x20id\x20DESC\x20LIMIT\x201','snImv','next_cursor','getSeconds','verify','inSbq','用户名或密码错误','tJwSb','WUPyJ','usPOU','IZjbK','data-update','system','kLmOK','DELETE\x20FROM\x20department_targets\x20WHERE\x20id=?','sub_code','https://oapi.dingtalk.com/topapi/v2/department/get?access_token=','single','CbAFX','ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20responsible\x20VARCHAR(255)\x20NULL','Rgaab','JgvJj','WAMBn','role','error','monthly_progress','xyYkh','emit','mRbsD','/api/annual-work-plans/:id','EyvPI','notification','EPFYy','HwKQE','admin','ihHeI','how','buffer','lfBfa','5974840PeCsRq','/api/','INSERT\x20INTO\x20users\x20(username,\x20password,\x20name,\x20email,\x20role,\x20department,\x20permissions,\x20status)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','mFMiQ','user-online','/api/integration/status','/api/login','[DingTalk]\x20同步部门失败:','NuyDU','/api/health','parent_id','TCUJQ','set','GeEhs','cursor','OfIut','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20monthly_progress\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20year\x20INT,\x0a\x20\x20\x20\x20month\x20INT,\x0a\x20\x20\x20\x20department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20task_name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20target_value\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20actual_value\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20responsible_person\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20start_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20end_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20key_activities\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20achievements\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20challenges\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20next_month_plan\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20support_needed\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','manager_id','SELECT\x20*\x20FROM\x20audit_logs','nXkqN','UPDATE','[DingTalk]\x20获取部门\x20','xudxr','alGqq','VtrgN','Backend\x20server\x20listening\x20on\x20http://localhost:','DRCOx','/api/major-events/:id','name','部门名称为必填项','end_date','listen','plans','socket.io','ZXEFz','lHAPk','GhliM','DELETE\x20FROM\x20audit_logs\x20WHERE\x20id\x20=\x20?','limit','ehabL','aUCkJ','pwNAO','email','backups','query','qfiho','status','Jffzd','mwcbd','put','username','SELECT\x20id\x20FROM\x20company_info\x20LIMIT\x201','MBBLI','realname','CqvMg','Loading\x20config\x20file\x20path:','mqGEZ','pmvTC','updated_at','bdMEe','DELETE\x20FROM\x20annual_work_plans\x20WHERE\x20id=?','xLxxh','DgNeY','length','code','YyNYe','timeline','CuAAZ','utf-8','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20audit_logs\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20username\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20role\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20method\x20VARCHAR(16)\x20NULL,\x0a\x20\x20\x20\x20path\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20status\x20INT\x20NULL,\x0a\x20\x20\x20\x20duration_ms\x20INT\x20NULL,\x0a\x20\x20\x20\x20ip\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20ua\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20query\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20body\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','bMFcl','body','access_token','progress','GvoMb','[Department]\x20检查循环引用失败:','create_dept_group','VNitH','get','ayFLz','/api/company-info','warn','maintenanceSince','shift','how_much','/api/action-plans','SELECT\x20value\x20FROM\x20system_settings\x20WHERE\x20`key`=?\x20LIMIT\x201','NpVeJ','nQjKx','NKhzI','priority','push','[已脱敏]','ItXDv','lstat','VSllq','[Login]\x20Success\x20for\x20default\x20admin','vSvKI','同步钉钉','result','add','/socket.io','actual_result','UkeQY','uUaDM','UyWko','EPGzP','[DingTalk]\x20同步员工失败:','NyZdg','dept_code','hxGnC','XGdBp','cZews','/backups','Missing\x20key','DB_NAME','ixMFJ','next_month_plan','[DingTalk]\x20开始同步员工','kVEai','true','company_info','psebW','QlqkW','JRZyw','static','mpJPn','errno','EuxTO','_at','irzER','未上传文件','\x20\x20\x20示例:\x20JWT_SECRET=your-very-long-random-secret-at-least-32-characters\x0a','Migration\x20warning:','HIymK','root','parse','startsWith','trim','fmPQT','getFullYear','params','YMjVP','###\x20','ygSwy','/api/dingtalk/test-connection','response','cwd','HAVdP','CMmWJ','originalname','不能将子节点设置为上级节点，避免循环引用','dept_id','tasks','uUQnj','goal','INSERT\x20INTO\x20audit_logs\x20(username,\x20role,\x20method,\x20path,\x20status,\x20duration_ms,\x20ip,\x20ua,\x20query,\x20body,\x20operation)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)','EYvSa','Hjvfj','when','founded_year','category','log','username\x20LIKE\x20?','join_date','GUJjV','不能将自己设置为上级节点','has_more','`=?','created_at\x20>=\x20?','BgVjg','compare','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20templates\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20type\x20VARCHAR(64)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20fields\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20updated_at\x20TIMESTAMP\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','QZXbc','key','NfqJM','digest','employees','部门编码已存在','iWkXN','qTcSv','Update\x20major_event\x20failed:','备份文件不存在或无法读取','文件不存在或无法删除','writeFile','未提供授权令牌','what','slice','now','JgbRE','type','authorization','new','findIndex','uTDsL','getHours','risks','LFRvu','ER_DUP_ENTRY','Bxvtq','bcryptjs','uVito','连接测试失败','PaqRU','delete','department\x20=\x20?','SELECT\x20*\x20FROM\x20department_targets','/api/departments/:id','icIKw','split','部门目标','readFile','month\x20=\x20?','size','SELECT\x20*\x20FROM\x20monthly_progress','object','json','vhVQA','zMHMH','cVYLO','INSERT\x20INTO\x20department_targets\x20(`','dxkdq','permissions','\x20AND\x20','DELETE\x20FROM\x20','socket','\x20ORDER\x20BY\x20','GpoPp','expected_result','join','annual_work_plans','remarks','actual_cost','TqkGi','auditLog','PUT','PlWKH','year\x20=\x20?','UPDATE\x20departments\x20SET\x20','缺少必填项:\x20','YYciV','DrQFh','指定的上级节点不存在','vPvSy','jBOKo','/api/maintenance/status','dingtalkAppSecret','VIEW','notifications','application/json','24LsiZXb','aSPTZ','INSERT\x20INTO\x20system_settings\x20(`key`,\x20value)\x20VALUES\x20(?,\x20?)','ALTER\x20TABLE\x20departments\x20ADD\x20COLUMN\x20type\x20VARCHAR(32)\x20DEFAULT\x20\x27DEPT\x27','/uploads','钉钉同步','/api/templates','`)\x20VALUES\x20(','缺少备份文件名','mZokh','website','loaded','budget','FDbsq','department_targets','upiTZ','HxNzn','GFXPr','3063856nowUvR','/backups/','development-only-secret-change-me','from','zaiPP','vtSkW','RJrzo','执行系统备份','endsWith','/api/monthly-progress','zWtHC','[DingTalk]\x20获取部门列表失败:','support_needed','password','[DingTalk]\x20获取员工列表失败:','ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20lessons_learned\x20TEXT\x20NULL','manager','promises','SELECT\x20*\x20FROM\x20departments\x20ORDER\x20BY\x20id\x20ASC','SELECT\x20id,\x20username,\x20role,\x20method,\x20path,\x20status,\x20duration_ms,\x20ip,\x20ua,\x20query,\x20body,\x20created_at\x20FROM\x20audit_logs\x20ORDER\x20BY\x20id\x20DESC\x20LIMIT\x20?\x20OFFSET\x20?','env','dept_name','fqOHZ','备份文件结构无效','wCfXR','autoBackup','backupInterval','includes','用户名和密码为必填项','cePLJ','title','DELETE\x20FROM\x20templates\x20WHERE\x20id=?','INSERT\x20INTO\x20departments\x20(id,\x20name,\x20code,\x20parent_id,\x20type,\x20manager,\x20phone,\x20email,\x20status,\x20description)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)\x20ON\x20DUPLICATE\x20KEY\x20UPDATE\x20name=VALUES(name),\x20code=VALUES(code),\x20parent_id=VALUES(parent_id),\x20type=VALUES(type),\x20manager=VALUES(manager),\x20phone=VALUES(phone),\x20email=VALUES(email),\x20status=VALUES(status),\x20description=VALUES(description)','responsible_person','`\x20=\x20?','GET','xWJrW','/api/organization/tree','ALLOWED_ORIGINS','1641848jsnnTZ','giOlK','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20roles\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20code\x20VARCHAR(64)\x20UNIQUE,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20permissions\x20JSON\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','mkdirSync','/api/dingtalk/send-message','系统设置',')\x20VALUES\x20(','获取钉钉access_token失败','mVcox','PeVDy','VcUcM','重大事项','cxSvb','wxrEo','lmGwB','kDbFU','目标类型','Qvtia','isArray','OykMi','\x20ORDER\x20BY\x20created_at\x20DESC','x-forwarded-for','ueqUE','fSykt','data','管理部','/api/action-plans/:id','end','gTZCq','UPDATE\x20department_targets\x20SET\x20','path','DdJSy','/api/admin/backups/restore-upload','hJqJf','sheet_type','DELETE\x20FROM\x20users\x20WHERE\x20id=?','DFRlV','HWXWC','description','root_dept_id','xGhlN','vRkhr','min','ljbjC','aNNqW','target_type','mTrJl','items','has','inactive','用户名已存在','appSecret','aflpl','max','target_types','createConnection','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20departments\x20(\x0a\x20\x20\x20\x20id\x20BIGINT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20code\x20VARCHAR(64)\x20UNIQUE,\x0a\x20\x20\x20\x20parent_id\x20BIGINT\x20NULL,\x0a\x20\x20\x20\x20type\x20VARCHAR(32)\x20DEFAULT\x20\x27DEPT\x27,\x0a\x20\x20\x20\x20manager\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20phone\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20email\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20DEFAULT\x20\x27active\x27,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','roxpP','meVoQ','quarter','user','jobnumber','method\x20=\x20\x27PUT\x27','job_number','行动计划','room','jrUFl','PTKwk','系统管理','wdOCL','[DingTalk\x20Webhook]\x20消息发送失败:','templates','created_at','XeVSk','PGgWL','DELETE\x20FROM\x20monthly_progress\x20WHERE\x20id=?','令牌无效或已过期','[Login]\x20Success\x20for:','jTybg','SELECT\x20*\x20FROM\x20','why','fields','operation','Updating\x20major_event','hCbGR','标题和消息内容为必填项','XjFfM','KyCmN','OSwOl','ER_DUP_FIELDNAME','nQEiM','mysql2/promise','aEjMb','industry','event_type','DYrpn','DB\x20init\x20failed:','padStart','\x20WHERE\x20id=?','FLgXN','dotenv','uOQzi','IBfnT','pHIKg','ROVgb','ZoCvI','post','SELECT\x20d.*,\x20p.name\x20as\x20parent_name\x20FROM\x20departments\x20d\x20LEFT\x20JOIN\x20departments\x20p\x20ON\x20d.parent_id\x20=\x20p.id','roles','dqniE','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20audit_logs\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20username\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20role\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20method\x20VARCHAR(16)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20path\x20VARCHAR(512)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20status\x20INT\x20NULL,\x0a\x20\x20\x20\x20duration_ms\x20INT\x20NULL,\x0a\x20\x20\x20\x20ip\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20ua\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20query\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20body\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)','yjJpz','fIIHt','QtWRM','YIQDJ','QbzKD','QhPef','failed','OPTIONS','SELECT\x20id,\x20username,\x20name,\x20email,\x20role,\x20department,\x20permissions,\x20status,\x20created_at\x20FROM\x20users\x20ORDER\x20BY\x20id\x20DESC','连接测试成功','mobile','Invalid\x20id','2136828ymLTSI','WeynF','/api/upload','ERBPF','ctNqt','user-agent','ZZyGy','filter','https://oapi.dingtalk.com/topapi/v2/user/list?access_token=','QOVni','fhVJf','errcode','[DingTalk]\x20从钉钉获取到\x20','BaFil','12664024RUGpDA','NTFur','method','xFYvT','department_id','goals','disconnect','event_name','\x20个部门','year','value','\x20[sub_code=','/api/department-targets','sSERa','详情\x20(ID:\x20','DEPT','/api/dingtalk/employees','LgGls','/api/employees','mRIuB','\x20WHERE\x20d.type\x20=\x20?','DB_PORT','toString','method\x20=\x20\x27DELETE\x27','HeTLc','key_points','phone','createPool','GVkRh','/api/system-settings/:id','who','method\x20=\x20\x27GET\x27','theme','PpRBe','bwWPk','/api/monthly-progress/:id','missing','sepbt','/api/annual-work-plans','DELETE\x20FROM\x20system_settings\x20WHERE\x20id=?','rfgjy','/api/users','UUlXG','leave-room','importance','achievements','MuHVo','dMVUj','系统日志','/api/admin/backups','errmsg','/api/employees/:id','MiIZq','axios','lPQoZ','xOuRn','headers','WWzDb','\x20SET\x20?','dwFRX','match','notes','vbeJB','DINGTALK_APP_KEY','7232554IgKiQU','eAPdM','UPDATE\x20employees\x20SET\x20','task_name','null','ALTER\x20TABLE\x20department_targets\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','INSERT\x20INTO\x20action_plans\x20(`','target_level','JHWwT','DELETE','audit_logs','yinkh','YNItG','dept_id_list','BVWOg','VSIkv','/api/admin/backups/restore','消息发送失败','parentId','/uploads/','IADGX','major_events','ItiOx','.json','UVlZf','target_name','\x20-\x20No\x20token','eTfTN','VijwS','users','phEZq'];_0xfe32=function(){return _0x14b085;};return _0xfe32();}async function applyAutoBackupSchedule(){const _0x191439=_0x1ce9f3,_0xc024a9={'QKFYZ':function(_0x152aae){return _0x152aae();},'lfBfa':function(_0x4f1fde,_0x3fc86d){return _0x4f1fde===_0x3fc86d;},'PaqRU':function(_0x2b6b40,_0x4ac188){return _0x2b6b40+_0x4ac188;}};clearAutoBackupTimer(),nextBackupAt=null;const _0x1f98c0=await _0xc024a9['QKFYZ'](getSystemAutoBackupSettings),_0x4be923=Boolean(_0x1f98c0&&_0xc024a9[_0x191439(0x3fc)](_0x1f98c0[_0x191439(0x249)],!![])),_0x56554b=Number(_0x1f98c0&&_0x1f98c0['backupInterval']!=null?_0x1f98c0['backupInterval']:0x18);if(!_0x4be923||!_0x56554b||_0x56554b<=0x0)return;const _0xf2c102=Math['max'](0xea60,Math['floor'](_0x56554b*0x36ee80));autoBackupTimer=setInterval(async()=>{try{await performBackup();}catch(_0x3298d2){}nextBackupAt=new Date(Date['now']()+_0xf2c102);},_0xf2c102),nextBackupAt=new Date(_0xc024a9[_0x191439(0x1ef)](Date[_0x191439(0x1e0)](),_0xf2c102));try{await performBackup();}catch(_0x5f152b){}}if(ENABLE_AUTH){const openPaths=new Set([_0x1ce9f3(0x403),'/api/health',_0x1ce9f3(0x402),'/api/maintenance/status']);app['use']((_0x5ca62e,_0xa068e4,_0x437c05)=>{const _0x22cdb4=_0x1ce9f3,_0x126c03={'CbAFX':_0x22cdb4(0x253),'LQhQD':function(_0x3a79c5){return _0x3a79c5();},'thzdj':_0x22cdb4(0x1dd),'mpqKH':_0x22cdb4(0x2a3)},_0x42efd5=_0x5ca62e[_0x22cdb4(0x275)]['replace'](/\/+$/,'');if(openPaths[_0x22cdb4(0x287)](_0x42efd5)||_0x42efd5==='/api/login'||_0x42efd5['startsWith']('/api/login')||_0x5ca62e['path'][_0x22cdb4(0x486)](_0x22cdb4(0x222))||_0x5ca62e['path']['startsWith']('/backups')||_0x5ca62e[_0x22cdb4(0x2e2)]===_0x126c03[_0x22cdb4(0x3e8)]&&_0x42efd5===_0x22cdb4(0x224))return _0x126c03['LQhQD'](_0x437c05);const _0x439bbb=_0x5ca62e[_0x22cdb4(0x318)][_0x22cdb4(0x1e3)]||'',_0x5e4e38=_0x439bbb['match'](/^Bearer\s+(.+)$/);if(!_0x5e4e38)return console['log']('[Auth]\x20Blocked\x20request\x20to\x20'+_0x5ca62e[_0x22cdb4(0x275)]+'\x20-\x20No\x20token'),_0xa068e4[_0x22cdb4(0x42b)](0x191)[_0x22cdb4(0x1fc)]({'error':_0x126c03['thzdj']});try{const _0x5c813f=jwt['verify'](_0x5e4e38[0x1],JWT_SECRET);return _0x5ca62e['user']=_0x5c813f,_0x437c05();}catch(_0x3fe055){return console['log'](_0x22cdb4(0x39d)+_0x5ca62e[_0x22cdb4(0x275)]+'\x20-\x20Invalid\x20token:\x20'+_0x3fe055[_0x22cdb4(0x359)]),_0xa068e4[_0x22cdb4(0x42b)](0x191)[_0x22cdb4(0x1fc)]({'error':_0x126c03['mpqKH']});}});}function getOperationDescription(_0x3db858,_0x576a01,_0x224799){const _0x26e2d5=_0x1ce9f3,_0x24dc54={'WDPBq':_0x26e2d5(0x387),'JkQQB':'月度进展','HIymK':'部门目标','kqaNJ':'年度工作计划','aUCkJ':'公司信息','fIIHt':'系统设置','MiIZq':'组织架构','sAuLk':'文件上传','rlNJP':_0x26e2d5(0x34b),'ccKCx':_0x26e2d5(0x3c9),'YIQDJ':'/backup','MNDgb':'OTmlW','UeVCf':'PqCWa','pelhd':'未知用户','mhCpE':'POST','aSPTZ':_0x26e2d5(0x329)},_0x509421=_0x576a01[_0x26e2d5(0x1f5)]('/')[_0x26e2d5(0x2d9)](Boolean),_0x350c51=_0x509421[0x1]||'',_0x8861d2=_0x509421[0x2]||null,_0xcace20={'login':_0x24dc54['WDPBq'],'users':'用户','departments':'部门','employees':'员工','monthly-progress':_0x24dc54['JkQQB'],'department-targets':_0x24dc54[_0x26e2d5(0x483)],'action-plans':_0x26e2d5(0x297),'annual-work-plans':_0x24dc54['kqaNJ'],'major-events':_0x26e2d5(0x262),'notifications':'通知','templates':'模板','target-types':_0x26e2d5(0x267),'company-info':_0x24dc54[_0x26e2d5(0x425)],'system-settings':_0x24dc54[_0x26e2d5(0x2c7)],'roles':'角色','admin':'系统管理','organization':_0x24dc54[_0x26e2d5(0x314)],'dingtalk':'钉钉同步','upload':_0x24dc54['sAuLk'],'logs':'系统日志'},_0x278c92=_0xcace20[_0x350c51]||_0x350c51;if(_0x576a01[_0x26e2d5(0x24b)](_0x24dc54['rlNJP']))return'同步钉钉'+(_0x576a01[_0x26e2d5(0x24b)](_0x24dc54['ccKCx'])?'部门':'员工')+'数据';if(_0x576a01['includes'](_0x24dc54[_0x26e2d5(0x2c9)]))return _0x24dc54[_0x26e2d5(0x3c2)]==='OTmlW'?_0x26e2d5(0x237):_0x5842c3['status'](0x1f4)['json']({'error':_0x648fa3['message']});if(_0x576a01[_0x26e2d5(0x24b)](_0x26e2d5(0x3b4))){if(_0x26e2d5(0x471)===_0x24dc54['UeVCf'])return _0x57972d[_0x26e2d5(0x42b)](0x1f4)['json']({'error':_0x3f643a[_0x26e2d5(0x359)]});else{const _0xc24fe3=_0x224799?.['username']||_0x24dc54['pelhd'];return _0x26e2d5(0x3ba)+_0xc24fe3;}}switch(_0x3db858){case'GET':if(_0x8861d2)return'查看'+_0x278c92+_0x26e2d5(0x2ee)+_0x8861d2+')';return'查询'+_0x278c92+'列表';case _0x24dc54['mhCpE']:const _0x12bc14=_0x224799?.['name']||_0x224799?.[_0x26e2d5(0x24e)]||_0x224799?.[_0x26e2d5(0x323)]||_0x224799?.[_0x26e2d5(0x2e7)]||_0x224799?.['username']||'';return'新增'+_0x278c92+(_0x12bc14?':\x20'+_0x12bc14:'');case'PUT':return'修改'+_0x278c92+_0x26e2d5(0x34d)+_0x8861d2+')';case _0x24dc54[_0x26e2d5(0x21f)]:return'删除'+_0x278c92+'\x20(ID:\x20'+_0x8861d2+')';default:return _0x3db858+'\x20'+_0x576a01;}}app['use'](async(_0x451beb,_0x243e15,_0x3bc2c3)=>{const _0x5cdc25=_0x1ce9f3,_0x429c48={'ibcPn':'/api/health','JRZyw':'/socket.io','alGqq':_0x5cdc25(0x333),'uQmnY':_0x5cdc25(0x231),'qubzD':_0x5cdc25(0x1e3),'ROVgb':_0x5cdc25(0x26c),'wBTEH':'secret','hJnWv':'token','ApoOS':_0x5cdc25(0x28a),'YVFuT':function(_0x22b190,_0x4f4228){return _0x22b190!==_0x4f4228;},'wtovh':_0x5cdc25(0x30a),'VijwS':function(_0x25f8b0){return _0x25f8b0();}},_0x2f34db=Date[_0x5cdc25(0x1e0)]();_0x243e15['on']('finish',async()=>{const _0xc8ebcc=_0x5cdc25,_0x5bf747={'YMjVP':function(_0x24c98f,_0x4dc708){return _0x24c98f!==_0x4dc708;},'ofJbs':_0xc8ebcc(0x459)};try{const _0x2a8eaf=_0x451beb[_0xc8ebcc(0x275)]||'';if(_0x2a8eaf['startsWith'](_0x429c48['ibcPn']))return;if(_0x2a8eaf['startsWith'](_0x429c48[_0xc8ebcc(0x479)]))return;if(_0x451beb[_0xc8ebcc(0x2e2)]==='OPTIONS')return;if(_0x2a8eaf[_0xc8ebcc(0x486)](_0x429c48[_0xc8ebcc(0x414)])||_0x2a8eaf['startsWith'](_0x429c48['uQmnY']))return;let _0x58638a=_0x451beb['user']?.['username']||null,_0x33b0fb=_0x451beb[_0xc8ebcc(0x293)]?.[_0xc8ebcc(0x3ed)]||null;if(!_0x58638a){const _0x243bba=_0x451beb['headers'][_0x429c48['qubzD']]||'',_0x24aa59=_0x243bba['match'](/^Bearer\s+(.+)$/);if(_0x24aa59)try{const _0x21a7e9=jwt[_0xc8ebcc(0x3da)](_0x24aa59[0x1],JWT_SECRET);_0x58638a=_0x21a7e9?.[_0xc8ebcc(0x42f)]||_0x58638a,_0x33b0fb=_0x21a7e9?.[_0xc8ebcc(0x3ed)]||_0x33b0fb;}catch(_0x3e06b4){}}_0x58638a=_0x58638a||_0xc8ebcc(0x3b8),_0x33b0fb=_0x33b0fb||_0xc8ebcc(0x36f);const _0x2fd4c7=(_0x451beb['headers'][_0x429c48[_0xc8ebcc(0x2bf)]]||_0x451beb[_0xc8ebcc(0x205)]?.['remoteAddress']||'')[_0xc8ebcc(0x2f6)](),_0x23013f=(_0x451beb['headers'][_0xc8ebcc(0x2d7)]||'')['toString'](),_0x577b17=_0x243e15['statusCode']||null,_0x410fea=Date['now']()-_0x2f34db,_0x834c97=_0x451beb[_0xc8ebcc(0x444)]||null;let _0x8e5c7e=null;if(_0x834c97){const _0x448f14={..._0x834c97};[_0xc8ebcc(0x23d),_0x429c48[_0xc8ebcc(0x37c)],_0x429c48[_0xc8ebcc(0x3bf)],_0x429c48['ApoOS'],_0xc8ebcc(0x21a),'emailPassword'][_0xc8ebcc(0x3aa)](_0x5bbbec=>{const _0x31ec98=_0xc8ebcc;if(_0x448f14&&_0x5bf747[_0x31ec98(0x48b)](_0x448f14[_0x5bbbec],undefined))_0x448f14[_0x5bbbec]=_0x5bf747['ofJbs'];});try{_0x8e5c7e=JSON['stringify'](_0x448f14);}catch(_0x3dcad4){_0x8e5c7e=null;}}let _0x2e7c58=null;try{_0x2e7c58=JSON[_0xc8ebcc(0x393)](_0x451beb['query']||null);}catch(_0x2fca6e){_0x429c48['YVFuT'](_0x429c48['wtovh'],_0xc8ebcc(0x30a))?_0x35dc31[_0xc8ebcc(0x42b)](0x1f4)['json']({'error':_0x4b819a['message']}):_0x2e7c58=null;}const _0x3971d0=getOperationDescription(_0x451beb[_0xc8ebcc(0x2e2)],_0x2a8eaf,_0x834c97);if(dbPool)try{await dbPool[_0xc8ebcc(0x429)](_0xc8ebcc(0x499),[_0x58638a,_0x33b0fb,_0x451beb['method'],_0x2a8eaf,_0x577b17,_0x410fea,_0x2fd4c7,_0x23013f,_0x2e7c58,_0x8e5c7e,_0x3971d0]);}catch(_0x579a82){}else{const _0x305521={'username':_0x58638a,'role':_0x33b0fb,'method':_0x451beb['method'],'path':_0x2a8eaf,'status':_0x577b17,'duration_ms':_0x410fea,'ip':_0x2fd4c7,'ua':_0x23013f,'query':_0x2e7c58,'body':_0x8e5c7e,'operation':_0x3971d0};try{await addRow('audit_logs',_0x305521);}catch(_0xb5edf0){}}}catch(_0x54e602){}}),_0x429c48[_0x5cdc25(0x33c)](_0x3bc2c3);}),app['get'](_0x1ce9f3(0x406),(_0x572c15,_0x3b9fe1)=>{const _0x2865b4=_0x1ce9f3;_0x3b9fe1[_0x2865b4(0x1fc)]({'status':'ok','timestamp':Date['now']()});}),app['post'](_0x1ce9f3(0x403),async(_0x4e919d,_0x53fbae)=>{const _0x31ca7a=_0x1ce9f3,_0x44c9a5={'GeEhs':function(_0xb0d6a2,_0x3a58d1){return _0xb0d6a2||_0x3a58d1;},'yXTZc':function(_0x369871,_0x4e62a2){return _0x369871===_0x4e62a2;},'vfqfA':_0x31ca7a(0x3f8),'ZNuYl':function(_0x627a2b,_0x2cff38){return _0x627a2b===_0x2cff38;},'DdJSy':'123456','dqniE':'管理员','qAXWN':function(_0x4df26a,_0x74d70a){return _0x4df26a(_0x74d70a);},'dxkdq':_0x31ca7a(0x33d),'BVWOg':_0x31ca7a(0x3dc),'rIgaj':function(_0x3c5885,_0x4e9e4d){return _0x3c5885(_0x4e9e4d);},'hemRg':_0x31ca7a(0x384),'WbvYF':'user'};console[_0x31ca7a(0x49f)](_0x31ca7a(0x344),_0x4e919d[_0x31ca7a(0x444)]?.[_0x31ca7a(0x42f)]);const {username:_0x36c8d4,password:_0x49b64b}=_0x4e919d['body']||{};if(_0x44c9a5[_0x31ca7a(0x40a)](!_0x36c8d4,!_0x49b64b))return _0x53fbae['status'](0x190)['json']({'error':'请输入用户名和密码'});if(_0x44c9a5['yXTZc'](_0x36c8d4,_0x44c9a5['vfqfA'])&&_0x44c9a5[_0x31ca7a(0x3bb)](_0x49b64b,_0x44c9a5[_0x31ca7a(0x276)])){console[_0x31ca7a(0x49f)](_0x31ca7a(0x45d));const _0x3b1716=jwt['sign']({'username':_0x36c8d4,'role':_0x31ca7a(0x3f8)},JWT_SECRET,{'expiresIn':'24h'});return _0x53fbae[_0x31ca7a(0x1fc)]({'token':_0x3b1716,'user':{'id':-0x1,'username':_0x36c8d4,'name':_0x44c9a5[_0x31ca7a(0x2c4)],'role':_0x44c9a5['vfqfA'],'department':_0x31ca7a(0x270),'permissions':[_0x44c9a5['vfqfA']]}});}try{let _0x271768=null;if(dbPool){const [_0x2050c6]=await dbPool['query']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20username\x20=\x20?\x20AND\x20status\x20=\x20?\x20LIMIT\x201',[_0x36c8d4,_0x31ca7a(0x3d1)]);_0x271768=_0x2050c6[0x0]||null;}else{const _0x14eac9=await _0x44c9a5['qAXWN'](readTable,_0x44c9a5[_0x31ca7a(0x201)]);_0x271768=_0x14eac9['find'](_0x33b2ab=>_0x33b2ab['username']===_0x36c8d4&&_0x33b2ab['status']==='active')||null;}if(!_0x271768)return console['log']('[Login]\x20User\x20not\x20found:',_0x36c8d4),_0x53fbae['status'](0x191)['json']({'error':_0x44c9a5[_0x31ca7a(0x32e)]});const _0x1dcd1e=_0x44c9a5['rIgaj'](require,'bcryptjs'),_0x54d3f6=await _0x1dcd1e[_0x31ca7a(0x1cf)](_0x49b64b,_0x271768['password']);if(!_0x54d3f6)return console['log'](_0x31ca7a(0x373),_0x36c8d4),_0x53fbae[_0x31ca7a(0x42b)](0x191)['json']({'error':_0x44c9a5[_0x31ca7a(0x32e)]});console[_0x31ca7a(0x49f)](_0x31ca7a(0x2a4),_0x36c8d4);const _0x406dfa=typeof _0x271768[_0x31ca7a(0x202)]===_0x44c9a5['hemRg']?_0x44c9a5['rIgaj'](safeParse,_0x271768['permissions']):_0x271768['permissions']||[],_0x521c92=jwt['sign']({'username':_0x271768['username'],'role':_0x271768[_0x31ca7a(0x3ed)]},JWT_SECRET,{'expiresIn':'24h'});return _0x53fbae['json']({'token':_0x521c92,'user':{'id':_0x271768['id'],'username':_0x271768['username'],'name':_0x271768['name']||_0x271768['username'],'role':_0x271768[_0x31ca7a(0x3ed)]||_0x44c9a5['WbvYF'],'department':_0x271768[_0x31ca7a(0x356)]||'','permissions':_0x406dfa}});}catch(_0x44c468){return console[_0x31ca7a(0x3ee)]('[Login]\x20Error:',_0x44c468['message']),_0x53fbae['status'](0x1f4)[_0x31ca7a(0x1fc)]({'error':'登录失败，请稍后重试'});}});const createCrudRoutes=(_0x31acba,_0x3b0ede,_0x4644fc='created_at')=>{const _0xee17fd=_0x1ce9f3,_0xbe694={'EuxTO':function(_0x2a82b8,_0x12df6f){return _0x2a82b8(_0x12df6f);},'ocaHJ':_0xee17fd(0x386),'gosiU':'object','FyGMs':function(_0x5d775c,_0x4ac788){return _0x5d775c!==_0x4ac788;},'xWJrW':function(_0x3d4ed0,_0x202acc,_0x3b7779,_0x23e830){return _0x3d4ed0(_0x202acc,_0x3b7779,_0x23e830);}};app[_0xee17fd(0x44b)]('/api/'+_0x3b0ede,async(_0x3e0214,_0x1f32bd)=>{const _0x266608=_0xee17fd;if(!dbPool)try{const _0x4488b1=await _0xbe694[_0x266608(0x47d)](readTable,_0x31acba);return _0x1f32bd['json'](_0x4488b1);}catch(_0x522bb6){return _0x1f32bd[_0x266608(0x42b)](0x1f4)[_0x266608(0x1fc)]({'error':_0x522bb6[_0x266608(0x359)]});}try{const [_0x4f9e67]=await dbPool[_0x266608(0x429)](_0x266608(0x2a6)+_0x31acba+_0x266608(0x206)+_0x4644fc+'\x20DESC');_0x1f32bd['json'](_0x4f9e67);}catch(_0x56698a){_0x1f32bd['status'](0x1f4)[_0x266608(0x1fc)]({'error':_0x56698a['message']});}}),app['post'](_0xee17fd(0x3fe)+_0x3b0ede,async(_0x20ff78,_0xcca5c0)=>{const _0x5d9e94=_0xee17fd;if(!dbPool)try{const _0x24cb9a=await addRow(_0x31acba,_0x20ff78['body']||{});return _0xcca5c0['status'](0xc9)[_0x5d9e94(0x1fc)](_0x24cb9a);}catch(_0x101dc9){return _0xcca5c0['status'](0x1f4)['json']({'error':_0x101dc9['message']});}try{const _0x2542bc=Object[_0x5d9e94(0x343)](_0x20ff78['body'])['filter'](_0x5e7ed5=>_0x5e7ed5!=='id'&&_0x5e7ed5!==_0x4644fc);if(_0x2542bc[_0x5d9e94(0x43c)]===0x0)return _0xcca5c0['status'](0x190)[_0x5d9e94(0x1fc)]({'error':'No\x20data'});const _0x27b75f=_0x2542bc[_0x5d9e94(0x377)](_0x68d489=>{const _0x12a542=_0x5d9e94,_0x7735b4=_0x20ff78[_0x12a542(0x444)][_0x68d489];return typeof _0x7735b4==='object'&&_0x7735b4!==null?JSON['stringify'](_0x7735b4):_0x7735b4;}),_0x3d9e22=_0x5d9e94(0x3b5)+_0x31acba+_0x5d9e94(0x347)+_0x2542bc['join'](_0xbe694['ocaHJ'])+'`)\x20VALUES\x20('+_0x2542bc[_0x5d9e94(0x377)](()=>'?')['join'](',')+')',[_0x1ad7ee]=await dbPool[_0x5d9e94(0x429)](_0x3d9e22,_0x27b75f);_0xcca5c0['json']({'id':_0x1ad7ee['insertId'],..._0x20ff78[_0x5d9e94(0x444)]});}catch(_0x4de331){_0xcca5c0[_0x5d9e94(0x42b)](0x1f4)[_0x5d9e94(0x1fc)]({'error':_0x4de331['message']});}}),app['put']('/api/'+_0x3b0ede+_0xee17fd(0x3b2),async(_0x1d767e,_0x30425c)=>{const _0x4e84cc=_0xee17fd;if(!dbPool)try{return await _0xbe694[_0x4e84cc(0x254)](updateRow,_0x31acba,_0x1d767e['params']['id'],_0x1d767e[_0x4e84cc(0x444)]||{}),_0x30425c[_0x4e84cc(0x1fc)]({'success':!![]});}catch(_0x100fd2){return _0x30425c[_0x4e84cc(0x42b)](0x1f4)['json']({'error':_0x100fd2['message']});}try{const _0x40dc32=Object[_0x4e84cc(0x343)](_0x1d767e['body'])[_0x4e84cc(0x2d9)](_0x5aa5f6=>_0x5aa5f6!=='id'&&_0x5aa5f6!==_0x4644fc);if(_0x40dc32[_0x4e84cc(0x43c)]===0x0)return _0x30425c['json']({'success':!![]});const _0x5404ea=_0x40dc32[_0x4e84cc(0x377)](_0x4480fe=>'`'+_0x4480fe+_0x4e84cc(0x4a5))['join'](','),_0x2801ce=[..._0x40dc32[_0x4e84cc(0x377)](_0x1c8264=>{const _0x44a821=_0x4e84cc,_0x1a1c58=_0x1d767e['body'][_0x1c8264];return typeof _0x1a1c58===_0xbe694['gosiU']&&_0xbe694['FyGMs'](_0x1a1c58,null)?JSON[_0x44a821(0x393)](_0x1a1c58):_0x1a1c58;}),_0x1d767e['params']['id']];await dbPool['query']('UPDATE\x20'+_0x31acba+_0x4e84cc(0x35f)+_0x5404ea+_0x4e84cc(0x2b9),_0x2801ce),_0x30425c['json']({'success':!![]});}catch(_0x2609b9){_0x30425c[_0x4e84cc(0x42b)](0x1f4)[_0x4e84cc(0x1fc)]({'error':_0x2609b9['message']});}}),app[_0xee17fd(0x1f0)]('/api/'+_0x3b0ede+'/:id',async(_0x262b69,_0x123ccb)=>{const _0x4da78f=_0xee17fd;if(!dbPool)try{return await deleteRow(_0x31acba,_0x262b69[_0x4da78f(0x48a)]['id']),_0x123ccb[_0x4da78f(0x1fc)]({'success':!![]});}catch(_0x18bf5e){return _0x123ccb[_0x4da78f(0x42b)](0x1f4)[_0x4da78f(0x1fc)]({'error':_0x18bf5e['message']});}try{await dbPool['query']('DELETE\x20FROM\x20'+_0x31acba+_0x4da78f(0x2b9),[_0x262b69['params']['id']]),_0x123ccb[_0x4da78f(0x1fc)]({'success':!![]});}catch(_0x2ff9f2){_0x123ccb['status'](0x1f4)['json']({'error':_0x2ff9f2[_0x4da78f(0x359)]});}});};app['get'](_0x1ce9f3(0x2f2),async(_0x36f2f8,_0x2d8243)=>{const _0x20764b=_0x1ce9f3;if(!dbPool)try{const _0x598add=await readTable(_0x20764b(0x1d5));return _0x2d8243['json'](_0x598add);}catch(_0x476f75){return _0x2d8243['status'](0x1f4)[_0x20764b(0x1fc)]({'error':_0x476f75[_0x20764b(0x359)]});}try{const [_0x426578]=await dbPool[_0x20764b(0x429)]('SELECT\x20*\x20FROM\x20employees\x20ORDER\x20BY\x20created_at\x20DESC');_0x2d8243['json'](_0x426578);}catch(_0x52f483){_0x2d8243['status'](0x1f4)['json']({'error':_0x52f483[_0x20764b(0x359)]});}}),app[_0x1ce9f3(0x2c1)](_0x1ce9f3(0x2f2),async(_0x6661ec,_0x5a34e3)=>{const _0x53a9b8=_0x1ce9f3,_0x222aa1={'pwNAO':'姓名和工号为必填项','OCIEx':function(_0xf35ada,_0x444eb8){return _0xf35ada(_0x444eb8);},'roxpP':'工号已存在','bNlLD':function(_0x4de75c,_0x1e51f2){return _0x4de75c||_0x1e51f2;},'IADGX':function(_0x54d3f9,_0x261561){return _0x54d3f9||_0x261561;},'bdMEe':_0x53a9b8(0x3d1),'DrQFh':function(_0x408347,_0x352744){return _0x408347||_0x352744;},'HwKQE':function(_0x9b687,_0x243e3d){return _0x9b687||_0x243e3d;},'wuvMW':function(_0x762f99,_0x54f62b){return _0x762f99===_0x54f62b;}},_0x31999d=_0x6661ec[_0x53a9b8(0x444)]||{},{name:_0x3f5059,employee_id:_0x5ef7a5,department:_0x35f724,position:_0x320e3d,phone:_0x41e9b8,email:_0x370491,status:_0x3efe1e}=_0x31999d;if(!_0x3f5059||!_0x5ef7a5)return _0x5a34e3[_0x53a9b8(0x42b)](0x190)['json']({'error':_0x222aa1[_0x53a9b8(0x426)]});if(!dbPool)try{const _0x9b157a=await _0x222aa1['OCIEx'](readTable,_0x53a9b8(0x1d5));if(_0x9b157a[_0x53a9b8(0x34f)](_0x847a5a=>_0x847a5a[_0x53a9b8(0x3a7)]===_0x5ef7a5))return _0x5a34e3['status'](0x190)['json']({'error':_0x222aa1[_0x53a9b8(0x290)]});const _0x50f20c=await addRow(_0x53a9b8(0x1d5),{'name':_0x3f5059,'employee_id':_0x5ef7a5,'department':_0x222aa1['bNlLD'](_0x35f724,null),'position':_0x222aa1['bNlLD'](_0x320e3d,null),'phone':_0x222aa1['IADGX'](_0x41e9b8,null),'email':_0x370491||null,'status':_0x222aa1[_0x53a9b8(0x3c7)](_0x3efe1e,_0x222aa1[_0x53a9b8(0x438)])});return _0x5a34e3['status'](0xc9)['json'](_0x50f20c);}catch(_0x9b2afc){return _0x5a34e3[_0x53a9b8(0x42b)](0x1f4)[_0x53a9b8(0x1fc)]({'error':_0x9b2afc[_0x53a9b8(0x359)]});}try{const [_0x29366c]=await dbPool['query'](_0x53a9b8(0x3b1),[_0x3f5059,_0x5ef7a5,_0x35f724||null,_0x222aa1[_0x53a9b8(0x215)](_0x320e3d,null),_0x222aa1[_0x53a9b8(0x3f7)](_0x41e9b8,null),_0x370491||null,_0x222aa1[_0x53a9b8(0x334)](_0x3efe1e,_0x53a9b8(0x3d1))]);_0x5a34e3[_0x53a9b8(0x42b)](0xc9)[_0x53a9b8(0x1fc)]({'id':_0x29366c['insertId'],..._0x31999d});}catch(_0x458094){if(_0x222aa1['wuvMW'](_0x458094[_0x53a9b8(0x43d)],'ER_DUP_ENTRY'))return _0x5a34e3[_0x53a9b8(0x42b)](0x190)[_0x53a9b8(0x1fc)]({'error':'工号已存在'});_0x5a34e3['status'](0x1f4)[_0x53a9b8(0x1fc)]({'error':_0x458094['message']});}}),app[_0x1ce9f3(0x42e)](_0x1ce9f3(0x313),async(_0x9434e6,_0x405bbb)=>{const _0x1f3936=_0x1ce9f3,_0xd6af8={'VLpfS':function(_0x29bf8d,_0x4e6789){return _0x29bf8d(_0x4e6789);},'DgNeY':_0x1f3936(0x1d5),'cNLbP':function(_0x20c2d6,_0x3b877d){return _0x20c2d6===_0x3b877d;},'qfiho':'mXrTS','cIxRR':_0x1f3936(0x419),'Qvtia':function(_0x5a8925,_0x16c92c){return _0x5a8925===_0x16c92c;},'FDcqY':'WSXWk','NKhzI':'工号已存在'},_0x1af8bb=_0x9434e6[_0x1f3936(0x444)]||{};if(!dbPool)try{if(_0x1af8bb[_0x1f3936(0x3a7)]){const _0x1b4bb3=await _0xd6af8['VLpfS'](readTable,_0xd6af8[_0x1f3936(0x43b)]);if(_0x1b4bb3[_0x1f3936(0x34f)](_0x4646c9=>_0x4646c9['employee_id']===_0x1af8bb[_0x1f3936(0x3a7)]&&String(_0x4646c9['id'])!==String(_0x9434e6['params']['id'])))return _0x405bbb['status'](0x190)[_0x1f3936(0x1fc)]({'error':'工号已存在'});}return await updateRow('employees',_0x9434e6['params']['id'],_0x1af8bb),_0x405bbb['json']({'success':!![]});}catch(_0xd5acbd){return _0x405bbb[_0x1f3936(0x42b)](0x1f4)['json']({'error':_0xd5acbd['message']});}try{if(_0xd6af8['cNLbP']('mXrTS',_0xd6af8[_0x1f3936(0x42a)])){const _0x1f494b=[_0xd6af8[_0x1f3936(0x38f)],_0x1f3936(0x3a7),'department','position',_0x1f3936(0x2fa),'email',_0x1f3936(0x42b)],{setSql:_0xbdcfc6,values:_0x328bcd}=buildSafeUpdate(_0x1af8bb,_0x1f494b);if(!_0xbdcfc6)return _0x405bbb['json']({'success':!![]});await dbPool['query'](_0x1f3936(0x322)+_0xbdcfc6+'\x20WHERE\x20id=?',[..._0x328bcd,_0x9434e6[_0x1f3936(0x48a)]['id']]),_0x405bbb[_0x1f3936(0x1fc)]({'success':!![]});}else return _0x1c4a47['status'](0x1f4)[_0x1f3936(0x1fc)]({'error':_0x3c5af6['message']});}catch(_0x35f3a5){if(_0xd6af8['Qvtia'](_0x35f3a5['code'],_0x1f3936(0x1ea))){if(_0xd6af8[_0x1f3936(0x268)]('WSXWk',_0xd6af8['FDcqY']))return _0x405bbb['status'](0x190)['json']({'error':_0xd6af8[_0x1f3936(0x456)]});else _0x4ecca1=_0x26f7e6||null;}_0x405bbb[_0x1f3936(0x42b)](0x1f4)[_0x1f3936(0x1fc)]({'error':_0x35f3a5[_0x1f3936(0x359)]});}}),app['delete'](_0x1ce9f3(0x313),async(_0x1d769b,_0x2064f7)=>{const _0x25cf0b=_0x1ce9f3,_0x442060={'ZoCvI':'DELETE\x20FROM\x20employees\x20WHERE\x20id=?'};if(!dbPool)try{return await deleteRow(_0x25cf0b(0x1d5),_0x1d769b['params']['id']),_0x2064f7[_0x25cf0b(0x1fc)]({'success':!![]});}catch(_0x59b9e2){return _0x2064f7[_0x25cf0b(0x42b)](0x1f4)[_0x25cf0b(0x1fc)]({'error':_0x59b9e2['message']});}try{await dbPool['query'](_0x442060[_0x25cf0b(0x2c0)],[_0x1d769b['params']['id']]),_0x2064f7['json']({'success':!![]});}catch(_0x44031b){_0x2064f7['status'](0x1f4)[_0x25cf0b(0x1fc)]({'error':_0x44031b[_0x25cf0b(0x359)]});}}),createCrudRoutes(_0x1ce9f3(0x20a),_0x1ce9f3(0x41d)),createCrudRoutes(_0x1ce9f3(0x21c),_0x1ce9f3(0x21c),'published_at'),createCrudRoutes(_0x1ce9f3(0x28d),_0x1ce9f3(0x379)),createCrudRoutes('roles',_0x1ce9f3(0x2c3)),app[_0x1ce9f3(0x44b)]('/api/logs',async(_0x59bb26,_0x53ed62)=>{const _0x103f55=_0x1ce9f3,_0x405711={'UkeQY':'LOGIN','mwcbd':function(_0xdd8dde,_0x2abcc3){return _0xdd8dde===_0x2abcc3;},'uRCfL':'POST','GjnYr':'CREATE','bGOYN':'DELETE','IqZNB':function(_0x190584,_0x28e43b){return _0x190584===_0x28e43b;},'dSagm':_0x103f55(0x2cc),'LMNkD':function(_0x590feb,_0x4a04c4,_0x2d477a){return _0x590feb(_0x4a04c4,_0x2d477a);},'dNyGZ':function(_0x150bab,_0x4c07ce){return _0x150bab(_0x4c07ce);},'pmvTC':function(_0x54aebe,_0x1a1872){return _0x54aebe*_0x1a1872;},'wZUKa':'audit_logs','qTcSv':function(_0x244499,_0x42865a){return _0x244499+_0x42865a;},'ASQbm':'created_at\x20<=\x20?','lknMJ':function(_0x3622a0,_0x429f59){return _0x3622a0===_0x429f59;},'yinkh':'method\x20=\x20\x27POST\x27\x20AND\x20path\x20NOT\x20LIKE\x20\x27/api/login%\x27','OfIut':_0x103f55(0x411),'PTKwk':function(_0x471f35,_0x3cc789){return _0x471f35===_0x3cc789;},'Buwuq':'VIEW','yneZB':'\x20WHERE\x20','IxVYI':function(_0x2fa986,_0x422028){return _0x2fa986(_0x422028);}},{page:page=0x1,pageSize:pageSize=0x14,username:_0x1ff093,type:_0x582a93,startDate:_0x3690cb,endDate:_0x205622}=_0x59bb26[_0x103f55(0x429)],_0x112d78=_0x405711['dNyGZ'](Number,pageSize),_0x2411c3=_0x405711[_0x103f55(0x436)](_0x405711['dNyGZ'](Number,page)-0x1,_0x112d78),_0x217591=(_0xec5b9a,_0x2ba3e9)=>{const _0x2474e1=_0x103f55;if(_0x2ba3e9&&_0x2ba3e9['includes'](_0x2474e1(0x3b4)))return _0x405711[_0x2474e1(0x464)];if(_0x405711[_0x2474e1(0x42d)](_0xec5b9a,_0x405711['uRCfL']))return _0x405711['GjnYr'];if(_0x405711[_0x2474e1(0x42d)](_0xec5b9a,'PUT'))return _0x2474e1(0x411);if(_0xec5b9a===_0x405711[_0x2474e1(0x391)])return _0x405711['bGOYN'];if(_0x405711['IqZNB'](_0xec5b9a,_0x2474e1(0x253)))return _0x2474e1(0x21b);return _0xec5b9a;},_0x196417=_0xefa6f=>{if(_0xefa6f>=0xc8&&_0xefa6f<0x12c)return'success';if(_0xefa6f>=0x190)return _0x405711['dSagm'];return'unknown';};if(!dbPool)try{let _0x3aaecc=await readTable(_0x405711['wZUKa']);if(_0x1ff093)_0x3aaecc=_0x3aaecc[_0x103f55(0x2d9)](_0x3b5cd6=>_0x3b5cd6['username']&&_0x3b5cd6[_0x103f55(0x42f)]['includes'](_0x1ff093));if(_0x3690cb)_0x3aaecc=_0x3aaecc['filter'](_0x62e602=>new Date(_0x62e602[_0x103f55(0x29f)])>=new Date(_0x3690cb));if(_0x205622)_0x3aaecc=_0x3aaecc['filter'](_0x5506e7=>new Date(_0x5506e7['created_at'])<=new Date(_0x205622));_0x582a93&&(_0x3aaecc=_0x3aaecc[_0x103f55(0x2d9)](_0x5c59c7=>{const _0x9c26bc=_0x103f55,_0x4c628d=_0x405711[_0x9c26bc(0x3bd)](_0x217591,_0x5c59c7['method'],_0x5c59c7['path']);return _0x4c628d===_0x582a93;}));_0x3aaecc[_0x103f55(0x3cf)]((_0x3b4087,_0x2dd5b0)=>new Date(_0x2dd5b0['created_at'])-new Date(_0x3b4087['created_at']));const _0x5d1885=_0x3aaecc[_0x103f55(0x43c)],_0x16f972=_0x3aaecc[_0x103f55(0x1df)](_0x2411c3,_0x405711[_0x103f55(0x1d8)](_0x2411c3,_0x112d78)),_0x349b9f=_0x16f972['map'](_0x2ecade=>({..._0x2ecade,'action_type':_0x217591(_0x2ecade['method'],_0x2ecade['path']),'details':_0x2ecade[_0x103f55(0x2a9)]||_0x2ecade[_0x103f55(0x275)]+(_0x2ecade['query']&&_0x2ecade[_0x103f55(0x429)]!=='null'?'\x20'+_0x2ecade['query']:''),'ip_address':_0x2ecade['ip'],'status':_0x196417(_0x2ecade['status'])}));return _0x53ed62['json']({'data':_0x349b9f,'total':_0x5d1885,'page':Number(page),'pageSize':_0x112d78});}catch(_0x5d3e64){return _0x53ed62[_0x103f55(0x42b)](0x1f4)[_0x103f55(0x1fc)]({'error':_0x5d3e64[_0x103f55(0x359)]});}try{let _0x8c4ec2=[],_0x50f872=[];_0x1ff093&&(_0x8c4ec2[_0x103f55(0x458)](_0x103f55(0x4a0)),_0x50f872['push']('%'+_0x1ff093+'%'));_0x3690cb&&(_0x8c4ec2['push'](_0x103f55(0x4a6)),_0x50f872[_0x103f55(0x458)](_0x3690cb));_0x205622&&(_0x8c4ec2[_0x103f55(0x458)](_0x405711[_0x103f55(0x355)]),_0x50f872[_0x103f55(0x458)](_0x205622));if(_0x582a93){if(_0x405711['lknMJ'](_0x582a93,'LOGIN'))_0x8c4ec2['push']('path\x20LIKE\x20\x27/api/login%\x27');else{if(_0x582a93==='CREATE')_0x8c4ec2['push'](_0x405711[_0x103f55(0x32b)]);else{if(_0x582a93===_0x405711[_0x103f55(0x40c)])_0x8c4ec2[_0x103f55(0x458)](_0x103f55(0x295));else{if(_0x582a93===_0x405711['bGOYN'])_0x8c4ec2[_0x103f55(0x458)](_0x103f55(0x2f7));else{if(_0x405711[_0x103f55(0x29a)](_0x582a93,_0x405711['Buwuq']))_0x8c4ec2['push'](_0x103f55(0x2ff));}}}}}const _0x5a35c9=_0x8c4ec2[_0x103f55(0x43c)]?_0x405711['qTcSv'](_0x405711['yneZB'],_0x8c4ec2['join'](_0x103f55(0x203))):'',[_0x223591]=await dbPool['query']('SELECT\x20COUNT(*)\x20as\x20total\x20FROM\x20audit_logs'+_0x5a35c9,_0x50f872),_0x2e1912=_0x223591[0x0][_0x103f55(0x36b)],_0x2f6651=_0x103f55(0x40f)+_0x5a35c9+'\x20ORDER\x20BY\x20created_at\x20DESC\x20LIMIT\x20?\x20OFFSET\x20?',[_0x3945d2]=await dbPool['query'](_0x2f6651,[..._0x50f872,_0x112d78,_0x2411c3]),_0x3b7770=_0x3945d2['map'](_0xa71419=>({..._0xa71419,'action_type':_0x217591(_0xa71419[_0x103f55(0x2e2)],_0xa71419[_0x103f55(0x275)]),'details':_0xa71419['operation']||_0xa71419[_0x103f55(0x275)]+(_0xa71419['query']&&_0xa71419[_0x103f55(0x429)]!==_0x103f55(0x324)?'\x20'+_0xa71419['query']:''),'ip_address':_0xa71419['ip'],'status':_0x196417(_0xa71419['status'])}));_0x53ed62['json']({'data':_0x3b7770,'total':_0x2e1912,'page':_0x405711['IxVYI'](Number,page),'pageSize':_0x112d78});}catch(_0x2b3145){_0x53ed62[_0x103f55(0x42b)](0x1f4)[_0x103f55(0x1fc)]({'error':_0x2b3145[_0x103f55(0x359)]});}}),app[_0x1ce9f3(0x1f0)]('/api/logs',async(_0x264e16,_0x1e5c54)=>{const _0x5c4dc7=_0x1ce9f3,_0x3c740a={'rLrVP':_0x5c4dc7(0x341),'TgeLQ':'所有日志已成功删除'};try{!dbPool?await writeTable('audit_logs',[]):await dbPool['query'](_0x3c740a['rLrVP']),_0x1e5c54[_0x5c4dc7(0x1fc)]({'success':!![],'message':_0x3c740a['TgeLQ']});}catch(_0x2b254d){_0x1e5c54[_0x5c4dc7(0x42b)](0x1f4)['json']({'error':_0x2b254d[_0x5c4dc7(0x359)]});}}),app['delete'](_0x1ce9f3(0x3cb),async(_0x35d40d,_0x390eb3)=>{const _0x1e0dea=_0x1ce9f3,_0x265c94={'LtkbY':function(_0x1208c3,_0x20ab18){return _0x1208c3(_0x20ab18);},'YbQAX':'audit_logs','QtWRM':_0x1e0dea(0x422),'UVlZf':'日志已成功删除','EPGzP':function(_0x4a99c5,_0x2ca003){return _0x4a99c5!==_0x2ca003;}},{id:_0x1a1991}=_0x35d40d['params'];try{if(!dbPool){const _0x4820ad=await _0x265c94['LtkbY'](readTable,'audit_logs'),_0x48717f=_0x4820ad[_0x1e0dea(0x2d9)](_0x3a54ee=>String(_0x3a54ee['id'])!==String(_0x1a1991));await writeTable(_0x265c94['YbQAX'],_0x48717f);}else await dbPool[_0x1e0dea(0x429)](_0x265c94[_0x1e0dea(0x2c8)],[_0x1a1991]);_0x390eb3[_0x1e0dea(0x1fc)]({'success':!![],'message':_0x265c94[_0x1e0dea(0x338)]});}catch(_0x2b0405){if(_0x265c94[_0x1e0dea(0x467)](_0x1e0dea(0x45c),'SDBiD'))_0x390eb3['status'](0x1f4)[_0x1e0dea(0x1fc)]({'error':_0x2b0405['message']});else return _0x506abe['status'](0x1f4)['json']({'error':_0x3d91fd[_0x1e0dea(0x359)]});}}),app[_0x1ce9f3(0x44b)](_0x1ce9f3(0x3c8),async(_0xcc1789,_0x2c98f3)=>{const _0x5d36f7=_0x1ce9f3,_0xd1af={'IWZEH':function(_0x332934,_0x1f2db3){return _0x332934===_0x1f2db3;},'GvoMb':'yQWSW','kDbFU':_0x5d36f7(0x2f4),'HAVdP':'\x20ORDER\x20BY\x20d.created_at\x20DESC'},_0x4f249d=_0xcc1789['query'][_0x5d36f7(0x1e2)];if(!dbPool)try{if(_0xd1af['IWZEH'](_0xd1af[_0x5d36f7(0x447)],'Asckg'))_0x226ba0=_0x15f36e[_0x5d36f7(0x485)](_0xe88481);else{const _0xea93e7=await readTable(_0x5d36f7(0x3c9));let _0x3ed0af=_0xea93e7;_0x4f249d&&(_0x3ed0af=_0xea93e7[_0x5d36f7(0x2d9)](_0x283bc5=>(_0x283bc5['type']||_0x5d36f7(0x2ef))===_0x4f249d));const _0x5af64c=new Map(_0xea93e7[_0x5d36f7(0x377)](_0x4d3759=>[_0x4d3759['id'],_0x4d3759[_0x5d36f7(0x419)]])),_0x567ef0=_0x3ed0af['map'](_0x16e3d5=>({..._0x16e3d5,'parent_name':_0x16e3d5['parent_id']?_0x5af64c[_0x5d36f7(0x44b)](_0x16e3d5[_0x5d36f7(0x407)])||'':null}));return _0x2c98f3['json'](_0x567ef0);}}catch(_0x3a9314){return _0x2c98f3['status'](0x1f4)['json']({'error':_0x3a9314['message']});}try{let _0x73f43=_0x5d36f7(0x2c2);const _0x2e1e4a=[];_0x4f249d&&(_0x73f43+=_0xd1af[_0x5d36f7(0x266)],_0x2e1e4a[_0x5d36f7(0x458)](_0x4f249d));_0x73f43+=_0xd1af[_0x5d36f7(0x491)];const [_0x240338]=await dbPool['query'](_0x73f43,_0x2e1e4a);_0x2c98f3[_0x5d36f7(0x1fc)](_0x240338);}catch(_0x5cf4ed){_0x2c98f3[_0x5d36f7(0x42b)](0x1f4)[_0x5d36f7(0x1fc)]({'error':_0x5cf4ed['message']});}}),app[_0x1ce9f3(0x2c1)](_0x1ce9f3(0x3c8),async(_0x3fd3dd,_0x7a106)=>{const _0x4f1307=_0x1ce9f3,_0x118678={'OykMi':_0x4f1307(0x3db),'KBLtp':'验证上级节点失败:\x20','VKsUs':function(_0x2f15b0,_0x3a7a09,_0x43c518){return _0x2f15b0(_0x3a7a09,_0x43c518);},'dwFRX':'departments','vPvSy':function(_0x21d1f1,_0x50d9a3){return _0x21d1f1||_0x50d9a3;},'Rnvon':function(_0x5ac2f8,_0x393e02){return _0x5ac2f8||_0x393e02;},'NAJrX':function(_0x5771fb,_0x169774){return _0x5771fb||_0x169774;},'cOWsu':function(_0x46df9d,_0x8c1f07){return _0x46df9d||_0x8c1f07;},'XKKgO':function(_0x52c732,_0xdbdcad){return _0x52c732||_0xdbdcad;},'vLyQM':'active','psebW':_0x4f1307(0x2ef),'VqoZm':'部门编码已存在'},_0x5b4a2d=_0x3fd3dd[_0x4f1307(0x444)]||{},{name:_0x1a4d19,code:_0x7ebf8,parent_id:_0x5eb9ce,type:_0x1a5559,manager:_0x2be018,phone:_0x407154,email:_0x23240e,status:_0x16ee35,description:_0x2a72be}=_0x5b4a2d;if(!_0x1a4d19)return _0x7a106['status'](0x190)['json']({'error':'部门名称为必填项'});if(_0x5eb9ce&&dbPool)try{const [_0x52b8dc]=await dbPool[_0x4f1307(0x429)](_0x4f1307(0x380),[_0x5eb9ce]);if(_0x52b8dc[_0x4f1307(0x43c)]===0x0){if(_0x118678[_0x4f1307(0x26a)]==='xeQLF')_0x4c783a[_0x4f1307(0x25a)](_0xbc4be1,{'recursive':!![]});else return _0x7a106[_0x4f1307(0x42b)](0x190)[_0x4f1307(0x1fc)]({'error':_0x4f1307(0x216)});}}catch(_0x59faa6){return _0x7a106[_0x4f1307(0x42b)](0x1f4)[_0x4f1307(0x1fc)]({'error':_0x118678[_0x4f1307(0x36a)]+_0x59faa6['message']});}if(!dbPool)try{const _0x434173=await _0x118678['VKsUs'](addRow,_0x118678[_0x4f1307(0x31b)],{'name':_0x1a4d19,'code':_0x118678[_0x4f1307(0x217)](_0x7ebf8,''),'parent_id':_0x118678['Rnvon'](_0x5eb9ce,null),'type':_0x1a5559||'DEPT','manager':_0x118678['NAJrX'](_0x2be018,null),'phone':_0x118678['Rnvon'](_0x407154,null),'email':_0x23240e||null,'status':_0x118678['cOWsu'](_0x16ee35,'active'),'description':_0x118678[_0x4f1307(0x362)](_0x2a72be,null)});return _0x7a106[_0x4f1307(0x42b)](0xc9)['json'](_0x434173);}catch(_0xf3c6d3){return _0x7a106['status'](0x1f4)['json']({'error':_0xf3c6d3[_0x4f1307(0x359)]});}try{const [_0x765e52]=await dbPool[_0x4f1307(0x429)]('INSERT\x20INTO\x20departments\x20(id,\x20name,\x20code,\x20parent_id,\x20type,\x20manager,\x20phone,\x20email,\x20status,\x20description)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)',[_0x5b4a2d['id']||null,_0x1a4d19,_0x118678[_0x4f1307(0x217)](_0x7ebf8,''),_0x5eb9ce||null,_0x1a5559||'DEPT',_0x2be018||null,_0x118678['XKKgO'](_0x407154,null),_0x23240e||null,_0x16ee35||_0x118678['vLyQM'],_0x2a72be||null]),_0x458b59=_0x5b4a2d['id']||_0x765e52['insertId'];_0x7a106['status'](0xc9)[_0x4f1307(0x1fc)]({'id':_0x458b59,..._0x5b4a2d,'type':_0x1a5559||_0x118678[_0x4f1307(0x477)]});}catch(_0x518064){if(_0x518064['code']===_0x4f1307(0x1ea))return _0x7a106[_0x4f1307(0x42b)](0x190)[_0x4f1307(0x1fc)]({'error':_0x118678['VqoZm']});_0x7a106[_0x4f1307(0x42b)](0x1f4)['json']({'error':_0x518064['message']});}}),app[_0x1ce9f3(0x42e)](_0x1ce9f3(0x1f3),async(_0x428eee,_0x1d9c2a)=>{const _0x4cb28f=_0x1ce9f3,_0x356764={'gTZCq':'VtrgN','mVcox':function(_0x468277,_0x574de1){return _0x468277===_0x574de1;},'ljMVz':'SELECT\x20parent_id\x20FROM\x20departments\x20WHERE\x20id\x20=\x20?','kVEai':function(_0x45be1d,_0x1b8ee0){return _0x45be1d===_0x1b8ee0;},'JUFzN':function(_0x2a54de,_0x155987,_0x290747,_0x3377ac){return _0x2a54de(_0x155987,_0x290747,_0x3377ac);},'vWTeR':_0x4cb28f(0x43d),'sxTOQ':'email','GVkRh':'status','DBgOB':function(_0x505f7c,_0x162fe7){return _0x505f7c===_0x162fe7;},'vhVQA':'部门编码已存在'},_0x22bc0f=Number(_0x428eee[_0x4cb28f(0x48a)]['id']),_0x35a1fc=_0x428eee['body']||{};if(_0x35a1fc[_0x4cb28f(0x407)]!==undefined&&_0x356764[_0x4cb28f(0x25f)](_0x35a1fc['parent_id'],_0x22bc0f))return _0x1d9c2a['status'](0x190)['json']({'error':_0x4cb28f(0x4a3)});if(_0x35a1fc[_0x4cb28f(0x407)]&&dbPool)try{const _0x3ddf27=async(_0x5e94fd,_0x108253)=>{const _0x95c6a0=_0x4cb28f;if(_0x95c6a0(0x415)!==_0x356764[_0x95c6a0(0x273)])return _0x1c4dd9['status'](0x190)['json']({'error':'指定的上级节点不存在'});else{if(_0x356764[_0x95c6a0(0x25f)](_0x5e94fd,_0x108253))return!![];const [_0x289b4a]=await dbPool['query'](_0x356764['ljMVz'],[_0x5e94fd]);if(_0x356764['kVEai'](_0x289b4a['length'],0x0)||!_0x289b4a[0x0][_0x95c6a0(0x407)])return![];return await _0x3ddf27(_0x289b4a[0x0][_0x95c6a0(0x407)],_0x108253);}},_0x48dd95=await _0x3ddf27(_0x35a1fc['parent_id'],_0x22bc0f);if(_0x48dd95)return _0x1d9c2a[_0x4cb28f(0x42b)](0x190)['json']({'error':_0x4cb28f(0x494)});}catch(_0x25db5f){console['error'](_0x4cb28f(0x448),_0x25db5f[_0x4cb28f(0x359)]);}if(!dbPool)try{return await _0x356764['JUFzN'](updateRow,'departments',_0x428eee['params']['id'],_0x35a1fc),_0x1d9c2a[_0x4cb28f(0x1fc)]({'success':!![]});}catch(_0x46f058){return _0x1d9c2a[_0x4cb28f(0x42b)](0x1f4)[_0x4cb28f(0x1fc)]({'error':_0x46f058[_0x4cb28f(0x359)]});}try{const _0x10659a=['name',_0x356764['vWTeR'],_0x4cb28f(0x407),'type',_0x4cb28f(0x240),_0x4cb28f(0x2fa),_0x356764['sxTOQ'],_0x356764[_0x4cb28f(0x2fc)],'description'],_0x5256f6=Object['keys'](_0x35a1fc)['filter'](_0x59e2b7=>_0x10659a['includes'](_0x59e2b7));if(_0x356764['DBgOB'](_0x5256f6['length'],0x0))return _0x1d9c2a['json']({'success':!![]});const _0x4a0ec7=_0x5256f6['map'](_0x3952f2=>_0x3952f2+'=?')['join'](','),_0x23002b=[..._0x5256f6['map'](_0x169bca=>_0x35a1fc[_0x169bca]),_0x22bc0f];await dbPool[_0x4cb28f(0x429)](_0x4cb28f(0x212)+_0x4a0ec7+'\x20WHERE\x20id=?',_0x23002b),_0x1d9c2a[_0x4cb28f(0x1fc)]({'success':!![]});}catch(_0x2e0c06){if(_0x356764[_0x4cb28f(0x474)](_0x2e0c06['code'],_0x4cb28f(0x1ea)))return _0x1d9c2a['status'](0x190)['json']({'error':_0x356764[_0x4cb28f(0x1fd)]});_0x1d9c2a[_0x4cb28f(0x42b)](0x1f4)['json']({'error':_0x2e0c06['message']});}}),app['delete']('/api/departments/:id',async(_0x457eb7,_0x44dfc4)=>{const _0x3f5dfa=_0x1ce9f3,_0x740478={'oLPrq':function(_0xe474ed,_0x2624d2,_0x393deb){return _0xe474ed(_0x2624d2,_0x393deb);},'WXnUq':'beSYR','ItXDv':'DELETE\x20FROM\x20departments\x20WHERE\x20id=?'};if(!dbPool)try{return await _0x740478['oLPrq'](deleteRow,_0x3f5dfa(0x3c9),_0x457eb7[_0x3f5dfa(0x48a)]['id']),_0x44dfc4['json']({'success':!![]});}catch(_0x5ae5bf){return _0x44dfc4[_0x3f5dfa(0x42b)](0x1f4)['json']({'error':_0x5ae5bf[_0x3f5dfa(0x359)]});}try{'beSYR'===_0x740478['WXnUq']?(await dbPool[_0x3f5dfa(0x429)](_0x740478[_0x3f5dfa(0x45a)],[_0x457eb7['params']['id']]),_0x44dfc4[_0x3f5dfa(0x1fc)]({'success':!![]})):_0x4edc8f=_0x3400e4['stringify'](_0x45136d);}catch(_0x114790){_0x44dfc4['status'](0x1f4)[_0x3f5dfa(0x1fc)]({'error':_0x114790['message']});}}),app[_0x1ce9f3(0x44b)](_0x1ce9f3(0x255),async(_0x132b03,_0x5cac50)=>{const _0x49c2e1=_0x1ce9f3,_0x29e00a={'xLxxh':function(_0x5dcb9d,_0xed4287){return _0x5dcb9d(_0xed4287);},'iWkXN':function(_0x8d762e,_0x223462){return _0x8d762e(_0x223462);}};if(!dbPool)try{const _0x979d50=await _0x29e00a[_0x49c2e1(0x43a)](readTable,_0x49c2e1(0x3c9)),_0x5a4474=buildOrgTree(_0x979d50);return _0x5cac50['json'](_0x5a4474);}catch(_0x561fd5){return _0x5cac50[_0x49c2e1(0x42b)](0x1f4)[_0x49c2e1(0x1fc)]({'error':_0x561fd5[_0x49c2e1(0x359)]});}try{const [_0xf2db88]=await dbPool[_0x49c2e1(0x429)](_0x49c2e1(0x242)),_0x3847c5=_0x29e00a[_0x49c2e1(0x1d7)](buildOrgTree,_0xf2db88);_0x5cac50['json'](_0x3847c5);}catch(_0x16b4cf){_0x5cac50['status'](0x1f4)[_0x49c2e1(0x1fc)]({'error':_0x16b4cf['message']});}});function buildOrgTree(_0x248cf1){const _0x5982ad=_0x1ce9f3,_0x32378f=[],_0x5eba17={};for(const _0x3864ee of _0x248cf1){_0x5eba17[_0x3864ee['id']]={..._0x3864ee,'children':[]};}for(const _0x21951c of _0x248cf1){const _0x257b80=_0x21951c[_0x5982ad(0x407)]||_0x21951c[_0x5982ad(0x332)]||null;_0x257b80&&_0x5eba17[_0x257b80]?_0x5eba17[_0x257b80]['children']['push'](_0x5eba17[_0x21951c['id']]):_0x32378f['push'](_0x5eba17[_0x21951c['id']]);}return _0x32378f;}app['post']('/api/notifications/send',async(_0x3d949c,_0x4720f0)=>{const _0x219d5f=_0x1ce9f3,_0x3a25f8={'uUQnj':function(_0x2b1ac7,_0x4e1c89){return _0x2b1ac7||_0x4e1c89;},'TqkGi':_0x219d5f(0x2ac),'eTfTN':_0x219d5f(0x3e2),'WAMBn':function(_0x4df421,_0x2b8158,_0x247c43){return _0x4df421(_0x2b8158,_0x247c43);},'icIKw':'notifications','upiTZ':_0x219d5f(0x3f5),'GhliM':'INSERT\x20INTO\x20notifications\x20(type,\x20title,\x20message,\x20published_at,\x20`read`)\x20VALUES\x20(?,\x20?,\x20?,\x20NOW(),\x200)'},_0x1f633d=_0x3d949c[_0x219d5f(0x444)]||{},{type:_0x4962af,title:_0x1e4216,message:_0x480772,recipients:_0x25b5c5}=_0x1f633d;if(_0x3a25f8[_0x219d5f(0x497)](!_0x1e4216,!_0x480772))return _0x4720f0[_0x219d5f(0x42b)](0x190)['json']({'error':_0x3a25f8[_0x219d5f(0x20d)]});try{const _0x387299={'type':_0x4962af||_0x3a25f8[_0x219d5f(0x33b)],'title':_0x1e4216,'message':_0x480772,'recipients':_0x25b5c5||[],'published_at':new Date()['toISOString'](),'read':0x0};if(!dbPool){const _0x7f57ee=await _0x3a25f8[_0x219d5f(0x3ec)](addRow,_0x3a25f8[_0x219d5f(0x1f4)],_0x387299);return io&&io['emit'](_0x3a25f8[_0x219d5f(0x22d)],{'type':'new','data':_0x7f57ee}),_0x4720f0['status'](0xc9)['json'](_0x7f57ee);}const [_0x5203f1]=await dbPool['query'](_0x3a25f8[_0x219d5f(0x421)],[_0x387299['type'],_0x387299[_0x219d5f(0x24e)],_0x387299[_0x219d5f(0x359)]]),_0xd4e877={'id':_0x5203f1['insertId'],..._0x387299};io&&io[_0x219d5f(0x3f1)](_0x3a25f8['upiTZ'],{'type':_0x219d5f(0x1e4),'data':_0xd4e877}),_0x4720f0[_0x219d5f(0x42b)](0xc9)['json'](_0xd4e877);}catch(_0x2c8edc){_0x4720f0[_0x219d5f(0x42b)](0x1f4)[_0x219d5f(0x1fc)]({'error':_0x2c8edc['message']});}});const bcrypt=require(_0x1ce9f3(0x1ec));app['get'](_0x1ce9f3(0x309),async(_0x29ee97,_0x4dd7bc)=>{const _0x2d1003=_0x1ce9f3;if(!dbPool)try{const _0x1354f3=await readTable(_0x2d1003(0x33d)),_0x4c6347=_0x1354f3[_0x2d1003(0x377)](({password:_0x4d27b6,..._0x6f564b})=>_0x6f564b);return _0x4dd7bc[_0x2d1003(0x1fc)](_0x4c6347);}catch(_0x4f44fa){return _0x4dd7bc['status'](0x1f4)[_0x2d1003(0x1fc)]({'error':_0x4f44fa[_0x2d1003(0x359)]});}try{const [_0x5e982b]=await dbPool[_0x2d1003(0x429)](_0x2d1003(0x2ce)),_0x1cb947=_0x5e982b[_0x2d1003(0x377)](_0x2dab73=>({..._0x2dab73,'permissions':safeParse(_0x2dab73['permissions'])||[]}));_0x4dd7bc[_0x2d1003(0x1fc)](_0x1cb947);}catch(_0x3c623b){_0x4dd7bc[_0x2d1003(0x42b)](0x1f4)[_0x2d1003(0x1fc)]({'error':_0x3c623b[_0x2d1003(0x359)]});}}),app['post']('/api/users',async(_0x1844bc,_0x6a208b)=>{const _0x3341c1=_0x1ce9f3,_0x19ec6f={'wpyVR':_0x3341c1(0x24c),'FBunf':function(_0x5d9819,_0x529f5d){return _0x5d9819!==_0x529f5d;},'CfOdX':'cDKHc','vbeJB':function(_0x53ab57,_0x497afe){return _0x53ab57||_0x497afe;},'XeVSk':'数据查看','phEZq':function(_0x4783de,_0x3b98a1){return _0x4783de||_0x3b98a1;},'YNItG':'active','Lgpmk':_0x3341c1(0x289)},_0x535d04=_0x1844bc['body']||{},{username:_0x1333cb,password:_0xc0c40a,name:_0xf83c2a,email:_0x5dabc7,role:_0x594f1d,department:_0x43932a,permissions:_0x200111,status:_0x21aac9}=_0x535d04;if(!_0x1333cb||!_0xc0c40a)return _0x6a208b[_0x3341c1(0x42b)](0x190)[_0x3341c1(0x1fc)]({'error':_0x19ec6f['wpyVR']});const _0x22840e=await bcrypt[_0x3341c1(0x354)](_0xc0c40a,0xa);if(!dbPool)try{if(_0x19ec6f['FBunf'](_0x3341c1(0x383),_0x19ec6f['CfOdX'])){const _0x44484a=await addRow(_0x3341c1(0x33d),{'username':_0x1333cb,'password':_0x22840e,'name':_0xf83c2a||_0x1333cb,'email':_0x5dabc7||'','role':_0x594f1d||'user','department':_0x19ec6f['vbeJB'](_0x43932a,''),'permissions':_0x200111||['数据查看'],'status':_0x19ec6f['vbeJB'](_0x21aac9,_0x3341c1(0x3d1))}),{password:_0x479215,..._0x440561}=_0x44484a;return _0x6a208b['status'](0xc9)['json'](_0x440561);}else _0x8f2b5['error']('[DingTalk]\x20保存部门\x20'+_0x40bc9e+'\x20失败:',_0x44ce7f['message']);}catch(_0x52bbe6){return _0x6a208b[_0x3341c1(0x42b)](0x1f4)[_0x3341c1(0x1fc)]({'error':_0x52bbe6[_0x3341c1(0x359)]});}try{const _0x2ba97c=JSON['stringify'](_0x200111||[_0x19ec6f[_0x3341c1(0x2a0)]]),[_0x25d4e0]=await dbPool['query'](_0x3341c1(0x3ff),[_0x1333cb,_0x22840e,_0x19ec6f[_0x3341c1(0x33e)](_0xf83c2a,_0x1333cb),_0x5dabc7||'',_0x19ec6f[_0x3341c1(0x31e)](_0x594f1d,_0x3341c1(0x293)),_0x19ec6f['phEZq'](_0x43932a,''),_0x2ba97c,_0x21aac9||_0x19ec6f[_0x3341c1(0x32c)]]);_0x6a208b[_0x3341c1(0x42b)](0xc9)[_0x3341c1(0x1fc)]({'id':_0x25d4e0[_0x3341c1(0x361)],'username':_0x1333cb,'name':_0xf83c2a||_0x1333cb,'email':_0x5dabc7,'role':_0x594f1d,'department':_0x43932a,'permissions':_0x200111,'status':_0x21aac9});}catch(_0x3a5c90){if(_0x3a5c90['code']===_0x3341c1(0x1ea))return _0x6a208b[_0x3341c1(0x42b)](0x190)[_0x3341c1(0x1fc)]({'error':_0x19ec6f['Lgpmk']});_0x6a208b['status'](0x1f4)[_0x3341c1(0x1fc)]({'error':_0x3a5c90['message']});}}),app['put']('/api/users/:id',async(_0x46104c,_0x1dd507)=>{const _0x10115c=_0x1ce9f3,_0x3bfcea={'QNKhr':_0x10115c(0x3eb),'VHKLU':_0x10115c(0x33d),'Jqszd':_0x10115c(0x23d),'hJEIb':_0x10115c(0x419),'UJDcA':_0x10115c(0x356),'cdUGj':'status'},_0x3bbaf2=_0x46104c['body']||{},{password:_0x27bce5,..._0x111a80}=_0x3bbaf2;let _0x58f40c={..._0x111a80};_0x27bce5&&(_0x58f40c['password']=await bcrypt['hash'](_0x27bce5,0xa));if(!dbPool){if('JgvJj'===_0x3bfcea['QNKhr'])try{return await updateRow(_0x3bfcea['VHKLU'],_0x46104c[_0x10115c(0x48a)]['id'],_0x58f40c),_0x1dd507[_0x10115c(0x1fc)]({'success':!![]});}catch(_0x4a7d1f){return _0x1dd507['status'](0x1f4)['json']({'error':_0x4a7d1f[_0x10115c(0x359)]});}else{const _0x28c0bb=_0x241711['body'][_0x5881b3];return typeof _0x28c0bb===_0x10115c(0x1fb)&&_0x28c0bb!==null?_0x3470af['stringify'](_0x28c0bb):_0x28c0bb;}}try{const _0x2d37e1=['username',_0x3bfcea['Jqszd'],_0x3bfcea['hJEIb'],_0x10115c(0x427),_0x10115c(0x3ed),_0x3bfcea['UJDcA'],'permissions',_0x3bfcea['cdUGj'],_0x10115c(0x2fa),_0x10115c(0x4a1)],_0x5296f4=Object[_0x10115c(0x343)](_0x58f40c)[_0x10115c(0x2d9)](_0x5e4ac3=>_0x2d37e1['includes'](_0x5e4ac3));if(!_0x5296f4['length'])return _0x1dd507[_0x10115c(0x1fc)]({'success':!![]});const _0xa5e2e2=_0x5296f4[_0x10115c(0x377)](_0xce211b=>_0xce211b+'\x20=\x20?')['join'](',\x20'),_0x1c3e84=_0x5296f4['map'](_0x3a93f9=>_0x3a93f9==='permissions'?JSON['stringify'](_0x58f40c[_0x3a93f9]):_0x58f40c[_0x3a93f9]);await dbPool['query']('UPDATE\x20users\x20SET\x20'+_0xa5e2e2+'\x20WHERE\x20id=?',[..._0x1c3e84,_0x46104c['params']['id']]),_0x1dd507['json']({'success':!![]});}catch(_0x1d52ab){_0x1dd507['status'](0x1f4)['json']({'error':_0x1d52ab['message']});}}),app['delete']('/api/users/:id',async(_0x25635b,_0x2213bb)=>{const _0x412b27=_0x1ce9f3,_0x383f89={'rLuqI':function(_0x1b952f,_0x39334e,_0x30b468){return _0x1b952f(_0x39334e,_0x30b468);},'GUJjV':_0x412b27(0x27a)};if(!dbPool)try{return await _0x383f89['rLuqI'](deleteRow,'users',_0x25635b[_0x412b27(0x48a)]['id']),_0x2213bb['json']({'success':!![]});}catch(_0x52fc8b){return _0x2213bb[_0x412b27(0x42b)](0x1f4)['json']({'error':_0x52fc8b['message']});}try{await dbPool['query'](_0x383f89[_0x412b27(0x4a2)],[_0x25635b[_0x412b27(0x48a)]['id']]),_0x2213bb[_0x412b27(0x1fc)]({'success':!![]});}catch(_0x58be65){_0x2213bb['status'](0x1f4)[_0x412b27(0x1fc)]({'error':_0x58be65[_0x412b27(0x359)]});}}),app['get']('/api/company-info',async(_0x4036e1,_0x12354d)=>{const _0x2f7d40=_0x1ce9f3;if(!dbPool)try{const _0x186a4f=await readTable(_0x2f7d40(0x476));return _0x12354d['json'](_0x186a4f[0x0]||{});}catch(_0xe44eaa){return _0x12354d[_0x2f7d40(0x42b)](0x1f4)['json']({'error':_0xe44eaa[_0x2f7d40(0x359)]});}try{const [_0x3b6bcf]=await dbPool['query']('SELECT\x20*\x20FROM\x20company_info\x20LIMIT\x201');_0x12354d['json'](_0x3b6bcf[0x0]||{});}catch(_0x491bd2){_0x12354d[_0x2f7d40(0x42b)](0x1f4)[_0x2f7d40(0x1fc)]({'error':_0x491bd2[_0x2f7d40(0x359)]});}}),app[_0x1ce9f3(0x42e)](_0x1ce9f3(0x44d),async(_0x35b901,_0x5d44d4)=>{const _0x590e0a=_0x1ce9f3,_0x473257={'IXIpS':function(_0x4c6ec9,_0x183739){return _0x4c6ec9(_0x183739);},'YyNYe':function(_0x3a9186,_0x597531){return _0x3a9186>_0x597531;},'CqvMg':_0x590e0a(0x476),'efbvJ':_0x590e0a(0x430),'ddVhb':_0x590e0a(0x3be),'ZXEFz':_0x590e0a(0x427),'sepbt':_0x590e0a(0x228),'Nmtbd':_0x590e0a(0x3b0),'qSyrV':_0x590e0a(0x2b4)},_0x25ff17=_0x35b901[_0x590e0a(0x444)]||{};if(!dbPool)try{const _0x246a33=await _0x473257['IXIpS'](readTable,'company_info');return _0x473257[_0x590e0a(0x43e)](_0x246a33[_0x590e0a(0x43c)],0x0)?await updateRow(_0x473257[_0x590e0a(0x433)],_0x246a33[0x0]['id'],_0x25ff17):await addRow(_0x590e0a(0x476),_0x25ff17),_0x5d44d4[_0x590e0a(0x1fc)]({'success':!![],..._0x25ff17});}catch(_0x3a8643){return _0x5d44d4['status'](0x1f4)[_0x590e0a(0x1fc)]({'error':_0x3a8643[_0x590e0a(0x359)]});}try{const [_0x572b2b]=await dbPool[_0x590e0a(0x429)](_0x473257['efbvJ']),_0x18d4e0=['name',_0x473257['ddVhb'],_0x590e0a(0x2fa),_0x473257[_0x590e0a(0x41f)],_0x473257[_0x590e0a(0x305)],_0x473257['Nmtbd'],_0x590e0a(0x27d),_0x590e0a(0x49d),'employee_count',_0x473257['qSyrV']];if(_0x572b2b['length']>0x0){const _0x44df73=_0x18d4e0[_0x590e0a(0x2d9)](_0x32a79b=>_0x25ff17[_0x32a79b]!==undefined);if(_0x44df73[_0x590e0a(0x43c)]){const _0xab292d=_0x44df73[_0x590e0a(0x377)](_0x4671d6=>_0x4671d6+_0x590e0a(0x35e))['join'](',\x20'),_0x20f633=_0x44df73[_0x590e0a(0x377)](_0x503190=>_0x25ff17[_0x503190]);await dbPool[_0x590e0a(0x429)]('UPDATE\x20company_info\x20SET\x20'+_0xab292d+'\x20WHERE\x20id=?',[..._0x20f633,_0x572b2b[0x0]['id']]);}}else{const _0x47eeb9=_0x18d4e0[_0x590e0a(0x377)](_0x49f88a=>_0x25ff17[_0x49f88a]??null);await dbPool[_0x590e0a(0x429)]('INSERT\x20INTO\x20company_info\x20('+_0x18d4e0[_0x590e0a(0x209)](',')+_0x590e0a(0x25d)+_0x18d4e0[_0x590e0a(0x377)](()=>'?')[_0x590e0a(0x209)](',')+')',_0x47eeb9);}_0x5d44d4['json']({'success':!![],..._0x25ff17});}catch(_0x3ae841){_0x5d44d4[_0x590e0a(0x42b)](0x1f4)[_0x590e0a(0x1fc)]({'error':_0x3ae841['message']});}}),app['get'](_0x1ce9f3(0x224),async(_0x5e8b53,_0x2eb5a1)=>{const _0xf4be1e=_0x1ce9f3,_0x552e6c={'LEtij':'只支持\x20JSON\x20备份文件','KyCmN':function(_0x44d51c,_0x4a68cc){return _0x44d51c!==_0x4a68cc;},'BeHEA':_0xf4be1e(0x29e),'lmGwB':'mOmOn','icPWF':'SELECT\x20id,\x20name,\x20type,\x20description,\x20fields,\x20updated_at,\x20created_at\x20FROM\x20templates\x20ORDER\x20BY\x20id\x20DESC'};if(!dbPool)try{if(_0x552e6c[_0xf4be1e(0x2ae)](_0xf4be1e(0x2f1),'LgGls'))_0x2f5f3a(new _0x12c525(_0x552e6c['LEtij']));else{const _0x152800=await readTable(_0x552e6c['BeHEA']);return _0x2eb5a1[_0xf4be1e(0x1fc)](_0x152800);}}catch(_0x289e1f){return _0x2eb5a1['status'](0x1f4)[_0xf4be1e(0x1fc)]({'error':_0x289e1f[_0xf4be1e(0x359)]});}try{if(_0x552e6c[_0xf4be1e(0x265)]==='mOmOn'){const [_0x57f724]=await dbPool[_0xf4be1e(0x429)](_0x552e6c['icPWF']),_0x42cc9a=_0x57f724[_0xf4be1e(0x377)](_0x77f787=>({'id':_0x77f787['id'],'name':_0x77f787[_0xf4be1e(0x419)],'type':_0x77f787['type'],'description':_0x77f787[_0xf4be1e(0x27d)],'fields':safeParse(_0x77f787[_0xf4be1e(0x2a8)])||[],'updated_at':_0x77f787['updated_at'],'created_at':_0x77f787['created_at']}));_0x2eb5a1[_0xf4be1e(0x1fc)](_0x42cc9a);}else return _0x2421a4['status'](0x1f4)[_0xf4be1e(0x1fc)]({'error':_0x6bf4d[_0xf4be1e(0x359)]});}catch(_0x28b1c3){_0x2eb5a1[_0xf4be1e(0x42b)](0x1f4)['json']({'error':_0x28b1c3['message']});}}),app['post']('/api/templates',async(_0x582313,_0x101869)=>{const _0x4319fd=_0x1ce9f3,_0x57363f={'mZokh':_0x4319fd(0x419),'Tdyld':'type','fdyBH':_0x4319fd(0x27d),'xGhlN':_0x4319fd(0x437)};if(!dbPool)try{const _0x112916=_0x582313['body']||{},_0x4fe991=await addRow(_0x4319fd(0x29e),_0x112916);return _0x101869['status'](0xc9)['json'](_0x4fe991);}catch(_0x32e3b3){return _0x101869['status'](0x1f4)['json']({'error':_0x32e3b3['message']});}try{const _0x268734=_0x582313['body']||{},_0x116579=[_0x57363f[_0x4319fd(0x227)],_0x57363f['Tdyld'],_0x57363f['fdyBH'],_0x4319fd(0x2a8),_0x57363f[_0x4319fd(0x27f)]],_0x6329c9=[_0x268734[_0x4319fd(0x419)]??null,_0x268734[_0x4319fd(0x1e2)]??null,_0x268734['description']??null,_0x268734['fields']!==undefined?JSON['stringify'](_0x268734[_0x4319fd(0x2a8)]):'[]',_0x268734[_0x4319fd(0x437)]??new Date()['toISOString']()],_0x2d417d=_0x116579[_0x4319fd(0x377)](()=>'?')['join'](','),[_0x57f68d]=await dbPool[_0x4319fd(0x429)]('INSERT\x20INTO\x20templates\x20('+_0x116579['join'](',')+')\x20VALUES\x20('+_0x2d417d+')',_0x6329c9);_0x101869[_0x4319fd(0x42b)](0xc9)[_0x4319fd(0x1fc)]({'id':_0x57f68d[_0x4319fd(0x361)],..._0x268734});}catch(_0x943474){_0x101869['status'](0x1f4)['json']({'error':_0x943474[_0x4319fd(0x359)]});}}),app['put']('/api/templates/:id',async(_0xdcad5b,_0x8b2f93)=>{const _0x26a58e=_0x1ce9f3,_0x547370={'XGdBp':function(_0x47dce9,_0x4fef0b,_0x15f913,_0x1a60c9){return _0x47dce9(_0x4fef0b,_0x15f913,_0x1a60c9);},'BVeQT':'name','ctNqt':_0x26a58e(0x1e2),'cbUnA':_0x26a58e(0x2a8)};if(!dbPool)try{return await _0x547370[_0x26a58e(0x46c)](updateRow,_0x26a58e(0x29e),_0xdcad5b['params']['id'],_0xdcad5b[_0x26a58e(0x444)]||{}),_0x8b2f93['json']({'success':!![]});}catch(_0x88e0d2){return _0x8b2f93[_0x26a58e(0x42b)](0x1f4)['json']({'error':_0x88e0d2['message']});}try{const _0x6a5352=_0xdcad5b[_0x26a58e(0x444)]||{},_0x14d5ec=[_0x547370['BVeQT'],_0x547370[_0x26a58e(0x2d6)],_0x26a58e(0x27d),_0x547370[_0x26a58e(0x3d5)],_0x26a58e(0x437)],_0xb6defc=Object[_0x26a58e(0x343)](_0x6a5352)['filter'](_0x4db799=>_0x14d5ec[_0x26a58e(0x24b)](_0x4db799));if(!_0xb6defc[_0x26a58e(0x43c)])return _0x8b2f93['json']({'success':!![]});const _0x1f1a46=_0xb6defc[_0x26a58e(0x377)](_0x40d5d5=>_0x40d5d5+'\x20=\x20?')[_0x26a58e(0x209)](',\x20'),_0x569be0=_0xb6defc[_0x26a58e(0x377)](_0x39d489=>_0x39d489===_0x26a58e(0x2a8)?JSON[_0x26a58e(0x393)](_0x6a5352[_0x39d489]??[]):_0x6a5352[_0x39d489]);await dbPool[_0x26a58e(0x429)]('UPDATE\x20templates\x20SET\x20'+_0x1f1a46+_0x26a58e(0x2b9),[..._0x569be0,_0xdcad5b['params']['id']]),_0x8b2f93[_0x26a58e(0x1fc)]({'success':!![]});}catch(_0x2428f8){_0x8b2f93['status'](0x1f4)['json']({'error':_0x2428f8[_0x26a58e(0x359)]});}}),app['delete']('/api/templates/:id',async(_0x8610d8,_0x4b0f11)=>{const _0x3fe032=_0x1ce9f3,_0x294b34={'PpRBe':function(_0x4405a0,_0xf50c8e){return _0x4405a0===_0xf50c8e;},'sEulm':_0x3fe032(0x349),'mqGEZ':_0x3fe032(0x24f)};if(!dbPool){if(_0x294b34[_0x3fe032(0x301)](_0x294b34['sEulm'],_0x294b34['sEulm']))try{return await deleteRow(_0x3fe032(0x29e),_0x8610d8['params']['id']),_0x4b0f11['json']({'success':!![]});}catch(_0x1872f6){return _0x4b0f11[_0x3fe032(0x42b)](0x1f4)[_0x3fe032(0x1fc)]({'error':_0x1872f6[_0x3fe032(0x359)]});}else _0x268241['status'](0x1f4)[_0x3fe032(0x1fc)]({'error':_0x31af4d[_0x3fe032(0x359)]});}try{await dbPool['query'](_0x294b34[_0x3fe032(0x435)],[_0x8610d8['params']['id']]),_0x4b0f11['json']({'success':!![]});}catch(_0x28981c){_0x4b0f11['status'](0x1f4)[_0x3fe032(0x1fc)]({'error':_0x28981c[_0x3fe032(0x359)]});}}),app['get']('/api/monthly-progress',async(_0x100182,_0x202f2c)=>{const _0xa2740e=_0x1ce9f3,_0x1411df={'FiNxE':'\x0a⚠️\x20\x20警告:\x20JWT_SECRET\x20未配置或使用默认值！','tCiQs':'\x20\x20\x20生产环境中，请在\x20.env\x20文件中设置强随机的\x20JWT_SECRET','sOMmr':_0xa2740e(0x211),'CMmWJ':_0xa2740e(0x1f8),'cZews':_0xa2740e(0x350),'FZgAA':_0xa2740e(0x203),'nPzZL':function(_0x4ccdd5,_0x490ff4){return _0x4ccdd5!==_0x490ff4;}};if(!dbPool)try{const {year:_0x5889d9,month:_0x182551,department:_0x55219b,status:_0x3e8b75}=_0x100182['query']||{};let _0x2a269e=await readTable('monthly_progress');if(_0x5889d9)_0x2a269e=_0x2a269e['filter'](_0x52942d=>Number(_0x52942d[_0xa2740e(0x2e9)])===Number(_0x5889d9));if(_0x182551)_0x2a269e=_0x2a269e[_0xa2740e(0x2d9)](_0x17fcfe=>Number(_0x17fcfe['month'])===Number(_0x182551));if(_0x55219b)_0x2a269e=_0x2a269e['filter'](_0x31555f=>String(_0x31555f[_0xa2740e(0x356)])===String(_0x55219b));if(_0x3e8b75)_0x2a269e=_0x2a269e[_0xa2740e(0x2d9)](_0x1f698a=>String(_0x1f698a['status'])===String(_0x3e8b75));return _0x202f2c['json'](_0x2a269e);}catch(_0x3a70d5){return _0x202f2c[_0xa2740e(0x42b)](0x1f4)['json']({'error':_0x3a70d5['message']});}try{const {year:_0x179420,month:_0x2ab625,department:_0x516bb5,status:_0x488c3d}=_0x100182[_0xa2740e(0x429)]||{},_0x128e7d=[],_0x29f7b8=[];_0x179420&&(_0x128e7d[_0xa2740e(0x458)](_0x1411df['sOMmr']),_0x29f7b8['push'](Number(_0x179420)));_0x2ab625&&(_0x128e7d['push'](_0x1411df[_0xa2740e(0x492)]),_0x29f7b8[_0xa2740e(0x458)](Number(_0x2ab625)));_0x516bb5&&(_0x128e7d['push'](_0xa2740e(0x1f1)),_0x29f7b8[_0xa2740e(0x458)](String(_0x516bb5)));_0x488c3d&&(_0x128e7d[_0xa2740e(0x458)](_0x1411df[_0xa2740e(0x46d)]),_0x29f7b8[_0xa2740e(0x458)](String(_0x488c3d)));const _0x42dbb9=_0xa2740e(0x1fa)+(_0x128e7d['length']?'\x20WHERE\x20'+_0x128e7d[_0xa2740e(0x209)](_0x1411df['FZgAA']):'')+_0xa2740e(0x26b),[_0x1db281]=await dbPool['query'](_0x42dbb9,_0x29f7b8);_0x202f2c['json'](_0x1db281);}catch(_0x31118c){_0x1411df[_0xa2740e(0x367)](_0xa2740e(0x2ca),_0xa2740e(0x2ba))?_0x202f2c['status'](0x1f4)['json']({'error':_0x31118c['message']}):(_0x18f578['warn'](_0x1411df['FiNxE']),_0x314339[_0xa2740e(0x44e)](_0x1411df['tCiQs']),_0x30c10f['warn'](_0xa2740e(0x481)));}}),app[_0x1ce9f3(0x2c1)](_0x1ce9f3(0x239),async(_0x1f9527,_0x3cf33d)=>{const _0x5682cc=_0x1ce9f3,_0x31ec06={'EYvSa':'month','wCfXR':_0x5682cc(0x323),'VNitH':_0x5682cc(0x2e9),'XjFfM':'start_date','NeJFa':'next_month_plan','RqfDw':'support_needed'};if(!dbPool)try{const _0x4fac4a=_0x1f9527[_0x5682cc(0x444)]||{},_0x4831ca=['year',_0x31ec06[_0x5682cc(0x49a)],'task_name'],_0x1120ca=_0x4831ca[_0x5682cc(0x2d9)](_0x12200b=>!_0x4fac4a[_0x12200b]&&_0x4fac4a[_0x12200b]!==0x0);if(_0x1120ca['length'])return _0x3cf33d[_0x5682cc(0x42b)](0x190)[_0x5682cc(0x1fc)]({'error':'缺少必填项:\x20'+_0x1120ca['join'](',\x20')});const _0x203014=await addRow('monthly_progress',_0x4fac4a);return _0x3cf33d[_0x5682cc(0x42b)](0xc9)[_0x5682cc(0x1fc)](_0x203014);}catch(_0x3daae7){return _0x3cf33d[_0x5682cc(0x42b)](0x1f4)['json']({'error':_0x3daae7[_0x5682cc(0x359)]});}try{const _0x250bec=_0x1f9527[_0x5682cc(0x444)]||{},_0x28ccdf=['year',_0x31ec06[_0x5682cc(0x49a)],_0x31ec06[_0x5682cc(0x248)]],_0x2a4a8f=_0x28ccdf['filter'](_0x1cd289=>!_0x250bec[_0x1cd289]&&_0x250bec[_0x1cd289]!==0x0);if(_0x2a4a8f[_0x5682cc(0x43c)])return _0x3cf33d['status'](0x190)[_0x5682cc(0x1fc)]({'error':'缺少必填项:\x20'+_0x2a4a8f['join'](',\x20')});const _0x2cac76=[_0x31ec06[_0x5682cc(0x44a)],'month','department','task_name',_0x5682cc(0x357),'actual_value','status','responsible_person',_0x31ec06[_0x5682cc(0x2ad)],'end_date','key_activities',_0x5682cc(0x30d),'challenges',_0x31ec06['NeJFa'],_0x31ec06['RqfDw']],_0x14381a=_0x2cac76['map'](_0x5e3d25=>_0x250bec[_0x5e3d25]??null),_0x70d68=_0x2cac76['map'](()=>'?')[_0x5682cc(0x209)](','),[_0x1f94cf]=await dbPool['query']('INSERT\x20INTO\x20monthly_progress\x20(`'+_0x2cac76['join'](_0x5682cc(0x386))+'`)\x20VALUES\x20('+_0x70d68+')',_0x14381a);_0x3cf33d['status'](0xc9)[_0x5682cc(0x1fc)]({'id':_0x1f94cf['insertId'],..._0x250bec});}catch(_0xe4667b){_0x3cf33d['status'](0x1f4)[_0x5682cc(0x1fc)]({'error':_0xe4667b['message']});}}),app[_0x1ce9f3(0x42e)](_0x1ce9f3(0x303),async(_0xe0fb48,_0x3df9af)=>{const _0x3913bb=_0x1ce9f3,_0x2eb7d4={'Hjvfj':_0x3913bb(0x23b),'vylBm':_0x3913bb(0x3ef),'KOrYW':'year','NpVeJ':_0x3913bb(0x36c),'CcVFT':'department','BqOKq':'responsible_person','PpPsk':'end_date'};if(!dbPool)try{return await updateRow(_0x2eb7d4['vylBm'],_0xe0fb48['params']['id'],_0xe0fb48['body']||{}),_0x3df9af['json']({'success':!![]});}catch(_0x4354c9){return _0x3df9af['status'](0x1f4)[_0x3913bb(0x1fc)]({'error':_0x4354c9[_0x3913bb(0x359)]});}try{const _0x18e13d=[_0x2eb7d4['KOrYW'],_0x2eb7d4[_0x3913bb(0x454)],_0x2eb7d4['CcVFT'],_0x3913bb(0x323),_0x3913bb(0x357),_0x3913bb(0x34c),'status',_0x2eb7d4[_0x3913bb(0x388)],_0x3913bb(0x37d),_0x2eb7d4['PpPsk'],_0x3913bb(0x39c),_0x3913bb(0x30d),'challenges',_0x3913bb(0x472),_0x3913bb(0x23c)],{setSql:_0x2c5305,values:_0x16625c}=buildSafeUpdate(_0xe0fb48['body']||{},_0x18e13d);if(!_0x2c5305)return _0x3df9af[_0x3913bb(0x1fc)]({'success':!![]});await dbPool['query'](_0x3913bb(0x3d0)+_0x2c5305+_0x3913bb(0x2b9),[..._0x16625c,_0xe0fb48['params']['id']]),_0x3df9af['json']({'success':!![]});}catch(_0x2b4730){_0x3913bb(0x2a1)!==_0x3913bb(0x258)?_0x3df9af['status'](0x1f4)['json']({'error':_0x2b4730['message']}):(_0x231d6d[_0x3913bb(0x3ee)](_0x2eb7d4[_0x3913bb(0x49b)],_0x2c3ead['message']),_0x210f72['status'](0x1f4)[_0x3913bb(0x1fc)]({'error':_0x59ab82['message']}));}}),app[_0x1ce9f3(0x1f0)]('/api/monthly-progress/:id',async(_0x3eccba,_0x3bd32e)=>{const _0x464e8c=_0x1ce9f3,_0x241d0f={'HeTLc':'行动计划','NfqJM':_0x464e8c(0x3ad),'bKHLM':'重大事项','TCUJQ':_0x464e8c(0x25c),'hvEbu':_0x464e8c(0x29b),'BEYQc':_0x464e8c(0x237),'zMHMH':'POST','KPByH':function(_0x5c808b,_0x5b97f6){return _0x5c808b+_0x5b97f6;},'DYrpn':'DELETE','mFMiQ':'WRNXX','SekbQ':function(_0x18aef1,_0x2e1a37,_0x3866b3){return _0x18aef1(_0x2e1a37,_0x3866b3);}};if(!dbPool){if(_0x241d0f[_0x464e8c(0x400)]!==_0x241d0f['mFMiQ']){const _0x2ed0d8=_0x5836a2['split']('/')[_0x464e8c(0x2d9)](_0x17b45f),_0x6541f1=_0x2ed0d8[0x1]||'',_0x3606e6=_0x2ed0d8[0x2]||null,_0x197b02={'login':'系统登录','users':'用户','departments':'部门','employees':'员工','monthly-progress':_0x464e8c(0x342),'department-targets':_0x464e8c(0x1f6),'action-plans':_0x241d0f[_0x464e8c(0x2f8)],'annual-work-plans':_0x241d0f[_0x464e8c(0x1d3)],'major-events':_0x241d0f['bKHLM'],'notifications':'通知','templates':'模板','target-types':'目标类型','company-info':'公司信息','system-settings':_0x241d0f[_0x464e8c(0x408)],'roles':'角色','admin':_0x241d0f[_0x464e8c(0x351)],'organization':'组织架构','dingtalk':_0x464e8c(0x223),'upload':_0x464e8c(0x3c4),'logs':_0x464e8c(0x310)},_0xc6e7d3=_0x197b02[_0x6541f1]||_0x6541f1;if(_0x7c7c3f[_0x464e8c(0x24b)]('/sync-dingtalk'))return _0x464e8c(0x45f)+(_0x54cf7c['includes']('departments')?'部门':'员工')+'数据';if(_0x43faba[_0x464e8c(0x24b)]('/backup'))return _0x241d0f[_0x464e8c(0x360)];if(_0x567b61[_0x464e8c(0x24b)]('/login')){const _0x188774=_0xb9bccc?.[_0x464e8c(0x42f)]||'未知用户';return'用户登录:\x20'+_0x188774;}switch(_0x518d29){case'GET':if(_0x3606e6)return'查看'+_0xc6e7d3+'详情\x20(ID:\x20'+_0x3606e6+')';return'查询'+_0xc6e7d3+'列表';case _0x241d0f[_0x464e8c(0x1fe)]:const _0x32049f=_0x4ec484?.['name']||_0x348119?.[_0x464e8c(0x24e)]||_0x34bbee?.[_0x464e8c(0x323)]||_0x435937?.['event_name']||_0x3eed30?.['username']||'';return'新增'+_0xc6e7d3+(_0x32049f?_0x241d0f['KPByH'](':\x20',_0x32049f):'');case _0x464e8c(0x20f):return'修改'+_0xc6e7d3+'\x20(ID:\x20'+_0x3606e6+')';case _0x241d0f[_0x464e8c(0x2b6)]:return'删除'+_0xc6e7d3+'\x20(ID:\x20'+_0x3606e6+')';default:return _0xb5c03b+'\x20'+_0x393594;}}else try{return await _0x241d0f[_0x464e8c(0x396)](deleteRow,'monthly_progress',_0x3eccba['params']['id']),_0x3bd32e[_0x464e8c(0x1fc)]({'success':!![]});}catch(_0x3f0af3){return _0x3bd32e[_0x464e8c(0x42b)](0x1f4)['json']({'error':_0x3f0af3[_0x464e8c(0x359)]});}}try{await dbPool['query'](_0x464e8c(0x2a2),[_0x3eccba['params']['id']]),_0x3bd32e[_0x464e8c(0x1fc)]({'success':!![]});}catch(_0x5b3c65){_0x3bd32e[_0x464e8c(0x42b)](0x1f4)['json']({'error':_0x5b3c65['message']});}}),app['get'](_0x1ce9f3(0x2ec),async(_0x58b4dd,_0x2bb17)=>{const _0x555d6e=_0x1ce9f3,_0xd66165={'EPFYy':function(_0x138fbd,_0x5978d3){return _0x138fbd===_0x5978d3;},'YYciV':_0x555d6e(0x431),'dUErB':'year\x20=\x20?','mCQkr':function(_0x4944c1,_0x511621){return _0x4944c1(_0x511621);},'kuVyX':'target_type\x20=\x20?'};if(!dbPool)try{const {year:_0x44ffe4,department:_0x42f52d,targetType:_0x42b158}=_0x58b4dd[_0x555d6e(0x429)]||{};let _0x38cd7c=await readTable(_0x555d6e(0x22c));if(_0x44ffe4)_0x38cd7c=_0x38cd7c[_0x555d6e(0x2d9)](_0x54d132=>Number(_0x54d132[_0x555d6e(0x2e9)])===Number(_0x44ffe4));if(_0x42f52d)_0x38cd7c=_0x38cd7c[_0x555d6e(0x2d9)](_0x38d5a3=>String(_0x38d5a3['department'])===String(_0x42f52d));if(_0x42b158)_0x38cd7c=_0x38cd7c['filter'](_0x1b5199=>String(_0x1b5199['target_type'])===String(_0x42b158));return _0x2bb17['json'](_0x38cd7c);}catch(_0x5756ad){if(_0xd66165[_0x555d6e(0x3f6)]('uhWOH',_0xd66165[_0x555d6e(0x214)])){if(!_0x520f01)return null;try{return _0x55b9cd['parse'](_0x3b4f88);}catch(_0x460f8f){return null;}}else return _0x2bb17['status'](0x1f4)[_0x555d6e(0x1fc)]({'error':_0x5756ad[_0x555d6e(0x359)]});}try{const {year:_0x1ffb6d,department:_0x53a377,targetType:_0x31466a}=_0x58b4dd['query']||{},_0x4ebab2=[],_0x3069aa=[];_0x1ffb6d&&(_0x4ebab2['push'](_0xd66165['dUErB']),_0x3069aa['push'](_0xd66165['mCQkr'](Number,_0x1ffb6d)));_0x53a377&&(_0x4ebab2[_0x555d6e(0x458)]('department\x20=\x20?'),_0x3069aa['push'](String(_0x53a377)));_0x31466a&&(_0x4ebab2['push'](_0xd66165['kuVyX']),_0x3069aa[_0x555d6e(0x458)](String(_0x31466a)));const _0x52fccf=_0x555d6e(0x1f2)+(_0x4ebab2[_0x555d6e(0x43c)]?_0x555d6e(0x3b7)+_0x4ebab2['join']('\x20AND\x20'):'')+_0x555d6e(0x26b),[_0x2a5f34]=await dbPool['query'](_0x52fccf,_0x3069aa);_0x2bb17[_0x555d6e(0x1fc)](_0x2a5f34);}catch(_0x325ae1){_0x2bb17['status'](0x1f4)['json']({'error':_0x325ae1['message']});}}),app[_0x1ce9f3(0x2c1)]('/api/department-targets',async(_0xd42bcf,_0x116160)=>{const _0xa64699=_0x1ce9f3,_0x2d2b0c={'mrlIE':'target_type','PlWKH':'year','cOcSv':'quarter','vRkhr':_0xa64699(0x36c),'NyZdg':'completion_rate','mTrJl':'department_targets','BkRTz':'department_id','KjpcP':_0xa64699(0x327),'SWkOf':_0xa64699(0x38c),'sDVaT':_0xa64699(0x22b)};if(!dbPool)try{const _0x2cde64=_0xd42bcf[_0xa64699(0x444)]||{},_0x4d3859=['year',_0xa64699(0x2e4),_0x2d2b0c['mrlIE']],_0x4dfa5b=_0x4d3859['filter'](_0x35ef4a=>!_0x2cde64[_0x35ef4a]&&_0x2cde64[_0x35ef4a]!==0x0);if(_0x4dfa5b[_0xa64699(0x43c)])return _0x116160[_0xa64699(0x42b)](0x190)['json']({'error':'缺少必填项:\x20'+_0x4dfa5b[_0xa64699(0x209)](',\x20')});const _0x5b478d=_0x2cde64['department']||null,_0x19679f=[_0x2d2b0c[_0xa64699(0x210)],_0xa64699(0x2e4),'department',_0xa64699(0x327),'target_type',_0xa64699(0x339),_0xa64699(0x357),_0xa64699(0x38c),_0x2d2b0c['cOcSv'],_0x2d2b0c[_0xa64699(0x280)],'current_value',_0x2d2b0c[_0xa64699(0x469)],'responsible_person',_0xa64699(0x27d)],_0x302bf8={};_0x19679f[_0xa64699(0x3aa)](_0x116d17=>_0x302bf8[_0x116d17]=_0x2cde64[_0x116d17]??(_0x116d17===_0xa64699(0x356)?_0x5b478d:null));const _0x52ee63=await addRow(_0x2d2b0c[_0xa64699(0x285)],_0x302bf8);return _0x116160['status'](0xc9)['json'](_0x52ee63);}catch(_0x45c4e4){return _0x116160[_0xa64699(0x42b)](0x1f4)[_0xa64699(0x1fc)]({'error':_0x45c4e4[_0xa64699(0x359)]});}try{const _0x594bc9=_0xd42bcf['body']||{},_0x4cec32=[_0x2d2b0c['PlWKH'],_0x2d2b0c['BkRTz'],_0x2d2b0c['mrlIE']],_0x3c6375=_0x4cec32[_0xa64699(0x2d9)](_0x1839f6=>!_0x594bc9[_0x1839f6]&&_0x594bc9[_0x1839f6]!==0x0);if(_0x3c6375['length'])return _0x116160['status'](0x190)['json']({'error':_0xa64699(0x213)+_0x3c6375[_0xa64699(0x209)](',\x20')});const _0x372758=_0x594bc9[_0xa64699(0x356)]||null,_0x363626=[_0xa64699(0x2e9),_0x2d2b0c['BkRTz'],_0xa64699(0x356),_0x2d2b0c['KjpcP'],'target_type','target_name',_0xa64699(0x357),_0x2d2b0c['SWkOf'],'quarter',_0xa64699(0x36c),_0xa64699(0x37e),_0x2d2b0c[_0xa64699(0x469)],'responsible_person','description'],_0xb01d8c=_0x363626['map'](_0x41f559=>_0x594bc9[_0x41f559]??(_0x41f559===_0xa64699(0x356)?_0x372758:null)),_0x15109f=_0x363626[_0xa64699(0x377)](()=>'?')['join'](','),[_0x447f12]=await dbPool['query'](_0xa64699(0x200)+_0x363626['join'](_0xa64699(0x386))+_0xa64699(0x225)+_0x15109f+')',_0xb01d8c);_0x116160['status'](0xc9)[_0xa64699(0x1fc)]({'id':_0x447f12['insertId'],..._0x594bc9});}catch(_0x405bc9){if(_0x2d2b0c[_0xa64699(0x3a1)]!==_0xa64699(0x1ff))_0x116160['status'](0x1f4)['json']({'error':_0x405bc9[_0xa64699(0x359)]});else try{const _0x24f2ee=_0x2ba035[_0xa64699(0x3da)](_0x11f633[0x1],_0x23cba7);_0x82c516=_0x24f2ee?.[_0xa64699(0x42f)]||_0x117da7,_0x5661de=_0x24f2ee?.[_0xa64699(0x3ed)]||_0x54ec6b;}catch(_0xbf6ef4){}}}),app['put']('/api/department-targets/:id',async(_0x3fbf46,_0x4fb3d0)=>{const _0x4cd8d7=_0x1ce9f3,_0x4675c6={'bwWPk':'year','aflpl':_0x4cd8d7(0x327),'xyYkh':_0x4cd8d7(0x284),'ehabL':'target_name','JHWwT':_0x4cd8d7(0x38c),'mBsDO':_0x4cd8d7(0x292),'jkwgg':'completion_rate','zYWAk':function(_0x180fbf,_0x212a78){return _0x180fbf===_0x212a78;}};if(!dbPool)try{return await updateRow(_0x4cd8d7(0x22c),_0x3fbf46[_0x4cd8d7(0x48a)]['id'],_0x3fbf46['body']||{}),_0x4fb3d0[_0x4cd8d7(0x1fc)]({'success':!![]});}catch(_0x978542){return _0x4fb3d0['status'](0x1f4)[_0x4cd8d7(0x1fc)]({'error':_0x978542['message']});}try{const _0x430063=[_0x4675c6[_0x4cd8d7(0x302)],_0x4cd8d7(0x2e4),_0x4cd8d7(0x356),_0x4675c6[_0x4cd8d7(0x28b)],_0x4675c6[_0x4cd8d7(0x3f0)],_0x4675c6[_0x4cd8d7(0x424)],'target_value',_0x4675c6[_0x4cd8d7(0x328)],_0x4675c6['mBsDO'],'month','current_value',_0x4675c6['jkwgg'],_0x4cd8d7(0x251),'description'],{setSql:_0x76cdb6,values:_0x1e1bd8}=buildSafeUpdate(_0x3fbf46['body']||{},_0x430063);if(!_0x76cdb6)return _0x4fb3d0['json']({'success':!![]});await dbPool[_0x4cd8d7(0x429)](_0x4cd8d7(0x274)+_0x76cdb6+_0x4cd8d7(0x2b9),[..._0x1e1bd8,_0x3fbf46[_0x4cd8d7(0x48a)]['id']]),_0x4fb3d0['json']({'success':!![]});}catch(_0x3012c9){_0x4675c6['zYWAk'](_0x4cd8d7(0x2f3),'mRIuB')?_0x4fb3d0[_0x4cd8d7(0x42b)](0x1f4)['json']({'error':_0x3012c9['message']}):_0x97e7a0[_0x4cd8d7(0x42b)](0x1f4)[_0x4cd8d7(0x1fc)]({'error':_0x59e5ca['message']});}}),app['delete'](_0x1ce9f3(0x374),async(_0xd27c5,_0x1c3d37)=>{const _0x561dca=_0x1ce9f3,_0x4b4182={'QFjHR':_0x561dca(0x22c)};if(!dbPool)try{return await deleteRow(_0x4b4182['QFjHR'],_0xd27c5[_0x561dca(0x48a)]['id']),_0x1c3d37['json']({'success':!![]});}catch(_0x3a6f4f){return _0x1c3d37['status'](0x1f4)['json']({'error':_0x3a6f4f[_0x561dca(0x359)]});}try{await dbPool['query'](_0x561dca(0x3e4),[_0xd27c5['params']['id']]),_0x1c3d37['json']({'success':!![]});}catch(_0x1b3745){_0x1c3d37['status'](0x1f4)['json']({'error':_0x1b3745['message']});}}),app['get'](_0x1ce9f3(0x452),async(_0x5854bc,_0x2a3159)=>{const _0x4e9212=_0x1ce9f3,_0x4d62b3={'mbjrq':_0x4e9212(0x1f1),'RDHos':_0x4e9212(0x368),'jTybg':_0x4e9212(0x3b7)};if(!dbPool)try{const {year:_0x16445c,department:_0x593418,status:_0x11f2ea,priority:_0xa1c5ff}=_0x5854bc[_0x4e9212(0x429)]||{};let _0x1f3b6d=await readTable(_0x4e9212(0x371));if(_0x16445c)_0x1f3b6d=_0x1f3b6d['filter'](_0x28a1f2=>Number(_0x28a1f2[_0x4e9212(0x2e9)])===Number(_0x16445c));if(_0x593418)_0x1f3b6d=_0x1f3b6d['filter'](_0x1f2008=>String(_0x1f2008[_0x4e9212(0x356)])===String(_0x593418));if(_0x11f2ea)_0x1f3b6d=_0x1f3b6d['filter'](_0x3a9671=>String(_0x3a9671[_0x4e9212(0x42b)])===String(_0x11f2ea));if(_0xa1c5ff)_0x1f3b6d=_0x1f3b6d['filter'](_0x39e279=>String(_0x39e279['priority'])===String(_0xa1c5ff));return _0x2a3159[_0x4e9212(0x1fc)](_0x1f3b6d);}catch(_0x3579eb){return _0x2a3159[_0x4e9212(0x42b)](0x1f4)['json']({'error':_0x3579eb[_0x4e9212(0x359)]});}try{const {year:_0x58b679,department:_0x107b64,status:_0x23baa0,priority:_0xddb1c1}=_0x5854bc[_0x4e9212(0x429)]||{},_0x5b2ee8=[],_0x37f926=[];_0x58b679&&(_0x5b2ee8['push']('year\x20=\x20?'),_0x37f926['push'](Number(_0x58b679)));_0x107b64&&(_0x5b2ee8[_0x4e9212(0x458)](_0x4d62b3['mbjrq']),_0x37f926[_0x4e9212(0x458)](String(_0x107b64)));_0x23baa0&&(_0x5b2ee8['push']('status\x20=\x20?'),_0x37f926[_0x4e9212(0x458)](String(_0x23baa0)));_0xddb1c1&&(_0x5b2ee8[_0x4e9212(0x458)](_0x4d62b3['RDHos']),_0x37f926[_0x4e9212(0x458)](String(_0xddb1c1)));const _0x44f288='SELECT\x20*\x20FROM\x20action_plans'+(_0x5b2ee8['length']?_0x4d62b3[_0x4e9212(0x2a5)]+_0x5b2ee8[_0x4e9212(0x209)]('\x20AND\x20'):'')+'\x20ORDER\x20BY\x20created_at\x20DESC',[_0x49629f]=await dbPool['query'](_0x44f288,_0x37f926);_0x2a3159['json'](_0x49629f);}catch(_0x49adf4){_0x2a3159['status'](0x1f4)[_0x4e9212(0x1fc)]({'error':_0x49adf4[_0x4e9212(0x359)]});}}),app[_0x1ce9f3(0x44b)](_0x1ce9f3(0x306),async(_0x5ae9fb,_0x480cdf)=>{const _0x74b5af=_0x1ce9f3,_0x3b90e7={'jrUFl':function(_0x16c4fc,_0x54afa4){return _0x16c4fc(_0x54afa4);},'FYVli':'annual_work_plans','irzER':_0x74b5af(0x211),'KysnZ':function(_0x52377c,_0x183f00){return _0x52377c!==_0x183f00;},'lPQZp':'CYjIy','WlWSl':_0x74b5af(0x1f8),'HzamF':_0x74b5af(0x203)};if(!dbPool)try{const {year:_0xef4d56,sheet_type:_0x23744b,month:_0xa51807}=_0x5ae9fb[_0x74b5af(0x429)]||{};let _0x40d056=await _0x3b90e7['jrUFl'](readTable,_0x3b90e7[_0x74b5af(0x34a)]);if(_0xef4d56)_0x40d056=_0x40d056['filter'](_0x538e82=>Number(_0x538e82[_0x74b5af(0x2e9)])===Number(_0xef4d56));if(_0x23744b)_0x40d056=_0x40d056['filter'](_0x2c32bb=>String(_0x2c32bb['sheet_type'])===String(_0x23744b));if(_0xa51807)_0x40d056=_0x40d056[_0x74b5af(0x2d9)](_0x500ede=>Number(_0x500ede[_0x74b5af(0x36c)])===Number(_0xa51807));return _0x480cdf['json'](_0x40d056);}catch(_0x2b043d){return _0x480cdf['status'](0x1f4)[_0x74b5af(0x1fc)]({'error':_0x2b043d[_0x74b5af(0x359)]});}try{const {year:_0x40069b,sheet_type:_0x3d2483,month:_0x331c93}=_0x5ae9fb[_0x74b5af(0x429)]||{},_0x24c0cb=[],_0x3966d7=[];_0x40069b&&(_0x24c0cb[_0x74b5af(0x458)](_0x3b90e7[_0x74b5af(0x47f)]),_0x3966d7[_0x74b5af(0x458)](Number(_0x40069b)));if(_0x3d2483){if(_0x3b90e7['KysnZ'](_0x3b90e7['lPQZp'],_0x3b90e7['lPQZp']))return _0x38d9c2['status'](0x190)[_0x74b5af(0x1fc)]({'error':_0x74b5af(0x41a)});else _0x24c0cb[_0x74b5af(0x458)]('sheet_type\x20=\x20?'),_0x3966d7[_0x74b5af(0x458)](_0x3b90e7[_0x74b5af(0x299)](String,_0x3d2483));}_0x331c93&&(_0x24c0cb['push'](_0x3b90e7['WlWSl']),_0x3966d7[_0x74b5af(0x458)](Number(_0x331c93)));const _0x2287a='SELECT\x20*\x20FROM\x20annual_work_plans'+(_0x24c0cb['length']?'\x20WHERE\x20'+_0x24c0cb[_0x74b5af(0x209)](_0x3b90e7['HzamF']):'')+'\x20ORDER\x20BY\x20created_at\x20DESC',[_0x2bee16]=await dbPool[_0x74b5af(0x429)](_0x2287a,_0x3966d7);_0x480cdf[_0x74b5af(0x1fc)](_0x2bee16);}catch(_0x33e645){_0x480cdf[_0x74b5af(0x42b)](0x1f4)[_0x74b5af(0x1fc)]({'error':_0x33e645['message']});}}),app[_0x1ce9f3(0x2c1)]('/api/annual-work-plans',async(_0x4a81c8,_0x1c0199)=>{const _0x3aab54=_0x1ce9f3,_0x58d31b={'JzftJ':'year','EqLzV':'plan_name','mpJPn':'start_date','ftQOe':_0x3aab54(0x22a),'bVtJl':_0x3aab54(0x42b),'VepfU':'goals','WXhwd':_0x3aab54(0x43f),'xkPOO':'responsible','vGFNW':_0x3aab54(0x208),'JYtUj':'Insert\x20annual_work_plans\x20failed:'};if(!dbPool)try{const _0x5b2aba=await addRow('annual_work_plans',_0x4a81c8[_0x3aab54(0x444)]||{});return _0x1c0199['status'](0xc9)['json'](_0x5b2aba);}catch(_0x2ac048){return _0x1c0199[_0x3aab54(0x42b)](0x1f4)[_0x3aab54(0x1fc)]({'error':_0x2ac048[_0x3aab54(0x359)]});}try{const _0x2a58e7=_0x4a81c8[_0x3aab54(0x444)]||{},_0xd6b47=['sheet_type',_0x58d31b['JzftJ'],_0x3aab54(0x36c),_0x3aab54(0x2e4),'department_name',_0x58d31b['EqLzV'],'category','priority',_0x58d31b[_0x3aab54(0x47b)],_0x3aab54(0x41b),_0x58d31b['ftQOe'],_0x58d31b['bVtJl'],'responsible_person',_0x3aab54(0x300),_0x58d31b['VepfU'],'tasks','resources',_0x58d31b['WXhwd'],_0x58d31b[_0x3aab54(0x390)],'notes',_0x58d31b[_0x3aab54(0x3a4)],_0x3aab54(0x463)],_0xde18f8=Object[_0x3aab54(0x343)](_0x2a58e7)['filter'](_0xf2965b=>_0xd6b47['includes'](_0xf2965b));if(!_0xde18f8[_0x3aab54(0x43c)])return _0x1c0199[_0x3aab54(0x42b)](0x190)[_0x3aab54(0x1fc)]({'error':'No\x20valid\x20data\x20provided'});const _0x3f7675=_0xde18f8[_0x3aab54(0x377)](_0x3c7c03=>_0x2a58e7[_0x3c7c03]),_0x278396='INSERT\x20INTO\x20annual_work_plans\x20(`'+_0xde18f8['join']('`,`')+_0x3aab54(0x225)+_0xde18f8['map'](()=>'?')['join'](',')+')',[_0x4b178e]=await dbPool[_0x3aab54(0x429)](_0x278396,_0x3f7675);_0x1c0199[_0x3aab54(0x42b)](0xc9)[_0x3aab54(0x1fc)]({'id':_0x4b178e[_0x3aab54(0x361)],..._0x2a58e7});}catch(_0x46e50f){console[_0x3aab54(0x3ee)](_0x58d31b['JYtUj'],_0x46e50f),_0x1c0199['status'](0x1f4)[_0x3aab54(0x1fc)]({'error':_0x46e50f[_0x3aab54(0x359)]});}}),app[_0x1ce9f3(0x42e)]('/api/annual-work-plans/:id',async(_0x6e298c,_0x40b753)=>{const _0x6b607=_0x1ce9f3,_0x1c62ec={'lHAPk':_0x6b607(0x457),'nXkqN':'status','FqxHp':'responsible_person','iEDTg':'theme','czqaB':'resources','hYIGw':'responsible','ItiOx':function(_0x3422a5,_0x929bed,_0x4e552d){return _0x3422a5(_0x929bed,_0x4e552d);}};if(!dbPool){if('SrScT'==='YurHc'){const _0x198a10=_0x356299[_0x6b607(0x44b)](_0x12f587)||{};_0x211f43[_0x6b607(0x409)](_0x25c467,{..._0x198a10,'employee_id':_0x24fcbc,'name':_0xc5a0f4['name']||_0x5651ce[_0x6b607(0x42f)]||_0x5be46f[_0x6b607(0x432)]||_0x198a10[_0x6b607(0x419)]||'','department':_0x2c3c69[_0x6b607(0x356)]||_0x109822[_0x6b607(0x245)]||_0x198a10['department']||'','position':_0x2982a7[_0x6b607(0x3b6)]||_0x198a10['position']||'','phone':_0x252242['phone']||_0x47672f[_0x6b607(0x2d0)]||_0x198a10[_0x6b607(0x2fa)]||'','email':_0x12dfcb['email']||_0x198a10['email']||'','status':_0x1c7e63['status']||_0x198a10[_0x6b607(0x42b)]||'active','created_at':_0x198a10[_0x6b607(0x29f)]||new _0x5cbd6c()['toISOString']()});}else try{return await updateRow(_0x6b607(0x20a),_0x6e298c[_0x6b607(0x48a)]['id'],_0x6e298c[_0x6b607(0x444)]||{}),_0x40b753[_0x6b607(0x1fc)]({'success':!![]});}catch(_0x1ebd45){return _0x40b753['status'](0x1f4)[_0x6b607(0x1fc)]({'error':_0x1ebd45[_0x6b607(0x359)]});}}try{const _0x1bba72=[_0x6b607(0x279),'year',_0x6b607(0x36c),_0x6b607(0x2e4),'department_name',_0x6b607(0x35d),_0x6b607(0x49e),_0x1c62ec[_0x6b607(0x420)],'start_date','end_date','budget',_0x1c62ec[_0x6b607(0x410)],_0x1c62ec[_0x6b607(0x353)],_0x1c62ec['iEDTg'],_0x6b607(0x2e5),_0x6b607(0x496),_0x1c62ec['czqaB'],'timeline',_0x1c62ec['hYIGw'],_0x6b607(0x31d),'expected_result','actual_result'],{setSql:_0x175f90,values:_0x40d046}=_0x1c62ec[_0x6b607(0x336)](buildSafeUpdate,_0x6e298c[_0x6b607(0x444)]||{},_0x1bba72);if(!_0x175f90)return _0x40b753['json']({'success':!![]});await dbPool[_0x6b607(0x429)]('UPDATE\x20annual_work_plans\x20SET\x20'+_0x175f90+'\x20WHERE\x20id=?',[..._0x40d046,_0x6e298c[_0x6b607(0x48a)]['id']]),_0x40b753['json']({'success':!![]});}catch(_0x462f67){console['error'](_0x6b607(0x3c5),_0x462f67),_0x40b753['status'](0x1f4)['json']({'error':_0x462f67[_0x6b607(0x359)]});}}),app['delete'](_0x1ce9f3(0x3f3),async(_0x5bcd6b,_0x5ddee3)=>{const _0x58f36c=_0x1ce9f3,_0x18216f={'NwbFT':function(_0x54ff0e,_0x431d6f){return _0x54ff0e===_0x431d6f;},'kBJqP':'zUqXn'};if(!dbPool)try{if(_0x18216f['NwbFT']('bWwOb',_0x18216f['kBJqP'])){if(_0x427cc2['code']==='ER_DUP_ENTRY')return _0x4b4094[_0x58f36c(0x42b)](0x190)[_0x58f36c(0x1fc)]({'error':_0x58f36c(0x1d6)});_0x47f5e9[_0x58f36c(0x42b)](0x1f4)[_0x58f36c(0x1fc)]({'error':_0x423a9e[_0x58f36c(0x359)]});}else return await deleteRow(_0x58f36c(0x20a),_0x5bcd6b[_0x58f36c(0x48a)]['id']),_0x5ddee3[_0x58f36c(0x1fc)]({'success':!![]});}catch(_0xf6ef47){return _0x5ddee3[_0x58f36c(0x42b)](0x1f4)[_0x58f36c(0x1fc)]({'error':_0xf6ef47['message']});}try{await dbPool['query'](_0x58f36c(0x439),[_0x5bcd6b['params']['id']]),_0x5ddee3[_0x58f36c(0x1fc)]({'success':!![]});}catch(_0x5db07b){_0x5ddee3['status'](0x1f4)[_0x58f36c(0x1fc)]({'error':_0x5db07b['message']});}}),app['get']('/api/major-events',async(_0x39cc22,_0x551e62)=>{const _0x3adf6a=_0x1ce9f3,_0x54d608={'QEZLw':'major_events','rEBMB':function(_0x3115da,_0x55d5f3){return _0x3115da===_0x55d5f3;},'PeVDy':'\x20WHERE\x20','ljbjC':_0x3adf6a(0x203)};if(!dbPool)try{const {year:_0xa22ef0}=_0x39cc22['query']||{};let _0x4fcc1b=await readTable(_0x54d608['QEZLw']);if(_0xa22ef0)_0x4fcc1b=_0x4fcc1b[_0x3adf6a(0x2d9)](_0x1418cc=>Number(_0x1418cc[_0x3adf6a(0x2e9)])===Number(_0xa22ef0));return _0x551e62['json'](_0x4fcc1b);}catch(_0x30911a){if(_0x54d608[_0x3adf6a(0x3b3)]('qsJex',_0x3adf6a(0x3ac)))return _0x551e62['status'](0x1f4)['json']({'error':_0x30911a['message']});else _0x1a2fb1[_0x3adf6a(0x42b)](0x1f4)['json']({'error':_0x546fb7['message']});}try{const {year:_0x3ae917}=_0x39cc22[_0x3adf6a(0x429)]||{},_0x33f374=[],_0x47a3af=[];_0x3ae917&&(_0x33f374['push'](_0x3adf6a(0x211)),_0x47a3af['push'](Number(_0x3ae917)));const _0x155301='SELECT\x20*\x20FROM\x20major_events'+(_0x33f374[_0x3adf6a(0x43c)]?_0x54d608[_0x3adf6a(0x260)]+_0x33f374[_0x3adf6a(0x209)](_0x54d608[_0x3adf6a(0x282)]):'')+'\x20ORDER\x20BY\x20created_at\x20DESC',[_0x26a398]=await dbPool['query'](_0x155301,_0x47a3af);_0x551e62['json'](_0x26a398);}catch(_0x4ea140){_0x551e62['status'](0x1f4)['json']({'error':_0x4ea140[_0x3adf6a(0x359)]});}}),app['post']('/api/major-events',async(_0x58ccbb,_0x15e041)=>{const _0x183898=_0x1ce9f3,_0x2a687d={'JgbRE':'year','ZZyGy':'event_name','fmPQT':_0x183898(0x30c),'zXuOq':_0x183898(0x33f),'NYDAQ':'department_id','YVRqU':'responsible_person','zSMme':_0x183898(0x20c),'cQRPs':_0x183898(0x2f9),'HxNzn':'success_criteria','fhVJf':_0x183898(0x37f)};if(!dbPool)try{const _0x3cb217=_0x58ccbb[_0x183898(0x444)]||{},_0x31d467=[_0x2a687d[_0x183898(0x1e1)],_0x2a687d[_0x183898(0x2d8)]],_0x971ea4=_0x31d467[_0x183898(0x2d9)](_0x28b2fb=>!_0x3cb217[_0x28b2fb]&&_0x3cb217[_0x28b2fb]!==0x0);if(_0x971ea4[_0x183898(0x43c)])return _0x15e041[_0x183898(0x42b)](0x190)['json']({'error':'缺少必填项:\x20'+_0x971ea4[_0x183898(0x209)](',\x20')});const _0x47654f=await addRow(_0x183898(0x335),_0x3cb217);return _0x15e041[_0x183898(0x42b)](0xc9)['json'](_0x47654f);}catch(_0x298ffe){return _0x15e041[_0x183898(0x42b)](0x1f4)[_0x183898(0x1fc)]({'error':_0x298ffe['message']});}try{const _0x59c7d6=_0x58ccbb['body']||{},_0x50e1af=['year',_0x183898(0x2e7),_0x183898(0x2b5),_0x2a687d[_0x183898(0x488)],'planned_date',_0x2a687d['zXuOq'],_0x2a687d['NYDAQ'],_0x183898(0x3af),_0x2a687d['YVRqU'],_0x183898(0x42b),'budget',_0x2a687d['zSMme'],'description',_0x2a687d['cQRPs'],_0x2a687d[_0x183898(0x22e)],_0x183898(0x1e8),'lessons_learned'],_0x5ee39d=_0x50e1af['map'](_0x6cc1f1=>_0x59c7d6[_0x6cc1f1]??null),_0x4f9010=_0x50e1af[_0x183898(0x377)](()=>'?')[_0x183898(0x209)](',');console['log'](_0x183898(0x365),_0x50e1af);const [_0x5cd9a2]=await dbPool[_0x183898(0x429)]('INSERT\x20INTO\x20major_events\x20(`'+_0x50e1af[_0x183898(0x209)]('`,`')+_0x183898(0x225)+_0x4f9010+')',_0x5ee39d);_0x15e041[_0x183898(0x42b)](0xc9)[_0x183898(0x1fc)]({'id':_0x5cd9a2['insertId'],..._0x59c7d6});}catch(_0x27ff63){console[_0x183898(0x3ee)](_0x2a687d[_0x183898(0x2dc)],_0x27ff63),_0x15e041[_0x183898(0x42b)](0x1f4)[_0x183898(0x1fc)]({'error':_0x27ff63['message']});}}),app['put'](_0x1ce9f3(0x418),async(_0x4d2ff6,_0x3e6a1f)=>{const _0x2f4632=_0x1ce9f3,_0x11e15e={'EsKVL':function(_0x15135c,_0xa74e2a,_0x28b658,_0xf75af2){return _0x15135c(_0xa74e2a,_0x28b658,_0xf75af2);},'DRCOx':'planned_date','bMFcl':_0x2f4632(0x2e4),'zEyWu':'responsible_department','LMvLB':_0x2f4632(0x42b),'KPoNn':'description','VSIkv':function(_0x177042,_0x43b487,_0x4c09dd){return _0x177042(_0x43b487,_0x4c09dd);},'MkDIX':_0x2f4632(0x2aa)};if(!dbPool)try{return await _0x11e15e['EsKVL'](updateRow,_0x2f4632(0x335),_0x4d2ff6['params']['id'],_0x4d2ff6[_0x2f4632(0x444)]||{}),_0x3e6a1f[_0x2f4632(0x1fc)]({'success':!![]});}catch(_0x1fe827){return _0x3e6a1f[_0x2f4632(0x42b)](0x1f4)['json']({'error':_0x1fe827['message']});}try{const _0x502b9c=[_0x2f4632(0x2e9),_0x2f4632(0x2e7),'event_type','importance',_0x11e15e[_0x2f4632(0x417)],_0x2f4632(0x33f),_0x11e15e[_0x2f4632(0x443)],_0x11e15e['zEyWu'],_0x2f4632(0x251),_0x11e15e['LMvLB'],'budget','actual_cost',_0x11e15e['KPoNn'],'key_points','success_criteria','risks',_0x2f4632(0x345)],{setSql:_0x1af726,values:_0x481faa}=_0x11e15e[_0x2f4632(0x32f)](buildSafeUpdate,_0x4d2ff6['body']||{},_0x502b9c);if(!_0x1af726)return _0x3e6a1f[_0x2f4632(0x1fc)]({'success':!![]});console['log'](_0x11e15e['MkDIX'],_0x4d2ff6[_0x2f4632(0x48a)]['id'],_0x1af726),await dbPool['query']('UPDATE\x20major_events\x20SET\x20'+_0x1af726+_0x2f4632(0x2b9),[..._0x481faa,_0x4d2ff6[_0x2f4632(0x48a)]['id']]),_0x3e6a1f[_0x2f4632(0x1fc)]({'success':!![]});}catch(_0x408445){console[_0x2f4632(0x3ee)](_0x2f4632(0x1d9),_0x408445),_0x3e6a1f['status'](0x1f4)[_0x2f4632(0x1fc)]({'error':_0x408445[_0x2f4632(0x359)]});}}),app['delete']('/api/major-events/:id',async(_0x331572,_0x575097)=>{const _0x1ab982=_0x1ce9f3,_0xb052dc={'QIANb':_0x1ab982(0x335)};if(!dbPool)try{return await deleteRow(_0xb052dc['QIANb'],_0x331572[_0x1ab982(0x48a)]['id']),_0x575097['json']({'success':!![]});}catch(_0x457aa1){return _0x575097['status'](0x1f4)['json']({'error':_0x457aa1['message']});}try{await dbPool['query']('DELETE\x20FROM\x20major_events\x20WHERE\x20id=?',[_0x331572['params']['id']]),_0x575097[_0x1ab982(0x1fc)]({'success':!![]});}catch(_0x4302e3){_0x575097['status'](0x1f4)['json']({'error':_0x4302e3[_0x1ab982(0x359)]});}}),app[_0x1ce9f3(0x2c1)]('/api/action-plans',async(_0x1d977f,_0x30412b)=>{const _0x2698dc=_0x1ce9f3,_0x12d16f={'sSERa':'/uploads','GpoPp':function(_0x244ed0,_0x118552){return _0x244ed0===_0x118552;},'lguQH':_0x2698dc(0x253),'vSvKI':'/api/templates','DFRlV':'authorization','meVoQ':function(_0x35c932){return _0x35c932();},'ZyiHX':'令牌无效或已过期','hxGnC':'when','tJwSb':_0x2698dc(0x2e9),'NdEGg':_0x2698dc(0x498),'LFRvu':_0x2698dc(0x1de),'aNNqW':_0x2698dc(0x2a7),'QZXbc':'who','rzwoP':'how_much','hBWMC':'status','XaJnc':'remarks','mwzQp':function(_0x3dde68,_0x4c34ec,_0x5af6d2){return _0x3dde68(_0x4c34ec,_0x5af6d2);},'vMoYR':_0x2698dc(0x371),'xOuRn':'department','yPpBt':_0x2698dc(0x446),'NuyDU':'`,`'};if(!dbPool)try{const _0xd7fc86=_0x1d977f[_0x2698dc(0x444)]||{},_0x59dc9b=[_0x2698dc(0x2e9),_0x2698dc(0x498),_0x2698dc(0x1de),_0x2698dc(0x2fe),_0x12d16f[_0x2698dc(0x46b)],'department'],_0x30f8da=_0x59dc9b['filter'](_0x291051=>!_0xd7fc86[_0x291051]&&_0xd7fc86[_0x291051]!==0x0);if(_0x30f8da['length']){if('TWDwN'!==_0x2698dc(0x22f))return _0x30412b['status'](0x190)[_0x2698dc(0x1fc)]({'error':_0x2698dc(0x213)+_0x30f8da['join'](',\x20')});else{const _0x5773c0=_0x1f1592[_0x2698dc(0x275)][_0x2698dc(0x369)](/\/+$/,'');if(_0x373d57[_0x2698dc(0x287)](_0x5773c0)||_0x5773c0===_0x2698dc(0x403)||_0x5773c0[_0x2698dc(0x486)]('/api/login')||_0x1e377c['path'][_0x2698dc(0x486)](_0x12d16f[_0x2698dc(0x2ed)])||_0x39548f['path'][_0x2698dc(0x486)](_0x2698dc(0x46e))||_0x12d16f[_0x2698dc(0x207)](_0x5bd96c['method'],_0x12d16f['lguQH'])&&_0x12d16f['GpoPp'](_0x5773c0,_0x12d16f[_0x2698dc(0x45e)]))return _0x2c24a9();const _0x54510a=_0x22a8eb['headers'][_0x12d16f[_0x2698dc(0x27b)]]||'',_0xe27814=_0x54510a[_0x2698dc(0x31c)](/^Bearer\s+(.+)$/);if(!_0xe27814)return _0x1f1f84[_0x2698dc(0x49f)](_0x2698dc(0x39d)+_0x584030['path']+_0x2698dc(0x33a)),_0x3601db[_0x2698dc(0x42b)](0x191)[_0x2698dc(0x1fc)]({'error':_0x2698dc(0x1dd)});try{const _0x43d993=_0x384a00['verify'](_0xe27814[0x1],_0x2ee9c4);return _0x786d64[_0x2698dc(0x293)]=_0x43d993,_0x12d16f[_0x2698dc(0x291)](_0x2bf805);}catch(_0x355ab4){return _0x25d2bc[_0x2698dc(0x49f)]('[Auth]\x20Blocked\x20request\x20to\x20'+_0x7785db[_0x2698dc(0x275)]+'\x20-\x20Invalid\x20token:\x20'+_0x355ab4['message']),_0x234cad['status'](0x191)['json']({'error':_0x12d16f['ZyiHX']});}}}const _0x4fed0a=[_0x12d16f[_0x2698dc(0x3dd)],_0x12d16f['NdEGg'],_0x12d16f[_0x2698dc(0x1e9)],_0x12d16f[_0x2698dc(0x283)],_0x12d16f[_0x2698dc(0x1d1)],_0x2698dc(0x49c),'how',_0x12d16f[_0x2698dc(0x3bc)],'department','priority',_0x12d16f[_0x2698dc(0x35b)],_0x2698dc(0x446),_0x2698dc(0x208),'actual_result',_0x12d16f['XaJnc']],_0x4e8213={};_0x4fed0a[_0x2698dc(0x3aa)](_0x5c6784=>_0x4e8213[_0x5c6784]=_0xd7fc86[_0x5c6784]??null);const _0x264b09=await _0x12d16f['mwzQp'](addRow,_0x12d16f['vMoYR'],_0x4e8213);return _0x30412b[_0x2698dc(0x42b)](0xc9)[_0x2698dc(0x1fc)](_0x264b09);}catch(_0x5cd42a){return _0x30412b[_0x2698dc(0x42b)](0x1f4)[_0x2698dc(0x1fc)]({'error':_0x5cd42a[_0x2698dc(0x359)]});}try{const _0x1dd3d3=_0x1d977f['body']||{},_0x245eb6=[_0x2698dc(0x2e9),_0x2698dc(0x498),'what','who','when',_0x12d16f[_0x2698dc(0x317)]],_0x24e0bb=_0x245eb6['filter'](_0x5d64c0=>!_0x1dd3d3[_0x5d64c0]&&_0x1dd3d3[_0x5d64c0]!==0x0);if(_0x24e0bb['length'])return _0x30412b[_0x2698dc(0x42b)](0x190)['json']({'error':'缺少必填项:\x20'+_0x24e0bb['join'](',\x20')});const _0x14eba0=[_0x2698dc(0x2e9),_0x2698dc(0x498),'what',_0x12d16f[_0x2698dc(0x283)],'who',_0x12d16f[_0x2698dc(0x46b)],_0x2698dc(0x3fa),_0x12d16f['rzwoP'],_0x12d16f['xOuRn'],'priority','status',_0x12d16f['yPpBt'],_0x2698dc(0x208),_0x2698dc(0x463),_0x2698dc(0x20b)],_0x6d819b=_0x14eba0[_0x2698dc(0x377)](_0x22a7cc=>_0x1dd3d3[_0x22a7cc]??null),_0x1fee50=_0x14eba0[_0x2698dc(0x377)](()=>'?')['join'](','),[_0x435cba]=await dbPool[_0x2698dc(0x429)](_0x2698dc(0x326)+_0x14eba0['join'](_0x12d16f[_0x2698dc(0x405)])+_0x2698dc(0x225)+_0x1fee50+')',_0x6d819b);_0x30412b[_0x2698dc(0x42b)](0xc9)['json']({'id':_0x435cba['insertId'],..._0x1dd3d3});}catch(_0x4af186){_0x30412b[_0x2698dc(0x42b)](0x1f4)['json']({'error':_0x4af186['message']});}}),app['put'](_0x1ce9f3(0x271),async(_0x4563ba,_0x5a417d)=>{const _0x2c75bf=_0x1ce9f3,_0x2735c4={'rbxAz':_0x2c75bf(0x371),'PIvio':'what','SHvIz':_0x2c75bf(0x457),'mBqsd':'expected_result','juYFv':_0x2c75bf(0x463),'fOvFU':function(_0x50510c,_0x2d0398,_0x25702c){return _0x50510c(_0x2d0398,_0x25702c);}};if(!dbPool)try{return await updateRow(_0x2735c4['rbxAz'],_0x4563ba[_0x2c75bf(0x48a)]['id'],_0x4563ba['body']||{}),_0x5a417d[_0x2c75bf(0x1fc)]({'success':!![]});}catch(_0x497de3){return _0x5a417d['status'](0x1f4)[_0x2c75bf(0x1fc)]({'error':_0x497de3['message']});}try{const _0x502b6e=['year','goal',_0x2735c4['PIvio'],_0x2c75bf(0x2a7),'who','when','how',_0x2c75bf(0x451),_0x2c75bf(0x356),_0x2735c4['SHvIz'],'status',_0x2c75bf(0x446),_0x2735c4['mBqsd'],_0x2735c4['juYFv'],_0x2c75bf(0x20b)],{setSql:_0x3526aa,values:_0x5bafdf}=_0x2735c4[_0x2c75bf(0x35a)](buildSafeUpdate,_0x4563ba[_0x2c75bf(0x444)]||{},_0x502b6e);if(!_0x3526aa)return _0x5a417d[_0x2c75bf(0x1fc)]({'success':!![]});await dbPool['query']('UPDATE\x20action_plans\x20SET\x20'+_0x3526aa+_0x2c75bf(0x2b9),[..._0x5bafdf,_0x4563ba[_0x2c75bf(0x48a)]['id']]),_0x5a417d['json']({'success':!![]});}catch(_0x5633c3){_0x5a417d[_0x2c75bf(0x42b)](0x1f4)['json']({'error':_0x5633c3[_0x2c75bf(0x359)]});}}),app[_0x1ce9f3(0x1f0)](_0x1ce9f3(0x271),async(_0xf71be9,_0x11d111)=>{const _0x2a827e=_0x1ce9f3,_0x4dc7ae={'cnHgb':_0x2a827e(0x371)};if(!dbPool)try{return await deleteRow(_0x4dc7ae['cnHgb'],_0xf71be9[_0x2a827e(0x48a)]['id']),_0x11d111[_0x2a827e(0x1fc)]({'success':!![]});}catch(_0x332a8c){return _0x11d111['status'](0x1f4)[_0x2a827e(0x1fc)]({'error':_0x332a8c[_0x2a827e(0x359)]});}try{await dbPool[_0x2a827e(0x429)]('DELETE\x20FROM\x20action_plans\x20WHERE\x20id=?',[_0xf71be9['params']['id']]),_0x11d111[_0x2a827e(0x1fc)]({'success':!![]});}catch(_0x497cc0){_0x11d111['status'](0x1f4)['json']({'error':_0x497cc0[_0x2a827e(0x359)]});}});const DB_ENABLED=process['env']['DB_ENABLED']==='true';let dbPool=null;async function initDB(){const _0x2d5a2d=_0x1ce9f3,_0xdd9291={'MuHVo':function(_0x4fa810,_0x51217e){return _0x4fa810||_0x51217e;},'DVZwB':_0x2d5a2d(0x37b),'KMqbp':function(_0x3e7c59,_0x32d9a4){return _0x3e7c59(_0x32d9a4);},'xFYvT':'planning_system','UtnQS':'ALTER\x20TABLE\x20department_targets\x20MODIFY\x20quarter\x20VARCHAR(16)\x20NULL','tWdny':'ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20actual_date\x20VARCHAR(32)\x20NULL','PKIfJ':'ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20actual_cost\x20DECIMAL(14,2)\x20NULL','JKQTA':'ALTER\x20TABLE\x20templates\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','xGUwg':'ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20notes\x20TEXT\x20NULL','RnFUH':function(_0x211e8b,_0x99c808){return _0x211e8b!==_0x99c808;},'ygSwy':'Bxvtq','fJAPS':_0x2d5a2d(0x2b0)};if(!DB_ENABLED)return;const _0x1b8087=process['env'][_0x2d5a2d(0x346)]||_0xdd9291['DVZwB'],_0x46dbac=process[_0x2d5a2d(0x244)]['DB_USER']||_0x2d5a2d(0x484),_0x1e3834=process['env'][_0x2d5a2d(0x352)]||'',_0x306a08=_0xdd9291[_0x2d5a2d(0x3d3)](Number,process[_0x2d5a2d(0x244)][_0x2d5a2d(0x2f5)]||0xcea),_0x83ec80=process['env'][_0x2d5a2d(0x470)]||_0xdd9291[_0x2d5a2d(0x2e3)];try{const _0x65e9c3=await mysql[_0x2d5a2d(0x28e)]({'host':_0x1b8087,'user':_0x46dbac,'password':_0x1e3834,'port':_0x306a08});try{await _0x65e9c3[_0x2d5a2d(0x429)]('CREATE\x20DATABASE\x20IF\x20NOT\x20EXISTS\x20`'+_0x83ec80+'`');}catch(_0x4a3ceb){}await _0x65e9c3[_0x2d5a2d(0x272)]();}catch(_0x3480ec){throw _0x3480ec;}dbPool=await mysql[_0x2d5a2d(0x2fb)]({'host':_0x1b8087,'user':_0x46dbac,'password':_0x1e3834,'port':_0x306a08,'database':_0x83ec80,'waitForConnections':!![],'connectionLimit':0xa,'queueLimit':0x0}),await dbPool[_0x2d5a2d(0x429)]('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20annual_work_plans\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20sheet_type\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20year\x20INT,\x0a\x20\x20\x20\x20month\x20INT\x20NULL,\x0a\x20\x20\x20\x20department_id\x20INT\x20NULL,\x0a\x20\x20\x20\x20department_name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20plan_name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20category\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20priority\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20start_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20end_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20budget\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20responsible_person\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool[_0x2d5a2d(0x429)](_0x2d5a2d(0x259)),await dbPool['query'](_0x2d5a2d(0x442)),await dbPool['query']('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20major_events\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20year\x20INT,\x0a\x20\x20\x20\x20event_name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20event_type\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20importance\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20planned_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20actual_date\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20department_id\x20INT\x20NULL,\x0a\x20\x20\x20\x20responsible_department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20responsible_person\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20budget\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20actual_cost\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20key_points\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20success_criteria\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20risks\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20lessons_learned\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool[_0x2d5a2d(0x429)](_0x2d5a2d(0x40d)),await dbPool['query']('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20department_targets\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20year\x20INT,\x0a\x20\x20\x20\x20department_id\x20INT\x20NULL,\x0a\x20\x20\x20\x20department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20target_level\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20target_type\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20target_name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20target_value\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20unit\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20quarter\x20VARCHAR(16)\x20NULL,\x0a\x20\x20\x20\x20month\x20INT\x20NULL,\x0a\x20\x20\x20\x20current_value\x20DECIMAL(14,2)\x20NULL,\x0a\x20\x20\x20\x20completion_rate\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20responsible_person\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)');try{await dbPool[_0x2d5a2d(0x429)]('ALTER\x20TABLE\x20department_targets\x20ADD\x20COLUMN\x20completion_rate\x20VARCHAR(32)\x20NULL');}catch(_0x3c3daf){}try{await dbPool['query'](_0xdd9291['UtnQS']);}catch(_0x2980ab){}await dbPool['query'](_0x2d5a2d(0x358)),await dbPool[_0x2d5a2d(0x429)](_0x2d5a2d(0x1d0)),await dbPool['query']('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20notifications\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20type\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20title\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20message\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20published_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20`read`\x20TINYINT(1)\x20DEFAULT\x200\x0a\x20\x20)'),await dbPool[_0x2d5a2d(0x429)]('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20target_types\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20description\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20color\x20VARCHAR(32)\x20NULL,\x0a\x20\x20\x20\x20icon\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20category\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20isActive\x20TINYINT(1)\x20DEFAULT\x201,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool[_0x2d5a2d(0x429)](_0x2d5a2d(0x28f));try{await dbPool['query']('ALTER\x20TABLE\x20departments\x20MODIFY\x20id\x20BIGINT\x20PRIMARY\x20KEY');}catch(_0x409344){}try{await dbPool[_0x2d5a2d(0x429)](_0x2d5a2d(0x221));}catch(_0x1ea26f){}await dbPool['query']('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20employees\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20employee_id\x20VARCHAR(64)\x20UNIQUE,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20position\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20phone\x20VARCHAR(64)\x20NULL,\x0a\x20\x20\x20\x20email\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20DEFAULT\x20\x27active\x27,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool[_0x2d5a2d(0x429)]('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20system_settings\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20`key`\x20VARCHAR(128)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20value\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool['query'](_0x2d5a2d(0x2c5)),await dbPool[_0x2d5a2d(0x429)]('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20users\x20(\x0a\x20\x20\x20\x20id\x20INT\x20AUTO_INCREMENT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20username\x20VARCHAR(64)\x20NOT\x20NULL\x20UNIQUE,\x0a\x20\x20\x20\x20password\x20VARCHAR(255)\x20NOT\x20NULL,\x0a\x20\x20\x20\x20name\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20email\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20role\x20VARCHAR(64)\x20DEFAULT\x20\x27user\x27,\x0a\x20\x20\x20\x20department\x20VARCHAR(255)\x20NULL,\x0a\x20\x20\x20\x20permissions\x20TEXT\x20NULL,\x0a\x20\x20\x20\x20status\x20VARCHAR(32)\x20DEFAULT\x20\x27active\x27,\x0a\x20\x20\x20\x20created_at\x20TIMESTAMP\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20)'),await dbPool[_0x2d5a2d(0x429)](_0x2d5a2d(0x372));const _0x1f80d8=['ALTER\x20TABLE\x20departments\x20ADD\x20COLUMN\x20type\x20VARCHAR(32)\x20DEFAULT\x20\x27DEPT\x27',_0x2d5a2d(0x3a2),'ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','ALTER\x20TABLE\x20audit_logs\x20ADD\x20COLUMN\x20operation\x20VARCHAR(512)\x20NULL',_0xdd9291['tWdny'],_0xdd9291['PKIfJ'],'ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20key_points\x20TEXT\x20NULL','ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20success_criteria\x20TEXT\x20NULL','ALTER\x20TABLE\x20major_events\x20ADD\x20COLUMN\x20risks\x20TEXT\x20NULL',_0x2d5a2d(0x23f),_0x2d5a2d(0x325),_0xdd9291['JKQTA'],'ALTER\x20TABLE\x20company_info\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','ALTER\x20TABLE\x20target_types\x20ADD\x20COLUMN\x20description\x20TEXT\x20NULL','ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20theme\x20VARCHAR(255)\x20NULL','ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20goals\x20TEXT\x20NULL','ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20tasks\x20TEXT\x20NULL','ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20resources\x20TEXT\x20NULL','ALTER\x20TABLE\x20annual_work_plans\x20ADD\x20COLUMN\x20timeline\x20VARCHAR(255)\x20NULL',_0x2d5a2d(0x3e9),_0xdd9291['xGUwg']];for(const _0x59a84c of _0x1f80d8){if(_0xdd9291['RnFUH'](_0xdd9291[_0x2d5a2d(0x48d)],_0x2d5a2d(0x1eb)))_0x338000=_0x722829['parse'](_0xdd9291[_0x2d5a2d(0x30e)](_0x420379,'{}'));else try{await dbPool[_0x2d5a2d(0x429)](_0x59a84c);}catch(_0x50f730){if(_0x50f730[_0x2d5a2d(0x43d)]!==_0xdd9291['fJAPS']&&_0x50f730[_0x2d5a2d(0x47c)]!==0x424){if(_0x2d5a2d(0x370)==='wGHav')console['error'](_0x2d5a2d(0x482),_0x50f730[_0x2d5a2d(0x359)],'Query:',_0x59a84c);else return _0x19a4a0[_0x2d5a2d(0x42b)](0x1f4)[_0x2d5a2d(0x1fc)]({'error':_0x566f63[_0x2d5a2d(0x359)]});}}}}function buildSafeUpdate(_0x46ce86,_0xe25553){const _0x3f0add=_0x1ce9f3,_0x46c714=Object[_0x3f0add(0x343)](_0x46ce86)['filter'](_0x1f7176=>_0xe25553['includes'](_0x1f7176));if(!_0x46c714[_0x3f0add(0x43c)])return{'setSql':'','values':[]};const _0x1b123a=_0x46c714[_0x3f0add(0x377)](_0x391897=>'`'+_0x391897+_0x3f0add(0x252))['join'](',\x20'),_0x5938da=_0x46c714[_0x3f0add(0x377)](_0x1e6f77=>_0x46ce86[_0x1e6f77]);return{'setSql':_0x1b123a,'values':_0x5938da};}async function getDingTalkAccessToken(){const _0x5ed73c=_0x1ce9f3,_0x42e02f={'nQEiM':function(_0xef9d65,_0x24d812){return _0xef9d65(_0x24d812);},'IbhGq':_0x5ed73c(0x453),'AcKIZ':function(_0x1c1d6c,_0x5b4e34){return _0x1c1d6c||_0x5b4e34;},'GQiQs':_0x5ed73c(0x25e),'IBfnT':function(_0x507190,_0x5cf8d7){return _0x507190(_0x5cf8d7);}};if(!axios)axios=_0x42e02f[_0x5ed73c(0x2b1)](require,'axios');let _0x1b022a=process[_0x5ed73c(0x244)]['DINGTALK_APP_KEY'],_0x535239=process['env'][_0x5ed73c(0x3a0)];if((!_0x1b022a||!_0x535239)&&dbPool)try{const [_0x3ff216]=await dbPool[_0x5ed73c(0x429)](_0x42e02f['IbhGq'],[_0x5ed73c(0x3a6)]),_0x118700=_0x3ff216&&_0x3ff216[0x0]&&_0x3ff216[0x0]['value']?_0x3ff216[0x0][_0x5ed73c(0x2ea)]:null;if(_0x118700)try{const _0x1e1f95=JSON[_0x5ed73c(0x485)](_0x118700);_0x1b022a=String(_0x1e1f95['dingtalkAppKey']||_0x1b022a||''),_0x535239=String(_0x1e1f95[_0x5ed73c(0x21a)]||_0x535239||'');}catch(_0x54e74e){}}catch(_0x4c62bf){}if(_0x42e02f[_0x5ed73c(0x397)](!_0x1b022a,!_0x535239))throw new Error('未配置钉钉APP\x20Key/Secret，请在环境变量或系统设置中配置');const _0x257abb=await axios['get']('https://oapi.dingtalk.com/gettoken',{'params':{'appkey':_0x1b022a,'appsecret':_0x535239}}),_0x3dc000=_0x257abb?.[_0x5ed73c(0x26f)]||{};if(_0x3dc000[_0x5ed73c(0x2dd)]!==0x0||!_0x3dc000['access_token']){const _0x459c74=_0x3dc000['errmsg']||_0x42e02f['GQiQs'],_0x5f0791=_0x3dc000[_0x5ed73c(0x3e5)]?_0x5ed73c(0x2eb)+_0x3dc000[_0x5ed73c(0x3e5)]+']':'';throw new Error(''+_0x459c74+_0x5f0791);}return _0x42e02f[_0x5ed73c(0x2bd)](String,_0x3dc000[_0x5ed73c(0x445)]);}function generateDingtalkSign(_0x5ec4ae,_0x584ba){const _0x402d3b=_0x1ce9f3,_0x19cb92=_0x584ba+'\x0a'+_0x5ec4ae,_0x251dce=crypto['createHmac']('sha256',_0x5ec4ae);_0x251dce['update'](_0x19cb92);const _0x2db5ae=encodeURIComponent(_0x251dce[_0x402d3b(0x1d4)]('base64'));return _0x2db5ae;}app['post'](_0x1ce9f3(0x48e),async(_0x12e9c9,_0x33a026)=>{const _0x2af807=_0x1ce9f3,_0x44360d={'vyGvT':function(_0x13b218,_0x1bd9fe){return _0x13b218(_0x1bd9fe);},'BgVjg':_0x2af807(0x315),'QOVni':'【连接测试】企业年度规划系统连接测试成功！','dAEha':function(_0x332821,_0x408e76){return _0x332821===_0x408e76;},'OSwOl':'duhKO'};try{if(!axios)axios=_0x44360d['vyGvT'](require,_0x44360d[_0x2af807(0x4a7)]);const {webhookUrl:_0x4b78d1,secret:_0x1afe27}=_0x12e9c9['body']||{};if(!_0x4b78d1){if(_0x2af807(0x2b3)!=='aEjMb')_0x2bf070[_0x2af807(0x42b)](0x1f4)[_0x2af807(0x1fc)]({'error':_0x11f518['message']});else return _0x33a026[_0x2af807(0x42b)](0x190)['json']({'success':![],'message':'Webhook地址不能为空'});}let _0x2765d3=_0x4b78d1;if(_0x1afe27){const _0x38f70a=Date['now'](),_0x1edce2=generateDingtalkSign(_0x1afe27,_0x38f70a),_0x47027f=_0x4b78d1['includes']('?')?'&':'?';_0x2765d3=''+_0x4b78d1+_0x47027f+'timestamp='+_0x38f70a+'&sign='+_0x1edce2;}const _0x167982=await axios[_0x2af807(0x2c1)](_0x2765d3,{'msgtype':'text','text':{'content':_0x44360d[_0x2af807(0x2db)]}},{'headers':{'Content-Type':_0x2af807(0x21d)},'timeout':0x2710});if(_0x44360d[_0x2af807(0x363)](_0x167982['data']['errcode'],0x0))_0x33a026[_0x2af807(0x1fc)]({'success':!![],'message':_0x2af807(0x2cf)});else{if(_0x44360d[_0x2af807(0x2af)]==='nnvmZ')try{_0x1b4ceb=_0x4dbeed['parse'](_0x1b87d5);}catch(_0x22c54e){_0x577c12=null;}else _0x33a026['json']({'success':![],'message':_0x167982[_0x2af807(0x26f)]['errmsg']||_0x2af807(0x1ee),'errcode':_0x167982['data'][_0x2af807(0x2dd)]});}}catch(_0x59e881){console[_0x2af807(0x3ee)]('[DingTalk\x20Webhook]\x20连接测试失败:',_0x59e881[_0x2af807(0x359)]),_0x33a026['status'](0x1f4)[_0x2af807(0x1fc)]({'success':![],'message':_0x59e881['response']?.[_0x2af807(0x26f)]?.[_0x2af807(0x312)]||_0x59e881['message']||'连接测试失败'});}}),app[_0x1ce9f3(0x2c1)](_0x1ce9f3(0x25b),async(_0x3f72d5,_0x8e2f43)=>{const _0x187ee0=_0x1ce9f3,_0x2b4f0d={'ytTkm':'消息标题和内容不能同时为空','YOntG':function(_0x2f3454,_0xc4a3f5,_0xed1c7f){return _0x2f3454(_0xc4a3f5,_0xed1c7f);},'fSykt':'markdown','ilJDe':function(_0x120036,_0x4a1696){return _0x120036||_0x4a1696;},'xQdqq':'application/json','jocaY':_0x187ee0(0x331)};try{if(!axios)axios=require(_0x187ee0(0x315));const {webhookUrl:_0x4f36af,secret:_0x1393a9,title:_0x3b362c,content:_0x5f430e,msgtype:msgtype='markdown'}=_0x3f72d5[_0x187ee0(0x444)]||{};if(!_0x4f36af)return _0x8e2f43[_0x187ee0(0x42b)](0x190)[_0x187ee0(0x1fc)]({'success':![],'message':'Webhook地址不能为空'});if(!_0x3b362c&&!_0x5f430e)return _0x8e2f43['status'](0x190)['json']({'success':![],'message':_0x2b4f0d['ytTkm']});let _0x6f5d0c=_0x4f36af;if(_0x1393a9){const _0x4446ce=Date[_0x187ee0(0x1e0)](),_0x14e4dc=_0x2b4f0d['YOntG'](generateDingtalkSign,_0x1393a9,_0x4446ce),_0x496174=_0x4f36af['includes']('?')?'&':'?';_0x6f5d0c=''+_0x4f36af+_0x496174+'timestamp='+_0x4446ce+'&sign='+_0x14e4dc;}let _0x4842db;msgtype==='markdown'?_0x4842db={'msgtype':_0x2b4f0d[_0x187ee0(0x26e)],'markdown':{'title':_0x3b362c||_0x187ee0(0x38b),'text':_0x187ee0(0x48c)+(_0x3b362c||'系统通知')+'\x0a\x0a'+(_0x5f430e||'')}}:_0x4842db={'msgtype':'text','text':{'content':_0x3b362c?'【'+_0x3b362c+'】\x0a'+(_0x5f430e||''):_0x2b4f0d['ilJDe'](_0x5f430e,'')}};const _0x586fa8=await axios[_0x187ee0(0x2c1)](_0x6f5d0c,_0x4842db,{'headers':{'Content-Type':_0x2b4f0d['xQdqq']},'timeout':0x2710});_0x586fa8['data']['errcode']===0x0?_0x8e2f43[_0x187ee0(0x1fc)]({'success':!![],'message':'消息发送成功'}):_0x8e2f43[_0x187ee0(0x1fc)]({'success':![],'message':_0x586fa8['data']['errmsg']||_0x2b4f0d['jocaY'],'errcode':_0x586fa8['data']['errcode']});}catch(_0x310df8){console['error']('[DingTalk\x20Webhook]\x20消息发送失败:',_0x310df8['message']),_0x8e2f43['status'](0x1f4)['json']({'success':![],'message':_0x310df8['response']?.[_0x187ee0(0x26f)]?.['errmsg']||_0x310df8[_0x187ee0(0x359)]||'消息发送失败'});}}),app['get']('/api/integration/status',async(_0x12a22f,_0x2d2ff0)=>{const _0x1cb383=_0x1ce9f3,_0x4b11ea={'ZJDdO':'integration'};let _0x7021c=Boolean(process['env']['DINGTALK_APP_KEY']&&process['env'][_0x1cb383(0x3a0)]);if(!_0x7021c&&dbPool)try{const [_0x3f03fc]=await dbPool[_0x1cb383(0x429)](_0x1cb383(0x453),[_0x4b11ea['ZJDdO']]),_0x341109=_0x3f03fc&&_0x3f03fc[0x0]&&_0x3f03fc[0x0][_0x1cb383(0x2ea)]?_0x3f03fc[0x0][_0x1cb383(0x2ea)]:null;if(_0x341109)try{const _0x5a83b5=JSON[_0x1cb383(0x485)](_0x341109);_0x7021c=Boolean(_0x5a83b5['dingtalkAppKey']&&_0x5a83b5['dingtalkAppSecret']);}catch(_0x5a6402){}}catch(_0x1334d){}_0x2d2ff0[_0x1cb383(0x1fc)]({'dingtalkConfigured':_0x7021c});});async function getMaintenanceStatus(){const _0x215020=_0x1ce9f3,_0x5a4673={'WWzDb':function(_0x5cc8e4){return _0x5cc8e4();},'ajUDP':function(_0x1d6137,_0x314da7){return _0x1d6137===_0x314da7;},'rfgjy':'string'},_0x21e572=await _0x5a4673[_0x215020(0x319)](getSystemAutoBackupSettings),_0x45dc6a=Boolean(_0x21e572&&_0x5a4673[_0x215020(0x395)](_0x21e572['maintenanceMode'],!![])),_0x15f596=_0x21e572&&typeof _0x21e572[_0x215020(0x392)]===_0x5a4673[_0x215020(0x308)]?_0x21e572['maintenanceMessage']:null,_0x16ef51=_0x21e572&&_0x21e572[_0x215020(0x44f)]?String(_0x21e572['maintenanceSince']):null;return{'enabled':_0x45dc6a,'message':_0x15f596,'since':_0x16ef51};}app['get'](_0x1ce9f3(0x219),async(_0x3656de,_0x21cc62)=>{try{const _0x416d48=await getMaintenanceStatus();_0x21cc62['json'](_0x416d48);}catch(_0x6c5b66){_0x21cc62['status'](0x1f4)['json']({'error':_0x6c5b66['message']});}}),app[_0x1ce9f3(0x44b)]('/api/system-settings',async(_0x5a3dbc,_0x58f29b)=>{const _0x9cd783=_0x1ce9f3,_0x5c7bb7={'OAtlK':function(_0x2b9c17,_0x2651f8){return _0x2b9c17(_0x2651f8);},'NfKCz':function(_0x5df919,_0x309ced){return _0x5df919===_0x309ced;},'dbrCt':'oVqWB'};if(!dbPool)try{const _0x27f63d=await readTable(_0x9cd783(0x364)),_0x164d95=_0x27f63d[_0x9cd783(0x377)](_0xb5acc=>({'id':_0xb5acc['id'],'key':_0xb5acc['key'],'value':_0xb5acc[_0x9cd783(0x2ea)]}));return _0x58f29b[_0x9cd783(0x1fc)](_0x164d95);}catch(_0x1960f7){if(_0x5c7bb7[_0x9cd783(0x3c1)]('oVqWB',_0x5c7bb7['dbrCt']))return _0x58f29b[_0x9cd783(0x42b)](0x1f4)[_0x9cd783(0x1fc)]({'error':_0x1960f7[_0x9cd783(0x359)]});else{const _0x401c9d=_0x45bdee['parse'](_0x2ae4d3);_0x34e942=_0x5c7bb7['OAtlK'](_0x2f021a,_0x401c9d['dingtalkAppKey']&&_0x401c9d[_0x9cd783(0x21a)]);}}try{const [_0x2dde2c]=await dbPool[_0x9cd783(0x429)]('SELECT\x20id,\x20`key`,\x20value,\x20created_at\x20FROM\x20system_settings\x20ORDER\x20BY\x20id\x20DESC'),_0x5971cd=_0x2dde2c['map'](_0x168ab6=>({'id':_0x168ab6['id'],'key':_0x168ab6[_0x9cd783(0x1d2)],'value':safeParse(_0x168ab6['value'])}));_0x58f29b['json'](_0x5971cd);}catch(_0x55a806){_0x58f29b[_0x9cd783(0x42b)](0x1f4)['json']({'error':_0x55a806[_0x9cd783(0x359)]});}}),app[_0x1ce9f3(0x2c1)]('/api/system-settings',async(_0x1ef653,_0x2395f2)=>{const _0x1b3256=_0x1ce9f3,_0x541d28={'HWXWC':_0x1b3256(0x46f),'ueqUE':_0x1b3256(0x3d4),'MaeAU':function(_0x269bd6,_0x8d7c69){return _0x269bd6(_0x8d7c69);},'ihHeI':function(_0x568067,_0x207b48){return _0x568067!==_0x207b48;},'yjJpz':'null'};if(!dbPool)try{const _0x503c47=String(_0x1ef653[_0x1b3256(0x444)]?.[_0x1b3256(0x1d2)]||'')[_0x1b3256(0x487)](),_0x1de863=_0x1ef653['body']?.[_0x1b3256(0x2ea)];if(!_0x503c47)return _0x2395f2['status'](0x190)[_0x1b3256(0x1fc)]({'error':_0x541d28[_0x1b3256(0x27c)]});const _0x100569=await addRow(_0x1b3256(0x364),{'key':_0x503c47,'value':_0x1de863});try{await applyAutoBackupSchedule();}catch(_0x3c1a76){}return _0x2395f2[_0x1b3256(0x42b)](0xc9)['json'](_0x100569);}catch(_0x19d4f0){if(_0x541d28[_0x1b3256(0x26d)]===_0x541d28[_0x1b3256(0x26d)])return _0x2395f2[_0x1b3256(0x42b)](0x1f4)['json']({'error':_0x19d4f0[_0x1b3256(0x359)]});else _0x17ff70['data'][_0x81a241]=[];}try{const _0x8dc1fa=_0x541d28['MaeAU'](String,_0x1ef653[_0x1b3256(0x444)]?.['key']||'')[_0x1b3256(0x487)](),_0x57ac80=_0x541d28[_0x1b3256(0x3f9)](_0x1ef653['body']?.[_0x1b3256(0x2ea)],undefined)?JSON[_0x1b3256(0x393)](_0x1ef653[_0x1b3256(0x444)]['value']):_0x541d28[_0x1b3256(0x2c6)];if(!_0x8dc1fa)return _0x2395f2['status'](0x190)['json']({'error':_0x1b3256(0x46f)});const [_0x166481]=await dbPool[_0x1b3256(0x429)](_0x1b3256(0x220),[_0x8dc1fa,_0x57ac80]);try{await applyAutoBackupSchedule();}catch(_0x5f48a2){}_0x2395f2['status'](0xc9)[_0x1b3256(0x1fc)]({'id':_0x166481[_0x1b3256(0x361)],'key':_0x8dc1fa,'value':_0x1ef653['body']['value']});}catch(_0x5f46d8){_0x2395f2['status'](0x1f4)[_0x1b3256(0x1fc)]({'error':_0x5f46d8['message']});}}),app[_0x1ce9f3(0x42e)](_0x1ce9f3(0x2fd),async(_0x4ccf40,_0x1552c3)=>{const _0x3e4e7b=_0x1ce9f3,_0x3173f2={'uVito':function(_0x21ed6a,_0x21d69c){return _0x21ed6a(_0x21d69c);},'citXF':'system_settings','cePLJ':function(_0x53e866,_0x27ab31){return _0x53e866(_0x27ab31);},'gclVC':_0x3e4e7b(0x324),'gyvmD':'UPDATE\x20system_settings\x20SET\x20`key`=?,\x20value=?\x20WHERE\x20id=?','pAAYO':function(_0x3c5343){return _0x3c5343();},'BQNbK':_0x3e4e7b(0x246),'RUXSI':_0x3e4e7b(0x236)};if(!dbPool)try{const _0x365013=Number(_0x4ccf40['params']['id']),_0x4e63dd=_0x3173f2[_0x3e4e7b(0x1ed)](String,_0x4ccf40[_0x3e4e7b(0x444)]?.[_0x3e4e7b(0x1d2)]||'')[_0x3e4e7b(0x487)](),_0x413c5d=_0x4ccf40['body']?.[_0x3e4e7b(0x2ea)];if(!_0x365013){if('lxKUk'===_0x3e4e7b(0x38d))return _0x1552c3['status'](0x190)[_0x3e4e7b(0x1fc)]({'error':_0x3e4e7b(0x2d1)});else _0x406bd8[_0x3e4e7b(0x42b)](0x1f4)[_0x3e4e7b(0x1fc)]({'error':_0x521902[_0x3e4e7b(0x359)]});}return await updateRow(_0x3173f2['citXF'],_0x365013,{'key':_0x4e63dd,'value':_0x413c5d}),_0x1552c3[_0x3e4e7b(0x1fc)]({'success':!![]});}catch(_0x477422){return _0x1552c3[_0x3e4e7b(0x42b)](0x1f4)[_0x3e4e7b(0x1fc)]({'error':_0x477422['message']});}try{const _0x113f2a=_0x3173f2[_0x3e4e7b(0x1ed)](Number,_0x4ccf40[_0x3e4e7b(0x48a)]['id']),_0x239a97=_0x3173f2[_0x3e4e7b(0x24d)](String,_0x4ccf40['body']?.['key']||'')['trim'](),_0x40b55f=_0x4ccf40['body']?.['value']!==undefined?JSON['stringify'](_0x4ccf40[_0x3e4e7b(0x444)][_0x3e4e7b(0x2ea)]):_0x3173f2['gclVC'];if(!_0x113f2a)return _0x1552c3['status'](0x190)['json']({'error':'Invalid\x20id'});await dbPool['query'](_0x3173f2['gyvmD'],[_0x239a97,_0x40b55f,_0x113f2a]);try{await _0x3173f2['pAAYO'](applyAutoBackupSchedule);}catch(_0x43363f){}_0x1552c3['json']({'success':!![]});}catch(_0x233f71){if(_0x3173f2['BQNbK']===_0x3173f2['RUXSI'])return _0x1d372a['status'](0x1f4)['json']({'error':_0x10dc4e['message']});else _0x1552c3['status'](0x1f4)['json']({'error':_0x233f71['message']});}}),app[_0x1ce9f3(0x1f0)](_0x1ce9f3(0x2fd),async(_0x4a5ec9,_0xbeed4f)=>{const _0x8a72f1=_0x1ce9f3,_0x2c0775={'ZcMbc':function(_0x1669ff,_0x23fc54,_0x49363a){return _0x1669ff(_0x23fc54,_0x49363a);},'GzLdV':'system_settings','uPhxW':_0x8a72f1(0x307)};if(!dbPool)try{return await _0x2c0775['ZcMbc'](deleteRow,_0x2c0775['GzLdV'],_0x4a5ec9['params']['id']),_0xbeed4f[_0x8a72f1(0x1fc)]({'success':!![]});}catch(_0x521fff){return _0xbeed4f[_0x8a72f1(0x42b)](0x1f4)[_0x8a72f1(0x1fc)]({'error':_0x521fff['message']});}try{await dbPool['query'](_0x2c0775['uPhxW'],[_0x4a5ec9['params']['id']]),_0xbeed4f['json']({'success':!![]});}catch(_0x369157){_0xbeed4f['status'](0x1f4)[_0x8a72f1(0x1fc)]({'error':_0x369157['message']});}});function safeParse(_0x9e4900){if(!_0x9e4900)return null;try{return JSON['parse'](_0x9e4900);}catch(_0x2c9914){return null;}}app['get']('/api/dingtalk/departments',async(_0x6167b2,_0x4b7f7e)=>{const _0x2d0574=_0x1ce9f3,_0x2af7c0={'ERBPF':function(_0xdae8fa,_0x7f3f33){return _0xdae8fa!==_0x7f3f33;},'BOWRj':_0x2d0574(0x315),'CrQFF':function(_0x30ba4b,_0x23b9f6){return _0x30ba4b!==_0x23b9f6;}};try{if(_0x2af7c0[_0x2d0574(0x2d5)](_0x2d0574(0x2d3),'WeynF')){const _0x5514ba=_0x1fb7dd[_0x2d0574(0x1e0)](),_0x5dbfdf=_0x27276e(_0x152536,_0x5514ba),_0x2fdd1f=_0x23d13e[_0x2d0574(0x24b)]('?')?'&':'?';_0x34d487=''+_0x4fc4e5+_0x2fdd1f+'timestamp='+_0x5514ba+'&sign='+_0x5dbfdf;}else{if(!axios)axios=require(_0x2af7c0['BOWRj']);const _0x9e8236=await getDingTalkAccessToken(),_0x55e824=_0x6167b2[_0x2d0574(0x429)][_0x2d0574(0x495)]||0x1,_0x33d0e2=await axios['post'](_0x2d0574(0x39b)+_0x9e8236,{'dept_id':Number(_0x55e824)});if(_0x2af7c0['CrQFF'](_0x33d0e2['data']['errcode'],0x0))throw new Error(_0x33d0e2[_0x2d0574(0x26f)][_0x2d0574(0x312)]||'获取钉钉部门列表失败');const _0x32c9f0=(_0x33d0e2[_0x2d0574(0x26f)]['result']||[])['map'](_0x5e65ed=>({'id':_0x5e65ed[_0x2d0574(0x495)],'name':_0x5e65ed[_0x2d0574(0x419)],'parent_id':_0x5e65ed['parent_id'],'create_dept_group':_0x5e65ed[_0x2d0574(0x449)],'auto_add_user':_0x5e65ed['auto_add_user']}));_0x4b7f7e['json'](_0x32c9f0);}}catch(_0xff0672){console['error']('[DingTalk]\x20获取部门列表失败:',_0xff0672['message']),_0x4b7f7e['status'](0x1f4)[_0x2d0574(0x1fc)]({'error':_0xff0672['message']});}}),app['get'](_0x1ce9f3(0x2f0),async(_0x4238fa,_0xcaa10f)=>{const _0x13d71b=_0x1ce9f3,_0x1ee1c2={'ZmiWU':function(_0x596e03){return _0x596e03();},'TktKs':function(_0xb27f43,_0x549152){return _0xb27f43(_0x549152);},'cxSvb':function(_0x49b22d,_0xd1fa4d){return _0x49b22d!==_0xd1fa4d;}};try{if(!axios)axios=require('axios');const _0x1652a4=await _0x1ee1c2[_0x13d71b(0x398)](getDingTalkAccessToken),_0x53ec91=_0x4238fa[_0x13d71b(0x429)]['dept_id']||0x1,_0x4fc734=_0x4238fa[_0x13d71b(0x429)][_0x13d71b(0x40b)]||0x0,_0x2af1ec=Math['min'](_0x1ee1c2['TktKs'](Number,_0x4238fa[_0x13d71b(0x429)]['size'])||0x64,0x64),_0xe0b624=await axios[_0x13d71b(0x2c1)](_0x13d71b(0x2da)+_0x1652a4,{'dept_id':Number(_0x53ec91),'cursor':Number(_0x4fc734),'size':_0x2af1ec});if(_0x1ee1c2[_0x13d71b(0x263)](_0xe0b624[_0x13d71b(0x26f)][_0x13d71b(0x2dd)],0x0))throw new Error(_0xe0b624['data'][_0x13d71b(0x312)]||'获取钉钉员工列表失败');const _0x286cb3=_0xe0b624['data'][_0x13d71b(0x460)]||{},_0x325c84=(_0x286cb3['list']||[])['map'](_0x187b9a=>({'employee_id':_0x187b9a[_0x13d71b(0x3b9)],'name':_0x187b9a[_0x13d71b(0x419)],'department':(_0x187b9a[_0x13d71b(0x32d)]||[])['join'](','),'position':_0x187b9a[_0x13d71b(0x24e)]||'','phone':_0x187b9a[_0x13d71b(0x2d0)]||'','email':_0x187b9a['email']||'','avatar':_0x187b9a[_0x13d71b(0x3ce)]||'','job_number':_0x187b9a[_0x13d71b(0x296)]||''}));_0xcaa10f[_0x13d71b(0x1fc)]({'list':_0x325c84,'has_more':_0x286cb3['has_more']||![],'next_cursor':_0x286cb3['next_cursor']||0x0});}catch(_0x5c853f){console['error'](_0x13d71b(0x23e),_0x5c853f[_0x13d71b(0x359)]),_0xcaa10f['status'](0x1f4)[_0x13d71b(0x1fc)]({'error':_0x5c853f[_0x13d71b(0x359)]});}}),app['post']('/api/departments/sync-dingtalk',async(_0x4681a6,_0x106637)=>{const _0x5e53e1=_0x1ce9f3,_0x121acb={'zOsPP':_0x5e53e1(0x315),'CaUKO':function(_0x578efb){return _0x578efb();},'BaFil':function(_0x1b6776,_0x38117b){return _0x1b6776(_0x38117b);},'FqJiP':'[DingTalk]\x20开始同步部门，根部门ID:','mabKf':function(_0x4a6581,_0x2fe3cb){return _0x4a6581>_0x2fe3cb;},'uTDsL':'COMPANY','xUASw':'DEPT','VcUcM':'active','Anehn':_0x5e53e1(0x250),'QuCRQ':'departments','mwmKN':function(_0x5f8456,_0x438537){return _0x5f8456(_0x438537);},'OWUXP':function(_0x17175f,_0x11f3e1,_0x124b68){return _0x17175f(_0x11f3e1,_0x124b68);}};try{let _0x2cc3d8=Array[_0x5e53e1(0x269)](_0x4681a6['body']?.[_0x5e53e1(0x286)])?_0x4681a6['body'][_0x5e53e1(0x286)]:[];if(_0x2cc3d8['length']===0x0){if(!axios)axios=require(_0x121acb['zOsPP']);const _0x58b285=await _0x121acb['CaUKO'](getDingTalkAccessToken),_0x27bf5f=_0x121acb[_0x5e53e1(0x2df)](Number,_0x4681a6[_0x5e53e1(0x444)]?.[_0x5e53e1(0x27e)]||process['env'][_0x5e53e1(0x3a9)]||0x1);console['log'](_0x121acb['FqJiP'],_0x27bf5f);const _0x134ef1=[_0x27bf5f],_0x209e8a=new Set(),_0x5ec6a4=[];while(_0x121acb['mabKf'](_0x134ef1[_0x5e53e1(0x43c)],0x0)){const _0x36cdf9=_0x134ef1[_0x5e53e1(0x450)]();if(_0x209e8a['has'](_0x36cdf9))continue;_0x209e8a[_0x5e53e1(0x461)](_0x36cdf9);try{const _0x513169=await axios['post'](_0x5e53e1(0x3e6)+_0x58b285,{'dept_id':_0x36cdf9});if(_0x513169[_0x5e53e1(0x26f)]['errcode']===0x0&&_0x513169[_0x5e53e1(0x26f)][_0x5e53e1(0x460)]){const _0x35a5be=_0x513169['data'][_0x5e53e1(0x460)],_0xd85d15=!_0x35a5be[_0x5e53e1(0x407)]||_0x35a5be[_0x5e53e1(0x407)]===0x0||_0x35a5be[_0x5e53e1(0x407)]===0x1,_0x3791c5=_0xd85d15?_0x121acb[_0x5e53e1(0x1e6)]:_0x121acb['xUASw'];_0x5ec6a4[_0x5e53e1(0x458)]({'id':_0x35a5be['dept_id'],'name':_0x35a5be['name'],'parent_id':_0x35a5be[_0x5e53e1(0x407)]??null,'type':_0x3791c5,'code':String(_0x35a5be['dept_id']),'manager':_0x35a5be[_0x5e53e1(0x40e)]||null,'phone':null,'email':null,'status':_0x5e53e1(0x3d1),'description':null});}}catch(_0xe846b1){console[_0x5e53e1(0x3ee)](_0x5e53e1(0x412)+_0x36cdf9+_0x5e53e1(0x389),_0xe846b1['message']);}let _0x2aad2e=0x0;while(!![]){try{const _0x15e016=await axios['post'](_0x5e53e1(0x39b)+_0x58b285,{'dept_id':_0x36cdf9,'cursor':_0x2aad2e,'size':0x64});if(_0x15e016[_0x5e53e1(0x26f)]['errcode']!==0x0)break;const _0x5e5279=Array['isArray'](_0x15e016['data'][_0x5e53e1(0x460)])?_0x15e016['data'][_0x5e53e1(0x460)]:[];for(const _0x25fefb of _0x5e5279){!_0x209e8a[_0x5e53e1(0x287)](_0x25fefb[_0x5e53e1(0x495)])&&_0x134ef1[_0x5e53e1(0x458)](_0x25fefb['dept_id']);}break;}catch(_0x2a4f23){break;}}}_0x2cc3d8=_0x5ec6a4,console[_0x5e53e1(0x49f)]('[DingTalk]\x20从钉钉获取到\x20'+_0x2cc3d8[_0x5e53e1(0x43c)]+_0x5e53e1(0x2e8));}let _0x3d2607=0x0;if(dbPool)for(const _0x224f7a of _0x2cc3d8){const _0x5f5cd5=_0x224f7a['id']||_0x224f7a[_0x5e53e1(0x495)]||_0x224f7a['department_id']||null,_0xea8679=_0x224f7a[_0x5e53e1(0x419)]||_0x224f7a['dept_name']||_0x224f7a[_0x5e53e1(0x340)]||'',_0x81492d=_0x224f7a['code']||_0x224f7a[_0x5e53e1(0x46a)]||String(_0x5f5cd5),_0x3be2fe=_0x224f7a['manager']||null,_0x2f3489=_0x224f7a['phone']||null,_0x29adc0=_0x224f7a[_0x5e53e1(0x427)]||null,_0x43dfbc=_0x224f7a[_0x5e53e1(0x42b)]||_0x121acb[_0x5e53e1(0x261)],_0x55fdc5=_0x224f7a[_0x5e53e1(0x27d)]||null;try{const _0x5e741a=_0x224f7a[_0x5e53e1(0x1e2)]||'DEPT';await dbPool['query'](_0x121acb[_0x5e53e1(0x3cc)],[_0x5f5cd5,_0xea8679,_0x81492d,_0x224f7a[_0x5e53e1(0x407)]||null,_0x5e741a,_0x3be2fe,_0x2f3489,_0x29adc0,_0x43dfbc,_0x55fdc5]),_0x3d2607++;}catch(_0x59ca05){console[_0x5e53e1(0x3ee)]('[DingTalk]\x20保存部门\x20'+_0x5f5cd5+_0x5e53e1(0x39e),_0x59ca05[_0x5e53e1(0x359)]);}}else{const _0x26bba8=await readTable(_0x121acb['QuCRQ']),_0x10eec9=new Map(_0x26bba8['map'](_0x247400=>[_0x247400['id'],_0x247400]));for(const _0x2b614c of _0x2cc3d8){const _0xac7aa=_0x2b614c['id']||_0x2b614c[_0x5e53e1(0x495)]||_0x2b614c['department_id'];if(_0xac7aa){const _0x5125dc=_0x10eec9['get'](_0xac7aa)||{},_0x2e11e9=_0x2b614c['type']||_0x5125dc[_0x5e53e1(0x1e2)]||'DEPT';_0x10eec9['set'](_0xac7aa,{..._0x5125dc,'id':_0xac7aa,'name':_0x2b614c[_0x5e53e1(0x419)]||_0x2b614c['dept_name']||_0x2b614c['department_name']||_0x5125dc['name']||'','code':_0x2b614c[_0x5e53e1(0x43d)]||_0x2b614c[_0x5e53e1(0x46a)]||_0x5125dc['code']||_0x121acb[_0x5e53e1(0x36e)](String,_0xac7aa),'parent_id':_0x2b614c['parent_id']!==undefined?_0x2b614c['parent_id']:_0x5125dc[_0x5e53e1(0x407)]||null,'type':_0x2e11e9,'manager':_0x2b614c[_0x5e53e1(0x240)]||_0x5125dc[_0x5e53e1(0x240)]||'','phone':_0x2b614c[_0x5e53e1(0x2fa)]||_0x5125dc['phone']||'','email':_0x2b614c[_0x5e53e1(0x427)]||_0x5125dc[_0x5e53e1(0x427)]||'','status':_0x2b614c[_0x5e53e1(0x42b)]||_0x5125dc[_0x5e53e1(0x42b)]||_0x5e53e1(0x3d1),'description':_0x2b614c['description']||_0x5125dc[_0x5e53e1(0x27d)]||'','created_at':_0x5125dc['created_at']||new Date()['toISOString']()});}}await _0x121acb['OWUXP'](writeTable,'departments',Array['from'](_0x10eec9['values']())),_0x3d2607=_0x2cc3d8['length'];}_0x106637['json']({'success':!![],'count':_0x3d2607});}catch(_0x538c5a){console[_0x5e53e1(0x3ee)](_0x5e53e1(0x404),_0x538c5a[_0x5e53e1(0x359)]),_0x106637['status'](0x1f4)['json']({'error':_0x538c5a[_0x5e53e1(0x359)]});}}),app[_0x1ce9f3(0x2c1)]('/api/employees/sync-dingtalk',async(_0x2a9183,_0x3fb414)=>{const _0x72b5ae=_0x1ce9f3,_0x70748b={'hJqJf':function(_0x5ee3cf,_0x14bbbb){return _0x5ee3cf!==_0x14bbbb;},'IxSju':'uUaDM','expot':'SELECT\x20id,\x20name\x20FROM\x20departments','UZefm':_0x72b5ae(0x23b),'Rgaab':function(_0x53093b,_0x50767b){return _0x53093b(_0x50767b);},'LpLsr':function(_0x11725f,_0x35390b){return _0x11725f===_0x35390b;},'lPQoZ':'nkzmu','nQjKx':function(_0x3d6a5c,_0x5e1194){return _0x3d6a5c===_0x5e1194;},'eHdLy':'未知部门','hwTsr':_0x72b5ae(0x288),'hCbGR':function(_0x5f01a5,_0x49456d){return _0x5f01a5(_0x49456d);},'qsZGx':function(_0x435992,_0x231641,_0x22f3a7){return _0x435992(_0x231641,_0x22f3a7);},'dMVUj':_0x72b5ae(0x468)};try{if(_0x70748b[_0x72b5ae(0x278)](_0x72b5ae(0x465),_0x70748b['IxSju']))_0x2f7cba[_0x72b5ae(0x458)]('year\x20=\x20?'),_0x14a7e8['push'](_0x5de19e(_0x1cb27d));else{let _0x1e3d62=Array['isArray'](_0x2a9183[_0x72b5ae(0x444)]?.[_0x72b5ae(0x286)])?_0x2a9183[_0x72b5ae(0x444)]['items']:[];if(_0x1e3d62[_0x72b5ae(0x43c)]===0x0){if(!axios)axios=require('axios');const _0x39c6c9=await getDingTalkAccessToken();console['log'](_0x72b5ae(0x473));let _0x763ef3=[];const _0x38b2a6=new Map();if(dbPool)try{const [_0x7277b0]=await dbPool['query'](_0x70748b['expot']);_0x763ef3=_0x7277b0['map'](_0x2684dd=>Number(_0x2684dd['id'])),_0x7277b0[_0x72b5ae(0x3aa)](_0x4797d6=>_0x38b2a6['set'](Number(_0x4797d6['id']),String(_0x4797d6[_0x72b5ae(0x419)]||'')));}catch(_0x11cb22){console['error'](_0x70748b[_0x72b5ae(0x394)],_0x11cb22['message']);}else try{const _0x37ce25=await _0x70748b[_0x72b5ae(0x3ea)](readTable,_0x72b5ae(0x3c9));_0x763ef3=_0x37ce25[_0x72b5ae(0x377)](_0x2453c0=>Number(_0x2453c0['id']||0x0))['filter'](_0x16a9db=>_0x16a9db>0x0),_0x37ce25[_0x72b5ae(0x3aa)](_0x94df63=>_0x38b2a6[_0x72b5ae(0x409)](Number(_0x94df63['id']||0x0),String(_0x94df63['name']||'')));}catch(_0x2b926c){console['error'](_0x72b5ae(0x36d),_0x2b926c[_0x72b5ae(0x359)]);}if(_0x70748b[_0x72b5ae(0x385)](_0x763ef3['length'],0x0)){if(_0x70748b[_0x72b5ae(0x316)]!=='DzBvM'){const _0x118645=_0x70748b[_0x72b5ae(0x3ea)](Number,_0x2a9183['body']?.['root_dept_id']||process[_0x72b5ae(0x244)][_0x72b5ae(0x3a9)]||0x1);_0x763ef3=[_0x118645];try{const _0xc05219=await axios['post'](_0x72b5ae(0x3e6)+_0x39c6c9,{'dept_id':_0x118645});_0x70748b[_0x72b5ae(0x455)](_0xc05219['data']['errcode'],0x0)&&_0xc05219['data']['result']&&_0x38b2a6['set'](_0x118645,_0xc05219[_0x72b5ae(0x26f)][_0x72b5ae(0x460)]['name']);}catch(_0x5d00e2){}}else _0x140256=null;}const _0x5bebfa=[],_0x39a563=new Set();for(const _0xb8322c of _0x763ef3){const _0x2c0f3e=_0x38b2a6[_0x72b5ae(0x44b)](_0xb8322c)||_0x70748b['eHdLy'];let _0x2e47bf=0x0;while(!![]){try{const _0x647679=await axios[_0x72b5ae(0x2c1)]('https://oapi.dingtalk.com/topapi/v2/user/list?access_token='+_0x39c6c9,{'dept_id':_0xb8322c,'cursor':_0x2e47bf,'size':0x64});if(_0x70748b[_0x72b5ae(0x278)](_0x647679['data'][_0x72b5ae(0x2dd)],0x0))break;const _0xfb9a3a=_0x647679[_0x72b5ae(0x26f)][_0x72b5ae(0x460)]?.['list']||[];for(const _0x25f098 of _0xfb9a3a){if(_0x39a563['has'](_0x25f098[_0x72b5ae(0x3b9)]))continue;_0x39a563[_0x72b5ae(0x461)](_0x25f098[_0x72b5ae(0x3b9)]),_0x5bebfa[_0x72b5ae(0x458)]({'employee_id':_0x25f098['userid'],'name':_0x25f098['name']||'','department':_0x2c0f3e,'position':_0x25f098[_0x72b5ae(0x24e)]||'','phone':_0x25f098['mobile']||'','email':_0x25f098['email']||_0x25f098['org_email']||'','status':_0x70748b[_0x72b5ae(0x385)](_0x25f098[_0x72b5ae(0x3d1)],![])?_0x70748b['hwTsr']:_0x72b5ae(0x3d1)});}if(!_0x647679['data']['result']?.[_0x72b5ae(0x4a4)])break;_0x2e47bf=_0x647679[_0x72b5ae(0x26f)]['result']?.[_0x72b5ae(0x3d8)]||0x0;}catch(_0x28d640){console['error']('[DingTalk]\x20获取部门\x20'+_0xb8322c+'\x20员工失败:',_0x28d640['message']);break;}}}_0x1e3d62=_0x5bebfa,console[_0x72b5ae(0x49f)](_0x72b5ae(0x2de)+_0x1e3d62['length']+'\x20名员工');}let _0x4daa1c=0x0;if(dbPool)for(const _0x2240f0 of _0x1e3d62){const _0x55d393=_0x2240f0[_0x72b5ae(0x3a7)]||_0x2240f0[_0x72b5ae(0x3b9)]||_0x2240f0['jobnumber']||null,_0xa407cc=_0x2240f0[_0x72b5ae(0x419)]||_0x2240f0[_0x72b5ae(0x42f)]||_0x2240f0['realname']||'',_0x4a7eaa=_0x2240f0[_0x72b5ae(0x356)]||_0x2240f0['dept_name']||'',_0x3ed126=_0x2240f0['position']||'',_0x22cd48=_0x2240f0[_0x72b5ae(0x2fa)]||_0x2240f0['mobile']||'',_0x3f7a1b=_0x2240f0[_0x72b5ae(0x427)]||'',_0x2f4e30=_0x2240f0[_0x72b5ae(0x42b)]||_0x72b5ae(0x3d1);if(!_0x55d393)continue;try{await dbPool['query']('INSERT\x20INTO\x20employees\x20(employee_id,\x20name,\x20department,\x20position,\x20phone,\x20email,\x20status)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)\x20ON\x20DUPLICATE\x20KEY\x20UPDATE\x20name=VALUES(name),\x20department=VALUES(department),\x20position=VALUES(position),\x20phone=VALUES(phone),\x20email=VALUES(email),\x20status=VALUES(status)',[_0x55d393,_0xa407cc,_0x4a7eaa,_0x3ed126,_0x22cd48,_0x3f7a1b,_0x2f4e30]),_0x4daa1c++;}catch(_0x16dfaf){console[_0x72b5ae(0x3ee)]('[DingTalk]\x20保存员工\x20'+_0x55d393+'\x20失败:',_0x16dfaf['message']);}}else{const _0x148369=await _0x70748b[_0x72b5ae(0x2ab)](readTable,'employees'),_0x5339df=new Map(_0x148369[_0x72b5ae(0x377)](_0x226b71=>[_0x226b71['employee_id'],_0x226b71]));for(const _0x3d50a7 of _0x1e3d62){const _0x1f317a=_0x3d50a7[_0x72b5ae(0x3a7)]||_0x3d50a7[_0x72b5ae(0x3b9)]||_0x3d50a7[_0x72b5ae(0x294)];if(_0x1f317a){const _0x1bc6a2=_0x5339df[_0x72b5ae(0x44b)](_0x1f317a)||{};_0x5339df['set'](_0x1f317a,{..._0x1bc6a2,'employee_id':_0x1f317a,'name':_0x3d50a7[_0x72b5ae(0x419)]||_0x3d50a7[_0x72b5ae(0x42f)]||_0x3d50a7['realname']||_0x1bc6a2[_0x72b5ae(0x419)]||'','department':_0x3d50a7[_0x72b5ae(0x356)]||_0x3d50a7['dept_name']||_0x1bc6a2['department']||'','position':_0x3d50a7[_0x72b5ae(0x3b6)]||_0x1bc6a2[_0x72b5ae(0x3b6)]||'','phone':_0x3d50a7['phone']||_0x3d50a7['mobile']||_0x1bc6a2['phone']||'','email':_0x3d50a7['email']||_0x1bc6a2['email']||'','status':_0x3d50a7[_0x72b5ae(0x42b)]||_0x1bc6a2[_0x72b5ae(0x42b)]||_0x72b5ae(0x3d1),'created_at':_0x1bc6a2['created_at']||new Date()[_0x72b5ae(0x375)]()});}}await _0x70748b['qsZGx'](writeTable,'employees',Array['from'](_0x5339df[_0x72b5ae(0x3a5)]())),_0x4daa1c=_0x1e3d62[_0x72b5ae(0x43c)];}_0x3fb414['json']({'success':!![],'count':_0x4daa1c});}}catch(_0x58bd4d){console['error'](_0x70748b[_0x72b5ae(0x30f)],_0x58bd4d['message']),_0x3fb414['status'](0x1f4)['json']({'error':_0x58bd4d['message']});}}),app[_0x1ce9f3(0x44b)](_0x1ce9f3(0x311),async(_0x332f8d,_0x339454)=>{const _0x4a1a97=_0x1ce9f3,_0x6b7e3={'IYWkx':function(_0x10581a,_0x9d5c91){return _0x10581a===_0x9d5c91;}};try{if(_0x6b7e3['IYWkx'](_0x4a1a97(0x3e0),_0x4a1a97(0x3e0))){const _0x652c3=Math['max'](0x1,Math[_0x4a1a97(0x281)](0xc8,Number(_0x332f8d[_0x4a1a97(0x429)]?.['limit']||0x32))),_0x82d1b1=Math['max'](0x0,Number(_0x332f8d['query']?.['offset']||0x0)),_0x30e0bd=await fs['readdir'](backupsDir),_0x130fcc=[];for(const _0x53a21e of _0x30e0bd){try{const _0xe658e=path['join'](backupsDir,_0x53a21e),_0x5c461b=await fs[_0x4a1a97(0x45b)](_0xe658e);_0x5c461b[_0x4a1a97(0x3c3)]()&&_0x130fcc[_0x4a1a97(0x458)]({'name':_0x53a21e,'mtime':_0x5c461b[_0x4a1a97(0x3ca)][_0x4a1a97(0x375)](),'size':_0x5c461b[_0x4a1a97(0x1f9)]});}catch(_0x515360){}}_0x130fcc['sort']((_0x4886ad,_0x4953eb)=>new Date(_0x4953eb['mtime'])-new Date(_0x4886ad['mtime']));const _0xba53cf=_0x130fcc[_0x4a1a97(0x43c)],_0x41661a=_0x130fcc[_0x4a1a97(0x1df)](_0x82d1b1,_0x82d1b1+_0x652c3)['map'](_0x581894=>({..._0x581894,'url':'/backups/'+encodeURIComponent(_0x581894[_0x4a1a97(0x419)])}));_0x339454[_0x4a1a97(0x1fc)]({'items':_0x41661a,'total':_0xba53cf});}else _0x2582ec['error'](_0x4a1a97(0x29d),_0x4dc222[_0x4a1a97(0x359)]),_0x42b050['status'](0x1f4)[_0x4a1a97(0x1fc)]({'success':![],'message':_0x5d627c[_0x4a1a97(0x48f)]?.[_0x4a1a97(0x26f)]?.[_0x4a1a97(0x312)]||_0x49fa79[_0x4a1a97(0x359)]||_0x4a1a97(0x331)});}catch(_0x54912c){_0x339454[_0x4a1a97(0x42b)](0x1f4)[_0x4a1a97(0x1fc)]({'error':_0x54912c['message']});}}),app['delete']('/api/admin/backups/:name',async(_0x3e903d,_0x2ab4d7)=>{const _0x18792e=_0x1ce9f3;try{const _0x39fd90=String(_0x3e903d[_0x18792e(0x48a)]?.[_0x18792e(0x419)]||''),_0x3ff1f7=_0x39fd90[_0x18792e(0x369)](/[^a-zA-Z0-9._-]/g,'_');if(!/^system-backup-\d{8}-\d{6}\.json$/[_0x18792e(0x3a8)](_0x3ff1f7))return _0x2ab4d7[_0x18792e(0x42b)](0x190)['json']({'error':'非法文件名'});const _0x375336=path['join'](backupsDir,_0x3ff1f7);try{await fs[_0x18792e(0x37a)](_0x375336);}catch(_0xbfdd4a){return _0x2ab4d7['status'](0x194)[_0x18792e(0x1fc)]({'error':_0x18792e(0x1db)});}_0x2ab4d7['json']({'success':!![]});}catch(_0xdd4a13){_0x2ab4d7[_0x18792e(0x42b)](0x1f4)['json']({'error':_0xdd4a13[_0x18792e(0x359)]});}}),app['get']('/api/admin/audit-logs',async(_0x5d99a3,_0x5cdf7e)=>{const _0x29e301=_0x1ce9f3,_0x5a5009={'eAPdM':function(_0x380943,_0x49f46a){return _0x380943(_0x49f46a);},'srxiK':function(_0xcb7519,_0x519ccd){return _0xcb7519(_0x519ccd);},'xNucT':_0x29e301(0x243),'wOsag':function(_0x2b3a79,_0x996e48){return _0x2b3a79(_0x996e48);},'mVKgJ':function(_0x5a4683,_0x3656b0){return _0x5a4683-_0x3656b0;},'aqoTn':function(_0x46394a,_0x4fd4a5){return _0x46394a-_0x4fd4a5;}};try{const _0x3045a2=Math[_0x29e301(0x28c)](0x1,Math[_0x29e301(0x281)](0xc8,_0x5a5009[_0x29e301(0x321)](Number,_0x5d99a3[_0x29e301(0x429)]?.[_0x29e301(0x423)]||0x32))),_0xf35cab=Math['max'](0x0,_0x5a5009['srxiK'](Number,_0x5d99a3['query']?.['offset']||0x0));if(dbPool){const [_0x138939]=await dbPool[_0x29e301(0x429)](_0x5a5009[_0x29e301(0x366)],[_0x3045a2,_0xf35cab]);return _0x5cdf7e['json']({'items':_0x138939});}const _0x11ba26=await _0x5a5009['wOsag'](readTable,'audit_logs'),_0x408050=_0x11ba26[_0x29e301(0x1df)](Math['max'](0x0,_0x5a5009['mVKgJ'](_0x5a5009[_0x29e301(0x376)](_0x11ba26['length'],_0x3045a2),_0xf35cab)),_0x5a5009['aqoTn'](_0x11ba26[_0x29e301(0x43c)],_0xf35cab))['reverse']();return _0x5cdf7e[_0x29e301(0x1fc)]({'items':_0x408050});}catch(_0x16849b){_0x5cdf7e[_0x29e301(0x42b)](0x1f4)[_0x29e301(0x1fc)]({'error':_0x16849b[_0x29e301(0x359)]});}}),app[_0x1ce9f3(0x2c1)]('/api/admin/backup',async(_0x2e1d21,_0x7d807c)=>{const _0x59ff97=_0x1ce9f3,_0x15c7f6={'EyccF':function(_0x6d95bd){return _0x6d95bd();}};try{const _0x52df1b=await _0x15c7f6['EyccF'](performBackup);_0x7d807c['json'](_0x52df1b);}catch(_0x5949c0){_0x7d807c[_0x59ff97(0x42b)](0x1f4)[_0x59ff97(0x1fc)]({'error':_0x5949c0[_0x59ff97(0x359)]});}}),app['get']('/api/admin/backup/status',async(_0x45bd6c,_0x31f744)=>{const _0x2a379e=_0x1ce9f3,_0x1224ab={'vtSkW':function(_0x40ec2c){return _0x40ec2c();},'FHYfi':function(_0x15a97d,_0x36ee75){return _0x15a97d(_0x36ee75);}};try{const _0x2dc081=await _0x1224ab[_0x2a379e(0x235)](getSystemAutoBackupSettings),_0x29007e=Boolean(_0x2dc081&&_0x2dc081['autoBackup']===!![]),_0x395d1e=_0x1224ab[_0x2a379e(0x3cd)](Number,_0x2dc081&&_0x2dc081[_0x2a379e(0x24a)]!=null?_0x2dc081[_0x2a379e(0x24a)]:null);_0x31f744['json']({'enabled':_0x29007e,'intervalHours':_0x395d1e||null,'nextRunAt':nextBackupAt?nextBackupAt[_0x2a379e(0x375)]():null});}catch(_0x717dd0){_0x31f744['status'](0x1f4)[_0x2a379e(0x1fc)]({'error':_0x717dd0[_0x2a379e(0x359)]});}}),app[_0x1ce9f3(0x2c1)](_0x1ce9f3(0x330),async(_0x1d8931,_0x4a95bf)=>{const _0x464a78=_0x1ce9f3,_0x123949={'UfYfO':_0x464a78(0x226),'WUPyJ':function(_0x128a33,_0x441be7){return _0x128a33(_0x441be7);}};try{const _0x1d221b=_0x1d8931['body']&&_0x1d8931[_0x464a78(0x444)][_0x464a78(0x419)];if(!_0x1d221b)return _0x4a95bf[_0x464a78(0x42b)](0x190)[_0x464a78(0x1fc)]({'error':_0x123949['UfYfO']});await _0x123949[_0x464a78(0x3de)](restoreBackupFromFile,_0x1d221b),_0x4a95bf['json']({'success':!![]});}catch(_0x41e128){_0x4a95bf['status'](0x1f4)[_0x464a78(0x1fc)]({'error':_0x41e128[_0x464a78(0x359)]});}}),app['post'](_0x1ce9f3(0x277),backupUpload[_0x1ce9f3(0x3e7)](_0x1ce9f3(0x39f)),async(_0x1df902,_0x41c45b)=>{const _0x3a6540=_0x1ce9f3,_0x3497fe={'kLmOK':'未上传备份文件','xZbaJ':'utf-8','usPOU':function(_0x10a243,_0x5d84e0){return _0x10a243!==_0x5d84e0;},'QlqkW':'备份文件结构无效','cLoIn':'HVJOV','qwBti':function(_0x57bad6,_0x4a9a78,_0x1efa56){return _0x57bad6(_0x4a9a78,_0x1efa56);}};try{if(!_0x1df902['file'])return _0x41c45b[_0x3a6540(0x42b)](0x190)['json']({'error':_0x3497fe[_0x3a6540(0x3e3)]});const _0x1eaee3=_0x1df902[_0x3a6540(0x39f)]['buffer']?_0x1df902[_0x3a6540(0x39f)][_0x3a6540(0x3fb)]['toString'](_0x3497fe[_0x3a6540(0x35c)]):'';let _0x59236e=null;try{_0x59236e=JSON[_0x3a6540(0x485)](_0x1eaee3||'{}');}catch(_0x373b47){return _0x41c45b['status'](0x190)[_0x3a6540(0x1fc)]({'error':'备份文件内容不是有效的JSON'});}if(!_0x59236e||_0x3497fe[_0x3a6540(0x3df)](typeof _0x59236e,'object')||!_0x59236e[_0x3a6540(0x26f)]||_0x3497fe[_0x3a6540(0x3df)](typeof _0x59236e['data'],_0x3a6540(0x1fb)))return'XxSom'!==_0x3a6540(0x378)?_0x8588c6[_0x3a6540(0x42b)](0x190)['json']({'error':'缺少必填项:\x20'+_0x187c5c['join'](',\x20')}):_0x41c45b[_0x3a6540(0x42b)](0x190)['json']({'error':_0x3497fe[_0x3a6540(0x478)]});const _0x3dce80=BACKUP_TABLES;if(dbPool)for(const _0x3621b0 of _0x3dce80){const _0x22aebe=Array['isArray'](_0x59236e['data'][_0x3621b0])?_0x59236e[_0x3a6540(0x26f)][_0x3621b0]:[];await dbPool['query'](_0x3a6540(0x204)+_0x3621b0);if(_0x22aebe['length']){if('xJWuR'!==_0x3497fe['cLoIn'])for(const _0xb95c50 of _0x22aebe){const _0x2d528e=normalizeDateTimeFields(_0xb95c50);await dbPool[_0x3a6540(0x429)]('INSERT\x20INTO\x20'+_0x3621b0+'\x20SET\x20?',_0x2d528e);}else _0x3712d0['log'](_0x3a6540(0x416)+_0x5a80cc);}}else for(const _0x5c913c of _0x3dce80){const _0x25b99c=Array['isArray'](_0x59236e['data'][_0x5c913c])?_0x59236e['data'][_0x5c913c]:[];await _0x3497fe['qwBti'](writeTable,_0x5c913c,_0x25b99c);}_0x41c45b[_0x3a6540(0x1fc)]({'success':!![]});}catch(_0x430553){_0x41c45b[_0x3a6540(0x42b)](0x1f4)['json']({'error':_0x430553['message']});}});const httpServer=createServer(app),io=new SocketIOServer(httpServer,{'path':_0x1ce9f3(0x462),'cors':{'origin':'*','methods':[_0x1ce9f3(0x253),'POST']}}),onlineRooms=new Set();io['on']('connection',_0x16f016=>{const _0xf16497=_0x1ce9f3,_0x2cb75a={'UyWko':function(_0x526cc5,_0x17fe93){return _0x526cc5===_0x17fe93;},'ayFLz':'wdOCL','clADI':_0xf16497(0x401),'NTFur':'join-room'};console[_0xf16497(0x49f)]('Socket\x20connected:',_0x16f016['id']),_0x16f016['on'](_0x2cb75a[_0xf16497(0x2e1)],_0x5da13b=>{const _0x2af06c=_0xf16497;if(!_0x5da13b)return;_0x16f016[_0x2af06c(0x209)](_0x5da13b),_0x16f016[_0x2af06c(0x26f)][_0x2af06c(0x298)]=_0x5da13b,onlineRooms[_0x2af06c(0x461)](_0x5da13b),io[_0x2af06c(0x3f1)](_0x2af06c(0x401),Array[_0x2af06c(0x233)](onlineRooms));}),_0x16f016['on'](_0xf16497(0x3e1),({room:_0x3c5a62,..._0x48b976})=>{const _0x34b4d6=_0xf16497,_0x2e4d62=_0x3c5a62||_0x16f016[_0x34b4d6(0x26f)][_0x34b4d6(0x298)];_0x2e4d62&&io['to'](_0x2e4d62)[_0x34b4d6(0x3f1)]('data-updated',_0x48b976);}),_0x16f016['on'](_0xf16497(0x30b),_0x5af3bb=>{const _0x3998f8=_0xf16497;if(!_0x5af3bb)return;try{if(_0x2cb75a[_0x3998f8(0x466)](_0x2cb75a[_0x3998f8(0x44c)],_0x3998f8(0x29c)))_0x16f016['leave'](_0x5af3bb);else return _0x57dd33[_0x3998f8(0x42b)](0x190)[_0x3998f8(0x1fc)]({'error':'工号已存在'});}catch{}onlineRooms[_0x3998f8(0x287)](_0x5af3bb)&&(onlineRooms[_0x3998f8(0x1f0)](_0x5af3bb),io[_0x3998f8(0x3f1)](_0x2cb75a['clADI'],Array[_0x3998f8(0x233)](onlineRooms)));}),_0x16f016['on'](_0xf16497(0x2e6),()=>{const _0x3e2cff=_0xf16497,_0x200503=_0x16f016[_0x3e2cff(0x26f)][_0x3e2cff(0x298)];_0x200503&&onlineRooms['has'](_0x200503)&&(onlineRooms[_0x3e2cff(0x1f0)](_0x200503),io['emit']('user-online',Array['from'](onlineRooms))),console['log']('Socket\x20disconnected:',_0x16f016['id']);});});async function start(){const _0x47d0b5=_0x1ce9f3,_0x5ba564={'mbrca':_0x47d0b5(0x2b7),'zaiPP':function(_0x5b257c){return _0x5b257c();}};try{await initDB();}catch(_0x19aeb7){console['error'](_0x5ba564['mbrca'],_0x19aeb7?.[_0x47d0b5(0x359)]||_0x19aeb7);}try{await _0x5ba564[_0x47d0b5(0x234)](applyAutoBackupSchedule);}catch(_0x4cc24c){}httpServer[_0x47d0b5(0x41c)](PORT,()=>{const _0x26300b=_0x47d0b5;console[_0x26300b(0x49f)]('Backend\x20server\x20listening\x20on\x20http://localhost:'+PORT);});}start();